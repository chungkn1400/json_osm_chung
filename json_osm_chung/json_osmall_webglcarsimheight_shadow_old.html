<!DOCTYPE html>
<html>
<!-- json_osmall_webglcarsimheight_shadow a program by NGUYEN.Chung (2015) 
openstreetmap roads to html5 array -->
<head>
<link id="ico" rel="shortcut icon" href="json_osm_chung.ico">
<title>json webglcarsimheight</title>
<meta charset="utf-8">
</head>
<body bgcolor="#FFFFFF" onunload="quit=1;close();" >
<div id="alldiv"  BGCOLOR="#FFFFFF" onKeyUp="keyup(event);" onKeyDown="keydown(event);" OnTouchDown="submousedown(event);"  OnTouchUp="submouseup(event);" >
	<div id="mydiv" style="position:absolute;top:0px;left:0px;z-index:200;" >
	<canvas id="canvasgl" style="border:none;top:0px;left:0px;" width="600" height="400"></canvas>
    </div>
	<!--div id="mydiv2" style="position:absolute;top:0px;left:0px;z-index:300;" onmousedown="submouse2down(event);"  onmouseup="submouse2up(event);" onmousemove="submouse2move(event);"-->
	<div id="mydiv2" style="position:absolute;top:0px;left:0px;z-index:300;" >
	<canvas id="canvas" style="border:none;top:0px;left:0px;" width="600" height="400"></canvas>
	<br />
	<button id="fullscreen"  onclick="sizescreen();">fullscreen</button>
	<button id="loadsave"  onclick="subloadsave();">loadsave</button>
	<select id="combo" onChange="subcombo();" onblur="tfocus=1;waitkey=0;resetmouse2();" onfocus="tfocus=0;waitkey=0;">
          <option id="initial">initial</option>
          <option id="flyto">flyto</option>
          <option id="deauville marinas">deauville marinas</option>
          <option id="deauville plage">deauville plage</option>
          <option id="trouville plage">trouville plage</option>
          <option id="nancy">nancy</option>
          <option id="crickvenica">crickvenica</option>
          <option id="paris tolbiac">paris tolbiac</option>
          <option id="paris defense">paris defense</option>
          <option id="ivry romain roland">ivry romain roland</option>
          <option id="orsay">orsay</option>
          <option id="le barcares">le barcares</option>
          <option id="jerusalem">jerusalem</option>
          <option id="marseille">marseille</option>
          <option id="nice">nice</option>
          <option id="arcachon">arcachon</option>
          <option id="grenoble">grenoble</option>
          <option id="san francisco">san francisco</option>
          <option id="new york">new york</option>
          <option id="atlanta">atlanta</option>
          <option id="rio">rio</option>
          <option id="hong kong">hong kong</option>
          <option id="athenes">athenes</option>
          <option id="perth">perth</option>
          <option id="le caire">le caire</option>
          <option id="washington">washington</option>
          <option id="tajmahal">tajmahal</option>
     </select>
	 <input type="text" id="msg" maxlength="99" size="99" />
	 <!--input type="text"  readonly="readonly" id="msg" maxlength="70" size="70" /-->
     <!--button id="quit"  onclick="subquit();">quit</button-->
     </div>
	<div id="mapdiv" style="position:absolute;top:4022px;left:0px;width:100%;height:95%;" >
    </div>
	<div id="mapdivmsg" style="position:absolute;top:4000px;left:0px;width:400px;height:20px;" >
	<input type="text" id="msgmap"  maxlength="80" size="80" />
    </div>
    <div id="radiodiv" style="position:absolute;top:6000px;left:0px;width:112px;height:350px;z-index:500;" onblur="tfocus=1;" onfocus="tfocus=0;" >
    <div id="radiodiv1" style="top:0px;left:0px;width:112px;height:350px;z-index:499;" onblur="tfocus=1;" onfocus="tfocus=0;" >
    <iframe id="radio" src="" style="top:0px;left:0px;width:112px;height:320px;" scrolling="no" ></iframe><br />
	</div>
    <button id="radioexpand"  onclick="radioexpand();">radio</button>
    <button id="radiocanal"  onclick="radiocanal();">ch</button>
	</div>
    <div id="streetviewdiv" style="position:absolute;top:7000px;left:0px;width:98%;height:98%;" onblur="tfocus=1;" onfocus="tfocus=0;" >
    <iframe id="streetview" src="" style="top:0px;left:0px;width:87%;height:94%;" ></iframe>
	<button id="quitstreetview"  onclick="quitstreetview();">quit view</button>
	</div>
	<div id="savediv" style="position:absolute;top:9000px;left:0px;width:100%;height:100%;">
<button id="load"  onclick="subload();">load</button>
<button id="save"  onclick="subsave();">save</button>
<button id="delete"  onclick="subdelete();">delete</button>
<button id="export"  onclick="subexport();">export</button>
<button id="import"  onclick="subimport();">import</button>
<button id="quit"  onclick="gamesavequit=1;">quit</button>
<br/><br/>
<div id="gamesave">
<input type="checkbox" id="save0check" name="gamesave" value="new" />new 
<input type="text" id="save0text" name="gamesavetext" value="newname" size=47 />
<input type="text" id="save0date" name="gamesavedate" value="date" size=20 /><br/>
</div>
<input type="file" id="gamesavefiles" name="files[]" hidden />
    </div>
</div>
<div id="zoomdiv" style="position:absolute;top:1400px;left:800px;z-index:400;width:40px;height:20px;">
<button id="zoom"  onclick="subzoom();">zoom</button>
</div>
<script>
try{if(localStorage){};}catch(e){localStorage=null;alert("localStorage is not supported");};
var apikey='&key=AIzaSyAH372ZH8QSQgRHsqdtqNxkLVpcp_XUUkE';
//apikey='&key=AIzaSyB6IVrhJJ9pNpagPZIKyEQYlDHDsoAGusE';
//put here your google static map apikey (=> https://developers.google.com/maps/documentation/static-maps/get-api-key)
//to get more than per ip apiusage quota (some thousands to 20 thousands per day) (its free)
</script>
<script type="text/javascript" src="gamesave.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3" type="text/javascript" ></script>
<script type="text/javascript" src='https://code.responsivevoice.org/responsivevoice.js'></script>
<script src="glMatrix-0.9.5.min.js"></script>
<script src="webgl-utils.js"></script>
<script src="base64binary.js"></script>
<script src="vk_keys.js"></script>
<script src="watermp3.js"></script>
<script src="oceanmp3.js"></script>
<script src="pneump3.js"></script>
<script src="carmp3.js"></script>
<script src="rainmp3.js"></script>
<script src="crashmp3.js"></script>
<script src="cricketmp3.js"></script>
<script src="naturemp3.js"></script>
<script src="jet4mp3.js"></script>
<script src="anchormp3.js"></script>
<script src="https://chungkn1400.github.io/json_osm_chung/json_osm_chung/voyagemp3.js"></script>
<script src="https://chungkn1400.github.io/json_osm_chung/json_osm_chung/deerhuntermp3.js"></script>
<!--script src="jscompile_chung.js"></script-->
<script src="carobjtxt.js"></script>
<script src="carwheelobjtxt.js"></script>
<script src="rocobjtxt.js"></script>
<script src="station2objtxt.js"></script>
<script src="loganobjtxt.js"></script>
<script src="c150objtxt.js"></script>
<script src="sailshipobjtxt.js"></script>
<script id="shader-fs0" type="x-shader/x-fragment">
    precision lowp float;
    //precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float z;

    uniform sampler2D uSampler;
	uniform vec4 ucolor;
	uniform float fog;

  void main(void) {
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		if(gl_FragColor.a<0.5){discard;}
		else if(ucolor.a>0.001){//gl_FragColor*=ucolor;
		     //if(ucolor.a>1.001){if(gl_FragColor.g<(ucolor.a-1.0)){discard;}}
		     float sz=max(0.0,z);
             gl_FragColor.rgb=gl_FragColor.rgb*ucolor.rgb+fog*sz/(sz+12.0);
			 }
		}
</script>
<script id="shader-vs0" type="x-shader/x-vertex">
    precision lowp float;
	//precision highp float;
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	//uniform float dmax;

	varying vec2 vTextureCoord;
    varying float z;

    void main(void) {
        vec4 xyz= uMVMatrix * vec4(aVertexPosition, 1.0);
		//xyz.y *=4.03;
		gl_Position = uPMatrix *xyz;
        vTextureCoord = aTextureCoord;
		z=-xyz.z;
		}
</script>
<script id="shader-fs22" type="x-shader/x-fragment">
    precision lowp float;
    //precision mediump float;
	//precision highp float;

	varying float z;

	const vec4 v41=vec4(1.0, 255.0, 65025.0, 160581375.0)/5000.0;
	const vec4 v42=vec4(1.0/255.0,1.0/255.0,1.0/255.0,1.0/255.0);

vec4 encodefloatrgba( float v ) {//range 0.0 - 5000.0
  if(v>5000.0){return vec4(1.0,1.0,1.0,1.0);}
  vec4 enc = fract(v41*v);//vec4(1.0, 255.0, 65025.0, 160581375.0) * (v/5000.0);
  //enc = fract(enc);
  return enc - enc.yzww * v42;//vec4(1.0/255.0,1.0/255.0,1.0/255.0,1.0/255.0);
  //return enc;
}
/*float decodefloatrgba( vec4 rgba ) {
  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) )*5000.0;
}*/

  void main(void) {
        //gl_FragColor = texture2D(uSampler, vTextureCoord);
	    //float z=gl_FragCoord.z;
		if(z<1.0){discard;}
        else{
      gl_FragColor=encodefloatrgba(z);
		}
    }
</script>
<script id="shader-vs22" type="x-shader/x-vertex">
    precision lowp float;
	//precision highp float;
    attribute vec3 aVertexPosition;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	//uniform float dmax;

    varying float z;

    void main(void) {
        vec4 xyz= uMVMatrix * vec4(aVertexPosition, 1.0);
		//xyz.y *=4.03;
		//float dxy=0.25*abs(xyz.y);//max(abs(xyz.x),abs(xyz.y));
		if(xyz.y>14.0){xyz.y=xyz.y*0.5+7.0;}
		else if(xyz.y<-14.0){xyz.y=xyz.y*0.5-7.0;}
	    gl_Position= uPMatrix *xyz;
		//if(abs(xyz.x)>8.0 || abs(xyz.y)>4.0){z=0.0;}
		//else{
		z=-xyz.z;
		if(z<1.0){z=0.0;}
		//z=floor(z*20.0)/20.0;
		z=z*z/5000.0;//}
    }
</script>
<script id="shader-fs2" type="x-shader/x-fragment">
    precision lowp float;
    //precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float z;

    uniform sampler2D uSampler;
	uniform vec4 ucolor;
	const vec4 v41=vec4(1.0, 255.0, 65025.0, 160581375.0)/5000.0;
	const vec4 v42=vec4(1.0/255.0,1.0/255.0,1.0/255.0,1.0/255.0);

vec4 encodefloatrgba( float v ) {//range 0.0 - 5000.0
  if(v>5000.0){return vec4(1.0,1.0,1.0,1.0);}
  vec4 enc = fract(v41*v);//vec4(1.0, 255.0, 65025.0, 160581375.0) * (v/5000.0);
  //enc = fract(enc);
  return enc - enc.yzww * v42;//vec4(1.0/255.0,1.0/255.0,1.0/255.0,1.0/255.0);
  //return enc;
}
/*float decodefloatrgba( vec4 rgba ) {
  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) )*5000.0;
}*/

  void main(void) {
        //gl_FragColor = texture2D(uSampler, vTextureCoord);
	    //float z=gl_FragCoord.z;
		if(z<1.0){discard;}
        else{
   if(ucolor.a>0.001){
      //vec4 color2=texture2D(uSampler, vTextureCoord);
	  if(texture2D(uSampler, vTextureCoord).a<0.5){discard;}
	  else{gl_FragColor=encodefloatrgba(z);}
   }else{
      gl_FragColor=encodefloatrgba(z);
		}
    }
    }
</script>
<script id="shader-vs2" type="x-shader/x-vertex">
    precision lowp float;
	//precision highp float;
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec3 aVertexNormal;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	//uniform float dmax;

	varying vec2 vTextureCoord;
    varying float z;

    void main(void) {
        vec4 xyz= uMVMatrix * vec4(aVertexPosition, 1.0);
		//xyz.y *=4.03;
		//float dxy=0.25*abs(xyz.y);//max(abs(xyz.x),abs(xyz.y));
		if(xyz.y>14.0){xyz.y=xyz.y*0.5+7.0;}
		else if(xyz.y<-14.0){xyz.y=xyz.y*0.5-7.0;}
	    gl_Position= uPMatrix *xyz;
        vTextureCoord = aTextureCoord;
		vec3 normal=aVertexNormal;
		//if(max(abs(xyz.x),abs(xyz.y))>10.0){z=0.0;}
		//else{
		z=-xyz.z;
		if(z<1.0){z=0.0;}
		//z=floor(z*20.0)/20.0;
		z=z*z/5000.0;//}
    }
</script>
<script id="shader-fl" type="x-shader/x-fragment">
    precision lowp float;
	//precision highp float;

    uniform sampler2D uSampler;
	uniform vec4 ucolor;
	uniform int ushadow;
	
	varying vec2 vTextureCoord;
	varying float z0;
	varying vec4 glFragColor;
	
	const vec4 v41=vec4(1.0, 255.0, 65025.0, 160581375.0)/5000.0;
	const vec4 v42=vec4(1.0/255.0,1.0/255.0,1.0/255.0,1.0/255.0);

vec4 encodefloatrgba( float v ) {//range 0.0 - 5000.0
  if(v>5000.0){return vec4(1.0,1.0,1.0,1.0);}
  vec4 enc = fract(v41*v);//vec4(1.0, 255.0, 65025.0, 160581375.0) * (v/5000.0);
  //enc = fract(enc);
  return enc - enc.yzww * v42;//vec4(1.0/255.0,1.0/255.0,1.0/255.0,1.0/255.0);
  //return enc;
}
    void main(void) {
        if(ushadow==0){
		  float ty=vTextureCoord.y;
		  if(ty<4.9){gl_FragColor = ucolor;}
		  else if(ty<9.9){gl_FragColor=texture2D(uSampler,vec2(vTextureCoord.x,ty-5.0));
		       if(gl_FragColor.a<0.5){discard;}
		  }else if(ty<19.9){gl_FragColor = ucolor;
		       if(texture2D(uSampler,vec2(vTextureCoord.x,ty-10.0)).a<0.5){discard;}
		  }else if(ty<99.9){gl_FragColor=texture2D(uSampler,vec2(vTextureCoord.x,ty-20.0));//city
		       if(gl_FragColor.a<0.5){discard;}
		  }else{gl_FragColor=glFragColor;}
		  /*}else if(ty<109.9){gl_FragColor = vec4(1.0,1.0,1.0,1.0);//white
		  }else if(ty<119.9){gl_FragColor = vec4(1.0,0.3,0.0,1.0);//orange
		  }else if(ty<129.9){gl_FragColor = vec4(0.55,0.55,0.55,1.0);//gray
		  }else if(ty<139.9){gl_FragColor = vec4(0.0,0.7,0.0,1.0);//green
		  }else if(ty<149.9){gl_FragColor = vec4(0.1,0.1,0.8,1.0);//blue
		  }else if(ty<1999.9){gl_FragColor = vec4(1.0,0.0,0.0,1.0);//red
		  }else if(ty>19999.0){float ss=floor((ty-20000.0)/256.0);float r=floor(ss/(256.0));ss-=r*256.0;float g=floor(ss/16.0);
		                                float b=floor(ss-16.0*g)/15.0;//hextodec
		                                r/=15.0;g/=15.0;
									     gl_FragColor=vec4(r,g,b,1.0);}*/
		  }
        else if(texture2D(uSampler,vTextureCoord).a<0.5){discard;}
		else{gl_FragColor=encodefloatrgba(z0);}
	}
</script>
<script id="shader-vl" type="x-shader/x-vertex">
    precision lowp float;
    attribute vec4 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float ucos1;
	uniform float usin1;
	uniform int ushadow2;
	
	varying vec2 vTextureCoord;
	varying float z0;
	varying vec4 glFragColor;

    void main(void) {
	    float x=aVertexPosition.x;
	    float y=aVertexPosition.y;
	    float z=aVertexPosition.z;
	    float r=aVertexPosition.a;
		vTextureCoord=aTextureCoord*0.5;
		float dx=0.2499;
		if(r>999.0){r-=1000.0;vTextureCoord.y=aTextureCoord.y;dx=0.99;}//bridgecolour
		else if(r>749.0){r-=750.0;vTextureCoord.x+=0.625;}//railstation
		else if(r>699.0){r-=700.0;vTextureCoord.x+=0.5;}//hospital
		else if(r>649.0){r-=650.0;vTextureCoord.x+=0.375;vTextureCoord.y+=0.5;}//turn right
		else if(r>599.0){r-=600.0;vTextureCoord.x+=0.375;}//turn left
		else if(r>499.0){r-=500.0;vTextureCoord.x+=0.25;vTextureCoord.y+=0.5;}//parking
		else if(r>399.0){r-=400.0;vTextureCoord.x+=0.25;}//highway
		else if(r>299.0){r-=300.0;vTextureCoord.x+=0.5;vTextureCoord.y+=0.5;}//station
		else if(r>199.0){r-=200.0;vTextureCoord.x+=0.125;vTextureCoord.y+=0.5;}//oneway2
		else if(r>99.0){r-=100.0;vTextureCoord.y+=0.5;}//oneway
		else if(r>20.0){r-=20.0;vTextureCoord=aTextureCoord;dx=0.99;}//city
		else if(r>9.0){r-=10.0;}//stop
		else{vTextureCoord.x+=0.125;}//cross
		if(aTextureCoord.x<0.01){x-=r*usin1;y+=r*ucos1;}
		if(aTextureCoord.x>dx){x+=r*usin1;y-=r*ucos1;}
        //gl_Position = uPMatrix*(uMVMatrix*vec4(x,y,z, 1.0));
        //gl_Position = (uMVMatrix*vec4(x,y,z, 1.0));
        vec4 xyz= uMVMatrix * vec4(x,y,z, 1.0);
		//if(ushadow2==1){xyz.y *=4.03;}
		//float dxy=0.25*abs(xyz.y);//max(abs(xyz.x),abs(xyz.y));
		if(ushadow2==1){
		if(xyz.y>14.0){xyz.y=xyz.y*0.5+7.0;}
		else if(xyz.y<-14.0){xyz.y=xyz.y*0.5-7.0;}
		}
		gl_Position = uPMatrix *xyz;
		z0=-xyz.z-0.1;//-0.35;
		if(z0<1.0){z0=0.0;}
		//z=floor(z*20.0)/20.0;
		 z0=z0*z0/5000.0;
		 float ty=vTextureCoord.y;
		  if(ty<109.9){glFragColor = vec4(1.0,1.0,1.0,1.0);//white
		  }else if(ty<119.9){glFragColor = vec4(1.0,0.3,0.0,1.0);//orange
		  }else if(ty<129.9){glFragColor = vec4(0.55,0.55,0.55,1.0);//gray
		  }else if(ty<139.9){glFragColor = vec4(0.0,0.7,0.0,1.0);//green
		  }else if(ty<149.9){glFragColor = vec4(0.1,0.1,0.8,1.0);//blue
		  }else if(ty<1999.9){glFragColor = vec4(1.0,0.0,0.0,1.0);//red
		  }else if(ty>19999.0){float ss=floor((ty-20000.0)/256.0);r=floor(ss/(256.0));ss-=r*256.0;float g=floor(ss/16.0);
		                                float b=floor(ss-16.0*g)/15.0;//hextodec
		                                r/=15.0;g/=15.0;
									     glFragColor=vec4(r,g,b,1.0);}
		  else{glFragColor = vec4(1.0,1.0,1.0,1.0);}
		}
</script>
<script id="shader-fs" type="x-shader/x-fragment">
    precision lowp float;
	//precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
    varying vec2 vTextureCoord6;
	varying float color0;
    varying float z;
	varying vec3 xyz0;
	varying vec3 rgb;
	
    uniform sampler2D uSampler;
	uniform vec4 ucolor;
    uniform sampler2D uSampler2;
    uniform sampler2D uSampler3;
    uniform sampler2D uSampler6;
	uniform float fog;
	uniform float tlight;
	const vec4 v43=vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0)*5000.0;

float decodefloatrgba( vec4 rgba ) {
  return dot( rgba, v43);//vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) )*5000.0;
}
float color;
/*void setlight(){
	if(xyz0.y<0.065 && ulight==1){
	 float z0=-xyz0.z-0.02;
	 if(abs(xyz0.x-0.01-0.2*z0)<z0*0.6){
		color+=1.0/(0.44+z0*z0);
			 }
	}	
}*/
    void main(void) {
	if(abs(color0)<0.001){discard;}else{
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		float s=vTextureCoord.y;
		if(ucolor.a>0.001){
	     if(gl_FragColor.a<0.5){discard;}else{
		   /*if(s<-100.0){r=0.0;g=0.0;b=0.7;}
		   else if(s>19999.0){float ss=floor((s-20000.0)/256.0);r=floor(ss/(256.0));ss-=r*256.0;g=floor(ss/16.0);
		                                b=floor(ss-16.0*g)/15.0;//hextodec
		                                r/=15.0;g/=15.0;
									    }
		   else if(s<400.0){r=1.0;g=1.0;b=1.0;}
		   else if(s<800.0){r=0.7;g=0.7;b=0.7;}
		   else if(s<1200.0){r=0.4;g=0.4;b=0.4;}
		   else if(s<1600.0){r=1.0;g=0.4;b=0.4;}
		   else if(s<2000.0){r=0.7;g=0.7;b=1.5;}
		   else if(s<2400.0){r=0.5;g=0.5;b=1.0;}
		   else if(s<2800.0){r=1.0;g=1.0;b=0.5;}
		   else if(s<3200.0){r=0.7;g=1.5;b=0.7;}
		   else if(s<3600.0){r=0.5;g=1.0;b=0.5;}
		   else if(s<4000.0){r=0.3;g=0.7;b=0.5;}
		   else {r=1.7;g=1.7;b=0.0;}//fuel
		   //else if(s<14000.0){r=1.7;g=1.7;b=0.0;}//fuel
		   //else{r=0.3;g=0.7;b=0.5;}
		   */
		   //r=1.0;g=1.0;b=1.0;
		   //gl_FragColor.a*=ucolor.a;
		   //gl_FragColor.r*=ucolor.r*r;
		   //gl_FragColor.g*=ucolor.g*g;
		   //gl_FragColor.b*=ucolor.b*b;
		   color=color0+0.1;
		   if(color0<0.0){color=-color0;}
		   else{
		    //vec4 xyz=texture2D(uSampler2, vTextureCoord2);
		    float z0=decodefloatrgba(texture2D(uSampler2, vTextureCoord2));
		    if(z>(z0+0.01)){color=0.4;}//min(color,0.4);}//shadow
			else{z0=decodefloatrgba(texture2D(uSampler3, vTextureCoord2*2.0-0.5));
			     if(z>(z0+0.01)){color=0.4;}}//min(color,0.4);}}
            //setlight();
			}
		 //int test=0;
		 //if(ucolor.a<9.0){
		   gl_FragColor.a*=ucolor.a;
		 /*}else if(ucolor.a>20.0){
		    if(gl_FragColor.r>0.9){discard;}
			else{
		    gl_FragColor.a*=ucolor.a-20.0;
			}
		 }else if(ucolor.a>9.0){
		    gl_FragColor.a*=ucolor.a-10.0;
			//gl_FragColor.rgb*=color;
			test=1;
		 }*/
		 //if(gl_FragColor.r<0.99){
	     float cloudshadow=max(0.6,min(1.0,2.2-texture2D(uSampler6, vTextureCoord6).a*2.0));
	     color=max(0.4,color*cloudshadow);
		 gl_FragColor.rgb*=color*ucolor.rgb;
		 gl_FragColor.rgb*=rgb;//vec3(r,g,b);
		 /*if(test==0){
		   gl_FragColor.r*=ucolor.r*r;
		   gl_FragColor.g*=ucolor.g*g;
		   gl_FragColor.b*=ucolor.b*b;
		 }*/
		 }}//}
		 float sz=-xyz0.z;//,fog=0.45;
		 gl_FragColor.rgb*=7.22/(7.22+sz*tlight);
 		 gl_FragColor.rgb+=fog*sz/(sz+12.0);
     }		 
    }
</script>
<script id="shader-fsa" type="x-shader/x-fragment">
    precision lowp float;
	//precision highp float;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
    varying vec2 vTextureCoord6;
	varying float color0;
    varying float z;
	varying vec3 xyz0;
	varying vec3 rgb;
	
    uniform sampler2D uSampler;
	uniform vec4 ucolor;
    //uniform sampler2D uSampler2;
    //uniform sampler2D uSampler3;
	const vec4 v43=vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0)*5000.0;

float decodefloatrgba( vec4 rgba ) {
  return dot( rgba, v43);//vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) )*5000.0;
}
float r,g,b,color;
/*void setlight(){
	if(xyz0.y<0.065 && ulight==1){
	 float z0=-xyz0.z-0.02;
	 if(abs(xyz0.x-0.01-0.2*z0)<z0*0.6){
		color+=1.0/(0.44+z0*z0);
			 }
	}	
}*/
    void main(void) {
	if(abs(color0)<0.001){discard;}else{
	  if(ucolor.a<-0.01){gl_FragColor=vec4(ucolor.rgb,1.0);}
	  else{
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		//float s=vTextureCoord.y;
		if(ucolor.a>0.001){
	     if(gl_FragColor.a<0.5){discard;}else{	   
		   //r=1.0;g=1.0;b=1.0;
		   //gl_FragColor.a*=ucolor.a;
		   //gl_FragColor.r*=ucolor.r*r;
		   //gl_FragColor.g*=ucolor.g*g;
		   //gl_FragColor.b*=ucolor.b*b;
		   color=color0+0.1;
		   if(color0<0.0){color=-color0;}
		   else{
		    //vec4 xyz=texture2D(uSampler2, vTextureCoord2);
		    /*float z0=decodefloatrgba(texture2D(uSampler2, vTextureCoord2));
		    if(z>(z0+0.01)){color=min(color,0.44);}//shadow
 			else{z0=decodefloatrgba(texture2D(uSampler3, vTextureCoord2));
			     if(z>(z0+0.01)){color=min(color,0.44);}} */
           //setlight();
			}
		 int test=0;
		 if(ucolor.a<9.0){
		   gl_FragColor.a*=ucolor.a;
		 /*}else if(ucolor.a>20.0){
		    if(gl_FragColor.r>0.9){discard;}
			else{
		    gl_FragColor.a*=ucolor.a-20.0;
			}*/
		 }else{
		    gl_FragColor.a*=ucolor.a-10.0;
			//gl_FragColor.rgb*=color;
			test=1;
		 }
		 gl_FragColor.rgb*=color;
		 if(test==0){
		   //gl_FragColor.r*=ucolor.r*r;
		   //gl_FragColor.g*=ucolor.g*g;
		   //gl_FragColor.b*=ucolor.b*b;
		   gl_FragColor.rgb*=ucolor.rgb;
		 }
		 }}else{
           if(gl_FragColor.a<0.5){discard;}else{
		    if(gl_FragColor.r>0.9){gl_FragColor*=1.6;}
		    else if(gl_FragColor.g>gl_FragColor.r*1.07){
			  gl_FragColor.rgb=gl_FragColor.g*ucolor.rgb;}
		   }
		 }
		 }
      }		 
    }
</script>
<script id="shader-fssun" type="x-shader/x-fragment">
    precision lowp float;
	//precision highp float;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
    varying vec2 vTextureCoord6;
	varying float color0;
    varying float z;
	varying vec3 xyz0;
	varying vec3 rgb;
	
    uniform sampler2D uSampler;
	uniform vec4 ucolor;
    //uniform sampler2D uSampler2;

    void main(void) {
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		float s=vTextureCoord.y;
	    float t=vTextureCoord.x;
		float color=-color0;
	    gl_FragColor.a*=max(0.0,1.0-(s*s+t*t));
		gl_FragColor.a*=ucolor.a;
		gl_FragColor.r*=ucolor.r*color;
		gl_FragColor.g*=ucolor.g*color;
		gl_FragColor.b*=ucolor.b*color;		 
    }
</script>
<script id="shader-vs" type="x-shader/x-vertex">
    precision lowp float;
	//precision mediump float;
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;
    attribute vec3 aVertexNormal;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    uniform mat4 uMVMatrix2;
    uniform mat4 uPMatrix2;
	uniform vec3 uSunpos;
	uniform float dmax;
	uniform float sunco1,sunsi1,cloudx,cloudy;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
    varying vec2 vTextureCoord6;
	varying float color0;
	varying float z;
	varying vec3 xyz0;
	varying vec3 rgb;

    void main(void) {
        //gl_Position = uPMatrix * (uMVMatrix * vec4(aVertexPosition, 1.0));
        vec4 xyzt= (uMVMatrix * vec4(aVertexPosition, 1.0));
        xyz0=xyzt.xyz;
		gl_Position = (uPMatrix * xyzt);
        vTextureCoord = aTextureCoord;
		//if(aVertexPosition.z<-0.3){vTextureCoord.s-=1000.0;}
		if(gl_Position.z>dmax ||
		   (dmax<999.0 && gl_Position.z<(abs(gl_Position.x)-4.7))){color0=0.0;}
		else{color0=min(1.15,0.75+abs(gl_Position.y*0.3));
		vec3 normal=aVertexNormal;
		float tsun=(abs(uSunpos.x)+abs(uSunpos.y)+abs(uSunpos.z));
	if(tsun<0.1){
	    color0=-color0;
	}else{
	    if(tsun>2.0){
		  vec3 lightdir=normalize(uSunpos-aVertexPosition);
		  color0*=0.4+abs(dot(lightdir,normal))*0.6;
		}
		vec4 xyz=uMVMatrix2*vec4(aVertexPosition, 1.0);
		//xyz.y *=4.03;
		//float dxy=0.25*abs(xyz.y);//max(abs(xyz.x),abs(xyz.y));
		if(xyz.y>14.0){xyz.y=xyz.y*0.5+7.0;}
		else if(xyz.y<-14.0){xyz.y=xyz.y*0.5-7.0;}
		vec4 pxyz=uPMatrix2*xyz;
		z=-xyz.z;
		if(z<1.0){z=0.0;}
		//z=floor(z*20.0)/20.0;
		z=z*z/5000.0;
 		float px=pxyz.x*0.5+0.5; 
		float py=pxyz.y*0.5+0.5; 
		vTextureCoord2.x=px; 
		vTextureCoord2.y=py;
		if(px<0.002 || px>0.998 || py<0.002 || py>0.998){z=0.0;} 		
		//gl_Position=xyz;
        float x=aVertexPosition.x-cloudx;
        float y=aVertexPosition.y-cloudy;		
		vTextureCoord6.x=0.5-(x*sunsi1-y*sunco1)*0.5*300.0/400.0;
		vTextureCoord6.y=0.5-(x*sunco1+y*sunsi1)*0.5*300.0/400.0;
		}
		}
	   float s=vTextureCoord.y,r,g,b;
		   if(s<-100.0){r=0.0;g=0.0;b=0.7;}
		   else if(s>19999.0){float ss=floor((s-20000.0)/256.0);r=floor(ss/(256.0));ss-=r*256.0;g=floor(ss/16.0);
		                                b=floor(ss-16.0*g)/15.0;//hextodec
		                                r/=15.0;g/=15.0;
									    }
		   else if(s<400.0){r=1.0;g=1.0;b=1.0;}
		   else if(s<800.0){r=0.7;g=0.7;b=0.7;}
		   else if(s<1200.0){r=0.4;g=0.4;b=0.4;}
		   else if(s<1600.0){r=1.0;g=0.59;b=0.57;}//hospital r=1.0;g=0.4;b=0.4;
		   else if(s<2000.0){r=0.7;g=0.7;b=1.5;} 
		   else if(s<2400.0){r=0.5;g=0.5;b=1.0;}
		   else if(s<2800.0){r=1.0;g=1.0;b=0.5;}
		   else if(s<3200.0){r=0.7;g=1.5;b=0.7;}
		   else if(s<3600.0){r=0.5;g=1.0;b=0.5;}
		   else if(s<4000.0){r=0.3;g=0.7;b=0.5;}
		   else {r=0.97;g=0.97;b=0.62;}//r=1.7;g=1.7;b=0.0;fuel official
	   rgb=vec3(r,g,b);	   
    }
</script>
<script id="shader-fssol" type="x-shader/x-fragment">
    precision lowp float;
	//precision highp float;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
    //varying vec2 vTextureCoord3;
    varying vec2 vTextureCoord4;
    varying vec2 vTextureCoord6;
	varying float color;
	varying float color3;
	varying float z;
	varying float xyz0z;

    uniform sampler2D uSampler;
    uniform sampler2D uSampler2;
    uniform sampler2D uSampler3;
    uniform sampler2D uSampler4;
    uniform sampler2D uSampler5;
    uniform sampler2D uSampler6;
	uniform float ksea;
	uniform float fog;
	uniform int tshadow;
	uniform float tlight;
	const vec3 v31=vec3(5000.0, 5000.0/255.0, 5000.0/65025.0);

/*float decodefloatrgba( vec4 rgba ) {
  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) )*5000.0;
}*/
float decodefloatrgb( vec3 rgb ) {
  return dot( rgb, v31);//vec3(5000.0, 5000.0/255.0, 5000.0/65025.0) );
}
    void main(void) {
	  gl_FragColor = texture2D(uSampler, vTextureCoord);
	 if(ksea>=0.0){ 
	  if(color3<0.1){
	   if(color>0.1){
	  //float color2=color;
	  //if(vTextureCoord.y<-1.0){color2*=0.45;}
	   vec4 fcolor2=texture2D(uSampler2, vTextureCoord2);
	   //gl_FragColor.rgb+=color*(gl_FragColor.rgb*(0.35+1.65*fcolor2.rgb)+0.1*fcolor2.rgb-gl_FragColor.rgb);	 
	   //gl_FragColor.rgb+=color2*(gl_FragColor.rgb*(0.30+1.65*fcolor2.rgb)+0.1*fcolor2.rgb-gl_FragColor.rgb);	 
	   gl_FragColor.rgb=gl_FragColor.rgb*(vec3(0.7,0.4,0.7)+1.12*fcolor2.rgb);	 
		 //gl_FragColor.rgb=fcolor2.rgb;
        }		 
      }else if(color3>0.2){
      //}else{
	   vec4 fcolor3=texture2D(uSampler3, 1.3*(vTextureCoord2*30.0/130.0+ksea*(vec2(0.5,0.5))));
	   gl_FragColor.rgb+=color3*(1.0-gl_FragColor.r)*(gl_FragColor.rgb*(0.30+1.65*fcolor3.rgb)+0.1*fcolor3.rgb-gl_FragColor.rgb);
      }
     }	  
     //vec4 xyz=texture2D(uSampler4, vTextureCoord4);
	 //float z0=decodefloatrgba(texture2D(uSampler4, vTextureCoord4));
    if(tshadow==1){
	 float light=1.10;
	 if(z>(decodefloatrgb(texture2D(uSampler4, vTextureCoord4).rgb)+0.01)){light=0.44;}//shadow
	 else{//z0=decodefloatrgba(texture2D(uSampler5, vTextureCoord4));
	      if(z>(decodefloatrgb(texture2D(uSampler5, vTextureCoord4*2.0-0.5).rgb)+0.01)){light=0.44;}}
	/*if(xyz0.y<0.065 && ulight==1){
	 z0=-xyz0.z-0.02;
	 if(abs(xyz0.x-0.01-0.2*z0)<z0*0.6){
		light+=1.0/(0.44+z0*z0);
			 }
	}*/		 
	float cloudshadow=max(0.6,min(1.0,2.2-texture2D(uSampler6, vTextureCoord6).a*2.0));
	light=max(0.44,light*cloudshadow);
	gl_FragColor.rgb*=light;		 
    }
	float sz=-xyz0z;//,fog=0.45;
	if(sz>120.0 && color<0.001){gl_FragColor.rg*=max(0.35,120.0/sz);}
	gl_FragColor.rgb*=7.22/(7.22+sz*tlight);
 	gl_FragColor.rgb+=fog*sz/(sz+12.0);
	}
</script>
<script id="shader-vssol" type="x-shader/x-vertex">
    precision lowp float;
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
    uniform mat4 uMVMatrix2;
    uniform mat4 uPMatrix2;
	uniform float sunco1,sunsi1,cloudx;
	uniform float mx,my,wavez,time,cos1,sin1,wavetx,wavety;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
    //varying vec2 vTextureCoord3;
    varying vec2 vTextureCoord4;
    varying vec2 vTextureCoord6;
	varying float color;
	varying float color3;
	varying float z;
	varying float xyz0z;

    void main(void) {
	    float x0=aVertexPosition.x;
		float y0=aVertexPosition.y;
		float zz=aVertexPosition.z;
		float d=999.0;
		if(zz<-0.04){
	     float xx=x0-mx;
		 float yy=y0-my;
		 d=max(abs(xx),abs(yy))*240.0;
		 if(d<30.0){
		   float sc=(d+10.0)/(d+20.0);
		   float xxx=xx*cos1+yy*sin1;
		   float yyy=-xx*sin1+yy*cos1;
		   zz+=((zz+0.04)/(zz-0.1))*(-0.75+cos(xxx*240.0*129.0+time*0.0009)*cos(yyy*240.0*129.0-time*0.0010))*wavez;
           x0=mx+sc*xx;y0=my+sc*yy;
        }}
		//gl_Position = uPMatrix * (uMVMatrix * vec4(aVertexPosition, 1.0));
        vec4 xyzt= (uMVMatrix * vec4(x0,y0,zz, 1.0));
        xyz0z=xyzt.z;
		gl_Position = (uPMatrix * xyzt);
        vTextureCoord = aTextureCoord+vec2(0.007,-0.007);
		if(aVertexPosition.z<-0.025){//-0.01){
		     color=0.0;}
		else{color=1.0;}
	    if(aVertexPosition.z<-0.39 || vTextureCoord.y<-1.0){
		     color3=0.3;}
	    else if(aVertexPosition.z<0.039){
		     color3=0.15;}
		else{color3=0.0;}
		//vTextureCoord2.x=aVertexPosition.x*130.0/2.0;//25.0 /2.5;
		//vTextureCoord2.y=aVertexPosition.y*130.0/2.0;//25.0 /2.5;
		vTextureCoord2=aVertexPosition.xy*130.0/2.0;//25.0 /2.5;
		if(d<30.0){vTextureCoord2+=vec2(wavetx,wavety);}
		//vTextureCoord3.x=aVertexPosition.x*30.0;// /2.5;
		//vTextureCoord3.y=aVertexPosition.y*30.0;// /2.5;
		vec4 xyz=uMVMatrix2*vec4(aVertexPosition, 1.0);
		//xyz.y *=4.03;
		//float dxy=0.25*abs(xyz.y);//max(abs(xyz.x),abs(xyz.y));
		if(xyz.y>14.0){xyz.y=xyz.y*0.5+7.0;}
		else if(xyz.y<-14.0){xyz.y=xyz.y*0.5-7.0;}
		vec4 pxyz=uPMatrix2*xyz;
		z=-xyz.z;
		if(z<1.0 || d<30.0){z=0.0;}
		//z=floor(z*20.0)/20.0;
		z=z*z/5000.0;
 		float px=pxyz.x*0.5+0.5; 
		float py=pxyz.y*0.5+0.5; 
		vTextureCoord4.x=px; 
		vTextureCoord4.y=py;
        if(px<0.002 || px>0.998 || py<0.002 || py>0.998){z=0.0;} 		
		//gl_Position=xyz;
		//float distshadow=400.0;
        float x=aVertexPosition.x-cloudx;
        float y=aVertexPosition.y;		
		vTextureCoord6.x=0.5-(x*sunsi1-y*sunco1)*0.5*300.0/400.0;
		vTextureCoord6.y=0.5-(x*sunco1+y*sunsi1)*0.5*300.0/400.0;
    }
</script>
<script id="shader-fstree" type="x-shader/x-fragment">
    precision lowp float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float z0;
	varying vec3 xyz0;

    uniform sampler2D uSampler;
	uniform int ushadow;
	uniform float fog;
	uniform float tlight;
	const vec4 v41=vec4(1.0, 255.0, 65025.0, 160581375.0)/5000.0;
	const vec4 v42=vec4(1.0/255.0,1.0/255.0,1.0/255.0,1.0/255.0);

vec4 encodefloatrgba( float v ) {//range 0.0 - 5000.0
  if(v>5000.0){return vec4(1.0,1.0,1.0,1.0);}
  vec4 enc = fract(v41*v);//vec4(1.0, 255.0, 65025.0, 160581375.0) * (v/5000.0);
  //enc = fract(enc);
  return enc - enc.yzww * v42;//vec4(1.0/255.0,1.0/255.0,1.0/255.0,1.0/255.0);
  //return enc;
}

/*void setlight(){
	if(xyz0.y<0.065){
	 float z0=-xyz0.z-0.02;
	 if(abs(xyz0.x-0.01-0.2*z0)<z0*0.6){
		gl_FragColor.rgb*=1.0+0.8/(0.35+z0*z0);
			 }
	}	
}*/
    void main(void) {
	   if(vTextureCoord.x>-1.0){
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		if(gl_FragColor.r>0.7){discard;}
		else if(ushadow==1){
		 if(z0<1.0){discard;}
         else{
           gl_FragColor=encodefloatrgba(z0);
		 }		 		
		}
		/*else if(ulight==1){
		 setlight();
		}*/
		else{float sz=-xyz0.z;//,fog=0.45;
	         gl_FragColor.rgb*=7.22/(7.22+sz*tlight);
 		     gl_FragColor.rgb+=fog*sz/(sz+12.0);}
	   }else{discard;};	
    }
</script>
<script id="shader-vstree" type="x-shader/x-vertex">
    precision lowp float;
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float ucos1;
	uniform float usin1;
	uniform int ushadow2;

    varying vec2 vTextureCoord;
	varying float z0;
	varying vec3 xyz0;

    void main(void) {
	    float x=aVertexPosition.x;
	    float y=aVertexPosition.y;
	    float z=aVertexPosition.z;
		//if(z<0.15 || z>20.0){vTextureCoord.x=-2.0;
		float scale2=2.0;
		if(ushadow2>=10){scale2=float(ushadow2)/120.0;}
		if(z<-0.1){vTextureCoord.x=-2.0;
		  gl_Position = vec4(1.0,1.0,1.0, 1.0); 
		}else{
		if(int(mod(floor((z)*2000.0),20.0)+0.1)==1){
		 if(aTextureCoord.x<0.2){x-=usin1;y+=ucos1;z-=0.235*scale2;}//0.47;}
		 else if(aTextureCoord.x>0.8){x+=usin1*scale2;y-=ucos1*scale2;z-=0.235*scale2;}//0.47;}
		 else{z+=scale2;}
		}else{
		 if(aTextureCoord.x<0.2){x-=usin1;y+=ucos1;}
		 if(aTextureCoord.x>0.8){x+=usin1;y-=ucos1;}
        }
		//gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z, 1.0));
		//gl_Position = (uMVMatrix * vec4(x,y,z, 1.0));
        vec4 xyz= uMVMatrix * vec4(x,y,z, 1.0);
		//if(ushadow2==1){xyz.y *=4.03;}
		//float dxy=0.25*abs(xyz.y);//max(abs(xyz.x),abs(xyz.y));
		if(ushadow2==1){
		if(xyz.y>14.0){xyz.y=xyz.y*0.5+7.0;}
		else if(xyz.y<-14.0){xyz.y=xyz.y*0.5-7.0;}
		}
		gl_Position = uPMatrix *xyz;
		xyz0=xyz.xyz;
		z0=-xyz.z-0.1;//-0.35;
		if(z0<1.0){z0=0.0;}
		//z0=floor(z0*20.0)/20.0;
		z0=(z0*z0/5000.0);
        vTextureCoord = aTextureCoord;
		};
    }
</script>
<script id="vshader2d" type="x-shader/x-vertex">
    precision lowp float;
    attribute vec3 a_position;
    varying vec2 v_texcoord;
	uniform float u_texscalex,u_texscaley; 
	uniform float u_textdx,u_textdy;
    uniform float u_scalex,u_scaley;	
	uniform float u_dx,u_dy;

    void main() {
	  float x=u_dx+a_position.x*u_scalex*0.025*(1.0+abs(u_dx));
      float y=u_dy+a_position.y*u_scaley*0.025*(1.0+abs(u_dy));
	  gl_Position = vec4(x,y,a_position.z,1.0);
      v_texcoord.x = u_textdx+a_position.x*0.02*u_texscalex+0.5;
      v_texcoord.y = u_textdy+a_position.y*0.02*u_texscaley+0.5;
    }   
</script>
<script id="fshader2d" type="x-shader/x-fragment">
precision lowp float;
varying vec2 v_texcoord;
uniform sampler2D u_sampler;
uniform vec4 ucolor;
void main() {
    gl_FragColor = texture2D(u_sampler, v_texcoord);
		if(ucolor.a>0.001){
		 gl_FragColor.a+=ucolor.a;
		 gl_FragColor.r+=ucolor.r;
		 gl_FragColor.g+=ucolor.g;
		 gl_FragColor.b+=ucolor.b;
		} 		
}
</script>
<!--script src="https://chungkn1400.github.io/mysrtm/srtm/w20n90/lngW5latN45.js"></script-->
<script>
//alert(lngW5latN45);
var tcompile=0;tcompile=1;//
var folderdrive="https://b3d8783ddc02a86af1ce60266a06c20f1a961f99.googledrive.com/host/0B6GM9ay7ImZLOXpiUkx5bFhacXc/";
folderdrive="https://chungkn1400.github.io/mysrtm/";
//  https://chungkn1400.github.io/mysrtm/srtm/e20n40/lngE20latN0.js"
var windx=600,windy=400;
var windx0=600,windy0=400;
var cssscale=1/1,cssscaley=1/1;
var auxvar=null,auxvar2=null,auxvar3=null,auxtext="";
var test=0;
var http="http:";
if(document.location.href.indexOf("https")>=0){
   http="https:";}
//http="http:";
var overpass="//overpass.osm.rambler.ru/cgi/";
//overpass="//overpass-api.de/api/";
//overpass="//api.openstreetmap.fr/oapi/";
if(http=="https:"){overpass="//overpass-api.de/api/";}
var overpass1=overpass;
var overpass2="//overpass-api.de/api/";
//overpass2=overpass1;;
if(http=="https:"){overpass2="//overpass-api.de/api/";}
var ioverpass=0;
function changeioverpass(){
loadioverpass();
ioverpass+=1;if(ioverpass>3){ioverpass=0;}
saveioverpass();
suboverpass(0);
}
function suboverpass(tprompt){
var crlf=String.fromCharCode(13)+String.fromCharCode(10);
var overpass01="//overpass.osm.rambler.ru/cgi/";
var overpass02="//overpass-api.de/api/";
var overpass03="//api.openstreetmap.fr/oapi/";
var msg="0 => 1+2"+crlf;
msg+="1 => "+overpass01+crlf;
msg+="2 => "+overpass02+crlf;
msg+="3 => "+overpass03+crlf+crlf;
loadioverpass(); 
if(tprompt==1){
 var s=prompt("osm server enter a number"+crlf+crlf+msg,ioverpass);
 if(s!=null){
  s=Math.max(0,Math.min(3,parseInt(s)));
  ioverpass=s;
  saveioverpass();
 }}
  if(ioverpass==0){overpass1=overpass01;overpass2=overpass02;}
  else if(ioverpass==1){overpass1=overpass01;overpass2=overpass01;}
  else if(ioverpass==2){overpass1=overpass02;overpass2=overpass02;}
  else if(ioverpass==3){overpass1=overpass03;overpass2=overpass03;}
  else{overpass1=overpass02;overpass2=overpass02;}
}
function loadioverpass(){
if(localStorage){var aux=localStorage.getItem("json_osm_chung_ioverpass");
                 if(aux){ioverpass=parseInt(aux);}}
}
function saveioverpass(){
if(localStorage){localStorage.setItem("json_osm_chung_ioverpass",ioverpass);}
}
suboverpass(0);
var toverpass=0;
var url=http+overpass+"interpreter?data=[out:json];way[highway=motorway]%2850.746%2C7.154%2C50.78%2C7.27%29%3Bout%20skel%203%3B";
//url=http+"//overpass-api.de/api/xapi?map?bbox=7.012854,51.450317,7.016477,51.452105";
//url=http+"//overpass-api.de/api/interpreter?data=node[name=\"Gielgen\"];out;";
function submsg(text){
 document.getElementById("msg").value=text;
}
/*var head0 = document.getElementsByTagName('head')[0];
function addjavascripttext(jstext){
submsg("addjavatext("+jstext+")");
var js = document.createElement("script");
js.type = "text/javascript";
if(tcompile==1){
 js.text = compile(document.getElementById(jstext).text);
}else{
 js.text = document.getElementById(jstext).text;
}
js.async=0;
head0.appendChild(js);
}
function addmain(){   
   addjavascripttext("main0");
}
setTimeout("addmain();",500);
/script
script type="text" id="main0"
*/
var wayjson,nodejson,ways=[],waynodes,nodes=[],waytype,wayname,nnode=0;
var latnodes=[],lonnodes=[],layernode=[];
var dlat=0.005,dlon=0.008;
var lat=48.765,lng=2.20;
lat=48.82612529;lng=2.35705595;
lat=49.36198047;lng=0.07262960;
var lat1=lat-dlat/2,lon1=lng-dlon/2;
var lat2=lat+dlat/2,lon2=lng+dlon/2;
var wayurl=http+overpass+"interpreter?data=[out:json];way[highway=motorway]%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20skel%20999%3B";
var nodeurl=http+overpass+"interpreter?data=[out:json];%28node%28371597318%29;node%28371597317%29%29%3Bout%20skel%209%3B";
wayurl=http+overpass+"interpreter?data=[out:json];way%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20skel%20999%3B";
wayurl=http+overpass+"interpreter?data=[out:json];way%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%2099%3B";
//wayurl=http+overpass+"interpreter?data=[out:json];way[highway~'motorway|trunk|primary']%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20skel%20999%3B";
//wayurl=http+overpass+"interpreter?data=[out:json];way[highway~'motorway|trunk']%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20skel%20999%3B";
//wayurl=http+overpass+"interpreter?data=[out:json];way[highway=motorway]%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20skel%20999%3B";
nodeurl=http+overpass+"interpreter?data=[out:json];node%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20skel%209999%3B";
var nodekey,nodekey2,nodekey3,nkeymax=450;
//nodeurl=http+overpass+"interpreter?data=[out:json];%28"+nodekey+"%29%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20skel%209999%3B";
var iiways=0,iways=[];
iways[0]=[];iways[1]=[];iways[2]=[];iways[3]=[];iways[4]=[];iways[5]=[];iways[6]=[];
var iwaylat=[],iwaylng=[];for(var i=0;i<=6;i++){iwaylat[i]=91;iwaylng[i]=0;};
var iwaydlat=[],iwaydlng=[];for(var i=0;i<=6;i++){iwaydlat[i]=0;iwaydlng[i]=0;};
var t100=50;
function waycallback(r){//alert(r);
  //msgload("");
  wayjson=JSON.parse(r);
  var msg="",ntower=0;
  nnode=0;
  ways=[];
  //if(tilat==1 || tinit<2){iiways+=1};if(iiways>4){iiways=0;}
  iiways=0;
  var latxx0=latx+sin1*dxmax/scale;
  var lngxx0=lngx+cos1*dxmax*klon/scale;
  var dist0=0,dist2=2.5*2.5*Math.max(200*200,5*dxmax*5*dxmax);
  for(var i=0;i<=4;i++){var dx=Math.abs(iwaylat[i]-latxx0)*scale*dlat/(dlat/2+iwaydlat[i]);
                        var dy=(Math.abs(iwaylng[i]-lngxx0)/klon)*scale*dlon/(dlon/2+iwaydlng[i]);
                        var dist=dx*dx+dy*dy;
						if(dist>dist2 && iwaylat[i]<90){
						   iwaylat[i]=91;iwaydlat[i]=0;iways[i]=[];inodes[i]=[];}
                        if(dist0<dist){dist0=dist;iiways=i;}}
  iwaylat[iiways]=ilat;iwaylng[iiways]=ilng;
  iwaydlat[iiways]=dlat;iwaydlng[iiways]=dlon;
  if(wayjson.elements){iways[iiways]=wayjson.elements;}
  var w=0,j=0,j0=0;
  ways=iways[w];
  for(var p=0;p<4;p++){
   j=ways.length;
   j0=j;
   w+=1;if(w>4){w=0;}
   for(var i=0;i<iways[w].length;i++){
      var test=0,id=iways[w][i].id;for(var k=0;k<j0;k++){if(ways[k].id==id){test=1;break;};}
	  if(test==0){ways[j]=iways[w][i];j+=1;}
   }
  }
  msg+="len="+ways.length;
  if(ways.length>0){
  for(var i=0;i<ways.length;i++){
   //var way=(ways[i]);
   /*msg+="/ "+way.type+" id="+way.id+" "
   waytype="none";
   if(way.tags){if(way.tags.highway){
      waytype=way.tags.highway;}}
   msg+=waytype;*/	  
   /*for(var j=0;j<way.nodes.length;j++){
      //if(i<2){msg+="/"+way.nodes[j];};
	  nnode+=1;
	  }*/
   //if(way.tags){if(way.tags.building){ntower+=1;}}
   if(ways[i].nodes){nnode+=ways[i].nodes.length;}
   }}
  //alert("nnode="+nnode+" "+msg);
  dtweb=timer()-dtweb;
  setTimeout("getnodes();",t300+t100);
  //if(nnode<7000){setTimeout("getways2();",20);}
  //else{ways2=[];waylat2=lat;waylon2=lng;setTimeout("getnodes();",t300*2);}
}
/*var wayjson2,ways2=[],nnode2=0;
function waycallback2(r){//alert(r);
  //msgload("ok");
  wayjson2=JSON.parse(r);
  var msg="",ntest=0;
  nnode2=0;
  ways2=[];
  if(wayjson2.elements){ways2=wayjson2.elements;}
  //msg+="len="+ways2.length;
  //if(ways2.length>0){
  //for(var i=0;i<ways2.length;i++){
   //var way=(ways[i]);
   /*msg+="/ "+way.type+" id="+way.id+" "
   waytype="none";
   if(way.tags){if(way.tags.highway){
      waytype=way.tags.highway;}}
   msg+=waytype;*/	  
   /*for(var j=0;j<way.nodes.length;j++){
      //if(i<2){msg+="/"+way.nodes[j];};
	  nnode+=1;
	  }
   //if(ways2[i].nodes){nnode2+=ways2[i].nodes.length;}
   //}}
  //alert("nnode2="+nnode2+" "+msg);
  //alert("ways2="+ways2.length)
  setTimeout("getnodes();",t300);
}*/
var nodesignal=[];
var iinodes=0,inodes=[];
inodes[0]=[];inodes[1]=[];inodes[2]=[];inodes[3]=[];inodes[4]=[];inodes[5]=[];inodes[6]=[];
function nodecallback(r){//alert(r);
  //msgload("");
  nodejson=JSON.parse(r);
  var msg="";
  nodes=[];
  iinodes=iiways;//iinodes+=1;if(iinodes>2){iinodes=0;}
  //inodes[iinodes]=[];
  if(nodejson.elements){inodes[iinodes]=nodejson.elements;}
  var w=0,j=0;
  nodes=inodes[w];
  for(var p=0;p<4;p++){
   j=nodes.length;
   w+=1;if(w>4){w=0;}
   for(var i=0;i<inodes[w].length;i++){nodes[j+i]=inodes[w][i];}
  }
  //msg+="len="+nodes.length;
  if(resetnode==1){latnodes=[];lonnodes=[];
                   nodesignal=[];}
  if(nodes){
  for(var i=0;i<nodes.length;i++){
     /*if(i<5){
	  msg+="/ nodeid="+nodes[i].id;
	  msg+=" lat="+nodes[i].lat;
	  msg+=" lon="+nodes[i].lon;
	  }*/
	 var inode=nodes[i].id; 
	 latnodes[inode]=nodes[i].lat;
     lonnodes[inode]=nodes[i].lon;
	 }}
  //alert(msg+nodes.length);
  
  tdraw=1;//loading=1.5;//drawgl(0);;	 
}
var nmarket=0,marketlon=[],marketlat=[];
var nodejson2,nodes2=[];
function nodecallback2(r){//alert(r);
  //msgload("");
  nodejson2=JSON.parse(r);
  //var msg="";
  nodes2=[];nstation=0;nhospital=0;nrailstation=0;nmarket=0;
  if(nodejson2.elements){nodes2=nodejson2.elements;}
  //msg+="len2="+nodes2.length;
  for(var i=0;i<nodes2.length;i++){
     /*if(i<5){
	  msg+="/ nodeid2="+nodes2[i].id;
	  msg+=" lat="+nodes2[i].lat;
	  msg+=" lon="+nodes2[i].lon;
	  }*/
	 var inode=nodes2[i].id; 
	 latnodes[inode]=nodes2[i].lat;
     lonnodes[inode]=nodes2[i].lon;
     if(nodes2[i].tags){
	  if(nodes2[i].tags.amenity){
	   if(nodes2[i].tags.amenity=="fuel"){
		 stationlat[nstation]=nodes2[i].lat;
		 stationlon[nstation]=nodes2[i].lon;
		 nstation+=1;
		 }
	   if(nodes2[i].tags.amenity=="hospital"){
		 hospitallat[nhospital]=nodes2[i].lat;
		 hospitallon[nhospital]=nodes2[i].lon;
		 nhospital+=1;
		 }
		 }
	  if(nodes2[i].tags.railway){
	   if(nodes2[i].tags.railway=="station"){
		 railstationlat[nrailstation]=nodes2[i].lat;
		 railstationlon[nrailstation]=nodes2[i].lon;
		 nrailstation+=1;
		 }}
	  if(nodes2[i].tags.shop){
	   if(nodes2[i].tags.shop=="mall" || nodes2[i].tags.shop=="supermarket"){
		 marketlat[nmarket]=nodes2[i].lat;
		 marketlon[nmarket]=nodes2[i].lon;
		 nmarket+=1;
		 }}
     }
	 }
  //alert(msg);
  if(inode3>0 && loading==1){setTimeout('getnodes3();',t100);}
  else{tdraw=2;loading=1.75;}//drawgl(0);;	 
}
var nodejson3,nodes3=[];
function nodecallback3(r){//alert(r);
  //msgload("");
  nodejson3=JSON.parse(r);
  //var msg="";
  nodes3=[];
  if(nodejson3.elements){nodes3=nodejson3.elements;}
  //msg+="len3="+nodes3.length;
  for(var i=0;i<nodes3.length;i++){
     /*if(i<5){
	  msg+="/ nodeid3="+nodes3[i].id;
	  msg+=" lat="+nodes3[i].lat;
	  msg+=" lon="+nodes3[i].lon;
	  }*/
	 var inode=nodes3[i].id; 
	 latnodes[inode]=nodes3[i].lat;
     lonnodes[inode]=nodes3[i].lon;
	 }
  //alert(msg);
  
  if(inode31>0 && loading==1){setTimeout('getnodes31();',t100);}
  else{tdraw=2;loading=1.75;}//drawgl(0);;	 
  //tdraw=2;loading=1.75;//drawgl(0);;	 
}
var nodejson31,nodes31=[];
function nodecallback31(r){//alert(r);
  //msgload("");
  nodejson31=JSON.parse(r);
  //var msg="";
  nodes31=[];
  if(nodejson31.elements){nodes31=nodejson31.elements;}
  //msg+="len31="+nodes31.length;
  for(var i=0;i<nodes31.length;i++){
     /*if(i<5){
	  msg+="/ nodeid31="+nodes31[i].id;
	  msg+=" lat="+nodes31[i].lat;
	  msg+=" lon="+nodes31[i].lon;
	  }*/
	 var inode=nodes31[i].id; 
	 latnodes[inode]=nodes31[i].lat;
     lonnodes[inode]=nodes31[i].lon;
	 }
  //alert(msg);
  
  if(loading==1){tdraw=2;loading=1.75;}//drawgl(0);;	 
}
var nodejson4,nodes4=[];
function nodecallback4(r){//alert(r);
  nodejson4=JSON.parse(r);
  var msg="",nlayer=0;
  nodes4=[];layernode=[];
  if(nodejson4.elements){nodes4=nodejson4.elements;}
  msg+="len4="+nodes4.length;
  ntown=0;
  for(var i=0;i<nodes4.length;i++){
     /*if(i<5){
	  msg+="/ nodeid4="+nodes4[i].id;
	  msg+=" lat="+nodes4[i].lat;
	  msg+=" lon="+nodes4[i].lon;
	  }*/
	 if(nodes4[i].tags){
	  var country="";
	  if(nodes4[i].tags['is_in:country_code']){country=nodes4[i].tags['is_in:country_code']+':';}
	  else if(nodes4[i].tags.wikipedia){country=nodes4[i].tags.wikipedia;}
	  country=country.toUpperCase();
	  if(country.indexOf(countrycode+":")>=0){
	  ntown+=1;
	  //var inode=nodes4[i].id; 
	  townlat[ntown]=nodes4[i].lat;
      townlon[ntown]=nodes4[i].lon;
	  if(nodes4[i].tags['name:en']){townname[ntown]=nodes4[i].tags['name:en'];}
	  else if(nodes4[i].tags.name){townname[ntown]=nodes4[i].tags.name;}
	  else{townname[ntown]="city";}
	  if(nodes4[i].tags.capital){towncapital[ntown]=nodes4[i].tags.capital;}
	  else{towncapital[ntown]='99';}
	  }
	  if(nodes4[i].tags.layer){layernode[nodes4[i].id]=nodes4[i].tags.layer;nlayer+=1;}
	 }}
  //alert(msg+"/"+ntown+"/layer="+nlayer);
  if(Math.abs(loading-1.4)<0.001){setTimeout("loading=0;",t100);msgload("");}
  tupdatetown=2;
  
  //tdraw=2;loading=1.75;//drawgl(0);;	 
}
var humidity=50,temp=20,wind=3.6;
function weathercallback(r){//alert(r);
  var weatherjson=JSON.parse(r);
  var allclouds=weatherjson.clouds.all;//alert(allclouds);
  wclouds=allclouds;
  wind=weatherjson.wind.speed*3.6;//kmh alert(wind);
  humidity=weatherjson.main.humidity;//alert(humidity);
  temp=parseInt((weatherjson.main.temp-273)*10)/10;//alert(temp);
  fogweather=Math.min(1,Math.max(0,(humidity-50)*0.15/Math.max(3,temp)));
  fogweather*=fogweather;
  if(Math.abs(loading-1.44)<0.001){loading=0;msgload("");}
  setskydometexture();
  if(temp>=7){tsnow=0;}
}
function msgload(text){
context.clearRect (0,23,150,100);
context.font = "12pt Arial";
context.fillStyle = '#ff0000';
context.fillText(text,20,40);
if(myisailship>=0 && text=="" && tinit>2){context.fillText("wind="+parseInt(wind)+" km/h",20,40);}
else if(myisailship>=0 && text!="" && tinit>2){context.fillText("wind="+parseInt(wind)+" km/h",20,60);}
else if(ianchorship>=0 && text=="" && tinit>2){context.fillText("wind="+parseInt(wind)+" km/h",20,40);}
else if(ianchorship>=0 && text!="" && tinit>2){context.fillText("wind="+parseInt(wind)+" km/h",20,60);}
}
var loading=0,tupdatebuffer=0,klon=1,dtloading=0,dxmax2=1,kdxmax=1,dtgetways=0;
var trygetways=0,dtweb=0;
var ilat=0,ilng=0,tilat=0,tautopilot0=0,icos1=1,isin1=0; 
function getways(){
trygetways=1;
if(tframe<dtgetways){return;}
dtgetways=timer()+4000;
//resetkeys();
dtloading=timer();
if(loading>=1){return;}
if(tfoot==1){t300=20;}else{t300=Math.min(90,parseInt(1+tfps));}
trygetways=0;
loading=1;
if(toverpass==0){toverpass=1;overpass=overpass1;}else{toverpass=0;overpass=overpass2;}
dxmax=25;
if(avgfps<8 || dtweb>4500){dxmax2=Math.max(13,dxmax2-2);}
else if(avgfps>9){dxmax2=Math.min(25,dxmax2+2);}
var k=(700/(10+iways[iiways].length));
k=Math.min(k,7000/(10+inodes[iinodes].length+nodes2.length+nodes3.length));
//k=Math.max(0.70,Math.min(3,Math.sqrt(k)));
if(tinit<4){k=1;kdxmax=0.75+testwater;dxmax2=13;avgfps=1;
            if(tinit==0){cos1=0;sin1=-1;};
            if(tinit==1){cos1=0;sin1=1;};
            if(tinit==2){cos1=1;sin1=0;};
            if(tinit==3){cos1=-1;sin1=0;};
			if(tinit>=2){tinit+=1;};}
//if(k<kdxmax || dtweb>5900){kdxmax-=0.25;}
//else if(k>kdxmax){kdxmax+=0.25;}
if(k<1 || dtweb>5900){kdxmax-=0.25;}
else if(k>1.1){kdxmax+=0.25;}
if(k<0.5){kdxmax-=0.25;}
kdxmax=Math.max(0.75,Math.min(4,kdxmax));auxvar2=kdxmax;
//auxvar=kdxmax;auxvar2=nodes.length;
dxmax=Math.max(19,dxmax2*kdxmax);
lat=latx+sin1*dxmax/scale;
lng=lngx+cos1*dxmax*klon/scale;
lat=Math.max(-87,Math.min(87,lat));
lng=Math.max(-179,Math.min(179,lng));
latx0=lat;lngx0=lng;
var lat00=lat,lng00=lng,worldx0=worldx,worldy0=worldy;
getworldxy(zoom,lat00,lng00);
getlatlng(zoom,worldx+256,worldy+256)
klon=(lng-lng00)/(lat-lat00);
worldx=worldx0;worldy=worldy0;
lat=lat00;lng=lng00;
//klon=1/Math.cos(3.1416*lat/180);
dlat=dxmax*5/scale;
//dlat=0.005;
dlon=dlat*klon;
dlat=Math.max(0.0000001,dlat);
dlon=Math.max(0.0000001,dlon);
var kx=2;
//lat1=lat-kx*dlat/2;lon1=lng-kx*dlon/2;
//lat2=lat+kx*dlat/2;lon2=lng+kx*dlon/2;
lat1=lat-kx*dlat/2;lon1=lng-kx*dlon/2;
lat2=lat+kx*dlat/2;lon2=lng+kx*dlon/2;
//if(Math.abs(ilat-lat)<dlat/4 && Math.abs(ilng-lng)<dlon/4){
//   tilat+=1;if(tilat<4){auxvar+=1000;auxvar3+=1000;loading=0;return;}}
tilat=0;
//if(Math.abs(ilat-lat)<dlat/2 && Math.abs(ilng-lng)<dlon/2){tilat=1;}
//if(tilat==0){
/* for(var i=0;i<=4;i++){
  if(Math.abs(iwaylat[i]-lat)<iwaydlat[i]/4 && Math.abs(iwaylng[i]-lng)<iwaydlng[i]/4){
       tilat=1;break;}
 }*/
//}
tilat=tilat1; 
ilat=lat;ilng=lng;
if(tilat==1){
 ilat+=sin1*dlat/1.75;
 ilng+=cos1*dlon/1.75;
 lat1+=sin1*dlat/1.75;
 lon1+=cos1*dlon/1.75;
 lat2+=sin1*dlat/1.75;
 lon2+=cos1*dlon/1.75;
}
auxvar=tilat;icos1=cos1;isin1=sin1;
var latlon2="%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29";
kx=0.040;
//lat1=lat-kx;lon1=lng-kx*klon;
//lat2=lat+kx;lon2=lng+kx*klon;
lat1=lat-kx;lon1=lng-kx*klon;
lat2=lat+kx;lon2=lng+kx*klon;
if(tilat==1){
 lat1+=sin1*kx/1.01;
 lon1+=cos1*kx*klon/1.01;
 lat2+=sin1*kx/1.01;
 lon2+=cos1*kx*klon/1.01;
}
var latlon3="%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29";
kx=1;
//lat1=lat-kx*dlat/2;lon1=lng-kx*dlon/2;
//lat2=lat+kx*dlat/2;lon2=lng+kx*dlon/2;
lat1=lat-dlat/2;lon1=lng-dlon/2;
lat2=lat+dlat/2;lon2=lng+dlon/2;
if(tilat==1){
 lat1+=sin1*dlat/1.75;
 lon1+=cos1*dlon/1.75;
 lat2+=sin1*dlat/1.75;
 lon2+=cos1*dlon/1.75;
}
msgload("loading...");
dtweb=timer();
//wayurl=http+overpass+"interpreter?data=[out:json];way%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20399%3B";
//var keyway="[highway~'motorway|trunk|primary|secondary']";
var keyway="[highway~'motorway|trunk|primary|secondary|tertiary|unclassified|residential']";
//var keyway="[highway~'motorway|trunk|primary|secondary|tertiary|residential']";
var latlon="%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29";
//keyway="(way['building:height']"+latlon+";way['building:levels']"+latlon+")";
//keyway="(way['building:height']"+latlon+";way['height']"+latlon+";way['building:levels']"+latlon+")";
//keyway="[building~'tower|apartment|commercial']";
keyway="(way[building]"+latlon+";way[highway~'motorway|trunk|primary|secondary|tertiary|unclassified|residential']"+latlon+")";
//keyway="(way[amenity~'fuel']"+latlon+";way[building]"+latlon+";way[highway]"+latlon+";way[aeroway~'aerodrome|runway|taxiway']"+latlon+")";
keyway="(way[natural~'wood|forest']"+latlon+";way[landuse~'forest']"+latlon+";way[building]"+latlon2+";way[highway]"+latlon+";way[aeroway~'aerodrome|runway|taxiway']"+latlon+")";
var keyway2="way['building:height']"+latlon2+";way['building']['height']"+latlon2+";way['building']['levels']"+latlon2+";way['building:levels']"+latlon2;
keyway="%28"+keyway2+";way[amenity~'parking|hospital']"+latlon+";way[natural~'wood|forest']"+latlon+";way[landuse~'forest']"+latlon+";way[building]"+latlon+";way[highway]"+latlon+";way[aeroway~'aerodrome|runway|taxiway']"+latlon3+"%29";
//keyway="(way[natural~'wood|forest']"+latlon+";way[landuse~'forest']"+latlon+";way[building]"+latlon+";way[highway]"+latlon+";way[aeroway~'aerodrome|runway|taxiway']"+latlon+")";
//keyway="(way[building]"+latlon+";way[highway]"+latlon+";way[aeroway~'aerodrome|runway|taxiway']"+latlon+")";
//keyway="way[highway~'motorway|trunk|primary|secondary|tertiary|unclassified|residential']"+latlon;
//wayurl=http+overpass+"interpreter?data=[out:json];way"+keyway+"%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29%3Bout%20399%3B";
wayurl=http+overpass+"interpreter?data=[out:json];"+keyway+"%3Bout%208999%3B";
try{		
httpGet(wayurl,waycallback);
}catch (e){alert("error getways");loading=0;}
}
/*var waylat2=990,waylon2=0;
function getways2(){
//if(Math.max(Math.abs(latx-waylat2),Math.abs(lngx-waylon2)/klon)<dlat/3 || tinit<1){
if(tinit<1){
  setTimeout("getnodes();",t300);return;
}
waylat2=latx;waylon2=lngx;
//resetkeys();
dtloading=timer();
var dlat2=0.020;dlat2=dlat;
var dlon2=dlat2*klon;
var kx=1;
var lat1=latx-kx*dlat2;lon1=lngx-kx*dlon2;
var lat2=latx+kx*dlat2;lon2=lngx+kx*dlon2;
msgload("loading2");
var latlon="%28"+lat1+"%2C"+lon1+"%2C"+lat2+"%2C"+lon2+"%29";
//keyway="(way['building:height']"+latlon+";way['building:levels']"+latlon+")";
var keyway="(way['building:height']"+latlon+";way['building']['height']"+latlon+";way['building']['levels']"+latlon+";way['building:levels']"+latlon+")";
keyway="(way['building']"+latlon+")";
var wayurl2=http+overpass+"interpreter?data=[out:json];"+keyway+"%3Bout%204999%3B";
try{		
httpGet(wayurl2,waycallback2);
}catch (e){alert("error getways2");loading=0;}
}*/
var resetnode=0,tgetnode=1;
function getnodes(){
msgload("getnodes");
if(toverpass==0){toverpass=1;overpass=overpass1;}else{toverpass=0;overpass=overpass2;}
lat=latx0;lng=lngx0;
//lat1=lat-dlat/2;lon1=lng-dlon/2;
//lat2=lat+dlat/2;lon2=lng+dlon/2;
lat1=lat-dlat/2;lon1=lng-dlon/2;
lat2=lat+dlat/2;lon2=lng+dlon/2;
if(tilat==1){
 lat1+=isin1*dlat/1.75;
 lon1+=icos1*dlon/1.75;
 lat2+=isin1*dlat/1.75;
 lon2+=icos1*dlon/1.75;
}
//nodeurl=http+overpass+"interpreter?data=[out:json];"+nodekey+"%3Bout%20skel%209999%3B";
var dx=0.001;
var lat11=lat1-dx,lon11=lon1-dx*klon;
var lat21=lat2+dx,lon21=lon2+dx*klon;
nodeurl=http+overpass+"interpreter?data=[out:json];node%28"+lat11+"%2C"+lon11+"%2C"+lat21+"%2C"+lon21+"%29%3Bout%20skel%2049999%3B";
//nodeurl=http+overpass+"interpreter?data=[out:json];node[layer]%28"+lat11+"%2C"+lon11+"%2C"+lat21+"%2C"+lon21+"%29%3Bout%20skel%2019999%3B";
//nodeurl=http+overpass+"interpreter?data=[out:json];node%28"+lat11+"%2C"+lon11+"%2C"+lat21+"%2C"+lon21+"%29%3Bout%2019999%3B";
resetnode=1;tgetnode=1;
try{		
httpGet(nodeurl,nodecallback);
}catch (e){alert("error getnodes");loading=0;}
}
function getnodes2(){
msgload("getnodes2");
if(toverpass==0){toverpass=1;overpass=overpass1;}else{toverpass=0;overpass=overpass2;}
lat=latx0;lng=lngx0;
lat1=lat-dlat/2;lon1=lng-dlon/2;
lat2=lat+dlat/2;lon2=lng+dlon/2;
var dx=0.001;
var lat11=lat1-dx,lon11=lon1-dx*klon;
var lat21=lat2+dx,lon21=lon2+dx*klon;
var latlon="%28"+lat11+"%2C"+lon11+"%2C"+lat21+"%2C"+lon21+"%29";
//var nodeurl2=http+overpass+"interpreter?data=[out:json];%28";
//var nodeurl2=http+overpass+"interpreter?data=[out:json];%28node[amenity~'fuel|hospital']"+latlon+";node[railway~'station']"+latlon+";";
var nodeurl2=http+overpass+"interpreter?data=[out:json];%28node[amenity~'fuel|hospital']"+latlon+";node[railway~'station']"+latlon+";node[shop~'mall|supermarket']"+latlon+";";
for(var i=1;i<=inode2;i++){
    nodeurl2+="node%28"+nodeid2[i]+"%29";
	if(i<inode2){nodeurl2+=";";}
	}
//nodeurl2+="%29%3Bout%20skel%201999%3B";
nodeurl2+="%29%3Bout%201999%3B";
try{		
httpGet(nodeurl2,nodecallback2);
}catch (e){alert("error getnodes2");loading=0;}
}
function getnodes3(){
msgload("getnodes3");
if(toverpass==0){toverpass=1;overpass=overpass1;}else{toverpass=0;overpass=overpass2;}
var nodeurl3=http+overpass+"interpreter?data=[out:json];%28";
for(var i=1;i<=inode3;i++){
    nodeurl3+="node%28"+nodeid3[i]+"%29";
	if(i<inode3){nodeurl3+=";";}
	}
nodeurl3+="%29%3Bout%20skel%201999%3B";
try{		
httpGet(nodeurl3,nodecallback3);
}catch (e){alert("error getnodes3");loading=0;}
}
function getnodes31(){
msgload("getnodes31");
if(toverpass==0){toverpass=1;overpass=overpass1;}else{toverpass=0;overpass=overpass2;}
var nodeurl31=http+overpass+"interpreter?data=[out:json];%28";
for(var i=1;i<=inode31;i++){
    nodeurl31+="node%28"+nodeid31[i]+"%29";
	if(i<inode31){nodeurl31+=";";}
	}
nodeurl31+="%29%3Bout%20skel%201999%3B";
try{		
httpGet(nodeurl31,nodecallback31);
}catch (e){alert("error getnodes31");loading=0;}
}
var ntown=0,townname=[],townlon=[],townlat=[],townlatxx=99,townlonxx=0;
var ntown0=0,townname0=[],townlon0=[],townlat0=[],tupdatetown=0,tupdatetown2=0;
var towncapital=[],towncapital0=[];
var mytown1="",mydisttown1=0,mytown2="",mydisttown2=0,mycapital1=0;
function getmytown(lonxxx,latyyy,co1,si1){
mytown1="";mydisttown1=990;mytown2="";mydisttown2=990;mycapital1=990;
var itown1=0;
for(var i=1;i<=ntown0;i++){
   var dx=(townlon0[i]-lonxxx)/klon;
   var dy=townlat0[i]-latyyy;
   var dist=(Math.sqrt(dx*dx+dy*dy));
   if((dx*co1+dy*si1)>dist*0.7){
     dist=parseInt(dist*1.15*40000/360);//km
	 if(dist<351 && dist>4){
	   var capital=999;
	   if(towncapital0[i]!=""){
	    if(towncapital0[i]=="yes"){capital=0;}else{capital=parseInt(towncapital0[i]);}
	   }
	   if(capital<=mycapital1 && dist<mydisttown1 && capital<6){mycapital1=capital;
	                          mytown1=townname[i].toUpperCase();
							  mydisttown1=dist;itown1=i;}
	   else if(dist<mydisttown2){mytown2=townname[i];
	                             mydisttown2=dist;
	   }							  
	 }
   }
}
if(mydisttown2>mydisttown1){
 for(var i=1;i<=ntown0;i++){
   var dx=(townlon0[i]-lonxxx)/klon;
   var dy=townlat0[i]-latyyy;
   var dist=(Math.sqrt(dx*dx+dy*dy));
   if((dx*co1+dy*si1)>dist*0.7 && i!=itown1){
     dist=parseInt(dist*1.15*40000/360);//km
     var dist2=dist;
	 if(towncapital0[i]>=6){dist2*=2;}
	 if(dist2<351 && dist>4 && towncapital0[i]>Math.min(5,mycapital1)){
	   if(dist2<mydisttown2){mytown2=townname[i];
	                        mydisttown2=dist;
	   }							  
	 }
   }
}}
if(mytown1=="" && mytown2==""){return 0;}
if(mytown1!=""){mytown1=mytown1.substr(0,17)+"  "+mydisttown1;}
if(mytown2!=""){mytown2=mytown2.substr(0,17)+"  "+mydisttown2;}
return 1;
}
function updatetown(){
if(loading!=0){return;}
if(tupdatetown==1){return;}
if(tupdatetown==2){tupdatetown=0;loading=1.2;
   for(var i=1;i<=ntown;i++){townname0[i]=townname[i];
       townlon0[i]=townlon[i];townlat0[i]=townlat[i];
	   towncapital0[i]=towncapital[i];
	   }
   ntown0=ntown;//alert("ntown="+ntown0+" "+towncapital[ntown0]);
   loading=0;
   return;
}
if(Math.max(Math.abs(townlatxx-latx),Math.abs(townlonxx-lngx)/klon)<0.04){//0.2
   tupdatetown2=0;return;}
townlatxx=latx;townlonxx=lngx;
tupdatetown=1;tupdatetown2=0;
getnodes4();
}
function getnodes4(){
if(loading!=0){return;}
msgload("getcities");
if(toverpass==0){toverpass=1;overpass=overpass1;}else{toverpass=0;overpass=overpass2;}
loading=1.4;
dtloading=tframe;
var dx=2.0;
var lat11=latx-dx,lon11=lngx-dx*klon;
var lat21=latx+dx,lon21=lngx+dx*klon;
var latlon="%28"+lat11+"%2C"+lon11+"%2C"+lat21+"%2C"+lon21+"%29";
dx=0.050;
lat11=latx-dx;lon11=lngx-dx*klon;
lat21=latx+dx;lon21=lngx+dx*klon;
var latlon1="%28"+lat11+"%2C"+lon11+"%2C"+lat21+"%2C"+lon21+"%29";
//var keynode="%28node[place~'village|city|town|metropolis']['is_in:country_code'~'"+countrycode+"']"+latlon+";%29";
//var keynode="%28node[place~'city|town|metropolis']['is_in:country_code'~'"+countrycode+"']"+latlon+";%29";
//var keynode="%28node[place~'city|town|metropolis'][capital~'yes|1|2|3|4|5|6']"+latlon+";%29";
var keynode="%28node[place~'city|town|metropolis']['is_in:country_code'~'"+countrycode+"']"+latlon+";node[place~'city|town|metropolis'][capital~'yes|1|2|3|4|5|6']"+latlon+";node[layer~'-1|0|1|2|3']"+latlon1+";%29";
//keynode="%28node[layer~'-1|0|1|2|3']"+latlon1+";%29";
var nodeurl4=http+overpass+"interpreter?data=[out:json];"+keynode+"%3Bout%201999%3B";
try{		
httpGet(nodeurl4,nodecallback4);
}catch (e){alert("error getnodes4");loading=0;}
}
var trygetweather=0;
function getweather(){
if(http!="http:"){return;}
if(loading!=0){return;}
msgload("getweather");
loading=1.44;
var weatherurl="http://api.openweathermap.org/data/2.5/weather?lat="+latx+"&lon="+lngx+"&APPID=4cd1de75fbc57d92794e74ec918593ca";
try{		
httpGet(weatherurl,weathercallback);
}catch (e){alert("error getweather");loading=0;}
}
var reversejson=null,countrycode="",cityname="";
function reversecallback(r){//alert(r);
  //reversejson=JSON.parse(r);
  if(ireverse==0){locationname="";}else{locationname2="";}
  var ii=r.indexOf('<country_code>');
  if(ii>=0){
   var rrr=r.substr(ii+14,30)+'<';
   ii=rrr.indexOf('<');
   countrycode=rrr.substr(0,ii).toUpperCase();}
  cityname=""; 
  ii=r.indexOf('<city>');
  if(ii>=0){
   var rrr=r.substr(ii+6,30)+'<';
   ii=rrr.indexOf('<');
    cityname=rrr.substr(0,ii);}
  var i=r.indexOf(' ref="');
  if(i>=0){
   var rr=r.substr(i+6,30)+'"';
   i=rr.indexOf('"');
    rr=rr.substr(0,i);
	if(isletter(rr)==0 && cityname!=""){rr=cityname;}
    if(ireverse==0){locationname=rr;}else{locationname2=rr;}//alert(rr);
	if(treversecity==0){locationname=rr;locationname2=rr;latrev20=latrev2;lngrev20=lngrev2;}
	else if(locationname!=locationname2){
	  if(Math.max(Math.abs(latrev2-latrev20),Math.abs(lngrev2-lngrev20)/klon)*scale>10){
	     setTimeout("testaddcitypanel();",50);}}
  }
  loading2=0;tupdatetown2=1;
  tloadingreverse=tframe+3000;
}
var loading2=0;  
var tloadingreverse=0,locationname="",locx=0,locy=90,loco1=0,ireverse=0;
var locationname2="",latrev2=0,lngrev2=0,treversecity=0,latrev20=0,lngrev20=0;
function getreverselocation(){
if(tframe<tloadingreverse || loading2==2){return;}
var dx=Math.max(Math.abs(x-locx),Math.abs(y-locy));
if(loading>0 || (dx<2 && Math.abs(loco1-o1)<1)){return;}
treversecity=1;if(dx>200){treversecity=0;}
loading2=1;if(ireverse==1){locx=x;locy=y;loco1=o1;}
tloadingreverse=tframe+28000;
ireverse+=1;if(ireverse>1){ireverse=0;}
var latxx=latx,lngxx=lngx;
if(ireverse==1){lngxx+=(20*cos1)*klon/scale;latxx+=(20*sin1)/scale;
                latrev2=latxx;lngrev2=lngxx;}
//var query="format=json&osm_type=N&osm_id="+nodeid+"&json_callback=reversecallback";
var myquery="format=xml&lat="+latxx+"&lon="+lngxx+"&zoom=10&addressdetails=1&accept-language=en";//&callback=reversecallback";
//myquery="format=json&lat="+latxx+"&lon="+lngxx+"&zoom=10&addressdetails=1&accept-language=en";//&callback=reversecallback";
//zoom=13
reverseurl=http+"//nominatim.openstreetmap.org/reverse?"+myquery;
try{		
httpGet2(reverseurl,reversecallback);
}catch (e){alert("error reverselocation");}
}
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');
var gl,contextgl;
var canvasgl = document.getElementById('canvasgl');
//var contextgl = canvasgl.getContext('2d');
canvasgl.width=windx;
canvasgl.height=windy;
function printmsg(msg){
context.clearRect (0,0,200,50);
context.font = "12pt Arial";
context.fillText(msg,20,20);
}
function printloading(){
//printmsg("loading...");
context.font = "12pt Arial";
context.fillStyle = '#00AA00';
var j=180;
j+=20;context.fillText("webglcarsimheight_shadow",20,j);
j+=20;context.fillText("a program by NGUYEN.Chung (freeware 2015)",20,j);
context.fillStyle = '#000000';
j+=20;context.fillText("powered by glMatrix",20,j);
j+=20;context.fillText("powered by Openstreetmap",20,j);
j+=20;context.fillText("powered by Gooble static maps",20,j);
j+=20;context.fillText("powered by Google maps",20,j);
j+=20;context.fillText("powered by responsivevoice",20,j);
j+=20;context.fillText("powered by nominatim.openstreetmap.org/reverse",20,j);
j+=20;context.fillText("powered by "+overpass,20,j);
j+=20;context.fillText("powered by api.openweathermap.org",20,j);
}
printloading();
function initwebgl(){
 printmsg("initgl");
 initGL(canvasgl);
 initShaders();
 printmsg("initbuffers");
 ibuff=0;
 initBuffers();
 printmsg("inittexture");
 initTexture();
 printmsg("loadmodels");
 loadmodels();
 twebglstart2=timer();
 setTimeout("initwebgl2();",500);
}
var twebglstart2=0;
function initwebgl2(){
	    if(timer()<(twebglstart2+50000)){
		  if(!solTexture2.data){
		     printmsg("initsoltexture2");
		     setTimeout("initwebgl2();",500);return;}
		  if(!solTexture2.datasize){
		     setTimeout("initwebgl2();",500);return;}
		  if(solTexture2.datasize<200 || !ways || !nodes || testtexturelistloaded()==0){
		     setTimeout("initwebgl2();",500);return;}
		}else{alert("soltexture2.data not loaded !");
		      if(confirm("retry ?")){document.location.href=document.location.href+" ";}}
 printmsg("initbuffers2");
 ibuff=1;
 initBuffers();
 ibuff=0;ibuff0=0;ibuff1=1;tinit=0;
 tmsgstart=0;dtloading=timer();tdraw=0;loading=0;tdraw2=0;
 if(tinitcombo==1){tinitcombo=0;
    setTimeout("subcombo();tick(0);",3000);}
 else{setTimeout("tick(0);",3000);}
 //setTimeout("dtloading=0;loading=1;",10000)
 //setTimeout("x00=999999;",10000);
 //setTimeout("x00=999999;",20000);
 //setTimeout("tdraw=1;",10000);
 //setTimeout("tdraw=1;",40000);
}
//contextgl.strokeStyle = '#ffff00';
//contextgl.lineWidth = 50;
//line(0,0,300,300);
context.width=windx;
context.height=windy;
context.lineWidth = 3;
context.fillStyle = '#ff0000';
context.font = "12pt Arial";
function line(x,y,x1,y1){
contextgl.beginPath();
contextgl.moveTo(x,y);
contextgl.lineTo(x1,y1);
contextgl.stroke();
}
var locationname0="",tlocationname=0;
function isletter(text){
var c=text.substr(0,1).toLowerCase();
if(c==""){return 0;}
if("abcdefghijklmnopqrstuvwxyz0123456789éèçàù".indexOf(c)>=0){return 1;}
return 0;
}
function printlocationname(){
printmyroadname();
var ix=canvas.width/2-80;
var iy=20;
if(locationname!=locationname0){
  if(locationname!=""){
   locationname0=locationname;
   tlocationname=tframe+8000;
   var msg="";
   switch (parseInt(Math.random()*3)){
	case 0:msg="you are entering ";break;
	case 1:msg="you arrive at ";break;
	case 2:msg="you are arriving at ";break;
	}
   if(isletter(locationname)==0){radiomsg(msg+cityname);}
   else{radiomsg(msg+locationname);}
  }else{
   tlocationname=tframe+8000;
   var msg="";
   switch (parseInt(Math.random()*2)){
	case 0:msg="you are leaving ";break;
	case 1:msg="you are quitting ";break;
	}
   radiomsg(msg+locationname0);
   locationname0=locationname;
  }  
}
//context.clearRect(ix,0,300,40);
context.font = "12pt Arial";
if(tframe>tlocationname){context.fillStyle = '#00df00';}
else{context.fillStyle = '#b00000';}
context.fillText(locationname,ix,iy);
}
function printmyroadname(){
var ix=canvas.width/2-80;
var iy=40;
context.clearRect(ix,0,300,60);
context.font = "12pt Arial";
context.fillStyle = '#00df00';
context.fillText(myroadname,ix,iy);
}
var contextx=0,contexty=0,contextpattern=0;
function context_moveTo(x,y){
  context.moveTo(x,y);
  contextx=x;contexty=y;
}
function context_lineTo(x,y){
  if(contextpattern==0){context.lineTo(x,y);}
  else if(contextpattern==2){
     var dr=20,dx=(x-contextx),dy=(y-contexty),dn=Math.sqrt(dx*dx+dy*dy)/dr;
	 for(var i=0;i<dn;i++){context.moveTo(contextx+i*dx/dn,contexty+i*dy/dn);
	           context.lineTo(contextx+i*dx/dn+dx*11/(dr*dn),contexty+i*dy/dn+dy*11/(dr*dn));}
     }
  else{
     var dr=10,dx=(x-contextx),dy=(y-contexty),dn=Math.sqrt(dx*dx+dy*dy)/dr;
	 for(var i=0;i<dn;i++){context.moveTo(contextx+i*dx/dn,contexty+i*dy/dn);
	           context.lineTo(contextx+i*dx/dn+dx*6/(dr*dn),contexty+i*dy/dn+dy*6/(dr*dn));}
     }
contextx=x;contexty=y;
}
function draw(){
var windx0=canvas.width,windy0=canvas.height;
context.clearRect (0,0,canvas.width-256,canvas.height);
printlocationname();
context.lineWidth = 1;
//auxvar=context.getImageData(200,100,1,1).data[0];
context.font = "12pt Arial";
for(var i=0;i<ways.length;i++){
  var way=(ways[i]),test=1,layer=0;
  waytype="none";
  if(way.nodes){
   if(way.tags){if(way.tags.highway){
      waytype=way.tags.highway;
      if(way.tags.layer){
	     layer=Math.min(1,way.tags.layer+0);}
	  }}
   if(way.tags){if(way.tags.building){
      waytype="building";}}
   if(way.tags){if(way.tags.aeroway){
      waytype=way.tags.aeroway;}}
   if(way.tags){if(way.tags.landuse){
      waytype=way.tags.landuse;}}
   if(way.tags){if(way.tags.natural){
      waytype=way.tags.natural;}}
   //if(waytype=="none" || waytype=="path"){
   //  test=0;}
   if(waytype=="building"){
     context.lineWidth = 1;
     context.strokeStyle = '#008fff';
   }else if(waytype=="aerodrome"){
     context.lineWidth = 10;
     context.strokeStyle = '#ff8800';
   }else if(waytype=="runway"){
     context.lineWidth = 20;
     context.strokeStyle = '#999999';
   }else if(waytype=="taxiway"){
     context.lineWidth = 15;
     context.strokeStyle = '#999900';
   }else if(waytype=="motorway"){
     context.lineWidth = 4;
     context.strokeStyle = '#ff0000';
   }else if(waytype=="trunk"){
     context.lineWidth = 3;
     context.strokeStyle = '#cf0000';
   }else if(waytype=="track"){
     context.lineWidth = 3;
     context.strokeStyle = '#9f8000';
   }else if(waytype=="primary"){
     context.lineWidth = 2;
     context.strokeStyle = '#4f9f00';
   }else if(waytype=="secondary"){
     context.lineWidth = 1;
     context.strokeStyle = '#00ff00';
   }else if(waytype=="tertiary"){
     context.lineWidth = 1;
     context.strokeStyle = '#008f00';
   }else if(waytype=="service"){
	 context.lineWidth = 1;
     context.strokeStyle = '#8f8f00';
   }else if(waytype=="pedestrian"){
	 context.lineWidth = 1;
     context.strokeStyle = '#ffff00';
   }else if(waytype=="path"){
	 context.lineWidth = 1;
     context.strokeStyle = '#ff00ff';
   }else if(waytype=="forest"){
	 context.lineWidth = 8;
     context.strokeStyle = '#009900';
   }else if(waytype=="wood"){
	 context.lineWidth = 4;
     context.strokeStyle = '#80ff80';
   }else{//test=0;
     context.lineWidth = 1;
     context.strokeStyle = '#000000';
   }
   if(test==1){
   contextpattern=0;
   if(layer<-1){contextpattern=2;}//context.strokeStyle = '#707000';}
   else if(layer<0){contextpattern=1;}//context.strokeStyle = '#999900';}
   context.beginPath();
   for(var j=0;j<way.nodes.length;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){  
	   //var y=windy0-windy0*(latnodes[inode]-lat1)/(lat2-lat1);
	   //var x=windx0*(lonnodes[inode]-lon1)/(lon2-lon1);
	   var dlat=latx-(lat1+lat2)/2;
	   var dlon=lngx-(lon1+lon2)/2;
	   var y=windy0-windy0*(latnodes[inode]-lat1-dlat)/(lat2-lat1);
	   var x=windx0*(lonnodes[inode]-lon1-dlon)/(lon2-lon1);
	   x=windx0/2+0.7*(x-windx0/2);
	   y=windy0/2+0.7*(y-windy0/2);
	   if(j==0){context_moveTo(x,y);}
	   else{context_lineTo(x,y);}
	 }  
   }
   context.stroke();
   if(waytype=="building"){
      context.fillStyle = '#dfefff';
	  context.fill();}	  
   /*if(waytype=="forest" || waytype=="wood"){
      context.fillStyle = '#00ff00';
	  context.fill();}*/	  
   }}}
   context.fillStyle = '#ff0000';
   var latt=parseInt(lat*1000)/1000;
   var lngg=parseInt(lng*1000)/1000;
   context.fillText("lat="+latt+" lon="+lngg,20,20);
   context.fillText("nways="+i+" nnodes="+nnode,20,40);
   context.fillText("x",canvas.width/2,canvas.height/2);
   context.fillText("clouds="+wclouds,20,60);
   context.fillText("temp="+temp+"°C",20,80);
   context.fillText("hum="+humidity+"%",20,100);
   context.fillText("wind="+wind+" km/h",20,120);
   //alert("drawways="+i);
}
function timer(){
return Date.now();
//return (new Date()).getTime();//ms
}
var tjoy="getGamepads" in navigator,joy=null,button=new Array(17);
var joyx=0,joyy=0,joyz=0,joyr=0,timejoy=0,timebutt=new Array(17);
for(var i=0;i<17;i++){timebutt[i]=0;}
function testjoystick(){
 for(var i=1;i<17;i++){button[i]=0;}
 joyx=0;joyy=0;joyz=0;joyr=0;
 if(!tjoy){return;}
 joy=navigator.getGamepads()[0];
 if(!joy){return}
 var butt=null,nbutt=joy.buttons.length;
 if(nbutt>16){nbutt=16;}
 for(var i=0;i<nbutt;i++){
   if(tframe>timebutt[i+1]){
	butt=joy.buttons[i];
    if (typeof(butt)=="object"){if(butt.pressed){button[i+1]=1;};
	   }else{if(butt==1.0){button[i+1]=1;};}
   }	   
 }
 var naxes=joy.axes.length; 
 if(naxes>0){joyx=joy.axes[0]-1;if(Math.abs(joyx)<0.09){joyx=0;};}
 if(naxes>1){joyy=joy.axes[1]-1;if(Math.abs(joyy)<0.09){joyy=0;};}
 if(naxes>2){joyr=joy.axes[2]-1;if(Math.abs(joyr)<0.09){joyr=0;};}
 if(naxes>3){joyz=joy.axes[3];if(Math.abs(joyz)<0.09){joyz=0;};}
}
function b(i){if(button[i]==1){
  timebutt[i]=tframe+150;button[i]=0;return 1;
}else{return 0;};}
function sign(x){if(x>=0){return 1;}else{return -1;}}
var radtodeg=180/Math.PI;
function diro1(dx,dy){ 
var do1;
if (Math.abs(dx)>Math.max(0.001,0.001*Math.abs(dy))){
   if(dx>0){do1=Math.atan(dy/dx)*radtodeg;
   }else{do1=180-Math.atan(dy/Math.abs(dx))*radtodeg;}
   }
else {if(dy>0){do1=90;}else{do1=-90;};}
return do1;
}

var mousex=0,mousey=0,tmousedown=0,tmouseup=0,tmousemove=0;
var mouseleft=0,mouseright=0,mouseup=0,mousedown=0;
var mousepageup=0,mousepagedown=0;
function submousedown(e){
tmousedown=1;
if(e.clientX){mousex=e.clientX;mousey=e.clientY;}
else if(e.x){mousex=e.x;mousey=e.y;}
else if(e.originalEvent){
  if(e.originalEvent.touches){
     if(e.originalEvent.touches[0].pageX){mousex= e.originalEvent.touches[0].pageX;}
     if(e.originalEvent.touches[0].pageY){mousey= e.originalEvent.touches[0].pageY;}
}};
//if(tmousemove==0){tmousemove=1;}else{tmousemove=0;}
}
function submousemove(e){return;
if(tmousemove==1){
if(e.clientX){mousex=e.clientX;mousey=e.clientY;}
else if(e.x){mousex=e.x;mousey=e.y;}
else if(e.originalEvent){
  if(e.originalEvent.touches){
     if(e.originalEvent.touches[0].pageX){mousex= e.originalEvent.touches[0].pageX;}
     if(e.originalEvent.touches[0].pageY){mousey= e.originalEvent.touches[0].pageY;}
}}}
}
function submouseup(e){
tmouseup=1;
}
function testmousedown(){
var dx=canvas.width,dy=canvas.height;
mouseleft=0;mouseright=0;mouseup=0;mousedown=0;
mousepageup=0;mousepagedown=0;
if(tmousedown==1){
   if(mousey>dy/2 && mousey<dy){
     if(mousex>0 && mousex<dx/3){mouseleft=1;}
	 else if(mousex>dx*0.35 && mousex<dx*0.65){mousedown=1;}
	 else if(mousex>dx*0.65 && mousex<dx){mouseright=1;}
   }else if(mousey>0 && mousey<dy/2){
     if(mousex>0 && mousex<dx*0.35){mousepageup=1;}
	 else if(mousex>dx*0.35 && mousex<dx*0.65){mouseup=1;}
	 else if(mousex>dx*0.65 && mousex<dx){mousepagedown=1;}
   }
}
}
function testmouseup(){
mouseleft=0;mouseright=0;mouseup=0;mousedown=0;
mousepageup=0;mousepagedown=0;
if(tmouseup==1){tmouseup=0;tmousedown=0;}   
}
var mouse2x=0,mouse2y=0,tmouse2down=0,tmouse2up=0,tmouse2move=0;
var mouse2left=0,mouse2right=0,mouse2up=0,mouse2down=0;
var mouse2x0=0,mouse2y0=0,mouse2dx=0,mouse2dy=0;
var tmouse3move=0,mouse3dx=-9,mouse3dy=0;
function resetmouse2(){tmouse2down=0;tmouse2up=0;tmouse2move=0;mouse2dx=0;mouse2dy=0;}
function submouse2down(e){if(tfocus==0){return;}
tmouse2down=1;
if(e.clientX){mouse2x=e.clientX;mouse2y=e.clientY;}
else if(e.x){mouse2x=e.x;mouse2y=e.y;}
else if(e.originalEvent){
  if(e.originalEvent.touches){
     if(e.originalEvent.touches[0].pageX){mouse2x= e.originalEvent.touches[0].pageX;}
     if(e.originalEvent.touches[0].pageY){mouse2y= e.originalEvent.touches[0].pageY;}
}};
//if(tmouse2move==0){tmouse2move=1;mouse2x0=mouse2x;mouse2y0=mouse2y;mouse2dx=0;mouse2dy=0;
//}else if(tmouse2move==1){tmouse2move=2;//mouse2x0=mouse2x;mouse2y0=mouse2y;mouse2dx=0;mouse2dy=0;}
//}else{tmouse2move=0;mouse2x0=mouse2x;mouse2y0=mouse2y;mouse2dx=0;mouse2dy=0;}
}
function submouse2move(e){return;
if(tfocus==0){return;}
if(tmouse2move==1){
if(e.clientX){mouse2x=e.clientX;mouse2y=e.clientY;}
else if(e.x){mouse2x=e.x;mouse2y=e.y;}
else if(e.originalEvent){
  if(e.originalEvent.touches){
     if(e.originalEvent.touches[0].pageX){mouse2x= e.originalEvent.touches[0].pageX;}
     if(e.originalEvent.touches[0].pageY){mouse2y= e.originalEvent.touches[0].pageY;}
}}
mouse2dx=(mouse2x-mouse2x0)/50;
mouse2dy=(mouse2y0-mouse2y)/50;
}}
function submouse2up(e){
tmouse2up=1;
}
var keys=new Array(256),keys0=new Array(256),tkeys=new Array(256),tkey=0;
var pkeys=new Array(256);
function resetkeys(){
 for(var i=0;i<256;i++){keys[i]=0;keys0[i]=0;tkeys[i]=0;}
}
resetkeys();
function keydown(e){
var key=eval(e.which || e.keyCode);
//var t=timer();
if(key>0 && key<256){keys[key]=1;tkeys[key]=tframe;keys0[key]=1;}
}
function keyup(e){
var key=eval(e.which || e.keyCode);
if(key>0 && key<256){keys[key]=0;keys0[key]=0;}
}
function subhelp(){
var crlf=String.fromCharCode(13)+String.fromCharCode(10);
var msg="H => help"+crlf;
msg+="shift+H => shadow(on/double/off)"+crlf;
msg+="esc => quit   /   shift+O => select osm server"+crlf;
msg+="3 => fullscreen"+crlf;
msg+="4 => cssscale (lowerres/faster)"+crlf;
msg+="1,2 => cockpit height / turn sailship"+crlf;
msg+="Q,S => fly mode /up/down"+crlf;
msg+="shift+G => flyto geolocation "+crlf;
msg+="G => minimap(on/off)"+crlf;
msg+="V => view type"+crlf;
msg+="arrow keys,A,E => move"+crlf;
msg+="pageup/pagedown => look up/down"+crlf;
msg+="K => car / foot"+crlf;
msg+="shift => brakes"+crlf;
msg+="shift+S => save game cookie"+crlf;
msg+="shift+T => change time hour / T => tourelle view"+crlf;
msg+="shift+M => mystreetview /  M => map"+crlf;
msg+="R => radio"+crlf;
msg+="shift+R => srtm relief(on/off/scale)"+crlf;
msg+="shift+L => link url  /  L => light"+crlf;
msg+="shift+C => collide  /  C => clouds(on/off)"+crlf;
msg+="P => auto pilot   /   F => fog"+crlf;
msg+="A => ascend (climb walls,foot mode) / anchor ship"+crlf;
msg+="Z => climb road"+crlf;
msg+="7 => change season"+crlf;
msg+="shift+X => scalex"+crlf;
msg+="shift+Z => default scaleh"+crlf;
msg+="space+arrows => turn head"+crlf;
msg+="shift+E => change cockpit"+crlf;
msg+="shift+N => number of cars"+crlf;
msg+="B,N / pageup,down => motor gaz"+crlf;
msg+="button 1 => accelerate"+crlf;
msg+="button 2 => decelerate"+crlf;
msg+="button 4 => car / foot"+crlf;
msg+="button 6 => brakes"+crlf;
msg+="button 5 => turn left"+crlf;
msg+="button 7 => turn right"+crlf;
msg+=crlf+"joystick and gamepad supported"+crlf;
soundcaroff();
alert(msg);
document.getElementById('msg').focus();
}
var tradio=0,tradiocanal=0,tradioexpand=0;
function subradio(){
 if(tradio==0){if(confirm("start radio ?")){tradio=1;stopsoundvoyage();
    //soundmusic();
	//soundcaroff();
	//var urlradio="https://chungswebsite.blogspot.fr/p/blog-page_20.html";
    //var urlradio="http://www.fipradio.fr/player";
	//urlradio="http://www.francemusique.fr/player";
	//urlradio="http://www.radioclassique.fr/player";
    //var urlradio="https://42c17c83e1e121e17e84ae58bf77551517545859.googledrive.com/host/0B6GM9ay7ImZLY25Sd1FSUWNENWM/mywebaudioplayer.html?11&1&1&0&";
	//urlradio=folderdrive+"radio1.html"
	//var urlradio="https://42c17c83e1e121e17e84ae58bf77551517545859.googledrive.com/host/0B6GM9ay7ImZLY25Sd1FSUWNENWM/myaudioplayer2.html";
	//var urlradio="https://sites.google.com/site/mywebglflightchung/mywebglflight/myaudioplayer.html?3&1&1&0&";
	var urlradio="https://42c17c83e1e121e17e84ae58bf77551517545859.googledrive.com/host/0B6GM9ay7ImZLY25Sd1FSUWNENWM/myaudioplayer2.html?13&1&1&0&";
    if(localStorage){var store=localStorage.getItem("json_osm_chung_tradiocanal");
	                 if(store){tradiocanal=store;}}
	if(tradiocanal==1){urlradio="myaudioplayer.html";}
	//else{urlradio="https://www.reverbnation.com/widget_code/html_widget/artist_352350?autoplay=true";}
	//else{urlradio="https://www.reverbnation.com/widget_code/html_widget/artist_352350?autoplay=true&widget_id=1&pwc[included_songs]=2";}
    else{/*var songid=[],i=-1;
	     i+=1;songid[i]='1452185';//miller
		 i+=1;songid[i]='1452181';//nemo
		 i+=1;songid[i]='1493447';//tenderly
		 i+=1;songid[i]='1493546';//avemaria
		 /*i+=1;songid[i]='
		 i+=1;songid[i]='
		 i+=1;songid[i]='
		 i+=1;songid[i]='
		 var song=songid[parseInt((i+0.99)*Math.random())];
	     urlradio="https://www.reverbnation.com/widget_code/html_widget/artist_352350?autoplay=true&widget_id=50&amp;posted_by=artist_352350&pwc[design]=default&pwc[background_color]=%23333333&pwc[included_songs]=0&pwc[song_ids]="+song+"&pwc[photo]=0%2C1&pwc[size]=fit";}
	     */
		 urlradio="https://www.reverbnation.com/widget_code/html_widget/artist_352350?autoplay=true&pwc[design]=default";}
    //else{urlradio="http://www.reverbnation.com/widget_code/html_widget/artist_352350?autolay=true&widget_id=1&pwc[design]=default&pwc[background_color]=%23333333&pwc[included_songs]=1&pwc[photo]=0&pwc[size]=custom";}
    //else{urlradio="http://www.reverbnation.com/widget_code/html_widget/artist_352350?widget_id=50&posted_by=fan_153975&pwc[design]=default&pwc[background_color]=%23333333&pwc[included_songs]=1&pwc[photo]=0&pwc[size]=custom";}
	// "widget_id=55&amp;pwc[included_songs]=1&amp;spoid=artist_352350";
    tradioexpand=0;	
    if(fullscreen==0){
	 document.getElementById('radiodiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-68-15)+'px;left:'+parseInt(windx*cssscale)+'px;width:120px;height:980px;z-index:500;' );
	 document.getElementById('radiodiv1').setAttribute('style','top:0px;left:0px;width:120px;height:980px;z-index:499;' );
	}else{
	 document.getElementById('radiodiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-68-15)+'px;left:'+parseInt(windx*cssscale-120)+'px;width:120px;height:980px;z-index:500;' );
	 document.getElementById('radiodiv1').setAttribute('style','top:0px;left:0px;width:120px;height:980px;z-index:499;' );
	}
    document.getElementById('radio').setAttribute('scrolling','no' );
    //document.getElementById('radio').setAttribute('style','top:0px;left:0px;width:119px;height:950px;' );
	setTimeout("document.getElementById('radio').src='"+urlradio+"';",400);
	setTimeout("document.getElementById('radiodiv1').setAttribute('style','top:0px;left:0px;width:119px;height:50px;z-index:499;' );",3000);
	setTimeout("document.getElementById('radio').setAttribute('style','top:0px;left:0px;width:119px;height:50px;z-index:490;' );",3100);
	}}
 else{if(confirm("stop radio ?")){tradio=0;restartsoundvoyage();
    //stopsoundmusic();
	//soundcaron();
	document.getElementById('radio').src=""
    document.getElementById('radiodiv').setAttribute('style','position:absolute;top:6000px;left:0px;width:40px;height:20px;' );
	}}
	//document.getElementById('radiodiv').focus();
}
function radiocanal(){
tradiocanal+=1;if(tradiocanal>1){tradiocanal=0;}
	var urlradio="https://42c17c83e1e121e17e84ae58bf77551517545859.googledrive.com/host/0B6GM9ay7ImZLY25Sd1FSUWNENWM/myaudioplayer2.html?13&1&1&0&";
	if(tradiocanal==1){urlradio="myaudioplayer.html";}
	else{urlradio="https://www.reverbnation.com/widget_code/html_widget/artist_352350?autoplay=true";}
	document.getElementById('radio').src=urlradio;	
    if(localStorage){localStorage.setItem("json_osm_chung_tradiocanal",tradiocanal);}
}
function radioreduce(){
    if(fullscreen==0){
	 document.getElementById('radiodiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-68-15)+'px;left:'+parseInt(windx*cssscale)+'px;width:120px;height:780px;z-index:500;' );
	}else{
	 document.getElementById('radiodiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-68-15)+'px;left:'+parseInt(windx*cssscale-120)+'px;width:120px;height:780px;z-index:500;' );
	}
    document.getElementById('radiodiv1').setAttribute('style','top:0px;left:0px;width:119px;height:50px;z-index:499;' );
    document.getElementById('radio').setAttribute('style','top:0px;left:0px;width:119px;height:50px;z-index:490;' );
}
function radioexpand(){
tradioexpand+=1;if(tradioexpand>1){tradioexpand=0;radioreduce();return;}
    if(fullscreen==0){
	 document.getElementById('radiodiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-368-15)+'px;left:'+parseInt(windx*cssscale-300)+'px;width:420px;height:980px;z-index:500;' );
	}else{
	 document.getElementById('radiodiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-368-15)+'px;left:'+parseInt(windx*cssscale-420)+'px;width:420px;height:980px;z-index:500;' );
	}
    document.getElementById('radiodiv1').setAttribute('style','top:0px;left:0px;width:350px;height:320px;z-index:499;' );
    document.getElementById('radio').setAttribute('style','top:0px;left:0px;width:350px;height:950px;' );
    setTimeout("document.getElementById('radio').setAttribute('style','top:0px;left:0px;width:350px;height:320px;' );",500);
}
var testsrtm=1;
function subsrtm(){
 //if(testsrtm==0){if(confirm("set srtm relief on ?")){testsrtm=1;tinitgmap=1;}}
 //else{if(confirm("set srtm relief off ?")){testsrtm=0;tinitgmap=1;}}
 var s=prompt("srtm enter a number 0:none->1:normal->4.0:high",testsrtm);
 if(s!=null){
  s=Math.max(0,Math.min(4,parseFloat(s)));
  if(s<=8){testsrtm=s;tinitgmap=2;}
 }
}
var tcollideon=1;
function subcollide(){
 if(tcollideon==0){if(confirm("set test collide on ?")){tcollideon=1;}}
 else{if(confirm("set test collide off ?")){tcollideon=0;}}
}
var tautopilot=0,dtautopilot=0;
function subautopilot(){
 if(tautopilot==0){if(confirm("set autopilot 1 on ?")){tautopilot=2;}}
 else if(tautopilot==2){if(confirm("set autopilot on ?")){tautopilot=1;}}
 else{if(confirm("set autopilot off ?")){tautopilot=0;}}
}
function subshadow(){
 if(noshadow==1){if(confirm("set shadow off ?")){noshadow=2;}}
 else if(noshadow==0){if(confirm("set double distshadow ?")){noshadow=1;}}
 else{if(confirm("set shadow on ?")){noshadow=0;}}
}
var tcockpitok=0;
function subgirl(){
 tcockpitok=0;
 //if(tgirl==0){if(confirm("set girl on ?")){tgirl=1;carTexture.image.src = "chevy2girl.png";}}
 //else{if(confirm("set girl off ?")){tgirl=0;carTexture.image.src = "chevy2.png";}}
 var msg="";
 if(tgirl==0){tgirl=1;carTexture.image.src = "toyota.png";msg="Toyota";}
 else if(tgirl==1){tgirl=2;carTexture.image.src = "volvo.png";msg="Volvo";}
 else if(tgirl==2){tgirl=3;carTexture.image.src = "cadillac.png";msg="Cadillac";}
 else if(tgirl==3){tgirl=4;carTexture.image.src = "mercedes.png";msg="Mercedes";}
 else if(tgirl==4){tgirl=5;carTexture.image.src = "ford.png";msg="Ford";}
 else{tgirl=0;carTexture.image.src = "chevy2.png";msg="Chevy";}
 resetkeys();
 context.clearRect (0,0,canvas.width,canvas.height);
 context.font = "Bold 18pt Arial";
 context.fillStyle = '#ff0000';
 context.fillText(msg,canvas.width*0.44,60);
}
var tfog=0,fog=0.45;if(Math.random()<0.5 && fogweather<0){tfog=0;fog=0;}
function subfog(){
 if(tfog==0){if(confirm("set fog on ?")){tfog=1;fog=0.45;fog0=fog;}}
 else if(tfog==1){if(confirm("set half fog?")){tfog=0.5;fog=0.5*0.45;fog0=fog;}}
 else{if(confirm("set fog off ?")){tfog=0;fog=0;fog0=fog;}}
}
var ttower=0;
function subtower(){
 if(ttower==0){if(confirm("set towers only on ?")){ttower=1;x00=999999;}}
 else{if(confirm("set towers only off ?")){ttower=0;x00=999999;}}
}
function subncar(){
var k=prompt("number of cars : enter a number 1.."+ncar+" last="+ncar2)
if(k){k=Math.max(1,Math.min(ncar,k));if(k>0){ncar2=k;}}
}
function quitmsgmap(){
document.getElementById('mapdiv').blur();
scrollTo(0,0);tmap=0;//alert('ok');
}
function sleep(ms){
var t=timer()+Math.min(10000,ms);
while(timer()<t){}
}
function getterrainheightcar(lngx,latx,lastz0){
var xx=((lngx-lng0)/klon)*scale;
var yy=(latx-lat0)*scale;
if(myisailship>=0 && typecar==0){troad=0;}
else if(ttunnel==0 && lastz0<-99){troad=testroadcar(xx,yy,-9999,lat0,lng0,0.5);}
else if(ttunnel==0){troad=testroadcar(xx,yy,lastz0,lat0,lng0,0.5);}
else if(ttunnel==2){troad=testroadcar(xx,yy,lastz0,lat0,lng0,0.5);}//0.1
else{troad=testroadcar(xx,yy,lastz0-0.3,lat0,lng0,1.05);}
if(troad>0){return zroad;}
var zz=getterrainheight(lngx,latx);
if(zz<-0.04){testwater=1;twater=1;return getterrainheightwater(xx,yy);}
return zz;
}
function teststopcar(){
	     if(vcar>0.04 && nstop0>=1){
		   for(var i=1;i<=nstop0;i++){
		       var dxx=x-stopx0[i];
			   if(Math.abs(dxx)<2.5+vcar){
			      var dyy=y-stopy0[i];
				  if(Math.abs(dyy)<2.5+vcar){
			       var dzz=z-stopz0[i];
				   if(Math.abs(dzz)<0.5){
				     var dxy=-dxx*stopco10[i]-dyy*stopsi10[i];
					 if(dxy>0.03){
					   if(cos1*stopco10[i]+sin1*stopsi10[i]>0.3){
				         vrun=Math.min(0.4,vrun);vcar=Math.max(0.04,vcar-0.0065*dtime*(vcar+0.05));return;}}
					 }}}}}
	     if(vcar>0.08 && pautoroad>=0){
		   var test=road0cross[pautoroad];
	       if(test || Math.abs(cos1*road0co1[pautoroad]+sin1*road0si1[pautoroad])<0.55){
				   var dxx=cos1*(x-road0x[pautoroad])+sin1*Math.abs(y-road0y[pautoroad]);
				   var dyy=cos1*(x-road0x[pautoroad]-road0l[pautoroad]*road0co1[pautoroad])+sin1*(y-road0y[pautoroad]-road0l[pautoroad]*road0si1[pautoroad]);
	               var dvv=0.08;dxx=Math.max(-dxx,-dyy);
				   if((dxx>1.0 || dxx<0.1)){dvv=Math.min(vcar,0.2);}
				   vrun=Math.min(0.4,vrun);vcar=Math.max(dvv,vcar-0.0065*dtime*(vcar+0.05));}}
}
function reseto3volant(){dtautopilot=0;o3volant=0;}
var x=0,y=0,z=0,o1=0,o2=-10,o3=0,vrun=0,vrunmax=1.5;
var cos1=0,sin1=0,cos2=0,sin2=0,cos3=0,sin3=0,do1=0,do2=0,do3=0; 
var xmin=-30000,xmax=30000,ymin=-30000,ymax=30000;
var quit=0,tmsg=0,tmsg2=0,lat0=lat,lng0=lng,latx=lat,lngx=lng;
var scale=0.3*windy/dlat,x00=0,y00=0;
scale=0.3*400/dlat;//scale*=0.8;
var scale0=scale,kscalex=1;
var tmap=0,dxmax=25,tfoot=0,vcar=0,t300=30;
var tmove=0,trot=0;
var tfocus=1,tdisplay=0,x0=0,y0=0,z0=0,tcar=0,vzz=0;
var o10=0,o20=0,o30=0,o100=0,o200=0,o300=0,tsizescreen=0;
var tscroll=0,tscale=0,tscale0=0,tgaz=0,vcruise=0.8;
var o2sol=0,o3sol=0,vcar0=0,vmx=0,vmy=0,vmz=0;
var vmx2=0,vmy2=0,vmz2=0,vmxyz0=0,tprop0=0;
var tcollide=0,zsol=0,troad=0,dtroad=0;
var o3volant=0,tjoyx=0,tfly=0,iview=0,vrunauto=0,vrunauto0=0,landing=1;
var winwidth=window.innerWidth-1;
var winheight=window.innerHeight;
var timer0=0,timer1=0,dttroad=0,lastz=0,dtinitmap=0;
var piloto10=0,tpiloto10=0,oldx=[],oldy=[],ioldxy=0,oldxy=0;
var lastcos1road=1,lastsin1road=0,lastxroad=0,lastyroad=0,ttunnel=0,lastlatx=0,lastlngx=0;
var zsolprev=0,troadprev=0,ttunnelprev=0,ttesttunnel=0,dzsol0=0,altz=0;
for(var i=0;i<=10;i++){oldx[i]=9999999;oldy[i]=9999999;}
function testkeys() {
if(tframe>tloadingreverse && tmap==0){
   getreverselocation();
   tloadingreverse=Math.max(tloadingreverse,tframe+4000);
   printlocationname();}
if(tsizescreen<(tframe-2000)){tsizescreen=tframe;
if(avgfps<8 && tmap==0){dxmax2=Math.max(13,dxmax2-2);}
if(avgfps>9 && tmap==0){dxmax2=Math.min(25,dxmax2+2);}
if(winwidth!=window.innerWidth || winheight!=window.innerHeight){
    winwidth=window.innerWidth;
	winheight=window.innerHeight;
	fullscreen-=1;sizescreen();
	}
}
if(tmsg<(tframe-150)){tmsg=tframe;
 var xx=Math.round(x),yy=Math.round(y),zz=Math.round(z*10)/10,oo1=Math.round(o1);
 var vv=Math.round(vcar*3000)/10;
 if(myisailship>=0){vv=Math.round(psailshipv[myisailship]*300)/10;}
 var pp=Math.round(vrun*1000)/10,oo2=Math.round(o2*10)/10,ff=Math.round(fps*10)/10,oo3=Math.round(o3*10)/10;
 var msg="x="+xx+"  y="+yy+"  z="+zz+"  v="+vv+"  prop="+pp
 if(test==1){msg+="  o1="+oo1+" o2="+oo2+" o3="+oo3;};
 msg+=" fps="+ff;
 //msg+=" tri="+ntri;
 if(distairportxx<4000){msg+=" airport="+parseInt(distairportxx);}
 if(auxvar!=null){msg+=" aux="+auxvar;}
 if(auxvar2!=null){msg+=" aux2="+auxvar2;}
 if(auxvar3!=null){msg+=" aux3="+auxvar3;}
 if(auxtext!=""){msg+=" auxt="+auxtext;}
 if(tfoot==0){msg+=" car";
              if(tfly==1){msg+=" fly";}
              else if(tautopilot==1){msg+=" auto";}
			  else if(tautopilot==2){msg+=" auto1";}}
 if(tfoot==1){if(tfly==1){msg+=" fly";};if(tascend==1){msg+=" ascend"};}
 if(myisailship>=0 && ianchorship==myisailship){msg+=" anchor";tascend=0;}
 if(tmap>=1){msg="lat="+lat+" lng="+lng+"  "+srtmfile;}
 document.getElementById('msg').value=msg;
 if(tmap==4 || tmap==6){document.getElementById('msgmap').value=msg;
        document.getElementById('msgmap').focus();}
 else if(tfocus==1 && tframe>tmsg2+10000){tmsg2=tframe;document.getElementById('msg').focus();}
 setvolume();
 setvol(myaudiojet,Math.max(0.002,0.5*200/(100+distboeing*distboeing)));
 setspeed(myaudiojet,0.95+0.4*10/(10+distboeing));
 settrottoir();
}
if(tframe>timejoy){timejoy=tframe+50;testjoystick();
}
tmove=0;trot=0;
//var vcar0=vcar;
var oo10=o1;
var testx=0,v=0.00000006*dtime,vv=0.00000015*200;if(testwater==1){v*=2;}
if(keys[vk_k] || b(4)){tfoot+=1;if(tfoot>1.1){tfoot=0;o2=0;o3=0;};
                       testzoom();resetkeys();reseto3volant();}
if(keys[vk_7]){month+=3.3;if(month>12.5){month-=12;};snowlat=9999;setsnow();resetkeys();}
	tgaz=0;
	//timer0=timer1;
	//timer1=timer();
	//var dt=timer1-timer;
	var dt=dtime;lastz=zsol;lastz=z-0.69;if(tfoot==0){lastz=z-0.8;}//timer1-timer0;
	if(dt>300){dt=300;}
	o10=o1;o20=o2;o30=o3;
	zsolprev=zsol;troadprev=troad;ttunnelprev=ttunnel;
	if(tinit<2 || tframe>ttesttunnel+10000){ttunnelprev=0;ttesttunnel=0;lastlatx=999;}
	if(tframe>ttesttunnel+4000 || lastlatx>99){zsol=getterrainheightcar(lngx,latx,lastz);}
	else{latx=lastlatx;lngx=lastlngx;
         x=((lngx-lng0)/klon)*scale;
         y=(latx-lat0)*scale;
         zsol=getterrainheightcar(lngx,latx,-999);}
	testwater=twater;
	if(troad==1){lastcos1road=cos1road;lastsin1road=sin1road;lastxroad=xroad;lastyroad=yroad;
	             lastlatx=latx;lastlngx=lngx;}
	if(troad==0 && troadprev==1 && ttunnelprev>=1 && lastlatx<99){
      if(ttunnelprev==2 && Math.random()<0.1){lastlatx=999;}
	  else{
	    if(tautopilot==0){soundcrash();}
	    var co1=lastcos1road,si1=lastsin1road;
		var dxx=3;if((x-lastxroad/2)*lastsin1road-(y-lastyroad/2)*lastcos1road>0){dxx=-dxx;}
	    lngx+=dxx*0.3*si1*klon/scale;
	    latx-=dxx*0.3*co1/scale;
	    x+=dxx*0.3*si1;y-=dxx*0.3*co1;pautoroad=-1;
		if((tautopilot==0 || Math.random()<0.75) && cos1*co1+sin1*si1<0){o1=diro1(-co1,-si1);cos1=-co1;sin1=-si1;}
		else{o1=diro1(co1,si1);cos1=co1;sin1=si1;}
	    zsol=zsolprev;
	    zsol=getterrainheightcar(lngx,latx,lastz);
		if(troad==0){
		  latx=lastlatx;lngx=lastlngx;
          x=((lngx-lng0)/klon)*scale;
          y=(latx-lat0)*scale;
		  ttesttunnel=tframe;
	      zsol=zsolprev;
	      zsol=getterrainheightcar(lngx,latx,-999);}
	}}
	ttunnel=0;if(troad==1){if(road0layer[ixyroad]<=-1){
	            if(road0layer[ixyroad]<=-2){ttunnel=1;}else{ttunnel=2;}}}
	if(ttunnel>=1){ttesttunnel=0;}
	if(tfly==1){if(tinit<=2){altz=Math.min(20,z-zsol);}else{z=altz+zsol;};}
	//else if(ttunnel==0 & ttunnelprev==0){
	//            if(tinit<=2){altz=Math.min(0.7,z-zsol);}else{z=altz+zsol;};}
    if (keys[vk_q]){
	   if(tfly==0 || tfoot==1){tfly=1;z+=dt*0.002;}
       else{tfly=0;}
	   resetkeys();}	   
    if (keys[vk_s]){z-=dt*0.002;}
    if(tfly==0){z=Math.min(Math.max(zsol+1.8,z-0.01),z);};
    if(z<zsol+0.55){if(tfoot==1){tfly=0;z=zsol+0.58;}
	                else{z=zsol+0.60;o2=Math.max(8,o2);soundpneu();}}
	if(tfoot==1){if(tfly==0){z=Math.min(zsol+5,z);z=Math.max(z-0.03,zsol+0.58);}
	             if(tascend==1){if(testcollide2(x,y,0.2)){z=Math.max(z,wallheight+0.25);}
			    }
     vcar=0;landing=1;vrun=0;//o3=0;
	 tcar=0;
	 if(keys[vk_a]){
	   if(myisailship<0){if(tascend==0){tascend=1;}else{tascend=0;};resetkeys();}
	   else{soundanchor();tascend=0;
	        if(ianchorship!=myisailship){ianchorship=myisailship;}else{ianchorship=-1;}
	        sleep(300);resetkeys();}}
	 if(tcollide==1){latx-=sin1*vv/4;lngx-=cos1*klon*vv/4;testx=1;tcollide=0;if(o2<-20){o2+=20;};}
	 if (keys[vk_left] || mouseleft || keys[vk_a] || joyx<-0.5 || button[5] || keys[58]) {o1+=dt*0.07;if(o1>180){o1-=360;o10-=360;};}
     if (keys[vk_right] || mouseright || keys[vk_e] || joyx>0.5 || button[7] || keys[60]) {o1-=dt*0.07;if(o1<-180){o1+=360;o10+=360;};}	  
	 if (joyx<-0.25) {o1-=joyx*dt*0.04;if(o1>180){o1-=360;o10-=360;};}
     if (joyx>0.25) {o1-=joyx*dt*0.04;if(o1<-180){o1+=360;o10+=360;};}	  
     if (keys[vk_up] || mouseup || keys[165]) {latx+=v*sin1;lngx+=v*cos1*klon;testx=1;}
     if (keys[vk_down] || mousedown) {latx-=v*sin1;lngx-=v*cos1*klon;testx=1;}	  
     if (joyy<-0.25) {latx-=0.9*joyy*v*sin1;lngx-=0.9*joyy*v*cos1*klon;testx=1;}
     if (joyy>0.25) {latx-=0.9*joyy*v*sin1;lngx-=0.9*joyy*v*cos1*klon;testx=1;}	  
     if (keys[vk_page_up] || mousepageup || joyz>0.5) {o2+=dt*0.04;}
     if (keys[vk_page_down] || mousepagedown || joyz<-0.5) {o2-=dt*0.04;}	  
	}else{tcar=1;}
	
/*if(tfoot==1){
  if(keys[vk_up]){latx+=v*sin1;lngx+=v*cos1*klon;test=1;}
  if(keys[vk_down]){latx-=v*sin1;lngx-=v*cos1*klon;test=1;}
  if(keys[vk_page_up]){o2+=dt*0.04;}
  if(keys[vk_page_down]){o2-=dt*0.04;}*/
/*if(tcar==1 && tmap==0){
  if(vcar>0.0001){
     v=0.0000001*vcar*dt;
     latx+=v*sin1;lngx+=v*cos1*klon;test=1;}
  if(keys[vk_up] || keys[vk_page_up]){vcar+=0.001*dt;if(vcar>1.0){vcar=1.0;}}
  if(keys[vk_down] || keys[vk_shift] || keys[vk_page_down]){
     if(vcar>=-0.001){vcar-=0.0005*dt;if(vcar<0){vcar=0;}
     }else if(keys[vk_down]){latx-=v*sin1;lngx-=v*cos1*klon;testx=1;}
  }else if(vcar<=0.0001){vcar=-0.002;};
  if(keys[vk_left]){o1+=dt*0.04;}
  if(keys[vk_right]){o1-=dt*0.04;}
}*/
if(tfly==1){
    testwater=0;landing=1;
}else{
	var h0=zsol,h1=zsol,h2=zsol,dx=1,dy=0.7;
	o2sol=0.04;o3sol=0;
	if(tcar==1 && tmap==0 && troad==0){
	  if(zsol>-0.04){
	   h0=getterrainheight2(x,y);
	   h1=getterrainheight2(x+dx*cos1-dy*sin1,y+dx*sin1+dy*cos1);
	   h2=getterrainheight2(x+dx*cos1+dy*sin1,y+dx*sin1-dy*cos1);
	   o2sol=Math.max(-80,Math.min(80,diro1(dx,(h1+h2)*0.5-h0)));
	   o3sol=Math.max(-80,Math.min(80,diro1(dy+dy,h2-h1)));
	  }else{
	   h0=getterrainheightwater(x,y);
	   h1=getterrainheightwater(x+dx*cos1-dy*sin1,y+dx*sin1+dy*cos1);
	   h2=getterrainheightwater(x+dx*cos1+dy*sin1,y+dx*sin1-dy*cos1);
	   o2sol=Math.max(-80,Math.min(80,diro1(dx*8,(h1+h2)*0.5-h0)));
	   o3sol=Math.max(-80,Math.min(80,diro1(dy*16,h2-h1)));
	   testwater=1;landing=1;
	  }
	  //h0=getterrainheight2(x,y);
	  //zsol=h0;
	}
    //if(tframe>dtroad+79.99 || troad==0){
        var xx=((lngx-lng0)/klon)*scale;
        var yy=(latx-lat0)*scale;
	    //troad=testroadcar(xx,yy,lastz,lat0,lng0,0.5);//}
	    if(keys[vk_z]==1 && keys[vk_shift]==0){troad=testroad(xx,yy,lat0,lng0,0.5);
	       if(troad==1){z=Math.max(zsol+3,zroad+3);o2road=0;}
		   resetkeys();
		}
	if(troad==0 && (tframe>dttroad+5000 || tframe<dtinitmap+5000)){
	            troad=testroad(xx,yy,lat0,lng0,0.5);
	            if(troad==1 && zroad<zsol-0.15){troad=0;zroad=zsol-0.15;}
				if(troad==1){
				o2road=Math.max(-50,Math.min(50,o2road));}
				}
	if(troad==1){
	        if(tfoot==1){zroad+=0.1;}
			zsol=Math.max(zsol,zroad);
			dttroad=tframe;
	        cos13=cos1road;sin13=sin1road;
			o2sol=Math.max(-80,Math.min(80,o2road));
            o3sol=Math.max(-80,Math.min(80,o3road));
			if(tfoot==0){o2=o2sol;o3=o3sol;};}
    else{cos13=cos1;sin13=sin1;}
	if(troad==0 || zroad>=zsol-0.1){if(z<zsol+0.48*tcar+0.2+testwater*0.5){
	          z=zsol+0.48*tcar+0.2;if(tfoot==0){o2=o2sol;o3=o3sol;}}}
	else if(z>zroad+0.69){z=zroad+0.68;zsol=zroad;}
	if(tcar==1 && (troad==0 || zroad>zsol-0.01)){
	   if(z>zsol+10){z=zsol+10;}
	   vzz-=dt*0.0006;if(vzz<-1.0){vzz=-1.0;}
	   if(z<zsol+0.70){if(vcar>0.003 && troad==0){
	                     if(o2<(o2sol-(0.05+vcar)/(0.003+vcar))){
						    soundpneu();}}
					   o2+=(o2sol-0.02-o2)/2;
                       cos2=Math.cos(degtorad(o2));
                       sin2=Math.sin(degtorad(o2));
					   landing=1;vzz=0;z=zsol+0.698;
	   }else{if(z>zsol+0.79){landing=0;}
             z+=(vzz-0.03)*dt*0.003;
	   }
	   z=Math.max(zsol+0.698,z);
	}
}//tfly	
    if(tcar==1 && tmap==0){
     if(tfly==0){	
	 if(tcollide==1 && tautopilot==0 && tframe>dtcollide){
	   var kvv=1+3*Math.max(0,vcar);
	   latx-=sin1*vv*kvv/4;lngx-=cos1*klon*vv*kvv/4;testx=1;tcollide=0;}
	 tcollide=0;
     if(isNaN(o3volant)){o3volant=0.0;}
	 var piloto1=0;
	 if(tautopilot>=1 && tframe>dtautopilot-2000 && troad==1){teststopcar();}
	 if(tautopilot>=1 && tframe>dtautopilot){
	     vrunauto0=Math.max(0.3,Math.min(1.0,vrunauto0));
	     vrun+=(vrunauto0-vrun)*dtime*0.0006;
		 if(troad==0){vrun=Math.min(vrunmax*0.45,Math.max(0.1,vrun));}
		 else{vrun=Math.min(vrunmax,Math.max(0.1,vrun));}
	     if(tupdatebuffer==0){
		    var kvrun=vrun/Math.max(0.1,vrunauto);vrun=vrunauto;findroad(1);//tautopilot);
			vrunauto=vrun;vrun=kvrun*Math.max(0.1,vrunauto);
			}
		 var do1pilot=o1pilot-o1;
		 while(do1pilot>180){do1pilot-=360;}
		 while(do1pilot<-180){do1pilot+=360;}
		 if(do1pilot>140 && troad==1){o1pilot=o1;do1pilot=0;pautoroad=-1;}
		 if(do1pilot<-140 && troad==1){o1pilot=o1;do1pilot=0;pautoroad=-1;}
		 if(Math.abs(do1pilot)>30 && vcar>0.08){vcar+=(0.08-vcar)*dtime*0.02;}
		 if(do1pilot>2){piloto1=Math.min(1,do1pilot/4);}
		 if(do1pilot<-2){piloto1=Math.max(-1,do1pilot/4);}
		 if(Math.abs(do1pilot)>2){
		    if(oldxy>40){ioldxy+=1;if(ioldxy>10){ioldxy=0;}
			                     oldx[ioldxy]=x;oldy[ioldxy]=y;
								 for(var i=0;i<=10;i++){
								  if(Math.abs(oldx[i]-x)+Math.abs(oldy[i]-y)<15 && i!=ioldxy){
								     for(var j=0;j<=10;j++){oldx[j]=9999999;};
									 tpiloto10=tframe+Math.random()*5000;break;}}
			                     oldxy=0;}}
         if(tframe<tpiloto10+2000){piloto1=0;}else{var vv=0.013*vcar;oldxy+=vv*dtime;}
	 for(var i=0;i<=ncar2;i++){
      if(i!=typecar && vcar>0.1){
	  var dxx=x+1.35*cos1+0.6*sin1-nx[i],testxx=0;
	  if(Math.abs(dxx)<1){
	    var dyy=y+1.35*sin1-0.6*cos1-ny[i];
	    if(Math.abs(dyy)<1 && Math.abs(nz[i]-z)<0.5){
		   var dxy=sin1*ncos1[i]-cos1*nsin1[i];
		   dxx=cos1*ncos1[i]+sin1*nsin1[i];
		   if(dxy<0.22 || dxx<0){
		      testxx=1;
			  if(dxx<0){vcar-=vcar*dtime*0.0022;piloto1=0.7;}
			  else{if(nvcar[i]>vcar-0.1){vcar+=vcar*dtime*0.002;vrun=1.29;
			                             nvcar[i]=vcar-0.1;nvrun[i]=0.15;};
										 piloto1=0.45;};
              if(o3volant<0){o3volant=0.0;}
			  break;}}}
	  if(testxx==0){
	    dxx=x+1.35*cos1-0.86*sin1-nx[i];
	    if(Math.abs(dxx)<1){
	      var dyy=y+1.35*sin1+0.86*cos1-ny[i];
	      if(Math.abs(dyy)<1 && Math.abs(nz[i]-z)<0.5){
		   var dxy=sin1*ncos1[i]-cos1*nsin1[i];
		   dxx=cos1*ncos1[i]+sin1*nsin1[i];
		   if(dxy>-0.21 || dxx<0){
			  if(dxx<0){vcar-=vcar*dtime*0.0022;piloto1=-0.5;}
			  else{if(nvcar[i]>vcar-0.1){vcar+=vcar*dtime*0.002;vrun=1.29;
			                             nvcar[i]=vcar-0.1;nvrun[i]=0.15;};
										 piloto1=-0.45;};
			  if(o3volant>0){o3volant=0.0;}
              break;}}}}
	  if(testxx==0){
	    dxx=x+1.349*cos1+1.03*sin1-nx[i];
	    if(Math.abs(dxx)<1){
	      var dyy=y+1.349*sin1-1.03*cos1-ny[i];
	      if(Math.abs(dyy)<1 && Math.abs(nz[i]-z)<0.5){
			  if(cos1*ncos1[i]+sin1*nsin1[i]>0){
			   piloto1=-0.6;if(o3volant>0){o3volant=0.0;}
			   if(nvcar[i]>vcar-0.1){vcar+=vcar*dtime*0.002;vrun=1.29;
			                                     nvcar[i]=vcar-0.1;nvrun[i]=0.15;}
			   break;}}}}
	  if(testxx==0){
	    dxx=x+1.349*cos1-1.03*sin1-nx[i];
	    if(Math.abs(dxx)<1){
	      var dyy=y+1.349*sin1+1.03*cos1-ny[i];
	      if(Math.abs(dyy)<1 && Math.abs(nz[i]-z)<0.5){
			  if(cos1*ncos1[i]+sin1*nsin1[i]>0){
			   piloto1=0.6;if(o3volant<0){o3volant=0.0;}
			   if(nvcar[i]>vcar-0.1){vcar+=vcar*dtime*0.002;vrun=1.29;
			                                     nvcar[i]=vcar-0.1;nvrun[i]=0.15;};
			   break;}}}}
	  }}
	 }else{oldxy=0;for(var j=0;j<=10;j++){oldx[j]=9999999;};}
	 }//tfly
	 if(landing==1 || tfly==1){
      if (joyy<-0.5 && vcar<0.1) {latx-=joyy*v*sin1/3;lngx-=joyy*v*cos1*klon/3;testx=1;}
      if (joyy>0.5) {latx-=joyy*v*sin1/4;lngx-=joyy*v*cos1*klon/4;testx=1;}	  
      if(Math.abs(o3volant)<10 || tfly==0){//40
	   if(o3volant>0.1){o3volant=Math.max(0.0,o3volant-dt*0.05/(1+tfly));}
	   if(o3volant<-0.1){o3volant=Math.min(0.0,o3volant+dt*0.05/(1+tfly));}
	  }
	  var ko3v=60.0/(60+Math.abs(o3volant));
	if(tmouse3move==1){
	  if (keys[vk_left] || mouseleft || keys[vk_a] || button[5] || keys[58]) {mouse3dx-=dtime*0.01;if(mouse3dx<-10){mouse3dx=-10;}}
      else if (keys[vk_right] || mouseright || keys[vk_e] || button[7] || keys[60]) {mouse3dx+=dtime*0.01;if(mouse3dx>10){mouse3dx=10;}}
	  else if (piloto1>0.1) {o3volant+=piloto1*ko3v*dt*0.18/(1+tfly);
	                         if(o3volant>64+tfly*40){o3volant=64+tfly*40;};}
      else if (piloto1<-0.1) {o3volant+=piloto1*ko3v*dt*0.18/(1+tfly);
	                         if(o3volant<-64-tfly*40){o3volant=-64-tfly*40;};}
	  if(Math.abs(joyx)>0.15){tjoyx=tframe;}
	  if(tframe<tjoyx+900){o3volant+=(-80*joyx-o3volant)*Math.min(1,ko3v*dt*0.003/(1+tfly));
	                       o3volant=Math.max(-64,Math.min(64,o3volant));}
    }else{
	  o1head=0;
	  if(keys[vk_space]){
	   if (keys[vk_left] || mouseleft || keys[vk_a] || button[5] || keys[58]) {o1head=65;}
       else if (keys[vk_right] || mouseright || keys[vk_e] || button[7] || keys[60]) {o1head=-65;}
       else if (keys[vk_down] || mousedown) {o1head=170;};
	  }else{
	   if (keys[vk_left] || mouseleft || keys[vk_a] || button[5] || keys[58]) {o3volant+=ko3v*dt*0.18/(1+tfly);
	                     if(o3volant>64+tfly*40){o3volant=64+tfly*40;};pautoroad=-1;pautoroad0=-1;
	                                                dtautopilot=tframe+3000;}
       else if (keys[vk_right] || mouseright || keys[vk_e] || button[7] || keys[60]) {o3volant-=ko3v*dt*0.18/(1+tfly);
	                     if(o3volant<-64-tfly*40){o3volant=-64-tfly*40;};pautoroad=-1;pautoroad0=-1;
	                                                dtautopilot=tframe+3000;}												
	  else if (piloto1>0.1) {o3volant+=piloto1*ko3v*dt*0.18/(1+tfly);if(o3volant>64){o3volant=64;};}
      else if (piloto1<-0.1) {o3volant+=piloto1*ko3v*dt*0.18/(1+tfly);if(o3volant<-64){o3volant=-64;};}
	  if(Math.abs(joyx)>0.15){tjoyx=tframe;}
	  if(tframe<tjoyx+900){o3volant+=(-80*joyx-o3volant)*Math.min(1,ko3v*dt*0.003/(1+tfly));
	                       o3volant=Math.max(-64,Math.min(64,o3volant));}
	}}
	  var o3volant2=o3volant;
	  if(tfly==1){o3=o3volant/1.5;o3volant2=o3volant/4;}
	  if(Math.abs(o3volant)>0.01){//0.2
	     var vcar3=vcar*0.5/(0.5+Math.abs(vcar));
		 var do13=0;
	     if(tframe<tjoyx+900){do13=0.00078*o3volant2*(vcar3+sign(vcar+0.001)*0.02)/(0.045+Math.abs(vcar));
	     }else{do13=0.00067*o3volant2*(vcar3+sign(vcar+0.001)*0.02)/(0.045+Math.abs(vcar));}   
		 if(Math.abs(do13)>0.021/(1.0+2.7*Math.abs(vcar))){soundpneu();
		   if(do13>0.04){do13=0.04;}
		   if(do13<-0.04){do13=-0.04;}
		 }
		 o1+=do13*dt;	
		 if(o1>360){o1-=360;o10-=360;}
		 if(o1<-360){o1+=360;o10+=360;}
	  }
      //if (keys[38] || joyy<-0.5) {x+=dt*0.002*cos1;y+=dt*0.002*sin1;if(vcar<0){vcar=0;}}
      //if (keys[40] || joyy>0.5) {x-=dt*0.002*cos1;y-=dt*0.002*sin1;}	  
	  //if(Math.abs(vcar0-vcar)>(0.1+Math.abs(vcar0))*0.00001*dt){
      //	 soundpneu();}
      //if(vcar0<vcar){planedo2+=Math.min(1,0.01*dt)*(diro1(240,(vcar0-vcar)*dt)-planedo2);
	  //}else{planedo2+=Math.min(1,0.01*dt)*(diro1(140,(vcar0-vcar)*dt)-planedo2);}
      //if(vcar0<vcar){planedo2+=(diro1(240,(vcar0-vcar)*dt)-planedo2);
	  //}else{planedo2+=(diro1(140,(vcar0-vcar)*dt)-planedo2);}
     if(tfly==0){
	  //if(vcar0<vcar){planedo2+=Math.min(1,0.01*dt)*(diro1(50,(vcar0-vcar)*dt)-planedo2);
	  //}else{planedo2+=Math.min(1,0.01*dt)*(diro1(30,(vcar0-vcar)*dt)-planedo2);}
	  vcar0=vcar;planedo2=0;
      var vmxyz=Math.sqrt(vmx*vmx+vmy*vmy+vmz*vmz);
      if(Math.abs(vmxyz0-vmxyz)>(0.1+vmxyz0)*0.00001*dt){
         soundpneu();}
	  vmxyz0=vmxyz;
      }	  
	 }else{
	   if (keys[vk_left] || mouseleft || keys[vk_a] || button[5] || keys[58]) {o3volant+=ko3v*dt*0.18/(1+tfly);if(o3volant>64){o3volant=64;};pautoroad=-1;pautoroad0=-1;
	                                                dtautopilot=tframe+3000;}
       else if (keys[vk_right] || mouseright || keys[vk_e] || button[7] || keys[60]) {o3volant-=ko3v*dt*0.18/(1+tfly);if(o3volant<-64){o3volant=-64;};pautoroad=-1;pautoroad0=-1;
	                                                dtautopilot=tframe+3000;}												
	 }
   	 var vrun10=vrun;
	 if(tfly==0){
	  if (keys[vk_up] || mouseup || keys[165]) {vrun+=dt*0.0009;tgaz=1;
         if(vcar<0.051){latx+=v*sin1/2;lngx+=v*cos1*klon/2;}}
      if ((keys[vk_down] || mousedown)&& keys[vk_space]==0){vrun-=dt*0.0009;if(vrun<0){vrun=0;};
         if(vcar<0.015 && vrun<0.001){latx-=v*sin1/2;lngx-=v*cos1*klon/2;vcar=-0.05;
					 tbrakes=tframe;
		 };}
		 //if (keys[33] || keys[vk_n] || button[1]) {vrun+=dt*0.0003;tgaz=1;};
     //if (keys[34] || keys[vk_b] || button[2]) {vrun-=dt*0.0003;if(vrun<0){vrun=0;};};
	 //if(tgaz==0){if(vrun>1.50){vrun=1.50;};}
     }else{
	   if(z>zsol+40){z-=dt*0.0007;}
       if (keys[vk_up] || mouseup || joyy<-0.5){o2-=dt*0.0344*cos3*Math.abs(cos3);o1-=dt*0.014*sin3;}
       if (keys[vk_down] || mousedown || joyy>0.5){o2+=dt*0.0344*cos3*Math.abs(cos3);o1+=dt*0.014*sin3;}	  
	 }
	 if (keys[vk_page_up] || mousepageup || keys[vk_n] || button[1]) {vrun+=dt*0.0009;tgaz=1;};
     if (keys[vk_page_down] || mousepagedown || keys[vk_b] || button[2]) {vrun-=dt*0.0009;if(vrun<0){vrun=0;};
					 tbrakes=tframe;
	                                           vcar-=0.0014*dt*(vcar+0.05);
											   if(vcar<0.001){vcar=0.001;};
				         if(vcar<0.005 && vrun<0.001 && button[2]){latx-=v*sin1;lngx-=v*cos1*klon;vcar=-0.05;};}
     if (keys[vk_shift] || button[6] || keys[vk_end]) {//vrun-=dt*0.0009;if(vrun<0){vrun=0;};
	                 //vcar-=0.0022*dt*(vcar+0.05);
					 tbrakes=tframe;
	                 vcar-=0.0022*dt*(Math.min(vcar,0.3)+0.05);
		             if(vcar<0.001){vcar=0.001;};}
     if (keys[vk_down] && Math.abs(vrun)<0.01) {//vrun-=dt*0.0009;if(vrun<0){vrun=0;};
	                 //vcar-=0.0022*dt*(vcar+0.05);
					 tbrakes=tframe;
	                 vcar-=0.0022*dt*(Math.min(vcar,0.3)+0.05);
		             if(vcar<0.001){vcar=0.001;};}
	 if(tgaz==0){if(vrun>vrunmax){vrun=vrunmax;};
	 }else{if(vrun>vrunmax+0.2){vrun=vrunmax+0.2;}}
	 
	//var air=(5000-z)/(5000+z);if(air<0){air=0;};
	var air=(20000-z)/(20000+z);if(air<0){air=0;};
	//vcar+=0.4*((vrun-vcar)*0.0013*0.8*air*dt-dt*(air*0.0003*vcar+sin2*0.004));
	var kair=vrunmax/1.3;
	var vrun2=1;
	if(vrunmax<2.01){
	   vrun2=vrun*((3-1.4*vcar/kair)/2)*3*air*air/(2+air*air);
	}else{
	   vrun2=vrun*((3-1.4*vcar/kair)/2)*3*air*air*((2+kair)/3)/(2+air*air*kair);
	}
	if(Math.abs(vrun-vrun10)>0.0005*dtime){vrunauto0=vrun;}
	var kv=1;
    if(landing==0){kv=0;}
    vcar+=(kv*(vrun)*0.00082*dt-dt*(kv*0.003*vcar+(sin2+0.01)*0.0020));	
    if(landing==1 && vcar>-0.01 && vcar<0.01){vcar=0;}	   	
	if(vcar>4.5){vcar=4.5;}//max vv=900
	if(vcar<-0.5){vcar=-0.5;}//min vv=-100
    vcruise=2;if(tfly==1){vcruise=0.3;}
	if(landing==0 || (tfly==1 && z>zsol+0.79)){
	 o2+=(vcar*air-vcruise)*cos2*dt*0.004*(1+tfly*5);
    }else if(troad==0){o2+=(o2sol-0.02-o2)/2;}
	if(o3>0.1){o3-=dt*0.001;}
	else if(o3<-0.1){o3+=dt*0.001;}
	//else if(landing==1){o3=0;}
	if(landing==1 && (tfly==0 || z<=zsol+0.79)){
	  if(tfly==1 && lastz>zsol+0.792){soundpneu();}
	  if(o2<o2sol-0.02){o2=o2sol-0.01;do2=0;};
	  //if(tpiste==1 && vcar<0.07){o2=0;do2=0;sin2=0;}
	  if(o2>o2sol+0.1 &&(vcar<0.05 || tcar==1)){o2=Math.max(o2sol,o2-dt*0.0005);};
	  if(keys[vk_page_down]){vcar-=0.00145*dt*(vcar+sign(vcar)*0.003);};
	  if(vcar>0.01){vcar-=Math.min(0.9,0.00063*dt)*vcar;}
	  o3=o3sol;if(vcar<0.01 &&(vcar>(0) || tcar==0)){vcar=0.00001;}
	  }
     if(tframe>dtroad+80 && tfly==0){
	     dtroad=tframe;
	     if(troad==1 && landing==1){
	        o2=o2sol;o3=o3sol;}
		 if(landing==1 && vcar>0.01 && troad==0 && zsol>0){
             o2+=(Math.random()-0.5)*5*vcar;
             o3+=(Math.random()-0.5)*7*vcar;
		  }
	  }
	var kfly=1+tfly*3;  
	var dt1=dt*0.002;
	if(dt1>0.8){dt1=0.8;}
	do3+=((o3-o30)-do3)*dt1;
	do2+=((o2-o20)-do2)*dt1;
	do1+=((o1-o10)-do1)*dt1;
	o1+=do1*dt*0.001*kfly;
	o2+=do2*dt*0.0025*kfly;
	o3+=do3*dt*0.0025*kfly;
	if(Math.abs(o3)<1.6){o3+=Math.cos(timer()*0.0015)*0.2*(1.6-Math.abs(o3));};
	vcarz=vcar*sin2;
  }

if(keys[vk_n] && keys[vk_shift]){subncar();resetkeys();}
if(keys[vk_p]){subautopilot();resetkeys();}
if(keys[vk_r]){if(keys[vk_shift]){subsrtm();}
               else{subradio();};resetkeys();}  
if(keys[vk_t] && keys[vk_shift]==0){//subtower();
                                 if(tmouse3move==0){tmouse3move=1;}else{tmouse3move=0;}
                                 resetkeys();}  
if(keys[vk_t]  && keys[vk_shift]) {thour+=3.5;if(thour>24){thour-=24;};
    hour=new Date().getHours()+thour;
	while(hour>24){hour-=24;}
	while(hour<0){hour+=24;}
	tupdatesun=0;train=0;train1=0;train2=0;
    alert("timehour = "+hour);resetkeys();}
if(keys[vk_s] && keys[vk_shift]) {keys[vk_s]=0;keys[vk_shift]=0;subcookie();}
if(keys[vk_l]){keys[vk_l]=0;if(keys[vk_shift]==0){
   tlight+=1;if(tlight>1){tlight=0;}}
   else{quit=1;setlink();return;};}
if(keys[27]){quit=1;subquit();return;}
if(keys[vk_4]){subcssscale();resetkeys();} 
if(keys[vk_3]){keys[vk_3]=0;sizescreen();}
if(tfoot==0){
 if(keys[vk_1] && keys[vk_2]){cockpith=0;resetkeys();}
 if(keys[vk_1]){cockpith+=1;resetkeys();if(cockpith>20){cockpith=20;};}
 if(keys[vk_2]){cockpith-=1;resetkeys();if(cockpith<-20){cockpith=-20;};}
}
if(keys[vk_9]){subtest();resetkeys();}
if(keys[vk_o]){suboverpass(1);resetkeys();}
if(keys[vk_z] & keys[vk_shift]){subscaleh();resetkeys();}
if(keys[vk_x] & keys[vk_shift]){subscalex();resetkeys();}
if(keys[vk_0]){subgirlimage();sleep(200);resetkeys();}
if(keys[169]){subtgirlimage();sleep(200);resetkeys();}//')'
if(keys[61]){subgirlimage3();sleep(200);resetkeys();}//'='
if(keys[vk_f]){subfog();resetkeys();}
if(keys[vk_e] && keys[vk_shift]){subgirl();resetkeys();}
if(keys[vk_h]){if(keys[vk_shift]==0){subhelp();}else{subshadow();};resetkeys();}
if(keys[vk_v]){keys[vk_v]=0;iview+=1;if(iview>2){iview=0;};
               if(tfly==0 || iview==0){reseto3volant();};
               o1view=o1;}
if(keys[vk_g]){keys[vk_g]=0;
   if(keys[vk_shift]){geolocate();}
   else if(tfoot==1){tminimap2+=1;if(tminimap2>1){tminimap2=0;}}
   else{tminimap+=1;if(tminimap>1){tminimap=0;}}
   testzoom();
   resetkeys();}
if(keys[vk_m]){
 if(keys[vk_shift]==1){substreetview();}
    //if(tmap==0){tmap=4;showmap();map.setCenter(new google.maps.LatLng(latx,lngx));updatemarker();}
    //else{tmap=0;hidemap();}}
 else{ 
   if(tmap==0){tmap=2}
   else if(tmap==2){tmap=1;}
   else if(tmap==1){tmap=3;}
   //else if(tmap==3){tmap=5;substreetview2();}
   //else if(tmap==5){tmap=4;quitstreetview();showmap();map.setCenter(new google.maps.LatLng(latx,lngx));updatemarker();}
   else if(tmap==3){tmap=4;showmap();map.setZoom(20-testwater*6);
                    map.setCenter(new google.maps.LatLng(latx,lngx));updatemarker();
					scrollTo(0,4000);}
   else if(tmap==4){tmap=6;showmap();map.setZoom(14-testwater);
                    map.setCenter(new google.maps.LatLng(latx,lngx));updatemarker();
					scrollTo(0,4000);}
   //else if(tmap==4){tmap=5;substreetview2();}
   //else if(tmap==5){tmap=0;quitstreetview();}
   else{tmap=0;}
   if(tmap!=4 && tmap!=6){hidemap();}
   context.clearRect (0,0,canvas.width,canvas.height);
   //if(tmap>3){tmap=0;
   //           //canvas.height = parseInt(canvasgl.height/3);
   //   		  context.clearRect(0,0,canvas.width,canvas.height);}
   //else{canvas.height = parseInt(canvasgl.height);}
   }
   sleep(200);
   resetkeys();}
if(keys[vk_space] && tmap>0){
   if(tmap==5){quitstreetview();}
   tmap=0;
   hidemap();
   context.clearRect(0,0,canvas.width,canvas.height);
   resetkeys();}
if(keys[vk_c]){
   if(keys[vk_shift]==0){
   tcloud+=1;if(tcloud>2){tcloud=0;}}
   else{subcollide();}
               resetkeys();}
//x=((lngx-lng0)/klon)*scale;
//y=(latx-lat0)*scale;
    
    if(o2>85){o2=85;}//o1=180+o1-o3;o3=180;};
    if(o2<-85){o2=-85}//;o1=180+o1+o3;o3=0;};
	while(o1>180){o1-=360;} 
	while(o1<-180){o1+=360;}
	while(o3>180){o3-=360;}
	while(o3<-180){o3+=360;}
    cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
    cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
    cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));

if(tmap==0 && tfoot==0){
	var vv=0.013*vcar;
	 vmx2=vv*cos1*cos2;
	 vmy2=vv*sin1*cos2;
	 vmz2=vv*sin2;
	 var kv=Math.min(1,dt*0.001);
	 if((keys[vk_shift] || keys[vk_end] ||  button[6]) && landing==1){
			  vmx2*=0.2;vmy2*=0.2;vmz2*=0.2;}
	 if(landing==1 && tfly==0){
	  var kv2=Math.abs((-vmx*sin1+vmy*cos1)*cos2-vmz*sin2);
	  if(kv2>0.0005*(1+troad)){soundpneu();}
	  kv2=Math.min(0.9,dt*0.0025*kv2/Math.sqrt(0.001+vmx*vmx+vmy*vmy+vmz*vmz));
	  vmx-=kv2*vmx;
	  vmy-=kv2*vmy;
	  vmz-=kv2*vmz;
	 }
	 vmx+=(vmx2-vmx)*kv;
	 vmy+=(vmy2-vmy)*kv;
	 vmz+=(vmz2-vmz)*kv;
x=((lngx-lng0)/klon)*scale;
y=(latx-lat0)*scale;
     var kvx=0.8;
	 x+=vmx*dt*kvx;
	 y+=vmy*dt*kvx;
	 z+=vmz*dt*kvx;
	 lngx=(x/scale)*klon+lng0;
	 latx=y/scale+lat0;
     vv=vmx*cos1*cos2+vmy*sin1*cos2+vmz*sin2;
	 vcar=vv/0.013;
     planedo3=diro1(0.045,vmx*sin1*cos2-vmy*cos1*cos2);	 

    /*auxvar=vcar-vcar0;
	if(Math.abs(vcar-vcar0)>0.0005*dtime){
	     soundpneu();}
    if(Math.abs(o1-oo10)>0.0005*dtime){
	     soundpneu();}*/
 }else{
  x=((lngx-lng0)/klon)*scale;
  y=(latx-lat0)*scale;
 }

    if(Math.abs(x-x0)+Math.abs(y-y0)>0.1){
       tmove=1;x0=x;y0=y;tmovertt=1;}
	if(Math.abs(o1-oo10)>0.001*dt){trot=1;}
	if(tmove==1 || trot==1){
	 if(troad==0 && tfly==0){
	  if(zsol<-0.04 || testwater==1){soundwater();}}
	}
	if(zsol<0.2 && testwater==1 && troad==0){soundocean();};

testx=0;
if(loading==0){dtloading=Math.max(tframe-4000,Math.min(dtloading,tframe+4000));}
if(tframe>dtloading+40000){dtloading=tframe;resetkeys();changeioverpass();
	      tloadsol=tframe+50000;
		  tdrawsol=tframe+9900;
		  tupdatesoltexture=2;loading=77;tdraw=0;tdraw2=0;
		  updatesoltexture();return;}
if(loading==0){
 //if(Math.max(Math.abs(x-x00),Math.abs(y-y00))>Math.min(24,dxmax*1.2)){testx=1;}
 //if(Math.max(Math.abs(x-x00),Math.abs(y-y00))>dxmax*1.2 || testiiways()){testx=1;}
 if(testiiways()==1){testx=1;}
}
if(testx==1 && loading==0){testx=0;//loading=-2;
   msgload("testx");
   //resetkeys();
   dtloading=tframe;
   trygetways=1;//getways();
   }

     if(Math.abs(o1-o10)+Math.abs(o2-o20)>dt*0.014){tscroll+=dtime;}
     else if(Math.abs(o3-o30)>dt*0.014){tscroll+=dtime;}
     else{tscroll=0;}
     if(tscroll>300){tscroll=500;if(fps<10){tscale=1;}}
	 else{tscale=0;}
     if(tscale!=tscale0){tscale0=tscale;
       if(tscale==1){subscale(1.5);}else{subscale(1);}}
	   
	 timestreetview=tframe+200;
	 altz=Math.min(44,z-zsol);
	 if(mysailshipz>-8){z=mysailshipz;}
}
var timestreetview=0;
function teststreetview(){
if(tframe<timestreetview+1000){return;}
timestreetview=tframe;
if(loading==0){
 loadstreetviewstorage();
 x=((lngx-lng0)/klon)*scale;
 y=(latx-lat0)*scale;
 //if(Math.max(Math.abs(x-x00),Math.abs(y-y00))>dxmax*1.2 || testiiways()){
 if(testiiways()){
   //msgload("testx");
   //resetkeys();
   dtloading=tframe;
   trygetways=1;//getways();
   }}
loadstreetviewmsg();
if(streetviewmsg=="quit"){quitstreetview();}
}
var tilat1=0;
function resetiiways(){
for(var i=0;i<=6;i++){iwaylat[i]=91;iwaydlat[i]=0;}
iways[0]=[];iways[1]=[];iways[2]=[];iways[3]=[];iways[4]=[];iways[5]=[];iways[6]=[];
inodes[0]=[];inodes[1]=[];inodes[2]=[];inodes[3]=[];inodes[4]=[];inodes[5]=[];inodes[6]=[];
}
function testiiways(){
//if(Math.abs(ilat-lat)<dlat/2 && Math.abs(ilng-lng)<dlon/2){tilat=1;}
//if(tilat==0){
 var testilat=0;
 var latxx0=latx+sin1*dxmax/scale;
 var lngxx0=lngx+cos1*dxmax*klon/scale;
 for(var i=0;i<=4;i++){
  if(Math.abs(iwaylat[i]-latxx0)<iwaydlat[i]/4 && Math.abs(iwaylng[i]-lngxx0)<iwaydlng[i]/4){
       testilat=1;break;}
 }
 if(testilat==0){tilat1=0;return 1;}
 var dlat1=dxmax*5/scale;
 var dlon1=dlat1*klon;
 latxx0+=sin1*dlat1/1.75;
 lngxx0+=cos1*dlon1/1.75;
 testilat=0;
 for(var i=0;i<=4;i++){
  if(Math.abs(iwaylat[i]-latxx0)<iwaydlat[i]/4 && Math.abs(iwaylng[i]-lngxx0)<iwaydlng[i]/4){
       testilat=1;break;}
 }
 if(testilat==0){tilat1=1;return 1;}
 return 0; 
//} 
}
function testiiways0(){
  var dist0=9999999,dist1=dxmax*1.2/1.5;
  var latxx0=latx+sin1*dxmax*0.74/scale;
  var lngxx0=lngx+cos1*dxmax*0.74*klon/scale;
  //if(Math.abs(ilat-latxx0)<dlat/4 && Math.abs(ilng-lngxx0)<dlon/4){return 0;}
  for(var i=0;i<=4;i++){var dx=Math.abs(iwaylat[i]-latxx0)*scale*dlat/(dlat/4+iwaydlat[i]);
                        var dy=(Math.abs(iwaylng[i]-lngxx0)/klon)*scale*dlon/(dlon/4+iwaydlng[i]);
                        var dist=dx*dx+dy*dy;
                        if(dist0>dist){dist0=dist;}}
  if(dist0>dist1*dist1*0.8*0.8){return 1;}
  return 0;
}
function movecar(){
if(tmap==0){
	var vcar00=vcar;
	var dt=dtime,lastz=zsol;
	if(dt>300){dt=300;}
	zsol=getterrainheight(lngx,latx);
	var h0=zsol,h1=zsol,h2=zsol,dx=1,dy=0.7;
	var o2sol=0.04,o3sol=0;
    var xx=((lngx-lng0)/klon)*scale;
    var yy=(latx-lat0)*scale;
    var troad=testroadcar(xx,yy,lastz,lat0,lng0,0.5);
	if(troad==0 && (tframe>dttroad+5000 || tframe<dtinitmap+5000)){
	            troad=testroad(xx,yy,lat0,lng0,0.5);
	            if(troad==1){
				o2road=Math.max(-50,Math.min(50,o2road));}
				}
	if(troad==0){
	  h1=getterrainheight2(x+dx*cos1-dy*sin1,y+dx*sin1+dy*cos1);
	  h2=getterrainheight2(x+dx*cos1+dy*sin1,y+dx*sin1-dy*cos1);
	  //h0=getterrainheight2(x,y);
	  //zsol=h0;
	  o2sol=Math.max(-80,Math.min(80,diro1(dx,(h1+h2)*0.5-h0)));
	  o3sol=Math.max(-80,Math.min(80,diro1(dy+dy,h2-h1)));
	}
	if(troad==1){zsol=zroad;//Math.max(zsol,zroad);
			o2sol=Math.max(-80,Math.min(80,o2road));
            o3sol=Math.max(-80,Math.min(80,o3road));
			carvisible=1;
    }
	o2=o2sol;o3=o3sol;
	z=zsol+0.69;
	 if(o3volant>0.1){o3volant=Math.max(0,o3volant-dt*0.05/(1+tfly));}
	 if(o3volant<-0.1){o3volant=Math.min(0,o3volant+dt*0.05/(1+tfly));}
	 var piloto1=0;
	     if(tupdatebuffer==0){
		    findroad(0);if(typecar>0 && vrun<nvrun[0] && vrun<130){
			vrun+=(nvrun[0]-vrun)*Math.min(1.0,dtime*0.003);}}//1/3
         if(typecar>0){teststopcar();}
		 var do1pilot=o1pilot-o1;
		 while(do1pilot>180){do1pilot-=360;}
		 while(do1pilot<-180){do1pilot+=360;}
		 if(do1pilot>2){piloto1=Math.min(1,do1pilot/4);}
		 if(do1pilot<-2){piloto1=Math.max(-1,do1pilot/4);}
	 for(var i=0;i<=ncar2;i++){
	  var dxy=cos1*ncos1[i]+sin1*nsin1[i];
      if(i!=typecar && ((nvcar[i]<vcar && dxy>0.92) || dxy<0)){	 
	  var dxx=x+1.5*cos1+0.64*sin1-nx[i],testxx=0;
	  if(Math.abs(dxx)<1){
	    var dyy=y+1.5*sin1-0.64*cos1-ny[i];
	    if(Math.abs(dyy)<1 && Math.abs(z-nz[i])<0.5){
		      piloto1=0.7;testxx=1;vcar-=vcar*dtime*0.005;break;}}
	  if(testxx==0){
	    dxx=x+1.5*cos1-0.64*sin1-nx[i];
	    if(Math.abs(dxx)<1){
	      var dyy=y+1.5*sin1+0.64*cos1-ny[i];
	      if(Math.abs(dyy)<1 && Math.abs(z-nz[i])<0.5){
		      piloto1=-0.5;vcar-=vcar*dtime*0.005;break;}}
	  }}}
	  var ko3v=60/(60+Math.abs(o3volant));
	  if (piloto1>0.1) {o3volant+=piloto1*ko3v*dt*0.18;if(o3volant>64){o3volant=64;};}
      if (piloto1<-0.1) {o3volant+=piloto1*ko3v*dt*0.18;if(o3volant<-64){o3volant=-64;};}
	  if(Math.abs(o3volant)>0.2){
	     var vcar3=vcar*0.5/(0.5+Math.abs(vcar));
		 var do13=0;
	     do13=0.00067*o3volant*(vcar3+sign(vcar+0.001)*0.02)/(0.045+Math.abs(vcar));   
		 if(do13>0.04){do13=0.04;}
		 if(do13<-0.04){do13=-0.04;}
		 o1+=do13*dt;	
		 if(o1>360){o1-=360;}
		 if(o1<-360){o1+=360;}
	  }
    if(o2>85){o2=85;}//o1=180+o1-o3;o3=180;};
    if(o2<-85){o2=-85}//;o1=180+o1+o3;o3=0;};
	while(o1>180){o1-=360;} 
	while(o1<-180){o1+=360;}
	while(o3>180){o3-=360;}
	while(o3<-180){o3+=360;}
    cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
    cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
    cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));

	var kv=1;
    vcar+=(kv*(vrun)*0.00082*dt-dt*(kv*0.003*vcar+(sin2+0.01)*0.0020));	
	if(vcar>4.5){vcar=4.5;}//max vv=900
	if(vcar<-0.5){vcar=-0.5;}//min vv=-100

	var vv=0.013*vcar;
	 vmx2=vv*cos1*cos2;
	 vmy2=vv*sin1*cos2;
	 vmz2=vv*sin2;
	 var kv=Math.min(1,dt*0.001);
	  var kv2=Math.abs((-vmx*sin1+vmy*cos1)*cos2-vmz*sin2);
	  kv2=Math.min(0.9,dt*0.0025*kv2/Math.sqrt(0.001+vmx*vmx+vmy*vmy+vmz*vmz));
	  vmx-=kv2*vmx;
	  vmy-=kv2*vmy;
	  vmz-=kv2*vmz;
	 
	 vmx+=(vmx2-vmx)*kv;
	 vmy+=(vmy2-vmy)*kv;
	 vmz+=(vmz2-vmz)*kv;
x=((lngx-lng0)/klon)*scale;
y=(latx-lat0)*scale;
     var kvx=0.8;
	 x+=vmx*dt*kvx;
	 y+=vmy*dt*kvx;
	 z+=vmz*dt*kvx;
	 lngx=(x/scale)*klon+lng0;
	 latx=y/scale+lat0;
     vv=vmx*cos1*cos2+vmy*sin1*cos2+vmz*sin2;
	 vcar=vv/0.013;
}
if(vcar<vcar00*(1.0-dtime*0.0001)){tbrakes=tframe;}
}
var tvolume=0,tspeed=0;
function setvolume(){
    var dpitch=0;
        if(tgirl>=5){dpitch=0.11;}//carTexture.image.src = "ford.png";}
        else if(tgirl>=4){dpitch=0.12;}//carTexture.image.src = "mercedes.png";}
        else if(tgirl>=3){dpitch=0.1;}//carTexture.image.src = "cadillac.png";}
        else if(tgirl>=2){dpitch=0.02;}//carTexture.image.src = "volvo.png";}
        else if(tgirl>=1){dpitch=0.03;}//carTexture.image.src = "toyota.png";}
        else{dpitch=0;}//carTexture.image.src = "chevy2.png";}//"chevy.jpg";
    //testsounds();
    var volume=(0.09+(Math.max(0,vcar)*0.5047+vrun*0.4033)*0.9);
	if(tgaz==1){volume+=0.10;}
	if(tcar==1){volume+=0.27+0.05*Math.max(0,Math.min(5,planedo2));}
	volume*=(1+0.1*Math.sin(tframe*0.003));
	if(volume>1){volume=1;};
    var speed=(0.14+(Math.max(0,vcar)*0.79+vrun*0.1)*0.9);
	if(tgaz==1){speed+=0.10;}
	if(tcar==1){speed=(speed+0.27)*(1+dpitch);}
	if(speed>1){speed=1;};
	if(Math.abs(tvolume-volume)<0.0025 && Math.abs(tspeed-speed)<0.0025){return;}
	tvolume=volume;tspeed=speed;
	var volume0=0.45*volume,volume1=0.32*volume;
	//var volume0=0.35*volume,volume1=0.85*volume;
if(twebaudio==1 && tradio==0){
  if(tfoot==1){
	setvol(myaudiocar,0.01);
  }else if(tcar==1){
	setvol(myaudiocar,volume*0.20);
	setspeed(myaudiocar,speed*1.65);
  }  
}
}

    var pix=new Uint8Array(16);
    var tframe=0,tframe0=0,tfps=30,fps=10,dtime=1,tmsg=0,clearr,clearg,clearb,tskip=0;
	var ttimeout=0,testloop=0,tskip2=0,tsrtm=0,itime=0,tinit=0,dtinit=0,timeinit=0;
	var tmovertt=0,nextdx=0,nextdy=0,avgfps=10,trttok=1,ttestmouse=0;
	var sunxsave=sunx,sunysave=suny,sunzsave=sunz;
	function tick(tt) {
        //requestAnimFrame(tick);
        if(quit==0 && testloop==0 && ttimeout==0){
		   //if(tfoot==0 && tcollideon==1 && tautopilot==0){
		      //testcollide();}
		   testloop=1;requestAnimationFrame(tick);
        }else{testloop=0;};
		updatesun();
		sunxsave=sunx;sunysave=suny;sunzsave=sunz;
		if(tshadownight==1){sunx=x-0.1*cos1*cos2;suny=y-0.1*sin1*cos2;sunz=z-0.1*sin2+0.051;}
		itime+=1;if(itime>10000){itime=0;}
		if(itime%8==1){testchurch();}
		//tframe0=tframe;
		//tframe=timer();
		dtime=tframe-tframe0;
		if(dtime>180){dtime=180;}
		if(tgamesave==1){ttestmouse=tframe+2000;}
		if(tframe<ttestmouse){resetmouse2();}
        if(tmousedown==1){testmousedown();}
		if(tgamesave==1){if(keys[vk_escape]){tgamesave=0;subquit();};}
		else if(tstreetview==0){testkeys();}
		else{if(keys[vk_left] || keys[vk_right]){document.getElementById('streetview').focus();resetkeys();}
		     if(keys[vk_m] || keys[vk_escape] || keys[vk_space]){quitstreetview();sleep(200);resetkeys();}}
        if(tmouseup==1){testmouseup();}
		tframe0=tframe;
		tframe=timer();
		tskip=0;
		ndraw=0;ntri=0;
		//if(x<xmin){x+=xmax-xmin;tskip=1;};
		//if(x>xmax){x-=xmax-xmin;tskip=1;};
		//if(y<ymin){y+=ymax-ymin;tskip=1;};
		//if(y>ymax){y-=ymax-ymin;tskip=1;};
		if(tgamesave>=1){tskip=1;}
		if(tstreetview==1){tskip=1;teststreetview();}
		if(tskip==0 && tframe>tsrtm && testsrtm>=0.01 && loading==0){
		   tsrtm=tframe+3000;testloadsrtm();
		   }
		if(tframe<tskip2+100){tskip=1;}
		//if(tskip==0 && (tmovertt==1 && itime%7==0 && trttok==1)){
		//   tmovertt=0;trttok=0;setTimeout("drawrttshadow();trttok=1;",20);}
		if(tskip==0 && trttok==1){
		   if(itime%16==4){trttok=0;drawrtt3shadow();trttok=1;}
		   if((itime%8==0 || (tshadownight==1 && tlight==1)) && loading<=1){
		        tmovertt=0;trttok=0;drawrttshadow();drawrtt2shadow();trttok=1;}
		   else{tmovertt=0;trttok=0;drawrtt2shadow();trttok=1;}
		   }
        gl.clearColor(1,1,1, 1.0);//auxvar2=loading;//auxvar2=tinitgmap;
        if(tskip==0 && tmap<3){drawScene();}
		//if(tinitgmap==1){tinitgmap=0;initgmap();}
        if(tinit<3){dtautopilot=tframe+3000;
		            if(tfly==0){vcar=0;vrun=0;vmx=0;vmy=0;vmz=0;}
		            else{z=zsol+12;vcar=0.5;vrun=1;}
				   }
		if(tinit==1){tinit=2;trygetways=1;latsol0=99;wind2=0;resetiiways();
		             setTimeout("trygetways=1;",10000);}
		if(trygetways==1 && loading==0){
                            if(trygetweather==1){trygetweather=0;getweather();}
		                    else{getways();};}
		//if(tinit==1){tinit=2;tinitgmap=1;setTimeout("x00=999999;",8000);}
		if(tinitgmap>=1 && (loading==0 || loading>25)){
		     tdrawsol=tframe+9900;//if(testsrtm>0.01){tdrawsol=0;}
		     loading=22;dtloading=tframe;tinitgmap=0;
			 //latsol0=latsol;lngsol0=lngsol;
		     latsol0=latsol;lngsol0=lngsol;
			 dlatsol=dlatsol1;dlngsol=dlngsol1;
		     dlatsol0=dlatsol;dlngsol0=dlngsol;
			 if(tupdatesoltexture==99){tupdatesoltexture=0;tloadsol=tframe+9999000;}
			 initgmap();initgmaptree();
		     loading=1;tskip2=timer()+dtime+400;
			 dtinitmap=tframe;tdraw2=2;trygetways=1;tinitgmap=0;
			 if(tinit<3){tfindwater=1;}
			 }
		if(tdraw==1){tdraw=11;setinode2();}
		if(tdraw==2 || (tdraw2==2 && tdraw==0)){
		   if(tdraw==0){tdraw2=0;}
		   tdraw=22;drawglroad(0);drawgl(0);}
		if(tupdatebuffer==1){
           dtloading=tframe;
		   loading=tupdatebuffer;
		   tupdatebuffer=0;
		   setTimeout("updatebuffer1();",t300);
		   //msgload("buffer");
		   }
	    else if(tupdatebuffer==2){
           dtloading=tframe;
		   loading=tupdatebuffer;
		   tupdatebuffer=0;
		   setTimeout("updatebuffer2();",t300);
		   }
	    else if(tupdatebuffer==3){
           dtloading=tframe;
		   loading=tupdatebuffer;
		   tupdatebuffer=0;
		   setTimeout("updatebuffer3();",t300);
		   }
	    else if(tupdatebuffer==4){
           dtloading=tframe;
		   loading=tupdatebuffer;
		   tupdatebuffer=0;
           updatebuffersolheight();
		   if(ibuff1==0){ibuff=0;ibuff0=0;ibuff1=1;}
		   else{ibuff=1;ibuff0=1;ibuff1=0;}
		   //ibuff=ibuff0;
           addwomantest();
           nextdx=((lng0-lngx0)/klon)*scale;
           nextdy=(lat0-latx0)*scale;
		   lat0=latx0;lng0=lngx0;
           x00=0;//((lngx-lng0)/klon)*scale;
           y00=0;//(latx-lat0)*scale;
           x=((lngx-lng0)/klon)*scale;
           y=(latx-lat0)*scale;
		   updateroc();testroc=1;
		   tupdatecloud=1;movecloud();		   
		   updateiroad();
		   updateroadarrow();
		   testaddphotopanel();
		   addcitypaneltest();
		   if(tframe<timeinit+40000){loadcitypanel();}
		   resetfindroad();
		   for(var i=0;i<=10;i++){oldx[i]+=nextdx;oldy[i]+=nextdy;}
		   tmovertt=1;
           setTimeout("loading=0;dtloading=tframe;",t100);
		   nextdx=0;nextdy=0;
		   if(tinit==0){tinit=1;dtinit=tframe+8000;tsequoia0=0;tsequoia=0;}
		   msgload("");
		   dtinitmap=Math.min(dtinitmap,tframe-3000);
		   setsnow();
		   trottoirx=999999;settrottoir();
		   tdraw=0;tdrawsol=Math.min(tdrawsol,tframe+2000);
		   tsequoia0=tsequoia;
		   testupdategrass=1;testupdateflower=1;
		   if(tinit==2){if(tfindwater==2){tinit=3;tfindwater=0;}}
		   if(tfindwater==1){tfindwater=2;}
		   if(tinit==3){findwater();tfindwater=0;resetsailships();}
		   }
		if(itime%30==1){
		 if(tmap==4 || tmap==6){scrollTo(0,4000);}else{scrollTo(0,0);}
		 if(tmap==2){draw();}
		 if(tmap==3){drawmap();}
		}else if(tmap==0 && tstreetview==0){scrollTo(0,0);}
		if(tgamesave==1){scrollTo(0,9000);}
		if(tstreetview==1){scrollTo(0,7000);}
		if(tupdatesoltexture==1){
		 //if(tupdatebuffersol==1){
		    tupdatesoltexture=99;
			handleLoadedTexture(solTexture);
            trygetweather=1;
	        solTexture.data=gettexturedata(solTexture);
            solTexture.datasize=parseInt(Math.sqrt(solTexture.data.length/4));
            //updatebuffersolheight();
		    //tupdatebuffersol=0;
			//updatebuffersol();
			//tinitgmap=0;initgmap();
		    //tupdatebuffersol=0;
			//latsol0=latsol;lngsol0=lngsol;
			//tinitgmap=2;//x00=999999;
			tmovertt=1;dtinit=tframe+8000;
		}//}
     	if((tupdatetown2==1 || tupdatetown==2) && loading==0 && tframe>dtloading+2000 && tframe>dtinit){
		       updatetown();}
        sunx=sunxsave;suny=sunysave;sunz=sunzsave;
		tfps+=(tframe-tframe0-tfps)*0.2;
		if(tfps<1){tfps=1;}
		if(tfps>1000){tfps=1000;}
		fps=1000/tfps;
		avgfps+=(fps-avgfps)*0.1;
		var dt=(tframe0+25-tframe);
		if(dt<10){dt=10};
		if(quit==0 && ttimeout){
		     //if(tfoot==0 && tcollideon==1 && tautopilot==0){
		        //testcollide();}
		     timeouttick=setTimeout("tick(0);",dt);
           }else{
		   //if(tclose==0){requestAnimationFrame(tick);};
           if(quit==0 && testloop==0){
		     //if(tfoot==0 && tcollideon==1 && tautopilot==0){
		        //testcollide();}
		     testloop=1;requestAnimFrame(tick);
		     }else{testloop=0;};}
    }
//getways();
document.getElementById('msg').focus();
document.getElementById('msg').value="H => help  /  arrow keys => move";

var icombo=3,combotext="deauville marinas";
var flytolat=48.826125,flytolng=2.3570559;
var flytoname="flyto",combolat=lat,combolng=lng;
function formatname(text){
var exclude='&",;?#',text1="",c="";
for(var i=0;i<text.length;i++){c=text.substr(i,1);if(exclude.indexOf(c)<0){text1+=c;}}
return text1;
}
//alert(formatname(formatname('&ok&&ok",;??#ok')));
function subcombo(){
tmouse2move=0;
icombo=document.getElementById('combo').selectedIndex;
combotext = document.getElementById('combo')[icombo].id ;
var o1=0;
lat=flytolat;lng=flytolng;
//if (combotext=="initial"){lat=48.826125  ;lng=2.357055   ;o1=120;}
if (combotext=="flyto"){lat=flytolat  ;lng=flytolng   ;o1=10;}
if (combotext=="deauville marinas"){lat=49.36198047661674   ;lng=0.07262960190958628   ;o1=120;}
if (combotext=="deauville plage"){lat=49.35600551121942   ;lng=0.06075459446313726   ;o1=110;}
if (combotext=="trouville plage"){lat=49.36663106706898   ;lng=0.07818353983048315   ;o1=130;}
if (combotext=="nancy"){lat=48.69306979368741   ;lng=6.182922715725031   ;o1=70;}
if (combotext=="crickvenica"){lat=45.1734569955986   ;lng=14.689314428610118   ;o1=-110;}
if (combotext=="paris tolbiac"){lat=48.826125291730506   ;lng=2.3570559500472212   ;o1=0;}
if (combotext=="paris defense"){lat=48.891977155490395   ;lng=2.237673523003608   ;o1=160;}
if (combotext=="ivry romain roland"){lat=48.80346335679542   ;lng=2.3934673532940915   ;o1=-50;}
if (combotext=="orsay"){lat=48.706787   ;lng=2.180894999999964   ;o1=-30;}
if (combotext=="le barcares"){lat=42.78764305091493   ;lng=3.0338932951133533   ;o1=175;} 
if (combotext=="jerusalem"){lat=31.776636707589287   ;lng=35.2337121963501   ;o1=36.3920;}
if (combotext=="marseille"){lat=43.2803905;lng=5.405139   ;o1=36.3920;}
if (combotext=="nice"){lat=43.7031905;lng=7.252817  ;o1=36.3920;}
if (combotext=="arcachon"){lat=44.6514284;lng=-1.171656  ;o1=36.3920;}
if (combotext=="grenoble"){lat=45.1841656;lng=5.7155425 ;o1=36.3920;}
if (combotext=="san francisco"){lat=37.7577;lng=-122.4376 ;o1=36.3920;}
if (combotext=="new york"){lat=40.7033121;lng=-73.97968 ;o1=36.3920;}
if (combotext=="atlanta"){lat=33.7677129;lng=-84.42060 ;o1=36.3920;}
if (combotext=="rio"){lat=-22.8650853;lng=-43.13109 ;o1=36.3920;}
if (combotext=="hong kong"){lat=22.3700556;lng=114.153758 ;o1=36.3920;}
if (combotext=="athenes"){lat=37.9908372;lng=23.7383394 ;o1=36.3920;}
if (combotext=="perth"){lat=-31.9546529;lng=115.852662 ;o1=36.3920;}
if (combotext=="le caire"){lat=30.04441959;lng=31.23571160;o1=36.3920;}
if (combotext=="washington"){lat=38.8850399;lng=-77.08054296;o1=36.3920;}
if (combotext=="tajmahal"){lat=27.17015;lng=78.002155;o1=36.3920;}
document.getElementById('msg').focus();
combolat=lat;combolng=lng;locationname="";cityname="";
if(latinit!=0 || lnginit!=0){
   lat=latinit;lng=lnginit;
   latinit=0;lnginit=0;
lat=Math.max(-87,Math.min(87,lat));
lng=Math.max(-177,Math.min(177,lng));
latx0=lat;lngx0=lng;lngsol0=999;
latx=lat;lngx=lng;tmap=0;tloadsol=0;tinittree2=1;tinitgmap=2;
x00=999999;
tinittree22=1;tloadingreverse=timer()+1100;locx=99999;trygetways=1;tinit=0;
return;
   }
lat=Math.max(-87,Math.min(87,lat));
lng=Math.max(-177,Math.min(177,lng));
latx0=lat;lngx0=lng;lngsol0=999;
latx=lat;lngx=lng;tmap=0;tloadsol=0;tinittree2=1;tinittree22=1;
z=-1;tloadingreverse=timer()+1100;locx=99999;
tinitgmap=2;x00=999999;trygetways=1;tinit=0;
}
var xmlhttp,httpstatus=0;
function httpGet(url,callback) 
{
  xmlhttp=null;
  xmlhttp = new XMLHttpRequest();
  if ("withCredentials" in xmlhttp) {
    // Check if the XMLHttpRequest object has a "withCredentials" property.
    // "withCredentials" only exists on XMLHTTPRequest2 objects.
    //alert("withCredentials");
	xmlhttp.open("GET", url, true);
  } else if (typeof XDomainRequest != "undefined") {
    // Otherwise, check if XDomainRequest.
    // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
    xmlhttp = new XDomainRequest();
	//alert("XDomainRequest");
    xmlhttp.open("GET", url);
  } else {
    // Otherwise, CORS is not supported by the browser.
    xmlhttp = null;
	alert("cors crossdomain not supported by browser");
	return;
  }
	xmlhttp.onreadystatechange=function()
    {
		if(xmlhttp.readyState==4){httpstatus=xmlhttp.status;
		    if(httpstatus>400){
			   if(loading==1){
			      setTimeout("if(loading==1 && httpstatus>400){loading=0;};",8000);}}}
        if(xmlhttp.readyState==4 && xmlhttp.status==200){callback(xmlhttp.responseText);}
    }	
    //xmlhttp.open("GET", theUrl, false);
    xmlhttp.send();    
}
var xmlhttp2;
function httpGet2(url,callback) 
{
  xmlhttp2=null;
  xmlhttp2 = new XMLHttpRequest();
  if ("withCredentials" in xmlhttp2) {
    // Check if the XMLHttpRequest object has a "withCredentials" property.
    // "withCredentials" only exists on XMLHTTPRequest2 objects.
    //alert("withCredentials");
	xmlhttp2.open("GET", url, true);
  } else if (typeof XDomainRequest != "undefined") {
    // Otherwise, check if XDomainRequest.
    // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
    xmlhttp2 = new XDomainRequest();
	//alert("XDomainRequest");
    xmlhttp2.open("GET", url);
  } else {
    // Otherwise, CORS is not supported by the browser.
    xmlhttp2 = null;
	alert("cors crossdomain not supported by browser");
	return;
  }
	xmlhttp2.onreadystatechange=function()
    {
        if (xmlhttp2.readyState==4 && xmlhttp2.status==200)
        {callback(xmlhttp2.responseText);
        }
    }	
    //xmlhttp2.open("GET", theUrl, false);
    xmlhttp2.send();    
}
function degtorad(degrees) {
    return degrees * Math.PI / 180;
}
var canvas2,canvastext;
//var canvas3,canvassrtm;
function initGL(canvasgl){
       try {
         canvas2=document.createElement('canvas');
         canvas2.setAttribute('width', 512);
         canvas2.setAttribute('height', 512);
         canvastext=canvas2.getContext("2d");

         /*canvas3=document.createElement('canvas');
         canvas3.setAttribute('width', 600);
         canvas3.setAttribute('height', 600);
         canvassrtm=canvas3.getContext("2d");*/

     	   gl = canvasgl.getContext("webgl");
     	   if(!gl){gl = canvasgl.getContext("experimental-webgl");}
           //gl = canvasgl.getContext("webgl");
		   gl.viewportWidth = canvasgl.width;
           gl.viewportHeight = canvasgl.height;
       } catch (e) {alert("error initGL "+e);}
       if (!gl) {
           alert("Could not initialise WebGL, sorry :-(");
		   quit=1;
       }
}
    function getShader(gl, id) {
        var shaderScript = document.getElementById(id);
        if (!shaderScript) {
            return null;
        }

        var str = "";
        var k = shaderScript.firstChild;
        while (k) {
            if (k.nodeType == 3) {
                str += k.textContent;
            }
            k = k.nextSibling;
        }

        var shader;
        if (shaderScript.type == "x-shader/x-fragment") {
            shader = gl.createShader(gl.FRAGMENT_SHADER);
        } else if (shaderScript.type == "x-shader/x-vertex") {
            shader = gl.createShader(gl.VERTEX_SHADER);
        } else {
            return null;
        }

        gl.shaderSource(shader, str);
        gl.compileShader(shader);

        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            alert(gl.getShaderInfoLog(shader));
            return null;
        }

        return shader;
    }


    var shaderProgram,treeProgram,solProgram;
	var lineProgram,sunProgram,program2d,shader2Program,shader0Program;
    var shaderaProgram,shader22Program;
    function initShaders() {
        var fragmentShader0 = getShader(gl, "shader-fs0");
        var vertexShader0 = getShader(gl, "shader-vs0");
        var fragmentshader22 = getShader(gl, "shader-fs22");
        var vertexshader22 = getShader(gl, "shader-vs22");
        var fragmentShader2 = getShader(gl, "shader-fs2");
        var vertexShader2 = getShader(gl, "shader-vs2");
        var fshaderline = getShader(gl, "shader-fl");
        var vshaderline = getShader(gl, "shader-vl");
        var fragmentShader = getShader(gl, "shader-fs");
        var fragmentShadera = getShader(gl, "shader-fsa");
        var fragmentShadersun = getShader(gl, "shader-fssun");
        var vertexShader = getShader(gl, "shader-vs");
        var fshadertree = getShader(gl, "shader-fstree");
        var vshadertree = getShader(gl, "shader-vstree");
        var fshadersol = getShader(gl, "shader-fssol");
        var vshadersol = getShader(gl, "shader-vssol");
        var fshader = getShader(gl, "fshader2d");
        var vshader = getShader(gl, "vshader2d");
	
        shader0Program = gl.createProgram();
        gl.attachShader(shader0Program, vertexShader0);
        gl.attachShader(shader0Program, fragmentShader0);
        gl.linkProgram(shader0Program);

        if (!gl.getProgramParameter(shader0Program, gl.LINK_STATUS)) {
            alert("Could not initialise shader0");
        }

        shader22Program = gl.createProgram();
        gl.attachShader(shader22Program, vertexshader22);
        gl.attachShader(shader22Program, fragmentshader22);
        gl.linkProgram(shader22Program);

        if (!gl.getProgramParameter(shader22Program, gl.LINK_STATUS)) {
            alert("Could not initialise shader22");
        }

        shader2Program = gl.createProgram();
        gl.attachShader(shader2Program, vertexShader2);
        gl.attachShader(shader2Program, fragmentShader2);
        gl.linkProgram(shader2Program);

        if (!gl.getProgramParameter(shader2Program, gl.LINK_STATUS)) {
            alert("Could not initialise shader2");
        }

        program2d = gl.createProgram();
        gl.attachShader(program2d, vshader);
        gl.attachShader(program2d, fshader);
        gl.linkProgram(program2d);

        if (!gl.getProgramParameter(program2d, gl.LINK_STATUS)) {
            alert("Could not initialise shaders2d");
        }

        lineProgram = gl.createProgram();
        gl.attachShader(lineProgram, vshaderline);
        gl.attachShader(lineProgram, fshaderline);
        gl.linkProgram(lineProgram);

        if (!gl.getProgramParameter(lineProgram, gl.LINK_STATUS)) {
            alert("Could not initialise lineshaders");
        }

        shaderProgram = gl.createProgram();
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        gl.linkProgram(shaderProgram);

        if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
            alert("Could not initialise shaders");
        }
        
        shaderaProgram = gl.createProgram();
        gl.attachShader(shaderaProgram, vertexShader);
        gl.attachShader(shaderaProgram, fragmentShadera);
        gl.linkProgram(shaderaProgram);

        if (!gl.getProgramParameter(shaderaProgram, gl.LINK_STATUS)) {
            alert("Could not initialise shadera");
        }
        
		sunProgram = gl.createProgram();
        gl.attachShader(sunProgram, vertexShader);
        gl.attachShader(sunProgram, fragmentShadersun);
        gl.linkProgram(sunProgram);

        if (!gl.getProgramParameter(sunProgram, gl.LINK_STATUS)) {
            alert("Could not initialise shaderssun");
        }

		treeProgram = gl.createProgram();
        gl.attachShader(treeProgram, vshadertree);
        gl.attachShader(treeProgram, fshadertree);
        gl.linkProgram(treeProgram);

        if (!gl.getProgramParameter(treeProgram, gl.LINK_STATUS)) {
            alert("Could not initialise treeshaders");
        }
		
	    solProgram = gl.createProgram();
        gl.attachShader(solProgram, vshadersol);
        gl.attachShader(solProgram, fshadersol);
        gl.linkProgram(solProgram);

        if (!gl.getProgramParameter(solProgram, gl.LINK_STATUS)) {
            alert("Could not initialise solshaders");
        }

        gl.useProgram(shader0Program);

        shader0Program.vertexPositionAttribute = gl.getAttribLocation(shader0Program, "aVertexPosition");
        gl.enableVertexAttribArray(shader0Program.vertexPositionAttribute);

        shader0Program.textureCoordAttribute = gl.getAttribLocation(shader0Program, "aTextureCoord");
        gl.enableVertexAttribArray(shader0Program.textureCoordAttribute);

        shader0Program.pMatrixUniform = gl.getUniformLocation(shader0Program, "uPMatrix");
        shader0Program.mvMatrixUniform = gl.getUniformLocation(shader0Program, "uMVMatrix");
        shader0Program.samplerUniform = gl.getUniformLocation(shader0Program, "uSampler");
        shader0Program.colorUniform = gl.getUniformLocation(shader0Program, "ucolor");
        shader0Program.fog = gl.getUniformLocation(shader0Program, "fog");

        gl.useProgram(shader22Program);

        shader22Program.vertexPositionAttribute = gl.getAttribLocation(shader22Program, "aVertexPosition");
        gl.enableVertexAttribArray(shader22Program.vertexPositionAttribute);

        shader22Program.pMatrixUniform = gl.getUniformLocation(shader22Program, "uPMatrix");
        shader22Program.mvMatrixUniform = gl.getUniformLocation(shader22Program, "uMVMatrix");

        gl.useProgram(shader2Program);

        shader2Program.vertexPositionAttribute = gl.getAttribLocation(shader2Program, "aVertexPosition");
        gl.enableVertexAttribArray(shader2Program.vertexPositionAttribute);

        shader2Program.textureCoordAttribute = gl.getAttribLocation(shader2Program, "aTextureCoord");
        gl.enableVertexAttribArray(shader2Program.textureCoordAttribute);

        shader2Program.vertexNormalAttribute = gl.getAttribLocation(shader2Program, "aVertexNormal");
        gl.enableVertexAttribArray(shader2Program.vertexNormalAttribute);

        shader2Program.pMatrixUniform = gl.getUniformLocation(shader2Program, "uPMatrix");
        shader2Program.mvMatrixUniform = gl.getUniformLocation(shader2Program, "uMVMatrix");
        shader2Program.samplerUniform = gl.getUniformLocation(shader2Program, "uSampler");
        shader2Program.colorUniform = gl.getUniformLocation(shader2Program, "ucolor");

        gl.useProgram(program2d);

        program2d.vertexPositionAttribute = gl.getAttribLocation(program2d, "a_position");
        gl.enableVertexAttribArray(program2d.vertexPositionAttribute);

        //program2d.textureCoordAttribute = gl.getAttribLocation(program2d, "a_texcoord");
        //gl.enableVertexAttribArray(program2d.textureCoordAttribute);

        program2d.samplerUniform = gl.getUniformLocation(program2d, "u_sampler");
        program2d.texscalexUniform = gl.getUniformLocation(program2d, "u_texscalex");
        program2d.texscaleyUniform = gl.getUniformLocation(program2d, "u_texscaley");
        program2d.textdxUniform = gl.getUniformLocation(program2d, "u_textdx");
        program2d.textdyUniform = gl.getUniformLocation(program2d, "u_textdy");
        program2d.colorUniform = gl.getUniformLocation(program2d, "ucolor");
        program2d.scalexUniform = gl.getUniformLocation(program2d, "u_scalex");
        program2d.scaleyUniform = gl.getUniformLocation(program2d, "u_scaley");
        program2d.dxUniform = gl.getUniformLocation(program2d, "u_dx");
        program2d.dyUniform = gl.getUniformLocation(program2d, "u_dy");

        gl.useProgram(lineProgram);

        lineProgram.vertexPositionAttribute = gl.getAttribLocation(lineProgram, "aVertexPosition");
        gl.enableVertexAttribArray(lineProgram.vertexPositionAttribute);
        
		lineProgram.textureCoordAttribute = gl.getAttribLocation(lineProgram, "aTextureCoord");
        gl.enableVertexAttribArray(lineProgram.textureCoordAttribute);

        lineProgram.pMatrixUniform = gl.getUniformLocation(lineProgram, "uPMatrix");
        lineProgram.mvMatrixUniform = gl.getUniformLocation(lineProgram, "uMVMatrix");
        lineProgram.samplerUniform = gl.getUniformLocation(lineProgram, "uSampler");
        lineProgram.colorUniform = gl.getUniformLocation(lineProgram, "ucolor");
        lineProgram.cos1Uniform = gl.getUniformLocation(lineProgram, "ucos1");
        lineProgram.sin1Uniform = gl.getUniformLocation(lineProgram, "usin1");
        lineProgram.shadowUniform = gl.getUniformLocation(lineProgram, "ushadow");
        lineProgram.shadowUniform2 = gl.getUniformLocation(lineProgram, "ushadow2");

        gl.useProgram(shaderProgram);

        shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, "aVertexPosition");
        gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);

        shaderProgram.textureCoordAttribute = gl.getAttribLocation(shaderProgram, "aTextureCoord");
        gl.enableVertexAttribArray(shaderProgram.textureCoordAttribute);

        shaderProgram.vertexNormalAttribute = gl.getAttribLocation(shaderProgram, "aVertexNormal");
        gl.enableVertexAttribArray(shaderProgram.vertexNormalAttribute);

        shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, "uPMatrix");
        shaderProgram.mvMatrixUniform = gl.getUniformLocation(shaderProgram, "uMVMatrix");
        shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, "uSampler");
        shaderProgram.colorUniform = gl.getUniformLocation(shaderProgram, "ucolor");
        shaderProgram.pMatrixUniform2 = gl.getUniformLocation(shaderProgram, "uPMatrix2");
        shaderProgram.mvMatrixUniform2 = gl.getUniformLocation(shaderProgram, "uMVMatrix2");
        shaderProgram.samplerUniform2 = gl.getUniformLocation(shaderProgram, "uSampler2");
        shaderProgram.samplerUniform3 = gl.getUniformLocation(shaderProgram, "uSampler3");
        shaderProgram.samplerUniform6 = gl.getUniformLocation(shaderProgram, "uSampler6");
        shaderProgram.sunposUniform = gl.getUniformLocation(shaderProgram, "uSunpos");
        shaderProgram.dmaxUniform = gl.getUniformLocation(shaderProgram, "dmax");
        shaderProgram.fog = gl.getUniformLocation(shaderProgram, "fog");
        shaderProgram.lightUniform = gl.getUniformLocation(shaderProgram, "tlight");
        shaderProgram.sunco1 = gl.getUniformLocation(shaderProgram, "sunco1");
        shaderProgram.sunsi1 = gl.getUniformLocation(shaderProgram, "sunsi1");
        shaderProgram.cloudx = gl.getUniformLocation(shaderProgram, "cloudx");
        shaderProgram.cloudy = gl.getUniformLocation(shaderProgram, "cloudy");

        gl.useProgram(shaderaProgram);

        shaderaProgram.vertexPositionAttribute = gl.getAttribLocation(shaderaProgram, "aVertexPosition");
        gl.enableVertexAttribArray(shaderaProgram.vertexPositionAttribute);

        shaderaProgram.textureCoordAttribute = gl.getAttribLocation(shaderaProgram, "aTextureCoord");
        gl.enableVertexAttribArray(shaderaProgram.textureCoordAttribute);

        shaderaProgram.vertexNormalAttribute = gl.getAttribLocation(shaderaProgram, "aVertexNormal");
        gl.enableVertexAttribArray(shaderaProgram.vertexNormalAttribute);

        shaderaProgram.pMatrixUniform = gl.getUniformLocation(shaderaProgram, "uPMatrix");
        shaderaProgram.mvMatrixUniform = gl.getUniformLocation(shaderaProgram, "uMVMatrix");
        shaderaProgram.samplerUniform = gl.getUniformLocation(shaderaProgram, "uSampler");
        shaderaProgram.colorUniform = gl.getUniformLocation(shaderaProgram, "ucolor");
        shaderaProgram.pMatrixUniform2 = gl.getUniformLocation(shaderaProgram, "uPMatrix2");
        shaderaProgram.mvMatrixUniform2 = gl.getUniformLocation(shaderaProgram, "uMVMatrix2");
        //shaderaProgram.samplerUniform2 = gl.getUniformLocation(shaderaProgram, "uSampler2");
        //shaderaProgram.samplerUniform3 = gl.getUniformLocation(shaderaProgram, "uSampler3");
        shaderaProgram.sunposUniform = gl.getUniformLocation(shaderaProgram, "uSunpos");
        shaderaProgram.dmaxUniform = gl.getUniformLocation(shaderaProgram, "dmax");

        gl.useProgram(sunProgram);

        sunProgram.vertexPositionAttribute = gl.getAttribLocation(sunProgram, "aVertexPosition");
        gl.enableVertexAttribArray(sunProgram.vertexPositionAttribute);

        sunProgram.textureCoordAttribute = gl.getAttribLocation(sunProgram, "aTextureCoord");
        gl.enableVertexAttribArray(sunProgram.textureCoordAttribute);

        sunProgram.vertexNormalAttribute = gl.getAttribLocation(sunProgram, "aVertexNormal");
        gl.enableVertexAttribArray(sunProgram.vertexNormalAttribute);

        sunProgram.pMatrixUniform = gl.getUniformLocation(sunProgram, "uPMatrix");
        sunProgram.mvMatrixUniform = gl.getUniformLocation(sunProgram, "uMVMatrix");
        sunProgram.samplerUniform = gl.getUniformLocation(sunProgram, "uSampler");
        sunProgram.colorUniform = gl.getUniformLocation(sunProgram, "ucolor");
        sunProgram.pMatrixUniform2 = gl.getUniformLocation(sunProgram, "uPMatrix2");
        sunProgram.mvMatrixUniform2 = gl.getUniformLocation(sunProgram, "uMVMatrix2");
        //sunProgram.samplerUniform2 = gl.getUniformLocation(sunProgram, "uSampler2");
        sunProgram.sunposUniform = gl.getUniformLocation(sunProgram, "uSunpos");
        sunProgram.dmaxUniform = gl.getUniformLocation(sunProgram, "dmax");

        gl.useProgram(treeProgram);

        treeProgram.vertexPositionAttribute = gl.getAttribLocation(treeProgram, "aVertexPosition");
        gl.enableVertexAttribArray(treeProgram.vertexPositionAttribute);

        treeProgram.textureCoordAttribute = gl.getAttribLocation(treeProgram, "aTextureCoord");
        gl.enableVertexAttribArray(treeProgram.textureCoordAttribute);

        treeProgram.pMatrixUniform = gl.getUniformLocation(treeProgram, "uPMatrix");
        treeProgram.mvMatrixUniform = gl.getUniformLocation(treeProgram, "uMVMatrix");
        treeProgram.cos1Uniform = gl.getUniformLocation(treeProgram, "ucos1");
        treeProgram.sin1Uniform = gl.getUniformLocation(treeProgram, "usin1");
        treeProgram.samplerUniform = gl.getUniformLocation(treeProgram, "uSampler");
        treeProgram.shadowUniform = gl.getUniformLocation(treeProgram, "ushadow");
        treeProgram.shadowUniform2 = gl.getUniformLocation(treeProgram, "ushadow2");
        treeProgram.lightUniform = gl.getUniformLocation(treeProgram, "tlight");
        treeProgram.fog = gl.getUniformLocation(treeProgram, "fog");
	
        gl.useProgram(solProgram);

        solProgram.vertexPositionAttribute = gl.getAttribLocation(solProgram, "aVertexPosition");
        gl.enableVertexAttribArray(solProgram.vertexPositionAttribute);

        solProgram.textureCoordAttribute = gl.getAttribLocation(solProgram, "aTextureCoord");
        gl.enableVertexAttribArray(solProgram.textureCoordAttribute);

        solProgram.pMatrixUniform = gl.getUniformLocation(solProgram, "uPMatrix");
        solProgram.mvMatrixUniform = gl.getUniformLocation(solProgram, "uMVMatrix");
        solProgram.pMatrixUniform2 = gl.getUniformLocation(solProgram, "uPMatrix2");
        solProgram.mvMatrixUniform2 = gl.getUniformLocation(solProgram, "uMVMatrix2");
        solProgram.samplerUniform = gl.getUniformLocation(solProgram, "uSampler");
        solProgram.samplerUniform2 = gl.getUniformLocation(solProgram, "uSampler2");
        solProgram.samplerUniform3 = gl.getUniformLocation(solProgram, "uSampler3");
        solProgram.samplerUniform4 = gl.getUniformLocation(solProgram, "uSampler4");
        solProgram.samplerUniform5 = gl.getUniformLocation(solProgram, "uSampler5");
        solProgram.samplerUniform6 = gl.getUniformLocation(solProgram, "uSampler6");
        solProgram.kseaUniform = gl.getUniformLocation(solProgram, "ksea");
        solProgram.fog = gl.getUniformLocation(solProgram, "fog");
        solProgram.sunco1 = gl.getUniformLocation(solProgram, "sunco1");
        solProgram.sunsi1 = gl.getUniformLocation(solProgram, "sunsi1");
        solProgram.cloudx = gl.getUniformLocation(solProgram, "cloudx");
        solProgram.mx = gl.getUniformLocation(solProgram, "mx");
        solProgram.my = gl.getUniformLocation(solProgram, "my");
        solProgram.wavez = gl.getUniformLocation(solProgram, "wavez");
        solProgram.time = gl.getUniformLocation(solProgram, "time");
        solProgram.cos1 = gl.getUniformLocation(solProgram, "cos1");
        solProgram.sin1 = gl.getUniformLocation(solProgram, "sin1");
        solProgram.wavetx = gl.getUniformLocation(solProgram, "wavetx");
        solProgram.wavety = gl.getUniformLocation(solProgram, "wavety");
        solProgram.tshadow = gl.getUniformLocation(solProgram, "tshadow");
        solProgram.lightUniform = gl.getUniformLocation(solProgram, "tlight");

	}
    var tclose=0;
	function subquit(){
        quit=1;
		savecookie();
	    close();
    	//alert("bye");
	    document.location.href="http://chungswebsite.blogspot.fr/";
	    //document.location.href="http://chung.blogvie.com/links/";
		//document.location.href="https://www.google.com/search?q=mywebglflight&rct=j";
	                   //http://chungswebsite.blogspot.fr/search/label/mywebglflight";
	}				   
	function close(){
	try{
	if(tclose<2){tclose=3;
	restorewindow();
	closesounds();
	deletetextures();
	}}catch(e){//alert("close?");
	};
	//alert("close end");
	}

	function closesounds(){
	if(twebaudio==0){return;}
	audioctx.close();
    /*myaudiocar.buffer=null;
    myaudiowater.buffer=null;
    myaudiopneu.buffer=null;
    myaudiorain.buffer=null;
    myaudiocrash.buffer=null;*/
    }
    var texturelist=[],itexturelist=0;
	function handleLoadedTexture00(texture) {
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvas2);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.bindTexture(gl.TEXTURE_2D, null);
        texture.width=canvas2.width;
		texture.height=canvas2.height;
    }
	function handleLoadedTexture0(texture) {
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, texture.image);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.bindTexture(gl.TEXTURE_2D, null);
        texture.width=texture.image.width;
		texture.height=texture.image.height;
		//texture.image.src=null;
    }
	function handleLoadedTexture(texture) {
	    if(texture.image.src==null){return;}
	    handleLoadedTexture0(texture);
		itexturelist+=1;
		texturelist[itexturelist]=texture;
		setTimeout("deleteimagelist("+itexturelist+");",500);
	}
	function deleteimagelist(i){
	    var texture=texturelist[i];
		texture.image.src=null;
	}
	function testtexturelistloaded(){
	  for(var i=1;i<=itexturelist;i++){if(texturelist[i].image.width>1){return 0;}}
	  return 1;
	}
    function gettexturedata(texture){
	  // Create a framebuffer backed by the texture
      var framebuffer = gl.createFramebuffer();
      gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
      gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture, 0);
      // Read the contents of the framebuffer (data stores the pixel data)
      var data = new Uint8Array(texture.width * texture.height * 4);
      gl.readPixels(0,0,texture.width,texture.height,gl.RGBA,gl.UNSIGNED_BYTE,data);
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      gl.deleteFramebuffer(framebuffer);
	  return data;
    }

    var towerTexture,roadTexture,solTexture,towernightTexture;
	var houseTexture,roofTexture,solTexture2,shopTexture;
	var carTexture,volantTexture,arrowTexture,volant2Texture;
	var rpmTexture,boussTexture,skydomeTexture;
	var treeTexture,solTexture0,seaTexture,solTexture02;
	var tree2Texture,sunTexture,rainTexture,greenTexture;
	var cloudTexture,roadbandTexture,crossTexture;
	var cloudTexture,roadbandTexture,crossTexture;
	var carobjTexture,woman1Texture,woman2Texture,loganobjTexture;
	var carobjlightTexture,loganobjlightTexture,c150objTexture;
	var woman3Texture,smokeTexture,citypanelTexture;
	var carTexture2,rocTexture,roadarrowTexture;
	var eiffeltowerTexture,libertystatueTexture;
	var christrioTexture,domerockTexture,gizahTexture,capitoleTexture;
	var tajmahalTexture,buddahTexture,photoTexture,bikiniTexture;
	var marisolTexture,womanTexture,churchTexture,boeingTexture;
	var arrowgreenforward,arrowgreenleft,arrowgreenright;
	var autumntreeTexture,autumntree2Texture,tree3Texture,trottoirTexture;
	var stationTexture,girlimage,girlimage2,girlimage3,sequoiaTexture;
	var grassTexture,flowerTexture,sailshipTexture,officialTexture,hospitalTexture;
	var rttFramebuffer,rttTexture,renderbuffer;
	var rtt2Framebuffer,rtt2Texture,renderbuffer2;
	var rtt3Framebuffer,rtt3Texture,renderbuffer3;
    function gldeleteTexture(texture){
	    if(texture){gl.deleteTexture(texture);
		            //texture.image.src=null;
	                };}
	function deletetextures(){
        //cancelRequestAnimationFrame(); 
	    for(var i=1;i<=itexturelist;i++){
		   gldeleteTexture(texturelist[i]);
		}
    }
function initrtttexture(){
        var s1024=1024,h1024=2048;
        rttFramebuffer = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, rttFramebuffer);
        rttFramebuffer.width = s1024;
        rttFramebuffer.height = h1024;
        rttTexture = gl.createTexture();
        rttTexture.width=rttFramebuffer.width;
        rttTexture.height=rttFramebuffer.height;
		gl.bindTexture(gl.TEXTURE_2D, rttTexture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA, rttFramebuffer.width, rttFramebuffer.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
        //gl.enable(gl.depth_texture);
		//gl.texImage2D(gl.TEXTURE_2D,0,gl.DEPTH_COMPONENT,rttFramebuffer.width,rttFramebuffer.height,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_SHORT, null);
        renderbuffer = gl.createRenderbuffer();
        gl.bindRenderbuffer(gl.RENDERBUFFER, renderbuffer);
        gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, rttFramebuffer.width, rttFramebuffer.height);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rttTexture, 0);
        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, renderbuffer);

        rtt2Framebuffer = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, rtt2Framebuffer);
        rtt2Framebuffer.width = s1024;
        rtt2Framebuffer.height = h1024;
        rtt2Texture = gl.createTexture();
        rtt2Texture.width=rtt2Framebuffer.width;
        rtt2Texture.height=rtt2Framebuffer.height;
		gl.bindTexture(gl.TEXTURE_2D, rtt2Texture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA, rtt2Framebuffer.width, rtt2Framebuffer.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
        //gl.enable(gl.depth_texture);
		//gl.texImage2D(gl.TEXTURE_2D,0,gl.DEPTH_COMPONENT,rtt2Framebuffer.width,rtt2Framebuffer.height,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_SHORT, null);
        renderbuffer2 = gl.createRenderbuffer();
        gl.bindRenderbuffer(gl.RENDERBUFFER, renderbuffer2);
        gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, rtt2Framebuffer.width, rtt2Framebuffer.height);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rtt2Texture, 0);
        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, renderbuffer2);

        rtt3Framebuffer = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, rtt3Framebuffer);
        rtt3Framebuffer.width = s1024;
        rtt3Framebuffer.height = h1024;
        rtt3Texture = gl.createTexture();
        rtt3Texture.width=rtt3Framebuffer.width;
        rtt3Texture.height=rtt3Framebuffer.height;
		gl.bindTexture(gl.TEXTURE_2D, rtt3Texture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA, rtt3Framebuffer.width, rtt3Framebuffer.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
        //gl.enable(gl.depth_texture);
		//gl.texImage2D(gl.TEXTURE_2D,0,gl.DEPTH_COMPONENT,rtt3Framebuffer.width,rtt3Framebuffer.height,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_SHORT, null);
        renderbuffer3 = gl.createRenderbuffer();
        gl.bindRenderbuffer(gl.RENDERBUFFER, renderbuffer3);
        gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, rtt3Framebuffer.width, rtt3Framebuffer.height);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rtt3Texture, 0);
        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, renderbuffer3);

        gl.bindTexture(gl.TEXTURE_2D, null);
        gl.bindRenderbuffer(gl.RENDERBUFFER, null);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
}
	var tinitsol0=1,tgirl=0;
    function initTexture() {
	    initrtttexture();
        solTexture = gl.createTexture();
        solTexture.image = new Image();
        solTexture.image.onload = function () {
			tupdatesoltexture=1;
			//handleLoadedTexture(solTexture);
            updatesoltexture2();
        }
        updatesoltexture();
		//solTexture.image.src = "map2.jpg";
		
        solTexture2 = gl.createTexture();
        solTexture2.image = new Image();
        //solTexture2.image.onload = function () {
			//tupdatesoltexture2=1;
			//handleLoadedTexture(solTexture);
        //}
solTexture2.image.onload = function () {
    //handleLoadedTexture(solTexture2);
canvas2.setAttribute('width', 512);
canvas2.setAttribute('height', 512);
canvastext.drawImage(solTexture2.image, -20, -20,552,552);
	handleLoadedTexture00(solTexture2);
	solTexture2.data=gettexturedata(solTexture2);
    solTexture2.datasize=parseInt(Math.sqrt(solTexture2.data.length/4));
    //auxvar=solTexture2.datasize;
	if(tinitgmap>=0){tinitgmap=2;loading=33;}
	canvas2.setAttribute('width', 10);
    canvas2.setAttribute('height', 10);
	setTimeout("solTexture2.image.src=null;",5000);
	}
        //updatesoltexture2();
		//solTexture.image.src = "map2.jpg";
    setTimeout("initTexture2();",2000);
	}
	function setskydometexture(){
	  if(skydomeTexture){
		if(wclouds<12){skydomeTexture.imagesrc2 = "skydome3_1024.jpg";
        }else if(wclouds<50-10){skydomeTexture.imagesrc2 = "skydome_1024.jpg";
        }else if(wclouds<75-10){skydomeTexture.imagesrc2 = "skydome4_1024.jpg";
        }else if(wclouds<87){skydomeTexture.imagesrc2 = "skydome2_1024.jpg";
		}else{skydomeTexture.imagesrc2 = "skydome_cloudy_1024.jpg";}
		if(skydomeTexture.image.src!=skydomeTexture.imagesrc2){
		   skydomeTexture.image.src=skydomeTexture.imagesrc2;}
	}}
    function initTexture2() {
        roadTexture = gl.createTexture();
        roadTexture.image = new Image();
        roadTexture.image.onload = function () {
			handleLoadedTexture(roadTexture);
        }
        roadTexture.image.src = "road99.bmp";
		
        roadbandTexture = gl.createTexture();
        roadbandTexture.image = new Image();
        roadbandTexture.image.onload = function () {
			handleLoadedTexture(roadbandTexture);
        }
        roadbandTexture.image.src = "roadband.bmp";
		
        towerTexture = gl.createTexture();
        towerTexture.image = new Image();
        towerTexture.image.onload = function () {
			handleLoadedTexture(towerTexture);
        }
        towerTexture.image.src = "tower1.jpg";

        towernightTexture = gl.createTexture();
        towernightTexture.image = new Image();
        towernightTexture.image.onload = function () {
			handleLoadedTexture(towernightTexture);
        }
        towernightTexture.image.src = "tower1night.jpg";

        churchTexture = gl.createTexture();
        churchTexture.image = new Image();
        churchTexture.image.onload = function () {
			handleLoadedTexture(churchTexture);
        }
        churchTexture.image.src = "church.jpg";

        houseTexture = gl.createTexture();
        houseTexture.image = new Image();
        houseTexture.image.onload = function () {
			handleLoadedTexture(houseTexture);
        }
        houseTexture.image.src = "tower1.jpg";//"house.jpg";

        roofTexture = gl.createTexture();
        roofTexture.image = new Image();
        roofTexture.image.onload = function () {
			handleLoadedTexture(roofTexture);
        }
        roofTexture.image.src = "roof.jpg";

        solTexture0 = gl.createTexture();
        solTexture0.image = new Image();
        solTexture0.image.onload = function () {
			handleLoadedTexture(solTexture0);
        }
        solTexture0.image.src = "grass0.jpg";//"map2.jpg";
		
        solTexture02 = gl.createTexture();
        solTexture02.image = new Image();
        solTexture02.image.onload = function () {
			handleLoadedTexture(solTexture02);
        }
        solTexture02.image.src = "grass_snow.jpg";
		
        carobjTexture = gl.createTexture();
        carobjTexture.image = new Image();
        carobjTexture.image.onload = function () {
            handleLoadedTexture(carobjTexture);
        }
        carobjTexture.image.src = "car.png";

        carobjlightTexture = gl.createTexture();
        carobjlightTexture.image = new Image();
        carobjlightTexture.image.onload = function () {
            handleLoadedTexture(carobjlightTexture);
        }
        carobjlightTexture.image.src = "carlight.png";

        loganobjTexture = gl.createTexture();
        loganobjTexture.image = new Image();
        loganobjTexture.image.onload = function () {
            handleLoadedTexture(loganobjTexture);
        }
        loganobjTexture.image.src = "logan.jpg";

        loganobjlightTexture = gl.createTexture();
        loganobjlightTexture.image = new Image();
        loganobjlightTexture.image.onload = function () {
            handleLoadedTexture(loganobjlightTexture);
        }
        loganobjlightTexture.image.src = "loganlight.jpg";

        c150objTexture = gl.createTexture();
        c150objTexture.image = new Image();
        c150objTexture.image.onload = function () {
            handleLoadedTexture(c150objTexture);
        }
        c150objTexture.image.src = "c150.jpg";

        carTexture = gl.createTexture();
        carTexture.image = new Image();
        carTexture.image.onload = function () {
            handleLoadedTexture(carTexture);
			tcockpitok=1;
        }
        if(tgirl>=5){carTexture.image.src = "ford.png";}
        else if(tgirl>=4){carTexture.image.src = "mercedes.png";}
        else if(tgirl>=3){carTexture.image.src = "cadillac.png";}
        else if(tgirl>=2){carTexture.image.src = "volvo.png";}
        else if(tgirl>=1){carTexture.image.src = "toyota.png";}
        else{carTexture.image.src = "chevy2.png";}//"chevy.jpg";

        /*carTexture2 = gl.createTexture();
        carTexture2.image = new Image();
        carTexture2.image.onload = function () {
            handleLoadedTexture(carTexture2)
        }
        carTexture2.image.src = "chevy2girl5.png";
        */
        volantTexture = gl.createTexture();
        volantTexture.image = new Image();
        volantTexture.image.onload = function () {
            handleLoadedTexture(volantTexture);
        }
        volantTexture.image.src = "volant2.png";//"volant.jpg";

        volant2Texture = gl.createTexture();
        volant2Texture.image = new Image();
        volant2Texture.image.onload = function () {
            handleLoadedTexture(volant2Texture);
        }
        volant2Texture.image.src = "volant3.png";//"volant.jpg";

        arrowTexture = gl.createTexture();
        arrowTexture.image = new Image();
        arrowTexture.image.onload = function () {
            handleLoadedTexture(arrowTexture);
        }
        arrowTexture.image.src = "arrow.png";

        rpmTexture = gl.createTexture();
        rpmTexture.image = new Image();
        rpmTexture.image.onload = function () {
            handleLoadedTexture(rpmTexture);
        }
        rpmTexture.image.src = "rpm.png";

        boussTexture = gl.createTexture();
        boussTexture.image = new Image();
        boussTexture.image.onload = function () {
            handleLoadedTexture(boussTexture);
        }
        boussTexture.image.src = "bouss.png";

        skydomeTexture = gl.createTexture();
        skydomeTexture.image = new Image();
        skydomeTexture.image.onload = function () {
            handleLoadedTexture(skydomeTexture);
        }
        if(Math.abs(wclouds-50.1)<0.001){wclouds=Math.sqrt(Math.random())*Math.random()*90;}
        //wclouds=80;
		if(wclouds<12){skydomeTexture.imagesrc2 = "skydome3_1024.jpg";
        }else if(wclouds<50){skydomeTexture.imagesrc2 = "skydome_1024.jpg";
        }else if(wclouds<75){skydomeTexture.imagesrc2 = "skydome4_1024.jpg";
		}else{skydomeTexture.imagesrc2 = "skydome2_1024.jpg";}
		skydomeTexture.image.src=skydomeTexture.imagesrc2;

        treeTexture = gl.createTexture();
        treeTexture.image = new Image();
        treeTexture.image.onload = function () {
            handleLoadedTexture(treeTexture);
        }
        treeTexture.image.src = "tree14.jpg";

        tree2Texture = gl.createTexture();
        tree2Texture.image = new Image();
        tree2Texture.image.onload = function () {
            handleLoadedTexture(tree2Texture);
        }
        tree2Texture.image.src = "tree1.jpg";
		
        tree3Texture = gl.createTexture();
        tree3Texture.image = new Image();
        tree3Texture.image.onload = function () {
            handleLoadedTexture(tree3Texture);
        }
        tree3Texture.image.src = 'tree22.jpg';//pine

        sequoiaTexture = gl.createTexture();
        sequoiaTexture.image = new Image();
        sequoiaTexture.image.onload = function () {
            handleLoadedTexture(sequoiaTexture);
        }
        sequoiaTexture.image.src = 'treesequoia.jpg';//pine

        autumntreeTexture = gl.createTexture();
        autumntreeTexture.image = new Image();
        autumntreeTexture.image.onload = function () {
            handleLoadedTexture(autumntreeTexture);
        }
        autumntreeTexture.image.src = "autumn_tree.jpg";

        autumntree2Texture = gl.createTexture();
        autumntree2Texture.image = new Image();
        autumntree2Texture.image.onload = function () {
            handleLoadedTexture(autumntree2Texture);
        }
        autumntree2Texture.image.src = "autumn_tree2.jpg";
		
        sunTexture = gl.createTexture();
        sunTexture.image = new Image();
        sunTexture.image.onload = function () {
            handleLoadedTexture(sunTexture);
        }
        sunTexture.image.src = "sun.png";
		
        seaTexture = gl.createTexture();
        seaTexture.image = new Image();
        seaTexture.image.onload = function () {
            handleLoadedTexture(seaTexture);
        }
        seaTexture.image.src = "water.jpg";
		
        rainTexture = gl.createTexture();
        rainTexture.image = new Image();
        rainTexture.image.onload = function () {
            handleLoadedTexture(rainTexture);
        }
        rainTexture.image.src = "rain2.jpg";

        greenTexture = gl.createTexture();
        greenTexture.image = new Image();
        greenTexture.image.onload = function () {
            handleLoadedTexture(greenTexture);
        }
        greenTexture.image.src = "green.bmp";

        cloudTexture = gl.createTexture();
        cloudTexture.image = new Image();
        cloudTexture.image.onload = function () {
            handleLoadedTexture(cloudTexture);
        }
        cloudTexture.image.src = "cloud.png";

        crossTexture = gl.createTexture();
        crossTexture.image = new Image();
        crossTexture.image.onload = function () {
            handleLoadedTexture(crossTexture);
        }
        crossTexture.image.src = "stopcross2.png";

        woman1Texture = gl.createTexture();
        woman1Texture.image = new Image();
        woman1Texture.image.onload = function () {
            handleLoadedTexture(woman1Texture);
        }
        woman1Texture.image.src = "margaretright.png";

        woman2Texture = gl.createTexture();
        woman2Texture.image = new Image();
        woman2Texture.image.onload = function () {
            handleLoadedTexture(woman2Texture);
        }
        woman2Texture.image.src = "margaretfront.png";

        woman3Texture = gl.createTexture();
        woman3Texture.image = new Image();
        woman3Texture.image.onload = function () {
            handleLoadedTexture(woman3Texture);
        }
        woman3Texture.image.src = "margaretleft.png";

        smokeTexture = gl.createTexture();
        smokeTexture.image = new Image();
        smokeTexture.image.onload = function () {
            handleLoadedTexture(smokeTexture);
        }
        smokeTexture.image.src = "smoke.bmp";

        citypanelTexture = gl.createTexture();
        citypanelTexture.image = new Image();
        citypanelTexture.image.onload = function () {
            //handleLoadedTexture(citypanelTexture);
 	canvas2.setAttribute('width', 512);
    canvas2.setAttribute('height', 64);
	canvastext.drawImage(citypanelTexture.image, 0,0,512,64);
    canvastext.font = "18pt Arial";
    canvastext.fillStyle = '#000000';
    canvastext.fillText("NGUYEN Chung",120,40);
	handleLoadedTexture00(citypanelTexture);
 	canvas2.setAttribute('width', 10);
    canvas2.setAttribute('height', 10);
	}
        citypanelTexture.image.src = "citypanel.png";
		for(var i=0;i<ncitypanel;i++){ncitypanelTexture[i] = gl.createTexture();}

        eiffeltowerTexture = gl.createTexture();
        eiffeltowerTexture.image = new Image();
        eiffeltowerTexture.image.onload = function () {
            handleLoadedTexture(eiffeltowerTexture);
        }
        eiffeltowerTexture.image.src = "eiffeltower3.png";

        libertystatueTexture = gl.createTexture();
        libertystatueTexture.image = new Image();
        libertystatueTexture.image.onload = function () {
            handleLoadedTexture(libertystatueTexture);
        }
        libertystatueTexture.image.src = "libertystatue.png";

        christrioTexture = gl.createTexture();
        christrioTexture.image = new Image();
        christrioTexture.image.onload = function () {
            handleLoadedTexture(christrioTexture);
        }
        christrioTexture.image.src = "christrio.png";

        domerockTexture = gl.createTexture();
        domerockTexture.image = new Image();
        domerockTexture.image.onload = function () {
            handleLoadedTexture(domerockTexture);
        }
        domerockTexture.image.src = "domerock.png";

        gizahTexture = gl.createTexture();
        gizahTexture.image = new Image();
        gizahTexture.image.onload = function () {
            handleLoadedTexture(gizahTexture);
        }
        gizahTexture.image.src = "gizah.png";

        capitoleTexture = gl.createTexture();
        capitoleTexture.image = new Image();
        capitoleTexture.image.onload = function () {
            handleLoadedTexture(capitoleTexture);
        }
        capitoleTexture.image.src = "capitole.png";

        tajmahalTexture = gl.createTexture();
        tajmahalTexture.image = new Image();
        tajmahalTexture.image.onload = function () {
            handleLoadedTexture(tajmahalTexture);
        }
        tajmahalTexture.image.src = "tajmahal.png";

        buddahTexture = gl.createTexture();
        buddahTexture.image = new Image();
        buddahTexture.image.onload = function () {
            handleLoadedTexture(buddahTexture);
        }
        buddahTexture.image.src = "buddah.png";

        rocTexture = gl.createTexture();
        rocTexture.image = new Image();
        rocTexture.image.onload = function () {
            handleLoadedTexture(rocTexture);
        }
        rocTexture.image.src = "roc.jpg";

        roadarrowTexture = gl.createTexture();
        roadarrowTexture.image = new Image();
        roadarrowTexture.image.onload = function () {
            handleLoadedTexture(roadarrowTexture);
        }
        roadarrowTexture.image.src = "roadarrow.png";

        photoTexture = gl.createTexture();
        photoTexture.image = new Image();
        photoTexture.image.onload = function () {
            handleLoadedTexture(photoTexture);
        }
        photoTexture.image.src = "nathalie.jpg";

        bikiniTexture = gl.createTexture();
        bikiniTexture.image = new Image();
        bikiniTexture.image.onload = function () {
            handleLoadedTexture(bikiniTexture);
        }
        bikiniTexture.image.src = "bikini.jpg";

        marisolTexture = gl.createTexture();
        marisolTexture.image = new Image();
        marisolTexture.image.onload = function () {
            handleLoadedTexture(marisolTexture);
        }
        marisolTexture.image.src = "marisol.jpg";

        womanTexture = gl.createTexture();
        womanTexture.image = new Image();
        womanTexture.image.onload = function () {
            handleLoadedTexture(womanTexture);
        }
        womanTexture.image.src = "woman.jpg";

        boeingTexture = gl.createTexture();
        boeingTexture.image = new Image();
        boeingTexture.image.onload = function () {
			handleLoadedTexture(boeingTexture);
        }
        boeingTexture.image.src = "boeing512.png";

        trottoirTexture = gl.createTexture();
        trottoirTexture.image = new Image();
        trottoirTexture.image.onload = function () {
			handleLoadedTexture(trottoirTexture);
        }
        trottoirTexture.image.src = "trottoir.jpg";
		
        stationTexture = gl.createTexture();
        stationTexture.image = new Image();
        stationTexture.image.onload = function () {
			handleLoadedTexture(stationTexture);
        }
        stationTexture.image.src = "station2.jpg";

        grassTexture = gl.createTexture();
        grassTexture.image = new Image();
        grassTexture.image.onload = function () {
            handleLoadedTexture(grassTexture);
        }

        grassTexture.image.src = "grass11.jpg";//grass1jpg;

        flowerTexture = gl.createTexture();
        flowerTexture.image = new Image();
        flowerTexture.image.onload = function () {
            handleLoadedTexture(flowerTexture);
        }

        flowerTexture.image.src = "flowerblue.jpg";
        
        shopTexture = gl.createTexture();
        shopTexture.image = new Image();
        shopTexture.image.onload = function () {
			handleLoadedTexture(shopTexture);
        }
        shopTexture.image.src = "vitrines2.jpg";

        sailshipTexture = gl.createTexture();
        sailshipTexture.image = new Image();
        sailshipTexture.image.onload = function () {
            handleLoadedTexture(sailshipTexture);
        }

        sailshipTexture.image.src = "sailship.jpg";

        officialTexture = gl.createTexture();
        officialTexture.image = new Image();
        officialTexture.image.onload = function () {
            handleLoadedTexture(officialTexture);
        }

        officialTexture.image.src = "official2.jpg";

        hospitalTexture = gl.createTexture();
        hospitalTexture.image = new Image();
        hospitalTexture.image.onload = function () {
            handleLoadedTexture(hospitalTexture);
        }

        hospitalTexture.image.src = "hospital2.jpg";

		arrowgreenforward=new Image();
		arrowgreenforward.src="arrowgreenforward.png";
		arrowgreenleft=new Image();
		arrowgreenleft.src="arrowgreenleft.png";
		arrowgreenright=new Image();
		arrowgreenright.src="arrowgreenright.png";
		girlimage=new Image();
		girlimage.src="girl2.jpg";
		girlimage2=new Image();
		girlimage2.src="girl3.jpg";
		girlimage3=new Image();
		girlimage3.src="girl4.jpg";

        }


//libertystatue
var lat2=40.689249,lng2=-74.0444999;
getworldxy(zoom,lat2,lng2);
var libertystatuex=lng2,libertystatuey=lat2;
//Eiffel Tower
lat2=48.85837;lng2=2.2944810;
getworldxy(zoom,lat2,lng2);
var eiffeltowerx=lng2,eiffeltowery=lat2;
//Christ rio
lat2=-22.951916;lng2=-43.210487;
getworldxy(zoom,lat2,lng2);
var christriox=lng2,christrioy=lat2;
//Dome of the Rock 
lat2=31.778019;lng2=35.23540800;
getworldxy(zoom,lat2,lng2);
var domerockx=lng2,domerocky=lat2;
//The Great Pyramid at Giza 
lat2=29.979234;lng2=31.13420199;
getworldxy(zoom,lat2,lng2);
var gizahx=lng2,gizahy=lat2;
//United States Capitol 
lat2=38.889939;lng2=-77.00905;
getworldxy(zoom,lat2,lng2);
var capitolex=lng2,capitoley=lat2;
//taj mahal
lat2=27.175015;lng2=78.042155;
getworldxy(zoom,lat2,lng2);
var tajmahalx=lng2,tajmahaly=lat2;
//hongkong Buddha
lat2=22.253985;lng2=113.904984;
getworldxy(zoom,lat2,lng2);
var buddahx=lng2,buddahy=lat2;

var tupdatesoltexture=0;
function updatesoltexture(){
        context.font = "12pt Arial";
        context.fillText("updatesol...",20,100);
		var lat000=lat,lng000=lng,worldx000=worldx,worldy000=worldy;
		latsol=latx;lngsol=lngx;
		getworldxy(zoom,latsol,lngsol);
        getlatlng(zoom,worldx+256,worldy+256)
		dlatsol1=lat-latsol;dlngsol1=lng-lngsol;
		lat=lat000;lng=lng000;worldx=worldx000;worldy=worldy000;
        //var lngsol2=lngsol+dlngsol1/nsol;
        //var latsol2=latsol+dlatsol1/nsol;
		//if(tinitsol0==1){
		// tinitsol0=0;
		 //solTexture.image.crossOrigin = "";
        // solTexture.image.src = "green1024.jpg";
		//}else{
		solTexture.image.crossOrigin = "anonymous";
        solTexture.image.src = getmap(zoom,latsol,lngsol,512,"jpg",2);//map2jpg;
		//}
}
var tupdatesoltexture2=0;		
function updatesoltexture2(){
		/*var lat000=lat,lng000=lng;
		latsol=lat;lngsol=lng;
		getworldxy(zoom,lat,lng);
        getlatlng(zoom,worldx+256,worldy+256)
		dlatsol1=lat-latsol;dlngsol1=lng-lngsol;
		lat=lat000;lng=lng000;*/
        var lngsol2=lngsol+0.5*dlngsol1/nsol;
        var latsol2=latsol+0.5*dlatsol1/nsol;
        canvas2.setAttribute('width', 512);
        canvas2.setAttribute('height', 512);
		solTexture2.image.crossOrigin = "anonymous";
        //solTexture2.image.src = getterrain(zoom,lat,lng,512,"jpg",2);//map2jpg;
        solTexture2.image.src = getterrain(zoom,latsol2,lngsol2,552,"jpg",1);//map2jpg;
}

var latsol=lat,lngsol=lng,dlatsol=1,dlngsol=1;
var latsol0=lat,lngsol0=lng;
var latsol00=lat,lngsol00=lng;
var dlatsol0=1,dlngsol0=1,dlatsol1=1,dlngsol1=1;
function getmap(zoom,lat,lng,size,type0,scale){
var type=type0;
if(type=="jpg"){type="jpg-baseline";}
var mapstyle="&style=feature:road%7Cvisibility:off&style=element:labels%7Cvisibility:off&style=element:geometry.stroke%7Cvisibility:off";
return "https://maps.googleapis.com/maps/api/staticmap?center="+lat+","+lng+"&zoom="+zoom+"&scale="+scale+"&size="+size+"x"+size+"&maptype=satellite&format="+type+mapstyle+apikey;
}
function getterrain(zoom,lat,lng,size,type0,scale){
var type=type0;
if(type=="jpg"){type="jpg-baseline";}
//var mapstyle="&style=element:all%7Cvisibility:off";
//mapstyle+="&style=element:geometry.fill%7Cvisibility:on";
//mapstyle+="&style=feature:road%7Cvisibility:off";
var mapstyle="&style=feature:road%7Cvisibility:off&style=element:labels%7Cvisibility:off&style=element:geometry.stroke%7Cvisibility:off";
mapstyle="&style=feature:road%7Cvisibility:on&style=element:labels%7Cvisibility:off&style=element:geometry.stroke%7Cvisibility:off";
return "https://maps.googleapis.com/maps/api/staticmap?center="+lat+","+lng+"&zoom="+zoom+"&scale="+scale+"&size="+size+"x"+size+"&maptype=terrain&format="+type+mapstyle+apikey;
} 
    var mvMatrix = mat4.create();
    var mvMatrixStack = [];
    var pMatrix = mat4.create();
    var pvMatrix = mat4.create();
    var mvMatrix2 = mat4.create();
    var pMatrix2 = mat4.create();
    var mvMatrix0 = mat4.create();
    var pMatrix0 = mat4.create();
    var mvMatrix2sol = mat4.create();
    var mvMatrix2road = mat4.create();

    var mymvMatrixstack=[],nmatrixstack=30,imatrixstack=0;
	for(var i=0;i<=nmatrixstack;i++){mymvMatrixstack[i]=mat4.create();}
	function mvPushMatrix() {
	   mat4.set(mvMatrix,mymvMatrixstack[imatrixstack]);
	   imatrixstack+=1;if(imatrixstack>nmatrixstack){imatrixstack=0;}
	}
	
	function mvPopMatrix() {
	   imatrixstack-=1;if(imatrixstack<0){imatrixstack=nmatrixstack;}
	   mat4.set(mymvMatrixstack[imatrixstack],mvMatrix);
	}
	
	/*function mvPushMatrix() {
        var copy = mat4.create();
        mat4.set(mvMatrix, copy);
        mvMatrixStack.push(copy);
    }

    function mvPopMatrix() {
        if (mvMatrixStack.length == 0) {
            throw "Invalid popMatrix!";
        }
        mvMatrix = mvMatrixStack.pop();
    }*/

    var colorr=1.0,colorg=1.0,colorb=1.0,colora=1.0;
    var rline=0.1;
	function setMatrixUniformsline() {
        gl.uniformMatrix4fv(lineProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(lineProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(lineProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(lineProgram.colorUniform,colorr,colorg,colorb,colora);
        var k=rline;
		if(tshadow==0){
		 gl.uniform1f(lineProgram.cos1Uniform,k*cos1);
         gl.uniform1f(lineProgram.sin1Uniform,k*sin1);
		}else{k=rline*1.6*(1.4+0.8*sunsi2);
		 gl.uniform1f(lineProgram.cos1Uniform,k*sunco1);
         gl.uniform1f(lineProgram.sin1Uniform,k*sunsi1);
        }		
		gl.uniform1i(lineProgram.shadowUniform,tshadow);
		gl.uniform1i(lineProgram.shadowUniform2,tshadow);
    }
	var dmaxuniform=99999;
    function setMatrixUniforms00() {
        gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(shaderProgram.colorUniform,colorr,colorg,colorb,colora);
	    gl.uniformMatrix4fv(shaderProgram.pMatrixUniform2, false, pMatrix2);
	    gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform2, false, mvMatrix2);
        gl.uniform3f(shaderProgram.sunposUniform,0,0,0);
        if(tshadownight==1){gl.uniform1f(shaderProgram.lightUniform,(1-tlight)/18);}
		else{gl.uniform1f(shaderProgram.lightUniform,0);}
        dmaxuniform=99999;
		gl.uniform1f(shaderProgram.dmaxUniform,dmaxuniform);
        gl.uniform1f(shaderProgram.fog,fog);
	    var scx=(dlngsol/klon)*scale;
	    var scy=dlatsol*scale;
        gl.uniform1f(shaderProgram.sunco1,sunco1*2/scy);
        gl.uniform1f(shaderProgram.sunsi1,sunsi1*2/scy);
        gl.uniform1f(shaderProgram.cloudx,(cloudx0+xsol)*(scy/2)*400.0/(300.0*distcloud));
        gl.uniform1f(shaderProgram.cloudy,(ysol)*(scy/2)*400.0/(300.0*distcloud));
    }
    function setMatrixUniforms0() {
        gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(shaderProgram.colorUniform,colorr,colorg,colorb,colora);
	    gl.uniformMatrix4fv(shaderProgram.pMatrixUniform2, false, pMatrix2);
	    gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform2, false, mvMatrix2);
        gl.uniform3f(shaderProgram.sunposUniform,0,0,0);
        if(tshadownight==1){gl.uniform1f(shaderProgram.lightUniform,1.5-tlight/2);}
		else{gl.uniform1f(shaderProgram.lightUniform,0);}
        dmaxuniform=dxmax*5;//dxmax2*5;
		gl.uniform1f(shaderProgram.dmaxUniform,dmaxuniform);
        gl.uniform1f(shaderProgram.fog,fog);
	    var scx=(dlngsol/klon)*scale;
	    var scy=dlatsol*scale;
        gl.uniform1f(shaderProgram.sunco1,sunco1*2/scy);
        gl.uniform1f(shaderProgram.sunsi1,sunsi1*2/scy);
        gl.uniform1f(shaderProgram.cloudx,(cloudx0+xsol)*(scy/2)*400.0/(300.0*distcloud));
        gl.uniform1f(shaderProgram.cloudy,(ysol)*(scy/2)*400.0/(300.0*distcloud));
    }
    function setMatrixUniforms1() {
        gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(shaderProgram.colorUniform,colorr,colorg,colorb,colora);
	    gl.uniformMatrix4fv(shaderProgram.pMatrixUniform2, false, pMatrix2);
	    gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform2, false, mvMatrix2);
        gl.uniform3f(shaderProgram.sunposUniform,1,0,0);
        if(tshadownight==1){gl.uniform1f(shaderProgram.lightUniform,1.5-tlight/2);}
		else{gl.uniform1f(shaderProgram.lightUniform,0);}
        dmaxuniform=dxmax*5;//dxmax2*5;
		gl.uniform1f(shaderProgram.dmaxUniform,dmaxuniform);
        gl.uniform1f(shaderProgram.fog,fog);
	    var scx=(dlngsol/klon)*scale;
	    var scy=dlatsol*scale;
        gl.uniform1f(shaderProgram.sunco1,sunco1*2/scy);
        gl.uniform1f(shaderProgram.sunsi1,sunsi1*2/scy);
        gl.uniform1f(shaderProgram.cloudx,(cloudx0+xsol)*(scy/2)*400.0/(300.0*distcloud));
        gl.uniform1f(shaderProgram.cloudy,(ysol)*(scy/2)*400.0/(300.0*distcloud));
    }
    function setMatrixUniforms() {
        gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(shaderProgram.colorUniform,colorr,colorg,colorb,colora);
	    gl.uniformMatrix4fv(shaderProgram.pMatrixUniform2, false, pMatrix2);
	    gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform2, false, mvMatrix2);
        gl.uniform3f(shaderProgram.sunposUniform,sunx,suny,sunz);
        if(tshadownight==1){gl.uniform1f(shaderProgram.lightUniform,1.5-tlight/2);}
		else{gl.uniform1f(shaderProgram.lightUniform,0);}
        dmaxuniform=dxmax*10;//dxmax2*5*2;
		gl.uniform1f(shaderProgram.dmaxUniform,dmaxuniform);
        gl.uniform1f(shaderProgram.fog,fog);
	    var scx=(dlngsol/klon)*scale;
	    var scy=dlatsol*scale;
        gl.uniform1f(shaderProgram.sunco1,sunco1*2/scy);
        gl.uniform1f(shaderProgram.sunsi1,sunsi1*2/scy);
        gl.uniform1f(shaderProgram.cloudx,(cloudx0+xsol)*(scy/2)*400.0/(300.0*distcloud));
        gl.uniform1f(shaderProgram.cloudy,(ysol)*(scy/2)*400.0/(300.0*distcloud));
    }
    function setMatrixUniformsa() {
        gl.uniformMatrix4fv(shaderaProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shaderaProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(shaderaProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(shaderaProgram.colorUniform,colorr,colorg,colorb,colora);
	    gl.uniformMatrix4fv(shaderaProgram.pMatrixUniform2, false, pMatrix2);
	    gl.uniformMatrix4fv(shaderaProgram.mvMatrixUniform2, false, mvMatrix2);
        gl.uniform3f(shaderaProgram.sunposUniform,0,0,0);
        //gl.uniform1i(shaderaProgram.lightUniform,tlight);
        dmaxuniform=99999;
		gl.uniform1f(shaderaProgram.dmaxUniform,dmaxuniform);
    }
    function setMatrixUniformssun() {
        gl.uniformMatrix4fv(sunProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(sunProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(sunProgram.mvMatrixUniform, false, pvMatrix);
        gl.uniform4f(sunProgram.colorUniform,colorr,colorg,colorb,colora);
	    gl.uniformMatrix4fv(sunProgram.pMatrixUniform2, false, pMatrix2);
	    gl.uniformMatrix4fv(sunProgram.mvMatrixUniform2, false, mvMatrix2);
        gl.uniform3f(sunProgram.sunposUniform,0,0,0);
        dmaxuniform=99999;
		gl.uniform1f(sunProgram.dmaxUniform,dmaxuniform);
    }
   function setMatrixUniformstree() {
        var k=1.0;
		if(tshadow==0){
		  gl.uniform1f(treeProgram.cos1Uniform,k*cos1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sin1);
		}else{k=1.4+0.8*sunsi2;
		  gl.uniform1f(treeProgram.cos1Uniform,k*sunco1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sunsi1);
		}
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, pvMatrix);
		gl.uniform1i(treeProgram.shadowUniform,tshadow);
		gl.uniform1i(treeProgram.shadowUniform2,tshadow);
        if(tshadownight==1){gl.uniform1f(treeProgram.lightUniform,2-tlight);}
		else{gl.uniform1f(treeProgram.lightUniform,0);}
        gl.uniform1f(treeProgram.fog,fog);
   }
   function setMatrixUniformstreesequoia() {
        var k=3.5;if(tsequoia0==2){k=6.0;}
		if(tshadow==0){
		  gl.uniform1f(treeProgram.cos1Uniform,k*cos1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sin1);
		}else{//k*=1.4+0.8*sunsi2;
		  gl.uniform1f(treeProgram.cos1Uniform,k*sunco1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sunsi1);
		}
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, pvMatrix);
		gl.uniform1i(treeProgram.shadowUniform,tshadow);
		gl.uniform1i(treeProgram.shadowUniform2,tshadow);
        if(tshadownight==1){gl.uniform1f(treeProgram.lightUniform,2-tlight);}
		else{gl.uniform1f(treeProgram.lightUniform,0);}
        gl.uniform1f(treeProgram.fog,fog);
   }
   function setMatrixUniformstree2() {
        var k=1.0;
		gl.uniform1f(treeProgram.cos1Uniform,k*cos1);
        gl.uniform1f(treeProgram.sin1Uniform,k*sin1);
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, pvMatrix);
		gl.uniform1i(treeProgram.shadowUniform,1);
		gl.uniform1f(treeProgram.lightUniform,0);
        gl.uniform1f(treeProgram.fog,fog);
    }
	
   function setMatrixUniformsgrass() {
        var k=0.15;
		if(tshadow==0){
		  gl.uniform1f(treeProgram.cos1Uniform,k*cos1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sin1);
		}else{//k*=1.4+0.8*sunsi2;
		  gl.uniform1f(treeProgram.cos1Uniform,k*sunco1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sunsi1);
		}
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
		gl.uniform1i(treeProgram.shadowUniform,tshadow);
		gl.uniform1i(treeProgram.shadowUniform2,k*300);//tshadow);
        if(tshadownight==1){gl.uniform1f(treeProgram.lightUniform,2-tlight);}
		else{gl.uniform1f(treeProgram.lightUniform,0);}
        gl.uniform1f(treeProgram.fog,fog);
    }
   function setMatrixUniformsflower() {
        var k=0.12;
		if(tshadow==0){
		  gl.uniform1f(treeProgram.cos1Uniform,k*cos1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sin1);
		}else{//k*=1.4+0.8*sunsi2;
		  gl.uniform1f(treeProgram.cos1Uniform,k*sunco1);
          gl.uniform1f(treeProgram.sin1Uniform,k*sunsi1);
		}
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
		gl.uniform1i(treeProgram.shadowUniform,tshadow);
		gl.uniform1i(treeProgram.shadowUniform2,k*100);//tshadow);
        if(tshadownight==1){gl.uniform1f(treeProgram.lightUniform,2-tlight);}
		else{gl.uniform1f(treeProgram.lightUniform,0);}
        gl.uniform1f(treeProgram.fog,fog);
    }
	var ksea=0,tlight=1,cloudx0=0,wavez=0.35,zwater=0,wavetx=0,wavety=0,wavevx=0,timewave=0;
	var waveo1=0,waveo10=0;
    function setMatrixUniformssol() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, pvMatrix);
	    gl.uniformMatrix4fv(solProgram.pMatrixUniform2, false, pMatrix2);
	    gl.uniformMatrix4fv(solProgram.mvMatrixUniform2, false, mvMatrix2sol);
        if(tsnow==0 && ttrottoir==1){gl.uniform1f(solProgram.kseaUniform,ksea-2);}
        else{gl.uniform1f(solProgram.kseaUniform,ksea);}
        if(tshadownight==1){gl.uniform1f(solProgram.lightUniform,2-tlight);}
		else{gl.uniform1f(solProgram.lightUniform,0);}
        gl.uniform1f(solProgram.fog,fog);
        gl.uniform1f(solProgram.sunco1,sunco1);
        gl.uniform1f(solProgram.sunsi1,sunsi1);
        gl.uniform1f(solProgram.cloudx,cloudx0*400.0/(300.0*distcloud));
        gl.uniform1f(solProgram.mx,parseInt((x-xsol)/6)*6/scxsol);
        gl.uniform1f(solProgram.my,parseInt((y-ysol)/6)*6/scysol);
		wavez=wind*0.01;wavez=1.99*wavez/(0.55+wavez);
		wavez*=setwavez(x,y);
        gl.uniform1f(solProgram.wavez,wavez);
        gl.uniform1f(solProgram.time,tframe%314160);
		var kwave=(wind+60)/(wind+40);
		if(Math.abs(waveo1-o1)<0.002*dtime){waveo10=o1;};waveo1=o1;
        gl.uniform1f(solProgram.cos1,kwave*Math.cos(degtorad(waveo10-40)));
        gl.uniform1f(solProgram.sin1,kwave*Math.sin(degtorad(waveo10-40)));
		timewave-=dtime*0.00035*wavevx;if(timewave<-1){timewave+=1;}
        gl.uniform1f(solProgram.wavetx,wavetx*timewave);
        gl.uniform1f(solProgram.wavety,wavety*timewave);
        if(noshadow>=2){gl.uniform1i(solProgram.tshadow,0);}
		else{gl.uniform1i(solProgram.tshadow,1);}
    }
   function getterrainheightwater(px,py){
        var mx=parseInt((x-xsol)/6)*6+xsol;
        var my=parseInt((y-ysol)/6)*6+ysol;
	    var xx=(px-mx)/scxsol;
		var yy=(py-my)/scysol;
		var d=Math.max(Math.abs(xx),Math.abs(yy))*240.0;
		var sc=(d+10.0)/(d+20.0);
		//if(d<30.0 && zz<-0.04){
		//if(pz>=-0.04){return pz;}
		var kwave=(wind+60)/(wind+40);
        var co1=kwave*Math.cos(degtorad(o1-40));
        var si1=kwave*Math.sin(degtorad(o1-40));
		var xxx=sc*(xx*co1+yy*si1);
		var yyy=sc*(-xx*si1+yy*co1);
		var time=tframe%31416;
		var zz;
		if(tfoot==1){zz=-0.041+0.2+0.6*(-1.0+Math.cos(xxx*240.0*129.0+time*0.0009)*Math.cos(yyy*240.0*129.0-time*0.0010))*wavez;}
		else{zz=-0.041+0.6*(-1.0+Math.cos(xxx*240.0*129.0+time*0.0009)*Math.cos(yyy*240.0*129.0-time*0.0010))*wavez;}
		return zz;
   }
   var texscalex=1,texscaley=1,textdx=0,textdy=0,scalex2d=1;scaley2d=1,dx2d=0,dy2d=0;   
   function setMatrixUniforms2D() {
        gl.uniform1f(program2d.texscalexUniform,texscalex);
        gl.uniform1f(program2d.texscaleyUniform,texscaley);
        gl.uniform1f(program2d.textdxUniform,textdx);
        gl.uniform1f(program2d.textdyUniform,textdy);
        gl.uniform4f(program2d.colorUniform,colorr,colorg,colorb,colora);
        gl.uniform1f(program2d.scalexUniform,scalex2d);
        gl.uniform1f(program2d.scaleyUniform,scaley2d);
        gl.uniform1f(program2d.dxUniform,dx2d);
        gl.uniform1f(program2d.dyUniform,dy2d);
   }
     function setMatrixUniforms22() {
        gl.uniformMatrix4fv(shader22Program.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shader22Program.mvMatrixUniform, false, mvMatrix);
    }
     function setMatrixUniforms2() {
        gl.uniformMatrix4fv(shader2Program.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shader2Program.mvMatrixUniform, false, mvMatrix);
        gl.uniform4f(shader2Program.colorUniform,colorr,colorg,colorb,colora);
    }
     function setMatrixUniformssh0() {
        gl.uniformMatrix4fv(shader0Program.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shader0Program.mvMatrixUniform, false, mvMatrix);
        gl.uniform4f(shader0Program.colorUniform,colorr,colorg,colorb,colora);
        gl.uniform1f(shader0Program.fog,fog);
    }

    var noshadow=0;
	function drawrttshadow() {//return;
	  if(noshadow>=22){return;}
      //gl.bindRenderbuffer(gl.RENDERBUFFER, renderbuffer);
      gl.bindFramebuffer(gl.FRAMEBUFFER, rttFramebuffer);
      //gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rttTexture, 0);
	  drawshadow(0);
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      //gl.bindRenderbuffer(gl.RENDERBUFFER, null);
    }
	function drawrtt2shadow() {//return;
	  if(noshadow>=22){return;}
      gl.bindFramebuffer(gl.FRAMEBUFFER, rtt2Framebuffer);
	  drawshadow(1);
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      //gl.bindRenderbuffer(gl.RENDERBUFFER, null);
    }
	function drawrtt3shadow() {//return;
	  if(noshadow>=22){return;}
      gl.bindFramebuffer(gl.FRAMEBUFFER, rtt3Framebuffer);
	  drawshadow3();
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      //gl.bindRenderbuffer(gl.RENDERBUFFER, null);
    }
var tshadow=1,distshadow=30.0,kdxy=0.5,sunzz=1000,sunco2=0,sunsi2=1,sunco1=0,sunsi1=1;
//var sunx=100,suny=-200,sunz=300;
var tshadownight=0;
    function drawshadownight(irtt) {
	    tshadow=1;
        if(irtt==0){gl.viewport(0, 0, rttTexture.width,rttTexture.height);}//620,419);
		else{gl.viewport(0, 0, rtt2Texture.width,rtt2Texture.height);}
        //gl.viewport(0, 0, 500,500);
        //gl.clearColor(1,1,1, 1.0);
        if(tlight==1){gl.clearColor(1,1,0, 1.0);}
		else{gl.clearColor(0,0,0, 1.0);}
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		distshadow=30.0;
		if(noshadow==1){distshadow=60.0;}
		distshadow*=0.5;
		var wx=distshadow,wy=distshadow*kdxy+7.0;
		var sunxx=sunx-x,sunyy=suny-y,sunzz=sunz-z;
		var dz=Math.max(0.01,Math.sqrt(sunxx*sunxx+sunyy*sunyy+sunzz*sunzz));
		var dx=Math.max(0.01,Math.sqrt(sunxx*sunxx+sunyy*sunyy));
		sunco2=dx/dz;sunsi2=sunzz/dz;
		//sunco1=sunxx/dx;sunsi1=sunyy/dx;
		sunco1=-cos1;sunsi1=-sin1;
	if(irtt==0){
        //mat4.ortho(-wx,wx,-wy*sunsi2,wy*sunsi2,0.10, 1900.0, pMatrix);
        mat4.ortho(-wx,wx,-wy,wy,5.3, 900.0, pMatrix);
    	//mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 0.2, 3000.0, pMatrix);//3000
		var d300=300;
		var xv=x+sunxx*d300/dz,yv=y+sunyy*d300/dz,zv=zsol+sunzz*d300/dz;//20*sunz+51000;
		mat4.lookAt([xv,yv,zv],[x,y,zsol],[-sunxx,-sunyy,1],mvMatrix);
   		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
		mat4.set(pMatrix,pMatrix0);
        mat4.set(mvMatrix,mvMatrix0);
   	}else{
          mat4.ortho(-wx/2,wx/2,-wy/2,wy/2,5.3, 900.0, pMatrix);
	      //mat4.set(pMatrix0,pMatrix);
	      mat4.set(mvMatrix0,mvMatrix);
    }
		gl.useProgram(shader22Program);
	if(irtt==0){
		setmatrix2();
		if(noshadow>=2){noshadow+=1;tshadow=0;return;}
		if(tlight==0){tshadow=0;return;}
		drawsol2();
		drawtowers2();
		drawchurchs2();
		drawhouses2();
		drawofficials2();
		drawhospitals2();
		drawroofs2();
		drawshops2();
		drawwoman2();
		drawroc2();
		drawroads2();
	}else{
		if(noshadow>=2){noshadow+=1;tshadow=0;return;}
		if(tlight==0){tshadow=0;return;}
		//if(iview==1 && tfoot==0){drawcarobj2();}
		//else if(tfoot==0){drawcarobj2();}//drawcar2();}
   		gl.useProgram(shader2Program);
		drawncarobj2();
   		//gl.useProgram(shaderProgram);
		//drawcloud22();
		//drawroads2();
	}
	if(irtt==0){
   		gl.useProgram(treeProgram);
		drawtree();
		if(tsequoia==0){drawtree2();}
		gl.useProgram(lineProgram);
		drawline();
		drawcross();
		drawcitypanel();
	}
		tshadow=0;
	}	
    function drawshadow(irtt) {
		if((hour<4 || hour>21)&& tmap==0){tshadownight=1;drawshadownight(irtt);return;}
		else{tshadownight=0;}
	    tshadow=1;
        if(irtt==0){gl.viewport(0, 0, rttTexture.width,rttTexture.height);}//620,419);
		else{gl.viewport(0, 0, rtt2Texture.width,rtt2Texture.height);}
        //gl.viewport(0, 0, 500,500);
        //gl.clearColor(1,1,1, 1.0);
        gl.clearColor(1,1,0, 1.0);
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		distshadow=30.0;
		if(noshadow==1){distshadow=60.0;}
		var wx=distshadow,wy=distshadow*kdxy+7.0;
		var dz=Math.max(0.01,Math.sqrt(sunx*sunx+suny*suny+sunz*sunz));
		var dx=Math.max(0.01,Math.sqrt(sunx*sunx+suny*suny));
		sunco2=dx/dz;sunsi2=sunz/dz;
		sunco1=sunx/dx;sunsi1=suny/dx;
	if(irtt==0){
        //last//mat4.ortho(-wx,wx,-wy*sunsi2,wy*sunsi2,100.0, 1900.0, pMatrix);
        //mat4.ortho(-wx,wx,-wy*sunsi2,wy*sunsi2,10.0, 9000.0, pMatrix);
        mat4.ortho(-wx,wx,-wy,wy,5.0, 5000.0, pMatrix);
		var xv=x+sunx*300/dz,yv=y+suny*300/dz,zv=zsol+sunz*300/dz;//20*sunz+51000;
		mat4.lookAt([xv,yv,zv],[x,y,zsol],[-sunx,-suny,-0.1],mvMatrix);
   		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
		mat4.set(pMatrix,pMatrix0);
        mat4.set(mvMatrix,mvMatrix0);
   	}else{
          mat4.ortho(-wx/2,wx/2,-wy/2,wy/2,5.0, 5000.0, pMatrix);
	      //mat4.set(pMatrix0,pMatrix);
	      mat4.set(mvMatrix0,mvMatrix);
    }
		gl.useProgram(shader22Program);
	if(irtt==0){
		setmatrix2();
		if(noshadow>=2){noshadow+=1;tshadow=0;return;}
		if(hour<4 || hour>21){tshadow=0;return;}
		drawsol2();
		drawtowers2();
		drawchurchs2();
		drawhouses2();
		drawroofs2();
		drawshops2();
		drawwoman2();
		drawroc2();
		drawroads2();
	}else{
		if(noshadow>=2){noshadow+=1;tshadow=0;return;}
		if(hour<4 || hour>21){tshadow=0;return;}
   		gl.useProgram(shader2Program);
		if(iview==1 && tfoot==0 && testwater==0){drawcarobj2();}
		else if(tfoot==0 && testwater==0){drawcarobj2();}//drawcar2();}
		drawncarobj2();
   		//gl.useProgram(shaderProgram);
		//drawcloud22();
		//drawroads2();
	}
	if(irtt==0){
   		gl.useProgram(treeProgram);
		drawtree();
		drawtree2();
		gl.useProgram(lineProgram);
		drawline();
		drawcross();
		drawcitypanel();
	}
		tshadow=0;
	}	
    function drawshadow3() {
	    tshadow=1;
        gl.viewport(0, 0, rtt3Texture.width,rtt3Texture.height);
        //gl.viewport(0, 0, 500,500);
        //gl.clearColor(1,1,1, 0.20);
        gl.clearColor(0,0,0, 0.20);
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		distshadow=distcloud;//400.0
		var wx=distshadow,wy=distshadow;
		var dz=Math.max(0.01,Math.sqrt(sunx*sunx+suny*suny+sunz*sunz));
		var dx=Math.max(0.01,Math.sqrt(sunx*sunx+suny*suny));
		sunco2=dx/dz;sunsi2=sunz/dz;
		sunco1=sunx/dx;sunsi1=suny/dx;
        mat4.ortho(-wx,wx,-wy*sunsi2,wy*sunsi2,10.0, 9000.0, pMatrix);
        //mat4.ortho(-wx,wx,-wy,wy,10.0, 10000.0, pMatrix);
		var xv=x+sunx*4000/dz,yv=y+suny*4000/dz,zv=zsol+sunz*4000/dz;//20*sunz+51000;
		mat4.lookAt([xv,yv,zv],[x,y,zsol],[-sunx,-suny,1],mvMatrix);
   		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(diro1(sunx,suny)+90), [0, 0, 1]);
		//setmatrix2();
		if(noshadow>=2){noshadow+=1;tshadow=0;return;}
		if(hour<4 || hour>21){tshadow=0;return;}
		if(tcloud>=1){
				   fogsave=fog;fog=0;
				   gl.useProgram(shader0Program);
				   drawcloud2();
				   fog=fogsave;}
		tshadow=0;
	}	
	var cos22=1,sin22=0,cos13=1,sin13=0,o1view=0;
	var dxview=1;
    var vm2=0,vm20=0,do222=0,o222=0,o333=0,o1save=0,cos1save=1,sin1save=0;
	var o1head=0,zview=0;
	function drawScene() {
	o1save=o1;cos1save=cos1;sin1save=sin1;
    gl.clearColor(0.85,0.85,1.0, 1.0);
		gl.viewport(0, 0, windx,windy);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    	mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 0.2, 3000.0, pMatrix);//3000

var ksuspension=20,kfps=Math.min(3,dtime*0.03);
if(tfoot==0){//suspensions
 if(iview==1){ksuspension=5;}else if(troad==0){ksuspension+=(9-ksuspension)/3;}
 else{ksuspension+=(20-ksuspension)/3;};
 if(tfly==1){ksuspension=7;} 
 vm20=vm2;
 vm2=(vmx2*cos1+vmy2*sin1)*100;
 if(vm2<0.01){vm2=0;}
 var do22=Math.max(-45,Math.min(45,(vm2-vm20)*7*ksuspension));
 o2+=do22;//'/(0.02+kfps3)'*5*
 o222=Math.max(o2-25,Math.min(o2+25,o222));
 o222=Math.max(-60,Math.min(60,o222));
 do222+=(o2-o222)*0.04*kfps-0.062*do222*kfps;//*ko222; 
 o222+=do222*0.3*kfps;
}else{
 o222=o2;planedo2=0;
} 
//var cos222=Math.cos(degtorad(o222)),sin222=Math.sin(degtorad(o222));
		if(tmap==0){
//o222+=0.945*(o2+sin2*10-o222)*Math.min(1.0,kfps*0.4) 
o333+=0.945*(o3+sin3*10-o333)*Math.min(1.0,kfps*0.4)
if(Math.random()<0.035*vcar*dtime){o333+=(Math.random()-0.5);}
		   var o22=Math.max(-50,Math.min(50,o222-planedo2*0.24-2.7));
		   var co3=Math.cos(degtorad(o333+planedo3*1.2));si3=Math.sin(degtorad(o333+planedo3*1.2));
		   var co2=Math.cos(degtorad(o22));si2=Math.sin(degtorad(o22));
		   cos22=co2;sin22=si2;
		   //mat4.lookAt([x,y,z+0.25],[x+cos1*cos2,y+sin1*cos2,z+sin2+0.25],[0,0,1],mvMatrix);
		   if(tfoot==1){
		      tmouse3move=0;tmouse2move=0;
		      var zz=Math.max(0.2+zsol,z-0.35);//0.29
			  zview=zz;
		      mat4.lookAt([x,y,zz],[x+cos1*cos2,y+sin1*cos2,zz+sin2],[0,0,1],mvMatrix);
		   }else if(iview==1 && (tfly==0 || tmouse3move==0)){
			var o13=0;
			if(cos1*cos13+sin1*sin13>0.85 || tautopilot==0){
			   cos13=cos1;sin13=sin1;o13=o1;}
		    else{o13=diro1(cos13,sin13);}
			var do1view=o13-o1view;
			while(do1view>180){do1view-=360;}
			while(do1view<-180){do1view+=360;}
			while(o1view>180){o1view-=360;}
			while(o1view<-180){o1view+=360;}
			do1view=Math.max(-50,Math.min(50,do1view));
			if(Math.abs(do1view)>1){o1view+=dtime*0.001*do1view;}
		    var cos133=Math.cos(degtorad(o1view));
			var sin133=Math.sin(degtorad(o1view));
			var xx=x-1.7*cos133*dxview,yy=y-1.7*sin133*dxview;
			var zz=Math.max(z-0.17-0.2*(1-dxview)-tfly*sin2*1.5,0.1+getterrainheight2(xx,yy));
		    var zzz=Math.max(0.1-ztunnel,z-0.7);
			if(tfly==0){zz=Math.max(zsol+0.2,zz);zzz=Math.max(zsol+0.2,zzz);}
			sin22=(zzz-zz)/Math.sqrt(2*2+(zzz-z)*(zzz-z));
			zview=zz;
			mat4.lookAt([xx,yy,zz],[x,y,zzz],[0,0,1],mvMatrix);
			o1=o1view;cos1=cos133;sin1=sin133;
		   }else{
		    var zz=Math.max(0.1-ztunnel,z-0.551);//0.46);//0.551);
		    var o11=o1-mouse2dx*18,dzz=0;if(tmouse3move==1){o11=o1-mouse3dx*18;dzz=-0.4*tfly;}
			o11+=o1head;
			var co1=Math.cos(degtorad(o11)),si1=Math.sin(degtorad(o11));
			if(tfly==0){zz=Math.max(zsol+0.2,zz);}
			zview=zz;
			mat4.lookAt([x,y,zz],[x+co1*co2,y+si1*co2,zz+mouse2dy*0.45+(si2+0.3*sin2)/1.3+dzz],[-co1*si2-si1*si3,-si1*si2+co1*si3,co2*co3],mvMatrix);
		    o1=o11;cos1=co1;sin1=si1;
		   }
		   //mat4.lookAt([x,y,z+0.5],[x+cos1*cos2,y+sin1*cos2,z+sin2+0.5],[0,0,1],mvMatrix);
		   //mat4.lookAt([x,y,z-0.2],[x+cos1*co2,y+sin1*co2,z+si2-0.2],[0,0,1],mvMatrix);
		}else if(tmap==1){
		   mat4.lookAt([x,y,z+0.5+200],[x,y+1,z+0.5],[0,0,1],mvMatrix);
		}else{return;
		   mat4.lookAt([x,y,z+0.5+200],[x+cos1,y+sin1,z+0.5],[0,0,1],mvMatrix);
		   gl.useProgram(shaderProgram);
		   //ibuff=ibuff0;
		   drawsol3();
		   return;
		   //mat4.lookAt([x,y,z+200.5],[x+cos1*cos2,y+sin1*cos2,z+sin2+0.5],[0,0,1],mvMatrix);
		}
		   
		gl.useProgram(shader0Program);
		//ibuff=ibuff0;
		var fogsave=fog;fog*=0.73;
		if(tmap==0){drawsky();
		   //if(tcloud>=1){movecloud();drawcloud();}
		   }
		//else{drawcloud2();}
		if(tmap==0){
		   gl.useProgram(sunProgram);
		   drawsun();}
		fog=fogsave;

        fogsave=fog;if(tmap>0){fog=0;}
		gl.useProgram(shaderProgram);
	gl.activeTexture(gl.TEXTURE15);
    gl.bindTexture(gl.TEXTURE_2D,  rttTexture);
    gl.uniform1i(shaderProgram.samplerUniform2, 15);
	gl.activeTexture(gl.TEXTURE13);
    gl.bindTexture(gl.TEXTURE_2D,  rtt2Texture);
    gl.uniform1i(shaderProgram.samplerUniform3, 13);
	gl.activeTexture(gl.TEXTURE14);
    gl.bindTexture(gl.TEXTURE_2D,  rtt3Texture);
    gl.uniform1i(shaderProgram.samplerUniform6, 14);
		drawtowers();
		drawchurchs();
		drawhouses();
		drawofficials();
		drawhospitals();
		drawroofs();
		drawshops();

        gl.useProgram(shaderProgram);
		drawroads();
		drawroadbands();
		drawroadarrow();
		drawwoman();
		draweiffeltower();
		drawlibertystatue();
		drawchristrio();
		drawdomerock();
		drawgizah();
		drawcapitole();
		drawtajmahal();
		drawbuddah();
		drawroc();
		drawboeing();
		drawboeing2();

		gl.useProgram(treeProgram);
		//updatetree();
		drawtree();
		drawtree2();
		if((itime%10)==7){setineartree();}
        else{if(ineartree>60 && ineartree<=140){soundcricket();}//120
             else{stopsoundcricket();}
             if(ineartree>140){soundnature();}
             else{stopsoundnature();}
		}
		if(z<zsol+10){if(loading<=995){updategrass();};drawgrass();
		              if(loading<=995){updateflower();};drawflower();
					  }

		gl.useProgram(lineProgram);
		drawline();
		drawcross();
		drawcitypanel();
		
		gl.useProgram(solProgram);
	gl.activeTexture(gl.TEXTURE15);
    gl.bindTexture(gl.TEXTURE_2D,  rttTexture);
    gl.uniform1i(solProgram.samplerUniform4, 15);
	gl.activeTexture(gl.TEXTURE13);
    gl.bindTexture(gl.TEXTURE_2D,  rtt2Texture);
    gl.uniform1i(solProgram.samplerUniform5, 13);
	gl.activeTexture(gl.TEXTURE14);
    gl.bindTexture(gl.TEXTURE_2D,  rtt3Texture);
    gl.uniform1i(solProgram.samplerUniform6, 14);
		drawsol();
		
		fog=fogsave;
	    
		gl.useProgram(program2d);
		drawrain();

/*		gl.useProgram(shaderProgram);
	gl.activeTexture(gl.TEXTURE15);
    gl.bindTexture(gl.TEXTURE_2D,  rttTexture);
    gl.uniform1i(shaderProgram.samplerUniform2, 15);
*/
	if(tmap>=0){gl.useProgram(shaderaProgram);
	            drawstationobj();
		        drawncarobj();
				drawsmoke();
		        if(tcloud>=1){
				   fogsave=fog;fog=0;
				   gl.useProgram(shader0Program);
				   movecloud();drawcloud();
				   fog=fogsave;}
				}
    fogsave=fog;fog=0;
	if(tmap==0 && tinit>2){
		      gl.useProgram(shaderProgram);
	          drawsailships();}
	if(tfoot==0 && tmap==0){
		   if(iview==0){gl.useProgram(shader0Program);drawcarcockpit();}
		   else if(iview==1){
		      gl.useProgram(shaderaProgram);
		      drawcarobj();
		   }
           if(tminimap==1 && tmouse3move==0){
		      //drawtexture(rttTexture);
			  //drawtexture(solTexture);
		      gl.useProgram(shaderProgram);
              drawminimap();}}
		else if(tminimap2==1 && tmap==0){gl.useProgram(shaderProgram);drawminimap();};   
		if(tmap==0){
		   gl.useProgram(shaderProgram);
		   drawbouss();
		   if((myisailship>=0 || ianchorship>=0) && tinit>2){drawbouss2();}
		   }

		if(tfoot==0 && tcollideon==1 && tautopilot==0){
		  //gl.useProgram(shaderaProgram);
		  //drawtestcollide();
		  testcollide();
		  if(tcollide2==1){
		     tcollide2=0;dxview=Math.max(0.35,dxview-0.2);
		  }else{dxview=Math.min(1.0,dxview+0.025*dtime*0.01);}	 
		  }
	
    fog=fogsave;	
	o1=o1save;cos1=cos1save;sin1=sin1save;
		
		}
var tminimap=1,tminimap2=0,tdrawminimap=0;		
function drawminimap(){
    var do2=planedo2;if(tfoot==1){do2=0;}
    var dy=Math.max(1,windy*(0.02+do2*0.01));
    var dx=(windx*0.5+windy*0.25*cssscaley/cssscale);
	var dxx=(windy*0.28)*cssscaley/cssscale;
	var dyy=(windy*0.24);
	gl.viewport(dx-1,dy-1,dxx+2,dyy+2);
    //gl.viewport(100/cssscale,10/cssscaley,60/cssscale,60/cssscaley);
	mvPushMatrix();
		mat4.lookAt([x,y,z+29*zoomminimap],[x+9.8*cos1,y+9.8*sin1,z],[0,0,1],mvMatrix);
        gl.useProgram(shaderProgram);
	/*gl.viewport(windx*0.5-1,dy*3-1,dxx*3+2,dyy*3+2);
	drawtexture(rtt3Texture);mvPopMatrix();
	gl.viewport(0, 0, windx,windy);return;*/
        gl.disable(gl.DEPTH_TEST);
		colorr=0.5;colorg=0.5;colorb=0.5;
		drawscreen();
	gl.viewport(dx,dy,dxx,dyy);
		//drawscreen();
		tshadow=1;
		//gl.useProgram(solProgram);
		drawsol3();
		gl.useProgram(shaderProgram);
        tdrawminimap=1;
		drawroads();
		drawroadbands();
        tdrawminimap=0;
		//drawcarcockpit();
	mat4.translate(mvMatrix, [x,y,z+1]);
	mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
    var sc=0.018;
    mat4.scale(mvMatrix,[sc,sc*0.8,sc]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    colorr=1;colorg=0;colorb=0;colora=0;
	drawcarre();
	colorr=1;colorg=1;colorb=1;colora=1;
		tshadow=0;
        gl.enable(gl.DEPTH_TEST);
	mvPopMatrix();
	gl.viewport(0, 0, windx,windy);
}
function drawroads(){
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE1);
    gl.bindTexture(gl.TEXTURE_2D,  roadTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 1);

	gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, roadVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, roadVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, roadVertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

	if(tshadow==0){
	    colorr=1;colorg=1;colorb=1;colora=1;
        if(tmap==0){setMatrixUniforms1();}
		else{setMatrixUniforms00();}
	}else{
	    colorr=1;colorg=1;colorb=1;colora=0;
        if(tdrawminimap==1){setMatrixUniforms00();}
		else{setMatrixUniforms0();}}
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, roadVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawroadbands(){
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,-0.002]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE1);
    gl.bindTexture(gl.TEXTURE_2D,  roadbandTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 1);

	gl.bindBuffer(gl.ARRAY_BUFFER, roadbandVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, roadbandVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, roadbandVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, roadbandVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, roadbandVertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, roadbandVertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

	if(tshadow==0){
	    colorr=1;colorg=1;colorb=1;colora=1;
        setMatrixUniforms1();}
	else{
	    colorr=1;colorg=1;colorb=1;colora=0;
        if(tdrawminimap==1){setMatrixUniforms00();}
		else{setMatrixUniforms0();}}
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, roadbandVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawtowers(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE2);
    if(hour<7 || hour>19){gl.bindTexture(gl.TEXTURE_2D,  towernightTexture);}
	else{gl.bindTexture(gl.TEXTURE_2D,  towerTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 2);

	gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, towerVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, towerVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, towerVertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniforms();
    gl.uniform1f(shaderProgram.lightUniform,0);
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, towerVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawchurchs(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE2);
    gl.bindTexture(gl.TEXTURE_2D,  churchTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 2);

	gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, churchVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, churchVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, churchVertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniforms();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, churchVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawhouses(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE2);
    gl.bindTexture(gl.TEXTURE_2D,  houseTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 2);

	gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, houseVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, houseVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, houseVertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniforms();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, houseVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawofficials(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE2);
    gl.bindTexture(gl.TEXTURE_2D,  officialTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 2);

	gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, officialVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, officialVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, officialVertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniforms();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, officialVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawhospitals(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE2);
    gl.bindTexture(gl.TEXTURE_2D,  hospitalTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 2);

	gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, hospitalVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, hospitalVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, hospitalVertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniforms();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, hospitalVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawroofs(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE3);
    gl.bindTexture(gl.TEXTURE_2D,  roofTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 3);

	gl.bindBuffer(gl.ARRAY_BUFFER, roofVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, roofVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, roofVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, roofVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=1;
	if(tmap==0){setMatrixUniforms();}
	else{setMatrixUniforms00();}
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, roofVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawshops(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE2);
    gl.bindTexture(gl.TEXTURE_2D,  shopTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 2);

	gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, shopVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, shopVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, shopVertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniforms();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, shopVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function setmatrix2(){
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	//mat4.multiply(pMatrix,mvMatrix,pvMatrix2);
	mat4.set(pMatrix,pMatrix2);
	mat4.set(mvMatrix,mvMatrix2);
	mvPopMatrix();
}
function drawroads2(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,-0.105]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  roadTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, roadVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms22();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, roadVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawtowers2(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	//mat4.multiply(pMatrix,mvMatrix,pvMatrix2);
	//mat4.set(pMatrix,pMatrix2);
	//mat4.set(mvMatrix,mvMatrix2);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  towerTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, towerVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms22();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, towerVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawchurchs2(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	//mat4.multiply(pMatrix,mvMatrix,pvMatrix2);
	//mat4.set(pMatrix,pMatrix2);
	//mat4.set(mvMatrix,mvMatrix2);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  churchTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, churchVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms22();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, churchVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
var itestchurch=0;
function testchurch(){
if(tframe<tsoundvoyage+295000 || tradio==1){return;}//4'53
var dist=9.0,x2=x+x,y2=y+y;
var ii=churchVertexPositionBuffer[ibuff].numItems*3;
itestchurch+=18;if(itestchurch>=ii || itestchurch>=36){itestchurch=0;}
for(var i=itestchurch;i<ii;i+=36){
 if(Math.abs(churchvertices[i]-x2)<dist){
  if(Math.abs(churchvertices[i+1]-y2)<dist){
   var dist1=Math.max(Math.abs(churchvertices[i]-x2),Math.abs(churchvertices[i+1]-y2));
   if(((churchvertices[i]-x2)*cos1+(churchvertices[i+1]-y2)*sin1)>dist1*0.6){
      dist=dist1;
 }}}
}
if(dist<8.99){soundvoyage();}
}
function drawhouses2(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  houseTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, houseVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms22();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, houseVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawofficials2(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	//mat4.multiply(pMatrix,mvMatrix,pvMatrix2);
	//mat4.set(pMatrix,pMatrix2);
	//mat4.set(mvMatrix,mvMatrix2);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  officialTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, officialVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms22();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, officialVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawhospitals2(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	//mat4.multiply(pMatrix,mvMatrix,pvMatrix2);
	//mat4.set(pMatrix,pMatrix2);
	//mat4.set(mvMatrix,mvMatrix2);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  hospitalTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, hospitalVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms22();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, hospitalVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawroofs2(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  roofTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, roofVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, roofVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms22();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, roofVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
function drawshops2(){
    gl.disable(gl.CULL_FACE);
    gl.enable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  roofTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, shopVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms22();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, shopVertexPositionBuffer[ibuff].numItems);
	mvPopMatrix();
}
var timerain=0,train0=0,wclouds=50.1;
var train=0,train1=0,train2=0,timerain1=0,timerain2=0;
var texscalex1=1,texscaley1=1,textdx1=0,textdy1=0;
var texscalex2=1,texscaley2=1,textdx2=0,textdy2=0;
var trainfog=0,fog0=0.45,fogweather=-1;
function drawrain(){
    var fog00=fog0*(1-0.55*Math.abs(12-hour)/12)*0.3;
	if(fogweather>=0 && tfog>=0.1 && tframe>trainfog+5000){fog00=fogweather*tfog;}
    if(fog<fog00){fog+=(fog00-fog)*dtime*0.0003;}else{fog=fog00;}
    if(tframe<trainfog+5000){
         fog0=Math.max(tfog*0.1,(0.55+tfog*0.15)*(trainfog+5000-tframe)/5000);fog=fog00;}
	else{fog0=tfog*0.45;}
	if(tframe>timerain){
      timerain=tframe+20000+Math.random()*40000;
      var dtcloud=((wclouds/50)+1)*0.035*(1+testwater)/2.0;
      if(Math.random()<dtcloud && humidity>=80){train=1;}else{train=0;}}
    if(train==0 && train1==0 && train2==0 || ttunnel>=1){stopsoundrain();return;}
	soundrain();trainfog=tframe;
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.ONE_MINUS_SRC_COLOR, gl.ONE);
	gl.activeTexture(gl.TEXTURE10);
    gl.bindTexture(gl.TEXTURE_2D,  rainTexture);
    gl.uniform1i(program2d.samplerUniform, 10);
	dx2d=0;dy2d=0;
    texscalex=windx/windy;texscaley=1;
	if(tframe>timerain2){
	        timerain2=tframe+70*(Math.random()+1)
			textdx=Math.random();textdy=Math.random();}
	if(tframe>timerain1){
	    train1=train;
	    timerain1=tframe+(Math.random()+2)*3000;}		
    var c=0;
    colorr=c;colorg=c;colorb=c;colora=1;
	drawcarre2D();

	colorr=1;colorg=1;colorb=1;colora=1;
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawrain0(){
    var fog00=fog0*(1-0.55*Math.abs(12-hour)/12);
	if(fogweather>=0 && tfog>=0.1 && tframe>trainfog+5000){fog00=fogweather*tfog;}
    if(fog<fog00){fog+=(fog00-fog)*dtime*0.0003;}else{fog=fog00;}
    if(tframe<trainfog+5000){
         fog0=Math.max(tfog*0.1,(0.55+tfog*0.15)*(trainfog+5000-tframe)/5000);fog=fog00;}
	else{fog0=tfog*0.45;}
	if(tframe>timerain){
      timerain=tframe+5000+Math.random()*40000;
      var dtcloud=(parseInt(wclouds/50)+1)*0.035/3.5;
      if(Math.random()<dtcloud && humidity>80){train=1;}else{train=0;}}
    if(train==0 && train1==0 && train2==0 || ttunnel>=1){stopsoundrain();return;}
	soundrain();trainfog=tframe;
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.ONE_MINUS_SRC_COLOR, gl.ONE);
	gl.activeTexture(gl.TEXTURE10);
    gl.bindTexture(gl.TEXTURE_2D,  rainTexture);
    gl.uniform1i(program2d.samplerUniform, 10);
	var vplane=vcar*4.5;
	var kvplane=(0.5+1.5*vplane);if(kvplane<0.5){kvplane=0.5;}
	dx2d=0;dy2d=0.2;
	texscalex=texscalex1;texscaley=texscaley1;
	textdx=textdx1;textdy=textdy1;
	if(tframe>timerain1){
	  train1=train;
      if(tframe>timerain2){
	    timerain1=tframe+(Math.random()+2)*800/kvplane;		
	  }else{timerain1=timerain2+(Math.random()+2)*600/kvplane;}
	  //texscalex=0.75*windx/windy;texscaley=0.85;
	  texscalex=0.85*windx/windy;texscaley=0.85;
	  textdx=Math.random();textdy=Math.random();
	}else{texscalex-=kvplane*dtime/7000;
	      texscaley-=kvplane*dtime/7000;}
    if(texscalex<0.1){texscalex=0.1;}
    if(texscaley<0.1){texscaley=0.1;}
    var c=(1.4-texscaley);
    colorr=c;colorg=c;colorb=c;colora=1;
	texscalex1=texscalex;texscaley1=texscaley;
	textdx1=textdx;textdy1=textdy;
	texscaley*=(1+Math.abs(dy2d));
	if(train1==1){drawcarre2D();}

	texscalex=texscalex2;texscaley=texscaley2;
	textdx=textdx2;textdy=textdy2;
	if(tframe>timerain2){
	  train2=train;
      if(tframe>timerain1){
	    timerain2=tframe+(Math.random()+2)*800/kvplane;	
	  }else{timerain2=timerain1+(Math.random()+2)*600/kvplane;}
	  //texscalex=0.75*windx/windy;texscaley=0.85;
	  texscalex=0.85*windx/windy;texscaley=0.85;
	  textdx=Math.random();textdy=Math.random();
	}else{texscalex-=kvplane*dtime/7000;
	      texscaley-=kvplane*dtime/7000;}
    if(texscalex<0.1){texscalex=0.1;}
    if(texscaley<0.1){texscaley=0.1;}
    c=(1.4-texscaley);
    colorr=c;colorg=c;colorb=c;colora=1;
	texscalex2=texscalex;texscaley2=texscaley;
	textdx2=textdx;textdy2=textdy;
	texscaley*=(1+Math.abs(dy2d));
	if(train2==1){drawcarre2D();}

	colorr=1;colorg=1;colorb=1;colora=1;
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawcarre2D(){
	//gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    //gl.vertexAttribPointer(program2D.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(program2d.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms2D();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarrecockpit(){
	gl.bindBuffer(gl.ARRAY_BUFFER, cockpitVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader0Program.textureCoordAttribute, cockpitVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, cockpitVertexPositionBuffer);
    gl.vertexAttribPointer(shader0Program.vertexPositionAttribute, cockpitVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniformssh0();
    gl_drawArrays(gl.TRIANGLES, 0, cockpitVertexPositionBuffer.numItems);
}
function drawbouss0(){
  var xx=windx-40,yy=40,r=14;
  context.clearRect (xx-40,yy-40,xx+40,yy+40);
  context.font = "12pt Arial";
  context.fillText("+",xx,yy);
  context.fillText("S",xx+r*cos1,yy+r*sin1);
  context.fillText("N",xx-r*cos1,yy-r*sin1);
  context.fillText("E",xx+r*sin1,yy-r*cos1);
  context.fillText("W",xx-r*sin1,yy+r*cos1);
}
function drawbouss(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    //gl.enable(gl.BLEND);
    //gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		//mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,220,-600]);//boussx
		mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,220,-600]);//boussx
		mat4.rotate(mvMatrix, degtorad(90-o1), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  boussTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    drawcarre();

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    //gl.disable(gl.BLEND);
}
var o1wind=Math.random()*360;
function drawbouss2(){
    if(Math.random()<dtime*0.004){
	   o1wind+=(Math.random()-0.5)*5;
	   if(o1wind>360){o1wind-=360;}
	   if(o1wind<-360){o1wind+=360;}}
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    //gl.enable(gl.BLEND);
    //gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		//mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,220,-600]);//boussx
		mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,160,-600]);//boussx
		mat4.rotate(mvMatrix, degtorad(o1wind-o1), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  boussTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
	mat4.scale(mvMatrix,[0.62,0.62,1]);
    drawcarre();

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    //gl.disable(gl.BLEND);
}
function drawsmoke(){
    if(tframe>tsoundpneu+1700){return;}
	var sc=0.12*(tframe-tsoundpneu+200)/400;
	while(sc>0.12*3){sc-=0.12*2;}
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_COLOR, gl.ONE);
	gl.activeTexture(gl.TEXTURE10);
    gl.bindTexture(gl.TEXTURE_2D,  smokeTexture);
    gl.uniform1i(shaderaProgram.samplerUniform, 10);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [-10,-9,-60*(windy/windx-sc*vcar*5)]);
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(planedo2), [1, 0, 0]);
    
    mat4.scale(mvMatrix,[sc,sc*0.8,sc]);
    colorr=1;colorg=1;colorb=1;colora=0;//1+20;
    drawcarrea();
	mat4.translate(mvMatrix, [20/sc,0,0]);
    drawcarrea();
    colorr=1;colorg=1;colorb=1;colora=1;
		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawscreen(){
    gl.disable(gl.CULL_FACE);
    //gl.disable(gl.DEPTH_TEST);
    //gl.enable(gl.BLEND);
    //gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0,0,-64]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  greenTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
	mat4.scale(mvMatrix,[4,4,1]);
	colorr=1;colorg=1;colorb=1;colora=0;
    drawcarre();
	colorr=1;colorg=1;colorb=1;colora=1;

		mvPopMatrix();
    //gl.enable(gl.DEPTH_TEST);
    //gl.disable(gl.BLEND);
}

var dtcollide=0,timecollide=0,tcollide2=0,ywall=0;
function testcollide(){
if(tframe<dtcollide){return;}
if(tframe<timecollide){return;}
if(ttunnel>=1 || tfly==1){return;}
//timecollide=tframe+250;
//drawtestcollide();
//auxvar=context.getImageData(200,100,1,1).data[0];
/*var dy=windy-3;//if(tfoot==0){dy=10;};
gl.readPixels(windx2,dy, 1,1,gl.RGBA, gl.UNSIGNED_BYTE, pix);
if((pix[0]*256+pix[1]*256+pix[2])>255){
*/
setywall();
if(testcollide2(x+ywall*cos1,y+ywall*sin1,0.1) || tcollide==1){
 if(iview==1){tcollide2=1;}
 else{  
   dtcollide=Math.min(0,dtcollide-3000);
   if(dtcollide<-4000){dtcollide=tframe+4000;}
   //pix[0]=0;pix[1]=255;pix[2]=0;
   tcollide=1;soundpneu();soundcrash();
   o1+=30*(Math.random()+0.2)*sign(parseInt(tframe/9000)%2-0.5);
 }  
}else if(dtcollide<0){dtcollide+=100;}
}
function setywall(){
	if(tfoot==1){ywall=0.249;
	}else if(iview==1){
	   kv=Math.max(0.02,dxview*1.7/0.58-0.1);
	   ywall=0.249*kv;
	}else{
       kv=(1+3*Math.max(0,vcar));
	   ywall=0.249*kv;}
}
function drawtestcollide(){
    mvPushMatrix();
    mat4.identity(mvMatrix);
    var kv=1;
	if(tfoot==1){mat4.translate(mvMatrix, [0,0.249,-0.58]);
	}else if(iview==1){
	   kv=Math.max(0.02,dxview*1.7/0.58-0.1);
	   mat4.translate(mvMatrix, [0,0.249*kv,-0.58*kv]);
	}else{
       kv=(1+3*Math.max(0,vcar));
	   mat4.translate(mvMatrix, [0,0.249*kv,-0.58*kv]);}
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  greenTexture);
    gl.uniform1i(shaderaProgram.samplerUniform, 0);
    var sc=0.00007*kv;
	mat4.scale(mvMatrix,[sc,sc*2.58,sc]);
	var aux=1-0.5*Math.abs(12-hour)/12;
    colorr=0;colorg=0;colorb=aux;colora=-1;
	drawcarrea();
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
var iwall=0,wallx=[],wally=[],wallco1=[],wallsi1=[],walll=[],wallh=[];
var iwall0=0,wallx0=[],wally0=[],wallco10=[],wallsi10=[],walll0=[],wallh0=[];
var wallheight=0,tascend=0;
function testcollide2(x,y,r0){
var r=r0+Math.abs(vcar*0.5);
wallheight=0;
for(i=0;i<iwall0;i++){
    if(Math.abs(wallx0[i]-x)<walll0[i]){
	  if(Math.abs(wally0[i]-y)<walll0[i]){
	    var dx=x-wallx0[i],dy=y-wally0[i];
		if(Math.abs(dx*wallsi10[i]-dy*wallco10[i])<r){
		  var dxx=dx*wallco10[i]+dy*wallsi10[i];
		  if(dxx>0 && dxx<walll0[i] && z<wallh0[i]+0.26){wallheight=wallh0[i];return 1;}
		  }}}}
/*r=0.08+Math.abs(vcar*0.5);
for(i=0;i<iwalltree0;i++){
    if(Math.abs(walltreex0[i]-x)<r){
	  if(Math.abs(walltreey0[i]-y)<r){
	    if(z<walltreeh0[i]){soundcrash();return 0;}
	}}} */
return 0;
}
function drawcarre(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms00();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarre2(){
	gl.bindBuffer(gl.ARRAY_BUFFER, bouss2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms00();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarresh0(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader0Program.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shader0Program.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniformssh0();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarre2sh0(){
	gl.bindBuffer(gl.ARRAY_BUFFER, bouss2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader0Program.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shader0Program.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniformssh0();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarrea(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderaProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderaProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderaProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniformsa();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarresun(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(sunProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(sunProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(sunProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniformssun();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarreshadow22(){
    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms22();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarreshadow(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader2Program.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shader2Program.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shader2Program.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
var skydomeo1=Math.random()*360,hour2=0;
function drawsky(){
        skydomeo1+=dtime*0.00034;if(skydomeo1>360){skydomeo1-=360;}
        gl.bindBuffer(gl.ARRAY_BUFFER, bouss2VertexTextureCoordBuffer);
		var s0=1/2-(o1+skydomeo1)/360;
		if(iview==1){s0=1/2-(o1view+skydomeo1)/360;}
		var s1=s0+1/4;
		var t0=0.39+sin22/4;//0.35+sin2/4;
		var t1=t0+1/4;
		index=0;
		   append(bouss2textureCoords,[
             s0,t0, s0,t1, s1,t0,
			 s0,t1, s1,t1, s1,t0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, (bouss2textureCoords), gl.STATIC_DRAW);

        gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0,0,-600]);
		var sc=(cssscale/cssscaley)*windx/windy;
		var o33=o3;if(iview==1){o33=0;}
        var sc7=7*(1+0.17*Math.abs(Math.sin(degtorad(2*o33))));
		mat4.scale(mvMatrix,[sc*sc7,sc7,1]);
		//mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,220,-600]);//boussx
		//mat4.translate(mvMatrix, [(cssscale/cssscaley)*234*windx/windy,220,-600]);//boussx
		mat4.rotate(mvMatrix, degtorad(-o33), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE4);
    gl.bindTexture(gl.TEXTURE_2D,  skydomeTexture);
    gl.uniform1i(shader0Program.samplerUniform, 4);
    
	var aux=1-0.945*Math.abs(12-hour2)/12;
    var aux2=1-0.93*Math.abs(12-hour2)/12;
    var aux3=1-0.62*Math.abs(12-hour2)/12;
    colorr=1.0*aux3;colorg=1.0*aux;colorb=1.0*aux2;colora=1.0;
    drawcarre2sh0();
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
var n5=1,tcloud=1;
var ncloud=30,cloudx=[],cloudy=[],cloudz=[],clouddx=[],clouddz=[];
var distcloud=400/n5,distzcloud=40/n5,cloudz0=[];
var cloudo1=[],cloudo2=[],tupdatecloud=1,vcloud=1;
for(var i=0;i<ncloud;i++){
  cloudx[i]=(Math.random()*2-1)*distcloud;
  cloudy[i]=(Math.random()*2-1)*distcloud;
  cloudz0[i]=(Math.random())*distzcloud+30/n5;
  cloudz[i]=cloudz0[i];
  cloudo1[i]=parseInt(Math.random()*1.99)*180;
  cloudo2[i]=parseInt(Math.random()*1.7)*180;
  clouddx[i]=(Math.random()+1.5)*0.82/n5;//0.8
  clouddz[i]=(Math.random()+1.5)*0.6/n5;
}
function movecloud(){
var distmax=distcloud;
if(cos1<-0.2 || tmap>=1){vcloud=1}
else if(cos1>0.2){vcloud=-1;}
cloudx0+=dtime*0.001*vcloud/n5;
for(var i=0;i<ncloud*(tcloud/2);i++){
  var test=tupdatecloud;
  cloudx[i]+=dtime*0.001*vcloud/n5;
  if(tupdatecloud==1){cloudx[i]+=nextdx;
                      cloudy[i]+=nextdy;}
  while((cloudx[i]-x)>distmax){cloudx[i]-=1.999*distmax;test=1;}
  while((cloudx[i]-x)<-distmax){cloudx[i]+=1.999*distmax;test=1;}
  while((cloudy[i]-y)>distmax){cloudy[i]-=1.999*distmax;test=1;}
  while((cloudy[i]-y)<-distmax){cloudy[i]+=1.999*distmax;test=1;}
  if(test==1){cloudz[i]=getterrainheight2(cloudx[i],cloudy[i])+cloudz0[i];}
  else{cloudz[i]=Math.max(cloudz[i],zsol+cloudz0[i]);}
}
tupdatecloud=0;
}
function drawcloud(){
var distmax=distcloud;
    //gl.disable(gl.CULL_FACE);
    //gl.disable(gl.DEPTH_TEST);
    /*gl.enable(gl.BLEND);
    if(tshadow==0){gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
    }else{gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
    }*/    
	var aux=1-0.945*Math.abs(12-hour)/12;
    var aux2=1-0.93*Math.abs(12-hour)/12;
    var aux3=1-0.62*Math.abs(12-hour)/12;
    colorr=0.77*aux3;colorg=0.77*aux;colorb=0.77*aux2;colora=1.0;
    //colorr*=1.12;colorg*=1.12;colorb*=1.12;colora=1.5;
	gl.activeTexture(gl.TEXTURE4);
    gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
    gl.uniform1i(shader0Program.samplerUniform, 4);
for(var i=0;i<ncloud*(tcloud/2);i++){
  if(rotavion(cloudx[i]-x,cloudy[i]-y,cloudz[i]-z,10) || tmap>=1){
    mvPushMatrix();
	mat4.translate(mvMatrix,[cloudx[i],cloudy[i],cloudz[i]]);
	mat4.scale(mvMatrix,[clouddx[i],clouddx[i],clouddz[i]]);
	mat4.rotate(mvMatrix, degtorad(o1+cloudo1[i]), [0, 0, 1]);
    mat4.rotate(mvMatrix, degtorad(90+cloudo2[i]), [0, 1, 0]);
    if(tmap>=1){mat4.rotate(mvMatrix, degtorad((90-cloudo2[i])/10), [0, 1, 0]);}
	
	drawcarresh0();

	mvPopMatrix();
}}
	colorr=1;colorg=1;colorb=1;colora=1;
    gl.enable(gl.DEPTH_TEST);
    //gl.disable(gl.BLEND);
}
function drawcloud2(){
cloudx0=0;
var distmax=distcloud;
	gl.activeTexture(gl.TEXTURE4);
    gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
    gl.uniform1i(shader0Program.samplerUniform, 4);
for(var i=0;i<ncloud*(tcloud/2);i++){
    mvPushMatrix();
	mat4.translate(mvMatrix,[cloudx[i],cloudy[i],cloudz[i]]);
	mat4.scale(mvMatrix,[-clouddx[i],-clouddx[i],clouddz[i]]);
    mat4.rotate(mvMatrix, degtorad(cloudo2[i]-180), [0, 1, 0]);
	mat4.rotate(mvMatrix, degtorad(cloudo1[i]), [1, 0, 0]);
    //if(cloudo1[i]<90){mat4.rotate(mvMatrix, degtorad(90*sunco2+cloudo2[i]), [0, 1, 0]);}
	//else{mat4.rotate(mvMatrix, degtorad(-90*sunco2+cloudo2[i]), [0, 1, 0]);}
   
	var c=0.5;
	colorr=c;colorg=c;colorb=c;colora=1;
    drawcarresh0();
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
}
function drawcloud22(){
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
    gl.uniform1i(shader2Program.samplerUniform, 0);
for(var i=0;i<ncloud;i++){
    mvPushMatrix();
	//mat4.scale(mvMatrix,[0.31,0.31,1]);
	mat4.translate(mvMatrix,[cloudx[i],cloudy[i],cloudz[i]]);
	mat4.scale(mvMatrix,[clouddx[i],clouddx[i],clouddz[i]]);
	//mat4.rotate(mvMatrix, degtorad(o1+cloudo1[i]), [0, 0, 1]);
	mat4.rotate(mvMatrix, degtorad(cloudo1[i]), [0, 0, 1]);
    //mat4.rotate(mvMatrix, degtorad(cloudo2[i]), [0, 1, 0]);
    mat4.rotate(mvMatrix, degtorad(-90*sunco2+cloudo2[i]), [0, 1, 0]);
    
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarreshadow();
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
}
function testcollidecar(i){
  for(var j=0;j<=ncar2;j++){
    if(i!=j){
	 var dx=nx[j]-nx[i];
	 if(Math.abs(dx)<0.45){
	   var dy=ny[j]-ny[i];
	   if(Math.abs(dy)<0.45){
	    var dz=nz[j]-nz[i];
	    if(Math.abs(dz)<0.45){
	      if(i==0 || j==0){soundpneu();soundcrash();}
		  var dxx=dx*cos1+dy*sin1;
		  vcar-=dxx*0.3*vcar;
		  lngx-=dxx*0.3*cos1*klon/scale;
		  latx-=dxx*0.3*sin1/scale;
		  x-=dxx*0.3*cos1;y-=dxx*0.3*sin1;
		  o1+=(Math.random()-0.5)*18;
		  no1[i]+=(Math.random()-0.5)*45;
		  no1[j]+=(Math.random()-0.5)*45;
		  }}}}}
}
var distncar=999;
function setsoundcar2vol(){
  distncar=999;
  var i=0;
  for(var j=1;j<=ncar2;j++){
	 var dx=nx[j]-x;
	 if(Math.abs(dx)<distncar){
	   var dy=ny[j]-y;
	   if(Math.abs(dy)<distncar){
	     var dz=nz[j]-z;
	     if(Math.abs(dz)<0.5*distncar){
	       distncar=Math.max(Math.abs(dz*2),Math.max(Math.abs(dx),Math.abs(dy)));
		   i=j;
	}}}}
  var vol2=Math.max(0.002,0.4/(0.8+distncar*distncar));
  setvol(myaudiocar2,vol2);
  var speed2=(0.14+(Math.max(0,nvcar[i])*0.79+nvrun[i]*0.1)*0.9)*5.9;
  setspeed(myaudiocar2,speed2);
}	   
var tinitncar=1,carvisible=0;
function drawncarobj(){
if(tinitncar==1){tinitncar=0;initncar();
   setTimeout("initncar();",2000);}
testcollidecar(0);
savecar(0);
setsoundcar2vol();
for(var i=1;i<=ncar2;i++){
   loadcar(i);
   typecar=i;
   //vrun=0;vmx=0;vmy=0;vmz=0;vcar=0;
   movecar();
   testcollidecar(i);
   testresetcar(typecar);
   if(Math.abs(x-nx[i])<10 && Math.abs(y-ny[i])<10 && carvisible==1){drawcarobj();}
   else{z=0;}
   savecar(i);
}
loadcar(0);
typecar=0;
}
var o3volant0=0,o3wheel=0,typecar=0,tlogan=0,tbrakes=0;
function drawcarobj(){
if(tfly==1 && typecar==0){drawc150obj();return;}
if(tlogan==1){drawloganobj();return;}
        mvPushMatrix();
		//mat4.identity(mvMatrix);
        var zzz=Math.max(zsol,z-0.68);//iview==1
		mat4.translate(mvMatrix, [x,y, zzz]);
		if(tautopilot>=1){o3volant0+=(o3volant-o3volant0)*0.001*dtime;}
		else{o3volant0=o3volant;}
		var o22=o2,o33=o3;
		if(typecar==0){o22=Math.max(-50,Math.min(50,o2-planedo2*0.24-2.7));
                       o33=o3+planedo3*1.2;}
        if(typecar==0){mat4.rotate(mvMatrix, degtorad(o1+o3volant0/4), [0, 0, 1]);}
		else{mat4.rotate(mvMatrix, degtorad(o1+o3volant0*0.04), [0, 0, 1]);}
        mat4.rotate(mvMatrix, degtorad(-o22), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-o33), [1, 0, 0]);
		//planedo3=sin3*24;
	var sc=0.0030;mat4.scale(mvMatrix,[sc,sc,sc]);
	gl.activeTexture(gl.TEXTURE11);
    if(tbrakes<tframe-300){gl.bindTexture(gl.TEXTURE_2D, carobjTexture);}
	else{gl.bindTexture(gl.TEXTURE_2D, carobjlightTexture);}
    gl.uniform1i(shaderaProgram.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, carVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderaProgram.textureCoordAttribute, carVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, carVertexPositionBuffer);
    gl.vertexAttribPointer(shaderaProgram.vertexPositionAttribute, carVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderaProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    var typcar=1+typecar%5;if(typecar==0){typcar=0;}
	if(typcar==0){colorr=1;colorg=1;colorb=1;colora=1;}
    if(typcar==1){colorr=1;colorg=0.1;colorb=0;colora=0;}
    if(typcar==2){colorr=0.2;colorg=0.1;colorb=1;colora=0;}
    if(typcar==3){colorr=1;colorg=1;colorb=0;colora=0;}
    if(typcar==4){colorr=0.2;colorg=1;colorb=1;colora=0;}
    if(typcar==5){colorr=1;colorg=0.1;colorb=1;colora=0;}
	setMatrixUniformsa();
	colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, carVertexPositionBuffer.numItems);

    o3wheel+=vcar*dtime*3;
	if(o3wheel>3600){o3wheel-=3600;}
	mvPushMatrix();
	mat4.translate(mvMatrix, [112,57,14.77]);
	sc=0.19;mat4.scale(mvMatrix,[sc,sc,sc]);
    mat4.rotate(mvMatrix, degtorad(o3volant0/2), [0, 0, 1]);	
    mat4.rotate(mvMatrix, degtorad(o3wheel), [0, 1, 0]);	
	drawcarwheel();
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [112,-56,14.77]);
	sc=0.19;mat4.scale(mvMatrix,[sc,-sc,sc]);
    mat4.rotate(mvMatrix, degtorad(-o3volant0/2), [0, 0, 1]);	
    mat4.rotate(mvMatrix, degtorad(o3wheel), [0, 1, 0]);	
    setMatrixUniformsa();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [-88,57,14.77]);
	sc=0.19;mat4.scale(mvMatrix,[sc,sc,sc]);
    mat4.rotate(mvMatrix, degtorad(o3wheel), [0, 1, 0]);	
    setMatrixUniformsa();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [-88,-56,14.77]);
	sc=0.19;mat4.scale(mvMatrix,[sc,-sc,sc]);
    mat4.rotate(mvMatrix, degtorad(o3wheel), [0, 1, 0]);	
    setMatrixUniformsa();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();

	mvPopMatrix();
}
function drawcarwheel(){
    gl.bindBuffer(gl.ARRAY_BUFFER, carwheelVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderaProgram.textureCoordAttribute, carwheelVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, carwheelVertexPositionBuffer);
    gl.vertexAttribPointer(shaderaProgram.vertexPositionAttribute, carwheelVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderaProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniformsa();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
}
function drawcarwheel2(){
    gl.bindBuffer(gl.ARRAY_BUFFER, carwheelVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader2Program.textureCoordAttribute, carwheelVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, carwheelVertexPositionBuffer);
    gl.vertexAttribPointer(shader2Program.vertexPositionAttribute, carwheelVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shader2Program.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
}
function drawloganobj(){
        mvPushMatrix();
		//mat4.identity(mvMatrix);
        var zzz=Math.max(zsol,z-0.68);//iview==1
		mat4.translate(mvMatrix, [x,y, zzz]);
		if(tautopilot>=1){o3volant0+=(o3volant-o3volant0)*0.001*dtime;}
		else{o3volant0=o3volant;}
		var o22=o2,o33=o3;
		if(typecar==0){o22=Math.max(-50,Math.min(50,o2-planedo2*0.24-2.7));
                       o33=o3+planedo3*1.2;}
        mat4.rotate(mvMatrix, degtorad(o1+o3volant0/8), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-o22), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-o33), [1, 0, 0]);
		//planedo3=sin3*24;
	var sc=0.0027;mat4.scale(mvMatrix,[sc,0.0032,sc]);
	gl.activeTexture(gl.TEXTURE11);
    if(tbrakes<tframe-300){gl.bindTexture(gl.TEXTURE_2D, loganobjTexture);}
	else{gl.bindTexture(gl.TEXTURE_2D, loganobjlightTexture);}
    gl.uniform1i(shaderaProgram.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, loganVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderaProgram.textureCoordAttribute, loganVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, loganVertexPositionBuffer);
    gl.vertexAttribPointer(shaderaProgram.vertexPositionAttribute, loganVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderaProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    var typcar=1+typecar%5;if(typecar==0){typcar=0;}
	if(typcar==0){colorr=1;colorg=1;colorb=1;colora=1;}
    if(typcar==1){colorr=1;colorg=0.1;colorb=0;colora=0;}
    if(typcar==2){colorr=0.2;colorg=0.1;colorb=1;colora=0;}
    if(typcar==3){colorr=1;colorg=1;colorb=0;colora=0;}
    if(typcar==4){colorr=0.2;colorg=1;colorb=1;colora=0;}
    if(typcar==5){colorr=1;colorg=0.1;colorb=1;colora=0;}
	mvPushMatrix();
    mat4.rotate(mvMatrix, degtorad(-90), [0, 0, 1]);
	setMatrixUniformsa();
	colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, loganVertexPositionBuffer.numItems);
	mvPopMatrix();

	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D, carobjTexture);
    gl.uniform1i(shaderaProgram.samplerUniform, 11);
    o3wheel+=vcar*dtime*3;
	if(o3wheel>3600){o3wheel-=3600;}
	mvPushMatrix();
	mat4.translate(mvMatrix, [102,54,14.77]);
	sc=0.165;mat4.scale(mvMatrix,[sc,sc,sc]);
    mat4.rotate(mvMatrix, degtorad(o3volant0/2), [0, 0, 1]);	
    mat4.rotate(mvMatrix, degtorad(o3wheel), [0, 1, 0]);	
	drawcarwheel();
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [102,-54,14.77]);
	sc=0.165;mat4.scale(mvMatrix,[sc,-sc,sc]);
    mat4.rotate(mvMatrix, degtorad(-o3volant0/2), [0, 0, 1]);	
    mat4.rotate(mvMatrix, degtorad(o3wheel), [0, 1, 0]);	
    setMatrixUniformsa();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [-98,57,14.77]);
	sc=0.170;mat4.scale(mvMatrix,[sc,sc,sc]);
    mat4.rotate(mvMatrix, degtorad(o3wheel), [0, 1, 0]);	
    setMatrixUniformsa();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [-98,-57,14.77]);
	sc=0.170;mat4.scale(mvMatrix,[sc,-sc,sc]);
    mat4.rotate(mvMatrix, degtorad(o3wheel), [0, 1, 0]);	
    setMatrixUniformsa();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();

	mvPopMatrix();
}
function drawc150obj(){
        if(tmouse3move==1){return;}
        mvPushMatrix();
		//mat4.identity(mvMatrix);
        var zzz=Math.max(zsol,z-0.68)+0.1;//iview==1
		mat4.translate(mvMatrix, [x,y, zzz]);
		var o22=o2,o33=o3;
		if(typecar==0){o22=Math.max(-50,Math.min(50,o2-planedo2*0.24-2.7));
                       o33=o3+planedo3*1.2;if(vcar>0.03){o33+=0.84*Math.sin(3.1416*tframe*0.00062);}}
        mat4.rotate(mvMatrix, degtorad(o1+o3volant/8-90), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(5-o22), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-o33), [0, 1, 0]);
		//planedo3=sin3*24;
	var sc=0.0037;mat4.scale(mvMatrix,[sc,sc,sc]);
	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D, c150objTexture);
    gl.uniform1i(shaderaProgram.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, c150VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderaProgram.textureCoordAttribute, c150VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, c150VertexPositionBuffer);
    gl.vertexAttribPointer(shaderaProgram.vertexPositionAttribute, c150VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderaProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    var typcar=1+typecar%5;if(typecar==0){typcar=0;}
	if(typcar==0){colorr=1;colorg=1;colorb=1;colora=1;}
    if(typcar==1){colorr=1;colorg=0.1;colorb=0;colora=0;}
    if(typcar==2){colorr=0.2;colorg=0.1;colorb=1;colora=0;}
    if(typcar==3){colorr=1;colorg=1;colorb=0;colora=0;}
    if(typcar==4){colorr=0.2;colorg=1;colorb=1;colora=0;}
    if(typcar==5){colorr=1;colorg=0.1;colorb=1;colora=0;}
    mat4.rotate(mvMatrix, degtorad(-90), [0, 0, 1]);
	setMatrixUniformsa();
	colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, c150VertexPositionBuffer.numItems);
	mvPopMatrix();
}
function drawcar2(){if(tfoot==1 || iview>=1){return;}
		tmovertt=1;
        mvPushMatrix();
	    //var dx=0.04;dy=0.03;
		//mat4.translate(mvMatrix, [x+dx*cos1+dy*sin1,y+dx*sin1-dy*cos1,z-0.57]);
		mat4.translate(mvMatrix, [x,y,z-0.65]);
        mat4.rotate(mvMatrix, degtorad(o1-90), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        //mat4.rotate(mvMatrix, degtorad(o2), [1, 0, 0]);
        //mat4.rotate(mvMatrix, degtorad(o3), [0, 0, 1]);
	var sc=0.006;mat4.scale(mvMatrix,[0.007,sc,sc]);
	gl.activeTexture(gl.TEXTURE4);
    gl.bindTexture(gl.TEXTURE_2D,  solTexture);
    gl.uniform1i(shader2Program.samplerUniform, 4);
    
    /*gl.bindBuffer(gl.ARRAY_BUFFER, carVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader2Program.textureCoordAttribute, carVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, carVertexPositionBuffer);
    gl.vertexAttribPointer(shader2Program.vertexPositionAttribute, carVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    //gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    //gl.vertexAttribPointer(shader2Program.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);
    */
    colorr=1;colorg=1;colorb=1;colora=0;
    //setMatrixUniforms2();
    //gl_drawArrays(gl.TRIANGLES, 0, carVertexPositionBuffer.numItems);
	drawcarreshadow();
    colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();

}
function drawncarobj2(){
if(tinitncar==1){tinitncar=0;initncar();
   setTimeout("initncar();",2000);}
savecar(0);
for(var i=1;i<=ncar;i++){
   loadcar(i);
   //vrun=0;vmx=0;vmy=0;vmz=0;vcar=0;
   typecar=i;
   if(carvisible==1){drawcarobj2();}
   //savecar(i);
}
loadcar(0);
typecar=0;
}
function drawcarobj2(){//if(tfoot==1 || iview!=1){return;}
if(tfly==1 && typecar==0){drawc150obj2();return;}
if(tlogan==1){drawloganobj2();return;}
        mvPushMatrix();
		//mat4.identity(mvMatrix);
        var zzz=Math.max(zsol,z-0.68);//iview==1
		mat4.translate(mvMatrix, [x,y, zzz]);
        mat4.rotate(mvMatrix, degtorad(o1+o3volant0/4), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-o3), [1, 0, 0]);
		//planedo3=sin3*24;
	var sc=0.0030;mat4.scale(mvMatrix,[sc,sc,sc]);
	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D, carobjTexture);
    gl.uniform1i(shader2Program.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, carVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader2Program.textureCoordAttribute, carVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, carVertexPositionBuffer);
    gl.vertexAttribPointer(shader2Program.vertexPositionAttribute, carVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shader2Program.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, carVertexPositionBuffer.numItems);

	mvPushMatrix();
	mat4.translate(mvMatrix, [112,57,14.77]);
	sc=0.19;mat4.scale(mvMatrix,[sc,sc,sc]);
    mat4.rotate(mvMatrix, degtorad(o3volant0/2), [0, 0, 1]);	
	drawcarwheel2();
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [112,-56,14.77]);
	sc=0.19;mat4.scale(mvMatrix,[sc,-sc,sc]);
    mat4.rotate(mvMatrix, degtorad(-o3volant0/2), [0, 0, 1]);	
    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [-88,57,14.77]);
	sc=0.19;mat4.scale(mvMatrix,[sc,sc,sc]);
    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [-88,-56,14.77]);
	sc=0.19;mat4.scale(mvMatrix,[sc,-sc,sc]);
    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();

	mvPopMatrix();
}
function drawloganobj2(){
        mvPushMatrix();
		//mat4.identity(mvMatrix);
        var zzz=Math.max(zsol,z-0.68);//iview==1
		mat4.translate(mvMatrix, [x,y, zzz]);
		if(tautopilot>=1){o3volant0+=(o3volant-o3volant0)*0.001*dtime;}
		else{o3volant0=o3volant;}
		var o22=o2,o33=o3;
		if(typecar==0){o22=Math.max(-50,Math.min(50,o2-planedo2*0.24-2.7));
                       o33=o3+planedo3*1.2;}
        mat4.rotate(mvMatrix, degtorad(o1+o3volant0/8), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-o22), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-o33), [1, 0, 0]);
		//planedo3=sin3*24;
	var sc=0.0027;mat4.scale(mvMatrix,[sc,0.0032,sc]);
	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D, loganobjTexture);
    gl.uniform1i(shader2Program.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, loganVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader2Program.textureCoordAttribute, loganVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, loganVertexPositionBuffer);
    gl.vertexAttribPointer(shader2Program.vertexPositionAttribute, loganVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shader2Program.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

	mvPushMatrix();
    mat4.rotate(mvMatrix, degtorad(-90), [0, 0, 1]);
	setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, loganVertexPositionBuffer.numItems);
	mvPopMatrix();

	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D, carobjTexture);
    gl.uniform1i(shader2Program.samplerUniform, 11);
    o3wheel+=vcar*dtime*3;
	if(o3wheel>3600){o3wheel-=3600;}
	mvPushMatrix();
	mat4.translate(mvMatrix, [102,54,14.77]);
	sc=0.165;mat4.scale(mvMatrix,[sc,sc,sc]);
    mat4.rotate(mvMatrix, degtorad(o3volant0/2), [0, 0, 1]);	
	drawcarwheel2();
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [102,-54,14.77]);
	sc=0.165;mat4.scale(mvMatrix,[sc,-sc,sc]);
    mat4.rotate(mvMatrix, degtorad(-o3volant0/2), [0, 0, 1]);	
    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [-98,57,14.77]);
	sc=0.170;mat4.scale(mvMatrix,[sc,sc,sc]);
    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();
    mvPushMatrix();
	mat4.translate(mvMatrix, [-98,-57,14.77]);
	sc=0.170;mat4.scale(mvMatrix,[sc,-sc,sc]);
    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, carwheelVertexPositionBuffer.numItems);
	mvPopMatrix();

	mvPopMatrix();
}
function drawc150obj2(){return;//if(tfoot==1 || iview!=1){return;}
        mvPushMatrix();
		//mat4.identity(mvMatrix);
        var zzz=Math.max(zsol,z-0.68)+0.1;//iview==1
		mat4.translate(mvMatrix, [x,y, zzz]);
		var o22=o2,o33=o3;
		if(typecar==0){o22=Math.max(-50,Math.min(50,o2-planedo2*0.24-2.7));
                       o33=o3+planedo3*1.2;}
        mat4.rotate(mvMatrix, degtorad(o1+o3volant0/8-90), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(5-o22), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-o33), [0, 1, 0]);
		//planedo3=sin3*24;
	var sc=0.0040;mat4.scale(mvMatrix,[-sc,sc,sc]);
	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D, c150objTexture);
    gl.uniform1i(shader2Program.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, c150VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shader2Program.textureCoordAttribute, c150VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, c150VertexPositionBuffer);
    gl.vertexAttribPointer(shader2Program.vertexPositionAttribute, c150VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shader2Program.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms2();
    gl_drawArrays(gl.TRIANGLES, 0, c150VertexPositionBuffer.numItems);

	mvPopMatrix();
}
var nsailship=5;
var psailshipx=new Array(nsailship),psailshipdo1=new Array(nsailship);
var psailshipy=new Array(nsailship),psailshipz=new Array(nsailship);
var psailshipo1=new Array(nsailship),psailshipco1=new Array(nsailship),psailshipsi1=new Array(nsailship);
var tpsailshipo1=new Array(nsailship),psailshipv=new Array(nsailship);
var psailshipo2=new Array(nsailship),psailshipo3=new Array(nsailship);
var psailshipdo2=new Array(nsailship),psailshipdo3=new Array(nsailship);
function getpsailship(i){
   sailshipx=psailshipx[i]; 
   sailshipy=psailshipy[i]; 
   sailshipz=psailshipz[i]; 
   sailshipo1=psailshipo1[i]; 
   sailshipo2=psailshipo2[i]; 
   sailshipo3=psailshipo3[i]; 
   sailshipco1=psailshipco1[i]; 
   sailshipsi1=psailshipsi1[i]; 
   tsailshipo1=tpsailshipo1[i]; 
   sailshipv=psailshipv[i];
   sailshipdo1=psailshipdo1[i]; 
   sailshipdo2=psailshipdo2[i]; 
   sailshipdo3=psailshipdo3[i]; 
}	 
function setpsailship(i){
   psailshipx[i]=sailshipx; 
   psailshipy[i]=sailshipy; 
   psailshipz[i]=sailshipz; 
   psailshipo1[i]=sailshipo1; 
   psailshipo2[i]=sailshipo2; 
   psailshipo3[i]=sailshipo3; 
   psailshipco1[i]=sailshipco1; 
   psailshipsi1[i]=sailshipsi1; 
   tpsailshipo1[i]=tsailshipo1; 
   psailshipv[i]=sailshipv;
   psailshipdo1[i]=sailshipdo1; 
   psailshipdo2[i]=sailshipdo2; 
   psailshipdo3[i]=sailshipdo3; 
}
function resetsailships(){
  for(var i=0;i<nsailship;i++){
     isailship=i;
     getpsailship(i);
	 resetsailship();
	 setpsailship(i);}
}
function movesailships(){
  for(var i=0;i<nsailship;i++){
     isailship=i;
	 getpsailship(i);
	 movesailship();
	 setpsailship(i);}
}
var mysailshipz=-99,isailship=0,myisailship=-1,mysailshipo1=0,mysailshipdxx=0,myisailship0=-1;
function drawsailships(){
  if(tinit<=3){mysailshipz=-99;return;}
  mysailshipz=-99;myisailship0=myisailship;
  myisailship=-1;
  for(var i=0;i<nsailship;i++){
     isailship=i;
	 getpsailship(i);
	 movesailship();
	 drawsailship();
	 setpsailship(i);}
}
var sailshipx=(Math.random())*1000;
var sailshipy=0.7*ymax+Math.random()*300,sailshipz=0;
var sailshipo1=Math.random()*40-20,sailshipco1=1,sailshipsi1=0;
var tsailshipo1=0,sailshipv=1,sailshipo2=0,sailshipo3=0;
var sailshipdo1=0,sailshipdo2=0,sailshipdo3=0;
for(var i=0;i<nsailship;i++){
    sailshipx+=50*Math.random();
	sailshipy+=50*Math.random();setpsailship(i);}
function resetsailship(){
  if(isailship==ianchorship){
     sailshipo1=mysailshipo1;
     sailshipco1=Math.cos(degtorad(sailshipo1));
     sailshipsi1=Math.sin(degtorad(sailshipo1));
	 sailshipx=(lnganchor-lng0)*scale/klon;
	 sailshipy=(latanchor-lat0)*scale;
     sailshipz=getterrainheight2(sailshipx,sailshipy);
	 sailshipv=0;
	 sailshipo2=0;
	 if(Math.max(Math.abs(x-sailshipx),Math.abs(y-sailshipy))<40 || myisailship!=ianchorship){
	    return;}
  }
  if(isailship==myisailship){
     sailshipo1=mysailshipo1;
     sailshipco1=Math.cos(degtorad(sailshipo1));
     sailshipsi1=Math.sin(degtorad(sailshipo1));
	 sailshipx=x-mysailshipdxx*sailshipco1;
	 sailshipy=y-mysailshipdxx*sailshipsi1;
     sailshipz=getterrainheight2(sailshipx,sailshipy);
	 sailshipv=0;
	 sailshipo2=0;
	 return;
  }
  if(Math.abs(sailshipx-x)>200){sailshipx=x+400*(Math.random()-0.5);}
  if(Math.abs(sailshipy-y)>200){sailshipy=y+400*(Math.random()-0.5);}
  sailshipo1=360*(Math.random()-0.5);
  sailshipco1=Math.cos(degtorad(sailshipo1));
  sailshipsi1=Math.sin(degtorad(sailshipo1));
  for(var i=0;i<250;i++){
    sailshipz=getterrainheightfast(sailshipx,sailshipy);
    if(sailshipz<-0.04){
	 if(getterrainheightfast(sailshipx+10*sailshipco1-5*sailshipsi1,sailshipy+10*sailshipsi1+5*sailshipco1)<-0.04){break;}
	 if(getterrainheightfast(sailshipx+10*sailshipco1+5*sailshipsi1,sailshipy+10*sailshipsi1-5*sailshipco1)<-0.04){break;}     
    }
	sailshipx+=20*sailshipco1+(Math.random()-0.5)*4;
	sailshipy+=20*sailshipsi1+(Math.random()-0.5)*4;
	if(sailshipx>x+200){sailshipx-=(400);}
	if(sailshipx<x-200){sailshipx+=(400);}
	if(sailshipy>y+200){sailshipy-=(400);}
	if(sailshipy<y-200){sailshipy+=(400);}
  }
}
var tsailshipskip=0;
function movesailship(){
	var distmax=250,test=0;
	if(isailship==ianchorship){distmax=350;}
	var dx=x-sailshipx,dy=y-sailshipy;
	if(sailshipx<(x-distmax)){sailshipx=x+0.99*distmax;test=1;}
	if(sailshipx>(x+distmax)){sailshipx=x-0.99*distmax;test=1;}
	if(sailshipy<(y-distmax)){sailshipy=y+0.99*distmax;test=1;}
	if(sailshipy>(y+distmax)){sailshipy=y-0.99*distmax;test=1;}
    if(isailship==ianchorship && test==1){ianchorship=-1;}	
    var xx=sailshipx,yy=sailshipy,zz=sailshipz;
	var zwater=-0.001;
    if(zz>zwater){//0.03){	
	  if(loading<=1.01){
	   sailshipx+=10*sailshipco1;
       sailshipy+=10*sailshipsi1;}
      sailshipz=getterrainheight2(sailshipx,sailshipy);
	  return;
	}else if(isailship!=ianchorship){
	  var sailshipsi2=Math.sin(degtorad(sailshipo2));
	  var co1=Math.cos(degtorad(sailshipo1-o1wind));
	  if(wind2>0.0001){wind=wind2;}
	  var pwind=Math.min(1.4,Math.max(-1.4,(wind/30)*((0.9+co1)/2+1-co1*co1)-sailshipv*co1*co1));
	  sailshipv+=(1-sailshipsi2+pwind*0.3-sailshipv)*Math.min(1,dtime*0.003);
	  sailshipx+=dtime*0.001*sailshipco1*sailshipv;
      sailshipy+=dtime*0.001*sailshipsi1*sailshipv;
	}
	sailshipz=getterrainheight2(sailshipx,sailshipy);
	if(isailship==ianchorship){latanchor=lat0+sailshipy/scale;
	                           lnganchor=lng0+sailshipx*klon/scale;}
    var do1=0;
	if(sailshipz>zwater-0.0012 && zz<zwater-0.001 && sailshipz<zwater){
       if(Math.random()<0.00005*dtime && sailshipo1<-360-180){
	      sailshipo1+=360;if(sailshipo1<-360-180){sailshipo1+=360;};return;}
	   else{sailshipx=xx;sailshipy=yy;sailshipz=zz;}
       do1=-0.01*dtime*(1+Math.random());}
    else if(sailshipz>zwater-0.0001 && zz<zwater){
	   if(Math.random()<0.00005*dtime && sailshipo1<-720-180){sailshipo1+=720;return;}
	   else{sailshipx=xx;sailshipy=yy;sailshipz=zz;}
       do1=-0.01*dtime*(1+Math.random());
	}else if(sailshipo1<-180 && sailshipz<zwater-0.0012){sailshipo1+=360;
	}else if(sailshipo1>180 && sailshipz<zwater-0.0012){sailshipo1-=360;}
	var dxx=dx*sailshipco1+dy*sailshipsi1;
	var dyy=-dx*sailshipsi1+dy*sailshipco1;
	if(Math.abs(do1)<0.00001 && isailship==ianchorship){
	    var ddo1=sailshipo1-o1wind;
	    while(ddo1>180){ddo1-=360;}
	    while(ddo1<-180){ddo1+=360;};
	    if(ddo1<170 && ddo1>0){do1=dtime*0.005;}
	    if(ddo1>-170 && ddo1<0){do1=-dtime*0.005;}}
	if(Math.abs(do1)<0.00001){
     var dh1=getterrainheight2(sailshipx+5*sailshipco1-3*sailshipsi1,sailshipy+5*sailshipsi1+3*sailshipco1);
	 if(dh1>=zwater){
	  do1=-0.01*dtime*(1+Math.random());
     }else{
      var dh2=getterrainheight2(sailshipx+5*sailshipco1+3*sailshipsi1,sailshipy+5*sailshipsi1-3*sailshipco1);
	  if(dh2>=zwater){do1=0.01*dtime*(1+Math.random());}
	  else if(itime%10==1){
	          if(testwater==1 && isailship!=myisailship0 && Math.random()<dtime*0.001){
							 if(dx*dx+dy*dy<36){do1=-sign(dyy)*(3.5-Math.random());}
							 else if(dyy>Math.max(0,dxx*0.3+5)){do1=3.5-Math.random();}
							 else if(dyy<-Math.max(0,dxx*0.3+5)){do1=-3.5+Math.random();}
					      }}
    }}
    //if(sailshipx<(xmin+100) || sailshipx>(xmax-100)){sailshipo1=diro1(pistex-sailshipx,pistey-sailshipy);}
    //if(sailshipy<(ymin+100) || sailshipy>(ymax-100)){sailshipo1=diro1(pistex-sailshipx,pistey-sailshipy);}
	if(dxx>-2.7 && dxx<1.2 && dyy>-0.7 && dyy<0.7){
	   var do11=0;
	   if(keys[vk_1]){do11=dtime*0.01;}
	   if(keys[vk_2]){do11=-dtime*0.01;}
	   if(Math.abs(do1)<0.00001){do1=do11;}
	   else if((do1<0 && do11>0)||(do1>0 && do11<0)){
	      do1=do11*0.5;
		  tsailshipskip+=dtime;
		  if(tsailshipskip>6000 && isailship!=ianchorship){
		    for(var k=0.5;k<15;k+=0.5){
	          var xx=sailshipx+k*sailshipco1;
              var yy=sailshipy+k*sailshipsi1;
	          var zz=getterrainheight2(xx,yy);
		      if(zz<zwater-0.0011){sailshipx=xx;sailshipy=yy;sailshipz=zz;break;}
			  }
		  }}
	   else{tsailshipskip=0;}
	   sailshipdo1+=(do1-sailshipdo1)*Math.min(1,dtime*0.003)+0.00001;
	   sailshipo1+=sailshipdo1;
	   sailshipco1=Math.cos(degtorad(sailshipo1));
	   sailshipsi1=Math.sin(degtorad(sailshipo1));
       if(myisailship0==isailship || myisailship0<0){	   
	    x=sailshipx+dxx*sailshipco1-dyy*sailshipsi1;
	    y=sailshipy+dxx*sailshipsi1+dyy*sailshipco1;
	    z=sailshipz+dxx*Math.sin(degtorad(sailshipo2))+1.1;
	    if(dxx>-1.7 && dxx<1.1){z+=0.2;}
	    lastz=z;mysailshipz=z;
	    lngx=lng0+x*klon/scale;
	    latx=lat0+y/scale;
	    o1+=do1;o1save+=do1;
		myisailship0=isailship;
	    myisailship=isailship;mysailshipo1=sailshipo1;mysailshipdxx=dxx;
		}
	}else if(Math.abs(do1)>0.00001){
	   sailshipo1+=do1;
	   sailshipco1=Math.cos(degtorad(sailshipo1));
	   sailshipsi1=Math.sin(degtorad(sailshipo1));
	}
}
function drawsailship(){
        if(sailshipz>=0.03){return;}//-0.04
	    var dx=x-sailshipx,dy=y-sailshipy;	  
        if(Math.abs(dx)>250){return;}
        if(Math.abs(dy)>250){return;}
		//if(getterrainheight2(sailshipx,sailshipy)>0){
		   //if(sailshipx>xmin && sailshipx<xmax && sailshipy>ymin && sailshipy<ymax){
		//      return;};//}
		if(rotavion(sailshipx-x,sailshipy-y,sailshipz-z,12)){
        var sailshipo22=0,sailshipo33=0;		
		var ddo1=sailshipo1-o1wind;
		while(ddo1>180){ddo1-=360;}
		while(ddo1<-180){ddo1+=360;};
        if(Math.abs(dx)<40 && Math.abs(dy)<40){
		 var dxx=1.7,dyy=0.3;
		 var dh1=getterrainheightwater(sailshipx+sailshipco1*dxx,sailshipy+sailshipsi1*dxx);
		 var dh2=getterrainheightwater(sailshipx-sailshipsi1*dyy,sailshipy+sailshipco1*dyy);
		 var dh3=getterrainheightwater(sailshipx+sailshipsi1*dyy,sailshipy-sailshipco1*dyy);
		 sailshipo22=diro1(dxx,dh1-(dh2+dh3)*0.5);
		 sailshipo33=diro1(dyy*2,(dh3-dh2));
		 var wind1=wind*(1+0.5*Math.abs(Math.sin(degtorad(ddo1))));
		 if(ddo1>0){sailshipo33-=7.8*wind1/(12+wind1);}else{sailshipo33+=7.8*wind1/(12+wind1);}
		}
		var kdt=Math.min(1,dtime*0.003);
		sailshipdo2+=(sailshipo22-sailshipo2-sailshipdo2)*kdt;
		sailshipdo3+=(sailshipo33-sailshipo3-sailshipdo3)*kdt;
		kdt=Math.min(1,dtime*0.00114);
		sailshipo2+=sailshipdo2*kdt;
		sailshipo3+=sailshipdo3*kdt;
		mvPushMatrix();
		mat4.translate(mvMatrix, [sailshipx,sailshipy,sailshipz-0.1]);
        mat4.rotate(mvMatrix, degtorad(sailshipo1), [0, 0, 1]);
		mat4.rotate(mvMatrix, degtorad(sailshipo2), [0, -1, 0]);
        if(ddo1>0){mat4.rotate(mvMatrix, degtorad(sailshipo3+3.9), [-1, 0, 0]);}
		else{mat4.rotate(mvMatrix, degtorad(sailshipo3-3.9), [-1, 0, 0]);}
		if(ddo1>0){mat4.scale(mvMatrix,[0.05,0.05,0.05]);}
		else{mat4.scale(mvMatrix,[0.05,-0.05,0.05]);}
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  sailshipTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, sailshipVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, sailshipVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
    gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute, tower0VertexNormalBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, sailshipVertexPositionBuffer.numItems);
		
		mvPopMatrix();
		}
}
var nstation=0,stationlat=[],stationlon=[],stationx=[],stationy=[],stationz=[],stationo1=[];
var nstation0=0,stationlat0=[],stationlon0=[],stationx0=[],stationy0=[],stationz0=[],stationo10=[];
function drawstationobj(){
	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D, stationTexture);
    gl.uniform1i(shaderaProgram.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, stationVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderaProgram.textureCoordAttribute, stationVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, stationVertexPositionBuffer);
    gl.vertexAttribPointer(shaderaProgram.vertexPositionAttribute, stationVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

 for(var i=0;i<nstation0;i++){
   if(stationz0[i]>-999){
	mvPushMatrix();
	mat4.translate(mvMatrix, [stationx0[i],stationy0[i],stationz0[i]]);
    mat4.rotate(mvMatrix, degtorad(stationo10[i]), [0, 0, 1]);
	
	var sc=0.01;mat4.scale(mvMatrix,[sc,sc,sc]);
	colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniformsa();
	colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, stationVertexPositionBuffer.numItems);

	mvPopMatrix();
	}}
}
var tupdatesun=0,sunx=0,suny=0,sunz=0,o1sun=0,o2sun=0;
var month=0;
function updatesun(){
if(tframe<tupdatesun){return;}
tupdatesun=tframe+60000*5;
		var xc=0,yc=0,zc=0;
		var date=new Date();
	    month=date.getMonth()+1;
		hour=date.getHours()+date.getMinutes()/60.0+ thour;
		while(hour>24){hour-=24;}
		while(hour<0){hour+=24;};
		var klat=Math.max(-50,Math.min(50,latx))/50;
		var kmonth=(month-3)/3;
		if(month>6){kmonth=(9-month)/3;}
		kmonth=(1-klat*kmonth)/2;
    	hour2=12+(hour-12)*2*(1+kmonth)/2;
		var h6=6+3*kmonth-3,h18=18-3*kmonth+3;
		if(hour2<h6){hour2=h6+(hour2-h6)/3;}
		if(hour2>h18){hour2=h18+(hour2-h18)/3;}
		sunx=1000*Math.sin((12-hour2)*3.14/24);
		suny=-1000*Math.cos((12-hour2)*3.44/24);
		sunz=800*Math.cos((12-hour2)*3.14/24)*Math.cos((12-hour2)*3.14/24)+40;
		o1sun=(12-hour2)*180/24;
		o2sun=diro1(1000,sunz);
		var r=Math.sqrt(sunx*sunx+suny*suny+0.59*sunz*sunz);
		sunx*=980/r;suny*=980/r;sunz*=980/r;
		tmovertt=1;
		//var sunx1=sunx,suny1=suny,sunz1=sunz;
		//if(tgmap==1){sunx1*=2.8;suny1*=2.8;sunz1*=2.8;}
}
function drawsun(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    //gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  sunTexture);
    gl.uniform1i(sunProgram.samplerUniform, 0);

    mvPushMatrix();
	if(tshadownight==990){mat4.translate(mvMatrix, [x+sunx,y+suny,z+sunz]);}
	else{mat4.translate(mvMatrix, [x+sunxsave,y+sunysave,z+sunzsave]);}
	mat4.rotate(mvMatrix, degtorad(o1sun), [0, 0, 1]);
	mat4.rotate(mvMatrix, degtorad(90-o2sun), [1, 0, 0]);
	var sc=4;
	mat4.scale(mvMatrix,[sc,sc,sc]);
	colorr=1;colorg=1;colorb=1;colora=1.4;
	drawcarresun();
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}	
function drawmap(){
context.clearRect (0,0,canvas.width,canvas.height);
gl.viewport(0, 0, windx,windy);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
//mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
mat4.perspective(47, (cssscale/cssscaley)*gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
gl.useProgram(shaderProgram);
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D, greenTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);
    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    mvPushMatrix();
	var hmax=1,hmin=100;
	for(var i=0;i<n;i+=1){
	  for(var j=0;j<n;j+=1){
	    var h=height1[(i+nsol2)*n22+j+nsol2];//srtm
		hmax+=(Math.max(h,hmax)-hmax)*0.1;
		hmin+=(Math.min(h,hmin)-hmin)*0.1;
    }}
    if(hmax>100){hmax*=0.8};	
	for(var i=0;i<n;i+=1){
	  for(var j=0;j<n;j+=1){	
    	mat4.identity(mvMatrix);
		var ix=(i-n/2),iy=(j-n/2);
		mat4.translate(mvMatrix, [ix*1.4,iy,-120]);
 		mat4.scale(mvMatrix,[0.0304,0.034,0.034]);
		var ixy=i*n+j;
		var ixy2=(i+nsol2)*n22+j+nsol2;
		//ixy2=parseInt(i*n22/n)*n22+parseInt(j*n22/n);
		//if(ixy<0){ixy=0};if(ixy>(n*n)){ixy=n*n;}
		//var h=height1[ixy2];
		var h=height[ixy];
        colorr=0;colorb=0;colorg=0.25+0.75*(h-hmin)/Math.max(1,hmax-hmin);
		if(h>hmax){colorg=2.5;colorb=0.75*(h-hmax)/h;colorr=colorb;}
		if(height1[ixy2]<-0.011){colorb=0.5;colorg=0;}
		//if(height00[ixy]<0){colorb+=0.13;colorg+=0.13;colorr+=0.3;} 
		if(height[ixy]<0.03 && (i+j)%2==0){colorb+=0.1;colorg+=0.1;colorr+=0.1;} 
		//if(height[ixy]<0 && (i+j)%2==0){colorb+=0.1;colorg+=0.1;colorr+=0.1;} 
		//colorr*=1.5;colorg*=1.5;colorb*=1.5;
		if(maptree[ixy]==1){colorr=1;}
		if(mapgrass[ixy]==1){colorg+=0.07;colorb*=0.8}
	    setMatrixUniforms00();
		gl.uniform1f(shaderProgram.fog,0);
        gl_drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
      }
	}
    mat4.identity(mvMatrix);
	var i=nsol*(0.5+0.5*(lngx-lngsol0)/dlngsol)-0.5;
	var j=nsol*(0.5+0.5*(latx-latsol0)/dlatsol)-0.5;
	var ix=(i-n/2),iy=(j-n/2);
	mat4.translate(mvMatrix, [ix*1.2,iy,-150]);
 	mat4.scale(mvMatrix,[0.05,0.05,0.05]);
	colorr=1;colorb=0;colorg=0;
	drawcarre()
	mvPopMatrix();
	colorr=1;colorb=1;colorg=1;
    gl.enable(gl.DEPTH_TEST);
}
var cockpith=0;
function drawcarcockpit(){
if(tcockpitok==0){return;}
if(tgirl==1){drawcarcockpit2();return;}
if(tgirl==2){drawcarcockpit3();return;}
if(tgirl==3){drawcarcockpit4();return;}
if(tgirl==4){drawcarcockpit5();return;}
if(tgirl==5){drawcarcockpit6();return;}
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		to1=o1+o1head-o1save;
		while(to1>180){to1-=360;}
		while(to1<-180){to1+=360;}
		if(o1head>120){to1=230;}
		if(tmouse3move==1 && Math.abs(to1)>120){to1=320;}
		mat4.rotate(mvMatrix, degtorad(to1*0.4), [0, -1, 0]);
		mat4.translate(mvMatrix, [20,-15,-60]);
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(planedo2), [1, 0, 0]);
		mat4.rotate(mvMatrix, degtorad(-planedo3*2.7), [0, 0, 1]);
		mat4.translate(mvMatrix, [0,Math.min(20,Math.max(-20,planedo2*0.7+cockpith-tfly*7.5)),0]);
		if(tmouse3move==1){mat4.translate(mvMatrix, [-mouse3dx*20,-mouse2dy*20,0]);}
		///else{mat4.translate(mvMatrix, [-mouse2dx*20,-mouse2dy*20,0]);}
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.useProgram(shader0Program);
	gl.activeTexture(gl.TEXTURE5);
	//if(tgirl==1){if(Math.random()<dtime*0.0001){tgirl=2;}}
	//if(tgirl==2){if(Math.random()<dtime*0.0002){tgirl=1;}}
    //if(tgirl<2){gl.bindTexture(gl.TEXTURE_2D,  carTexture);}
    gl.bindTexture(gl.TEXTURE_2D,  carTexture);
	//else{gl.bindTexture(gl.TEXTURE_2D,  carTexture2);}
    gl.uniform1i(shader0Program.samplerUniform, 5);
    
    mat4.scale(mvMatrix,[2,1.4,1]);
    colorr=1;colorg=1;colorb=1;colora=0;//1+20;
    //drawcarresh0();
	drawcarrecockpit();
    colorr=1;colorg=1;colorb=1;colora=1;
	gl.useProgram(shaderProgram);

    mvPushMatrix();
	mat4.translate(mvMatrix, [-17.65,-5.8,0.005]);
    mat4.scale(mvMatrix,[0.07,0.10,1]);
	colora=1;
	drawrpm();
	colora=1;
	mvPopMatrix();

    mvPushMatrix();
	mat4.translate(mvMatrix, [-20.05,-13.5,0.01]);
    mat4.scale(mvMatrix,[0.26,0.427,1]);
	mat4.rotate(mvMatrix, degtorad(o3volant), [0, 0, 1]);
    drawvolant();
	mvPopMatrix();
	
	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
function drawvolant(){
	gl.useProgram(shaderaProgram);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  volantTexture);
    gl.uniform1i(shaderaProgram.samplerUniform, 0);
    
    colorr=1;colorg=1;colorb=1;colora=1+20;
    drawcarrea();
    colorr=1;colorg=1;colorb=1;colora=1;
	gl.useProgram(shaderProgram);
}
function drawvolant2(){
	gl.useProgram(shaderaProgram);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  volant2Texture);
    gl.uniform1i(shaderaProgram.samplerUniform, 0);
    
    colorr=1;colorg=1;colorb=1;colora=1+20;
    drawcarrea();
    colorr=1;colorg=1;colorb=1;colora=1;
	gl.useProgram(shaderProgram);
}
function drawrpm(){
    mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  rpmTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
	drawcarre();
    
    gl.bindTexture(gl.TEXTURE_2D,  arrowTexture);
	var o3rpm=130-(vrun+0.7*vcar)*105*(0.8+1.3)/(0.8+vrunmax);
	if(o3rpm<-130){o3rpm=-130;};
	mat4.rotate(mvMatrix, degtorad(o3rpm), [0, 0, 1]);
 	//mat4.scale(mvMatrix,[0.065,0.059,0.067]);
    mat4.scale(mvMatrix,[0.8,0.8,0.8]);
	drawcarre();
	mvPopMatrix();
}
function drawcarcockpit2(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		to1=o1+o1head-o1save;
		while(to1>180){to1-=360;}
		while(to1<-180){to1+=360;}
		if(o1head>120){to1=230;}
		if(tmouse3move==1 && Math.abs(to1)>120){to1=320;}
		mat4.rotate(mvMatrix, degtorad(to1*0.4), [0, -1, 0]);
		mat4.translate(mvMatrix, [0,2.3,-84]);
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(planedo2), [1, 0, 0]);
		mat4.rotate(mvMatrix, degtorad(-planedo3*2.7), [0, 0, 1]);
		mat4.translate(mvMatrix, [0,Math.min(20,Math.max(-20,planedo2*0.7+cockpith-tfly*7.5)),0]);
		if(tmouse3move==1){mat4.translate(mvMatrix, [-mouse3dx*20,-mouse2dy*20,0]);}
		///else{mat4.translate(mvMatrix, [-mouse2dx*20,-mouse2dy*20,0]);}
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.useProgram(shader0Program);
	gl.activeTexture(gl.TEXTURE5);
	//if(tgirl==1){if(Math.random()<dtime*0.0001){tgirl=2;}}
	//if(tgirl==2){if(Math.random()<dtime*0.0002){tgirl=1;}}
    if(tgirl<2){gl.bindTexture(gl.TEXTURE_2D,  carTexture);}
	//else{gl.bindTexture(gl.TEXTURE_2D,  carTexture2);}
    gl.uniform1i(shader0Program.samplerUniform, 5);
    
    mat4.scale(mvMatrix,[2,1.4,1]);
    colorr=1;colorg=1;colorb=1;colora=0;//1+20;
    //drawcarresh0();
	drawcarrecockpit();
    colorr=1;colorg=1;colorb=1;colora=1;
	gl.useProgram(shaderProgram);

    mvPushMatrix();
	mat4.translate(mvMatrix, [-17.65,-26,0.005]);
    mat4.scale(mvMatrix,[0.07,0.10,1]);
	colora=1;
	drawrpm();
	colora=1;
	mvPopMatrix();

    mvPushMatrix();
	mat4.translate(mvMatrix, [-17.57,-37.3,0.01]);
    mat4.scale(mvMatrix,[0.265,0.427,1]);
	mat4.rotate(mvMatrix, degtorad(o3volant), [0, 0, 1]);
    drawvolant();
	mvPopMatrix();
	
	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
function drawcarcockpit3(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		to1=o1+o1head-o1save;
		while(to1>180){to1-=360;}
		while(to1<-180){to1+=360;}
		if(o1head>120){to1=230;}
		if(tmouse3move==1 && Math.abs(to1)>120){to1=320;}
		mat4.rotate(mvMatrix, degtorad(to1*0.4), [0, -1, 0]);
		mat4.translate(mvMatrix, [20,-17.35,-60]);
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(planedo2), [1, 0, 0]);
		mat4.rotate(mvMatrix, degtorad(-planedo3*2.7), [0, 0, 1]);
		mat4.translate(mvMatrix, [0,Math.min(20,Math.max(-20,planedo2*0.7+cockpith-tfly*7.5)),0]);
		if(tmouse3move==1){mat4.translate(mvMatrix, [-mouse3dx*20,-mouse2dy*20,0]);}
		///else{mat4.translate(mvMatrix, [-mouse2dx*20,-mouse2dy*20,0]);}
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.useProgram(shader0Program);
	gl.activeTexture(gl.TEXTURE5);
	//if(tgirl==1){if(Math.random()<dtime*0.0001){tgirl=2;}}
	//if(tgirl==2){if(Math.random()<dtime*0.0002){tgirl=1;}}
    //if(tgirl<2){gl.bindTexture(gl.TEXTURE_2D,  carTexture);}
    gl.bindTexture(gl.TEXTURE_2D,  carTexture);
	//else{gl.bindTexture(gl.TEXTURE_2D,  carTexture2);}
    gl.uniform1i(shader0Program.samplerUniform, 5);
    
    mat4.scale(mvMatrix,[1.92,1.05,1]);
    colorr=1;colorg=1;colorb=1;colora=0;//1+20;
    //drawcarresh0();
	drawcarrecockpit();
    colorr=1;colorg=1;colorb=1;colora=1;
	gl.useProgram(shaderProgram);

    mvPushMatrix();
	mat4.translate(mvMatrix, [-18.75,-6,0.005]);
    mat4.scale(mvMatrix,[0.06,0.1,1]);
	colora=1;
	drawrpm();
	colora=1;
	mvPopMatrix();

    mvPushMatrix();
	mat4.translate(mvMatrix, [-19.9,-16.8,0.01]);
    mat4.scale(mvMatrix,[0.24,0.422,1]);
	mat4.rotate(mvMatrix, degtorad(o3volant), [0, 0, 1]);
    drawvolant();
	mvPopMatrix();
	
	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
function drawcarcockpit4(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		to1=o1+o1head-o1save;
		while(to1>180){to1-=360;}
		while(to1<-180){to1+=360;}
		if(o1head>120){to1=230;}
		if(tmouse3move==1 && Math.abs(to1)>120){to1=320;}
		mat4.rotate(mvMatrix, degtorad(to1*0.4), [0, -1, 0]);
		mat4.translate(mvMatrix, [10.5,-11.7,-60]);
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(planedo2), [1, 0, 0]);
		mat4.rotate(mvMatrix, degtorad(-planedo3*2.7), [0, 0, 1]);
		mat4.translate(mvMatrix, [0,Math.min(20,Math.max(-20,planedo2*0.7+cockpith-tfly*7.5)),0]);
		if(tmouse3move==1){mat4.translate(mvMatrix, [-mouse3dx*20,-mouse2dy*20,0]);}
		///else{mat4.translate(mvMatrix, [-mouse2dx*20,-mouse2dy*20,0]);}
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.useProgram(shader0Program);
	gl.activeTexture(gl.TEXTURE5);
	//if(tgirl==1){if(Math.random()<dtime*0.0001){tgirl=2;}}
	//if(tgirl==2){if(Math.random()<dtime*0.0002){tgirl=1;}}
    //if(tgirl<2){gl.bindTexture(gl.TEXTURE_2D,  carTexture);}
    gl.bindTexture(gl.TEXTURE_2D,  carTexture);
	//else{gl.bindTexture(gl.TEXTURE_2D,  carTexture2);}
    gl.uniform1i(shader0Program.samplerUniform, 5);
    
    mat4.scale(mvMatrix,[1.92,1.05,1]);
    colorr=1;colorg=1;colorb=1;colora=0;//1+20;
    //drawcarresh0();
	drawcarrecockpit();
    colorr=1;colorg=1;colorb=1;colora=1;
	gl.useProgram(shaderProgram);

    mvPushMatrix();
	mat4.translate(mvMatrix, [-18.75,-8,0.005]);
    mat4.scale(mvMatrix,[0.06,0.1,1]);
	colora=1;
	drawrpm();
	colora=1;
	mvPopMatrix();

    mvPushMatrix();
	mat4.translate(mvMatrix, [-20.3,-18,0.01]);
    mat4.scale(mvMatrix,[0.24,0.422,1]);
	mat4.rotate(mvMatrix, degtorad(o3volant), [0, 0, 1]);
    drawvolant2();
	mvPopMatrix();
	
	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
function drawcarcockpit5(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		to1=o1+o1head-o1save;
		while(to1>180){to1-=360;}
		while(to1<-180){to1+=360;}
		if(o1head>120){to1=230;}
		if(tmouse3move==1 && Math.abs(to1)>120){to1=320;}
		mat4.rotate(mvMatrix, degtorad(to1*0.4), [0, -1, 0]);
		mat4.translate(mvMatrix, [10.8,-13.1,-60]);
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(planedo2), [1, 0, 0]);
		mat4.rotate(mvMatrix, degtorad(-planedo3*2.7), [0, 0, 1]);
		mat4.translate(mvMatrix, [0,Math.min(20,Math.max(-20,planedo2*0.7+cockpith-tfly*7.5)),0]);
		if(tmouse3move==1){mat4.translate(mvMatrix, [-mouse3dx*20,-mouse2dy*20,0]);}
		///else{mat4.translate(mvMatrix, [-mouse2dx*20,-mouse2dy*20,0]);}
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.useProgram(shader0Program);
	gl.activeTexture(gl.TEXTURE5);
	//if(tgirl==1){if(Math.random()<dtime*0.0001){tgirl=2;}}
	//if(tgirl==2){if(Math.random()<dtime*0.0002){tgirl=1;}}
    //if(tgirl<2){gl.bindTexture(gl.TEXTURE_2D,  carTexture);}
    gl.bindTexture(gl.TEXTURE_2D,  carTexture);
	//else{gl.bindTexture(gl.TEXTURE_2D,  carTexture2);}
    gl.uniform1i(shader0Program.samplerUniform, 5);
    
    mat4.scale(mvMatrix,[1.7,1.3,1]);
    colorr=1;colorg=1;colorb=1;colora=0;//1+20;
    //drawcarresh0();
	drawcarrecockpit();
    colorr=1;colorg=1;colorb=1;colora=1;
	gl.useProgram(shaderProgram);

    mvPushMatrix();
	mat4.translate(mvMatrix, [-20,-9.3,0.005]);
    mat4.scale(mvMatrix,[0.06,0.1,1]);
	colora=1;
	drawrpm();
	colora=1;
	mvPopMatrix();

    mvPushMatrix();
	mat4.translate(mvMatrix, [-22.5,-19.8,0.01]);
    mat4.scale(mvMatrix,[0.245,0.422,1]);
	mat4.rotate(mvMatrix, degtorad(o3volant), [0, 0, 1]);
    drawvolant2();
	mvPopMatrix();
	
	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
function drawcarcockpit6(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		//windx=canvas.width;
		//windy=canvas.height;
		//mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		to1=o1+o1head-o1save;
		while(to1>180){to1-=360;}
		while(to1<-180){to1+=360;}
		if(o1head>120){to1=230;}
		if(tmouse3move==1 && Math.abs(to1)>120){to1=320;}
		mat4.rotate(mvMatrix, degtorad(to1*0.4), [0, -1, 0]);
		mat4.translate(mvMatrix, [10.8,-14,-60]);
		//mat4.translate(mvMatrix, [234*windx/windy,220,-600]);//boussx
		//mat4.rotate(mvMatrix, degtorad(planedo2), [1, 0, 0]);
		mat4.rotate(mvMatrix, degtorad(-planedo3*2.05), [0, 0, 1]);
		mat4.translate(mvMatrix, [0,Math.min(20,Math.max(-20,planedo2*0.7+cockpith-tfly*7.5)),0]);
		if(tmouse3move==1){mat4.translate(mvMatrix, [-mouse3dx*20,-mouse2dy*20,0]);}
		///else{mat4.translate(mvMatrix, [-mouse2dx*20,-mouse2dy*20,0]);}
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.useProgram(shader0Program);
	gl.activeTexture(gl.TEXTURE5);
	//if(tgirl==1){if(Math.random()<dtime*0.0001){tgirl=2;}}
	//if(tgirl==2){if(Math.random()<dtime*0.0002){tgirl=1;}}
    //if(tgirl<2){gl.bindTexture(gl.TEXTURE_2D,  carTexture);}
    gl.bindTexture(gl.TEXTURE_2D,  carTexture);
	//else{gl.bindTexture(gl.TEXTURE_2D,  carTexture2);}
    gl.uniform1i(shader0Program.samplerUniform, 5);
    
    mat4.scale(mvMatrix,[1.74,0.97,1]);
    colorr=1;colorg=1;colorb=1;colora=0;//1+20;
    //drawcarresh0();
	drawcarrecockpit();
    colorr=1;colorg=1;colorb=1;colora=1;
	gl.useProgram(shaderProgram);

    mvPushMatrix();
	mat4.translate(mvMatrix, [-20,-9.3,0.005]);
    mat4.scale(mvMatrix,[0.06,0.1,1]);
	colora=1;
	drawrpm();
	colora=1;
	mvPopMatrix();

    mvPushMatrix();
	mat4.translate(mvMatrix, [-20.5,-19.7,0.01]);
    mat4.scale(mvMatrix,[0.22,0.422,1]);
	mat4.rotate(mvMatrix, degtorad(o3volant), [0, 0, 1]);
    drawvolant();
	mvPopMatrix();
	
	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
var nroc=30,rocx=new Array(nroc),rocy=new Array(nroc),rocz=new Array(nroc);
var roco1=new Array(nroc),roco2=new Array(nroc),roco3=new Array(nroc);
var rocscale=new Array(nroc),roch=new Array(nroc);
function initroc(){
for(var i=0;i<nroc;i++){
   rocx[i]=-999+Math.random()*400;rocy[i]=-999+Math.random()*400;rocz[i]=0.15;
   roco1[i]=Math.random()*360;roco2[i]=Math.random()*360;roco3[i]=Math.random()*360;
   rocscale[i]=0.17+0.2*Math.random();
   roch[i]=2.7*rocscale[i]*(-0.35+0.5*Math.random());
   }
}
initroc(); 
function updateroc(){
for(var i=0;i<nroc;i++){
   rocx[i]+=nextdx;
   rocy[i]+=nextdy;
}
//}
//function updategrass0(){
for(var i=0;i<ngrass;i++){
   grassx[i]+=nextdx;
   grassy[i]+=nextdy;
}
for(var i=0;i<nflower;i++){
   flowerx[i]+=nextdx;
   flowery[i]+=nextdy;
}
for(var i=0;i<nsailship;i++){
    psailshipx[i]+=nextdx;
    psailshipy[i]+=nextdy;
}
}
var x1=0,y1=0,z1=0,x2=0,y2=0,z2=0;
function rotavion(x,y,z,r){
 x1=x*cos1+y*sin1;
 //'y1=0-x*sin1+y*cos1
 //'z1=z
 x2=x1*cos2+z*sin2;
 //'y2=y1
 y2=-x*sin1+y*cos1;
 z2=-x1*sin2+z*cos2;
if(x2<0.87*Math.abs(y2)/(gl.viewportWidth/gl.viewportHeight)-r){return 0;}
if(x2<0.87*Math.abs(z2)-r){return 0;}
return 1;
}
var testroc=0,zroc=-0.39,nways=0;  
function drawroc(){
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  rocTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, rocVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, rocVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms(); 
var distmax=30;
for(var i=0;i<nroc;i++){		
		var test=0;if(loading==0){test=testroc;}
		while(rocx[i]<(x-distmax)){rocx[i]+=distmax*1.99999;test=11;};
		while(rocx[i]>(x+distmax)){rocx[i]-=distmax*1.99999;test=11;};
		while(rocy[i]<(y-distmax)){rocy[i]+=distmax*1.99999;test=11;};
		while(rocy[i]>(y+distmax)){rocy[i]-=distmax*1.99999;test=11;};
		var d=rocscale[i]*1.8+Math.min(roch[i]*0.8,0);
		if(Math.abs(rocx[i]-x)<d){
		   if(Math.abs(rocy[i]-y)<d){
		      if(rocz[i]>zroc && tfly==0 && myisailship<0){tcollide=1;};};}
	    if(test==11){var dnroc=nroc*40000/(40000+nways*nways*19*19/(dxmax*dxmax));
					 if(i>(dnroc) || dnroc<5){rocz[i]=-999999;}
		             else{rocz[i]=1;}}
		if(test>=1 && rocz[i]>-999990){
		  if(testroad2(rocx[i],rocy[i],lat0,lng0,d*1.5)>0){rocz[i]=-999;}
          else{
		    rocz[i]=getterrainheight2(rocx[i],rocy[i]);
		    if(rocz[i]<zroc || rocz[i]>40+zsol){rocz[i]=-999;}
		  }
		}
    if(rocz[i]>zroc){
    	var r=3*rocscale[i]+5;	  
        if(rotavion(rocx[i]-x,rocy[i]-y,rocz[i]-z,r)){  
		mvPushMatrix();
		if(tshadow==0){mat4.translate(mvMatrix, [rocx[i],rocy[i],rocz[i]+roch[i]]);
        }else{mat4.translate(mvMatrix, [rocx[i],rocy[i],zsol]);}
		mat4.rotate(mvMatrix, degtorad(roco1[i]), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(roco2[i]), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(roco3[i]), [1, 0, 0]);
		var sc=rocscale[i]*0.015;
		mat4.scale(mvMatrix,[sc,sc,sc]);
    
    gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, pvMatrix);
    gl_drawArrays(gl.TRIANGLES, 0, rocVertexPositionBuffer.numItems);
		
		mvPopMatrix();
    }}
 }
 if(loading==0){testroc=0;}
}
function drawroc2(){
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  rocTexture);
    gl.uniform1i(shader22Program.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexPositionBuffer);
    gl.vertexAttribPointer(shader22Program.vertexPositionAttribute, rocVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms22(); 
var distmax=50;
for(var i=0;i<nroc;i++){		
    if(rocz[i]>zroc){
    	var r=3*rocscale[i]+5;	  
        if(rotavion(rocx[i]-x,rocy[i]-y,0,r)){  
		mvPushMatrix();
		if(tshadow==0){mat4.translate(mvMatrix, [rocx[i],rocy[i],rocz[i]+roch[i]]);
        }else{mat4.translate(mvMatrix, [rocx[i],rocy[i],zsol+roch[i]]);}
		mat4.rotate(mvMatrix, degtorad(roco1[i]), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(roco2[i]), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(roco3[i]), [1, 0, 0]);
		var sc=rocscale[i]*0.015;
		mat4.scale(mvMatrix,[sc,sc,sc]);
    
    gl.uniformMatrix4fv(shader22Program.mvMatrixUniform, false, mvMatrix);
	    //mat4.multiply(pMatrix,mvMatrix,pvMatrix);
        //gl.uniformMatrix4fv(shader22Program.mvMatrixUniform, false, pvMatrix);
    gl_drawArrays(gl.TRIANGLES, 0, rocVertexPositionBuffer.numItems);
		
		mvPopMatrix();
    }}
 }
}
var testupdategrass=0;
function updategrass(){if(tmove==0){return;};
        gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=6.8,test=0,h=0.3;	
		index=0;
		for (var i=0; i < ngrass; i++) {
		   xc=grassvertices[index];
		   yc=grassvertices[index+1];
		   zc=grassvertices[index+2];
		   //grassx[i]=xc;grassy[i]=yc;grassz[i]=zc;	 
		   test=testupdategrass;
		   if(test==1){xc=grassx[i];yc=grassy[i];}
		   while(xc<(x-distmax)){xc+=distmax*1.99999;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.99999;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.99999;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.99999;test=1;};
		   if(test==1){
		     zc=-999;
			 if(testmapgrass(xc,yc)==1){
		       if(testroad(xc,yc,lat0,lng0,0.5)==0){zc=getterrainheight2(xc,yc)+0.01;};}
		     if(zc<0){zc=-999;}
		     append(grassvertices,[
               xc,yc,zc,  xc,yc,zc+grassh[i],  xc,yc,zc			 
			   ]);}else{index+=9;}; 
		}	
        /*var igrass=0;
		index=0;
		for (var i=0; i < ngrass; i++) {
		    if(grassz[i]>0){
			  xc=grassx[i];yc=grassy[i];zc=grassz[i];
			  if(rotavion(xc-x,yc-y,zc-z,grassh[i])>0){
			    igrass+=1;
			    addindexcloud(grassvertices2,[
               xc,yc,zc,  xc,yc,zc+grassh[i],  xc,yc,zc			 
			   ]);
			  }
			}
		}
        gl.bufferData(gl.ARRAY_BUFFER, (grassvertices2), gl.STATIC_DRAW);
		grassVertexPositionBuffer.numItems=igrass*3;*/
        gl.bufferData(gl.ARRAY_BUFFER, (grassvertices), gl.STATIC_DRAW);
		testupdategrass=0;
}
var testupdateflower=0;
function updateflower(){if(tmove==0){return;};
        gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=6.8,test=0,h=0.3;	
		index=0;
		for (var i=0; i < nflower; i++) {
		   xc=flowervertices[index];
		   yc=flowervertices[index+1];
		   zc=flowervertices[index+2];
		   test=testupdateflower;
		   if(test==1){xc=flowerx[i];yc=flowery[i];}
		   while(xc<(x-distmax)){xc+=distmax*1.99999;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.99999;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.99999;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.99999;test=1;};
		   if(test==1){
		     zc=-999;
			 if(testmapgrass(xc,yc)==1){
		       if(testroad(xc,yc,lat0,lng0,0.5)==0){zc=getterrainheight2(xc,yc)+0.01;};}
		     if(zc<0){zc=-999;}
		     h=flowerh[i];		
		     append(flowervertices,[
               xc,yc,zc,  xc,yc,zc+h,  xc,yc,zc,
               xc,yc,zc+h, xc,yc,zc+h, xc,yc,zc			   
			   ]);}else{index+=18;}; 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (flowervertices), gl.STATIC_DRAW);
		testupdateflower=0;
}
var ttrottoir=0,ntrottoir=0,trottoirlat=[],trottoirlon=[],trottoirr=[],trottoirx=0,trottoiry=0;
var jtrottoir=0;
function settrottoir(){
var j=0;
if(Math.abs(trottoirx-x)<7 && Math.abs(trottoiry-y)<7){return;}
trottoirx=x;trottoiry=y;
jtrottoir=0;
var dy1=0.0008,dy=0.0008,dx1=klon*dy1,dx=klon*dy;
for(var i=0;i<ntrottoir;i++){
 if(Math.abs(trottoirlat[i]-latx)<dy1){
  if(Math.abs(trottoirlon[i]-lngx)<dx1){
    jtrottoir+=1;
    dy=trottoirr[i]+0.0003;
    if(Math.abs(trottoirlat[i]-latx)<dy){
	  if(Math.abs(trottoirlon[i]-lngx)<dy*klon){j+=1;}}}}
}
if(j>12){ttrottoir=1;}else{ttrottoir=0;}
}
var tsnow=0,snowzsol=0,snowlat=9999,tpine=0;
function setsnow(){
if(Math.abs(zsol-snowzsol)>20 || Math.abs(snowlat-latx)>2){
 snowzsol=zsol;snowlat=latx;
 tsnow=0;
 var twinter=0;
 if(latx>0){twinter=(1+Math.min(12-month,month-1))*50/(20+Math.abs(latx));}
 if(latx<0){twinter=(1+Math.min(Math.abs(6-month),Math.abs(7-month)))*50/(20+Math.abs(latx));}
 if(Math.random()*Math.max(0.55,twinter*30/Math.max(15,zsol))<0.5){tsnow=1;}
 tpine=0;if(Math.abs(latx)*zsol*(0.5+Math.random())>45*90){tpine=1;}
 if(temp>5){tsnow=0;}
}
tautumn=0;
var dmonth=0;
if(latx>10){dmonth=0.7+(latx-10)/30;if(month>=12-dmonth || month<=dmonth){tautumn=1;}}
if(latx<-10){dmonth=0.7+(10-latx)/30;if(month>=6-dmonth && month<=6+dmonth){tautumn=1;}}
}
var treetype=0,treetypez=0,ttreetype=0,tautumn=0;
var month=new Date().getMonth()+1; 
function drawtree(){
if(Math.abs(treetypez-zsol)>20 || tframe>ttreetype){
 treetypez=zsol;ttreetype=tframe+4000;
 if(zsol>(60+3*(60-Math.abs(lat))) || Math.abs(lat)>65){treetype=0;}//pine
 else if(zsol>3*(30-Math.abs(lat))){treetype=0;}//chene
 else{treetype=2;}//tropical
}

        mvPushMatrix();
	if(tshadow==0){mat4.translate(mvMatrix, [0,0,zsol0]);}
    else{mat4.translate(mvMatrix, [0,0,zsol0+0.02]);}
	var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
  if(tautumn==0){
    if(treetype==0){if(tpine==0){gl.bindTexture(gl.TEXTURE_2D,treeTexture);}
	                else{gl.bindTexture(gl.TEXTURE_2D,tree3Texture);}
    }else{gl.bindTexture(gl.TEXTURE_2D,tree2Texture);}
	gl.uniform1i(treeProgram.samplerUniform, 6);
  }else{
    if(treetype==0){if(tpine==0){gl.bindTexture(gl.TEXTURE_2D,autumntreeTexture);}
	                else{gl.bindTexture(gl.TEXTURE_2D,tree3Texture);}
    }else{gl.bindTexture(gl.TEXTURE_2D,autumntree2Texture);}
	gl.uniform1i(treeProgram.samplerUniform, 6);
  } 
    gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, treeVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, treeVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformstree(); 
    gl_drawArrays(gl.TRIANGLES, 0, treeVertexPositionBuffer[ibuff].numItems);
		
		mvPopMatrix();
}
var tsequoia=1,tsequoia0=1;
function drawtree2(){
/*if(Math.abs(treetypez-zsol)>20 || tframe>ttreetype){
 treetypez=zsol;ttreetype=tframe+4000;
 if(zsol>(60+3*(60-Math.abs(lat))) || Math.abs(lat)>65){treetype=0;}//pine
 else if(zsol>3*(30-Math.abs(lat))){treetype=0;}//chene
 else{treetype=2;}//tropical
}*/

        mvPushMatrix();
	if(tshadow==0){mat4.translate(mvMatrix, [0,0,zsol0]);}
    else{mat4.translate(mvMatrix, [0,0,zsol0+0.02]);}
	var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
  if(tautumn==0){
    if(tsequoia0>=1){gl.bindTexture(gl.TEXTURE_2D,sequoiaTexture);
    }else if(treetype==0){gl.bindTexture(gl.TEXTURE_2D,tree2Texture);
    }else{gl.bindTexture(gl.TEXTURE_2D,treeTexture);}
	gl.uniform1i(treeProgram.samplerUniform, 6);
  }else{
    if(tsequoia0>=1){gl.bindTexture(gl.TEXTURE_2D,sequoiaTexture);
    }else if(treetype==0){gl.bindTexture(gl.TEXTURE_2D,autumntree2Texture);
    }else{gl.bindTexture(gl.TEXTURE_2D,autumntreeTexture);}
	gl.uniform1i(treeProgram.samplerUniform, 6);
  }
  
    gl.bindBuffer(gl.ARRAY_BUFFER, tree2VertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, tree2VertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tree2VertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, tree2VertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);
    
    if(tsequoia0==0){setMatrixUniformstree();}
	else{setMatrixUniformstreesequoia();}
    gl_drawArrays(gl.TRIANGLES, 0, tree2VertexPositionBuffer[ibuff].numItems);
		
		mvPopMatrix();
}
function drawgrass(){
        mvPushMatrix();
	if(tshadow==0){mat4.translate(mvMatrix, [0,0,zsol0]);}
    else{mat4.translate(mvMatrix, [0,0,zsol0+0.02]);}
	var sc=1;
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D,  grassTexture);
    gl.uniform1i(treeProgram.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexTextureCoordBuffer);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, grassVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexPositionBuffer);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, grassVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
	setMatrixUniformsgrass(); 
    gl_drawArrays(gl.TRIANGLES, 0, grassVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
function drawflower(){
        mvPushMatrix();
	if(tshadow==0){mat4.translate(mvMatrix, [0,0,zsol0]);}
    else{mat4.translate(mvMatrix, [0,0,zsol0+0.02]);}
	//var sc=1;
    //mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE13);
    gl.bindTexture(gl.TEXTURE_2D,  flowerTexture);
    gl.uniform1i(treeProgram.samplerUniform, 13);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexTextureCoordBuffer);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, flowerVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexPositionBuffer);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, flowerVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
	setMatrixUniformsflower(); 
    gl_drawArrays(gl.TRIANGLES, 0, flowerVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
function drawline(){

        mvPushMatrix();
	mat4.translate(mvMatrix, [0,0,zsol0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
    
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,crossTexture);
   	gl.uniform1i(lineProgram.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, lineVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(lineProgram.textureCoordAttribute, lineVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, lineVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(lineProgram.vertexPositionAttribute, lineVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);
    
	rline=1;
	colorr=0.8;colorg=0.8;colorb=0.8;
    setMatrixUniformsline();
    colorr=1;colorg=1;colorb=1;	
    //gl.lineWidth(4);
    gl_drawArrays(gl.TRIANGLES, 0, lineVertexPositionBuffer[ibuff].numItems);
		
		mvPopMatrix();
}
function drawcross(){

        mvPushMatrix();
	mat4.translate(mvMatrix, [0,0,zsol0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
    
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,crossTexture);
   	gl.uniform1i(lineProgram.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, crossVertexTextureCoordBuffer[ibuff]);
    gl.vertexAttribPointer(lineProgram.textureCoordAttribute, crossVertexTextureCoordBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, crossVertexPositionBuffer[ibuff]);
    gl.vertexAttribPointer(lineProgram.vertexPositionAttribute, crossVertexPositionBuffer[ibuff].itemSize, gl.FLOAT, false, 0, 0);
    
	rline=1;
	colorr=0.7;colorg=0.7;colorb=0.7;colora=1;
    setMatrixUniformsline();
    colorr=1;colorg=1;colorb=1;colora=1;	
    gl_drawArrays(gl.TRIANGLES, 0, crossVertexPositionBuffer[ibuff].numItems);
		
		mvPopMatrix();
}
function drawroadarrow(){
var dist=12;
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,roadarrowTexture);
 	gl.uniform1i(shaderProgram.samplerUniform, 0);
for(var i=1;i<=iroadarrow0;i++){
 if(Math.abs(roadarrow0x[i]-x)<dist){
  if(Math.abs(roadarrow0y[i]-y)<dist){
   var xx=roadarrow0x[i],yy=roadarrow0y[i],zz=roadarrow0z[i]+0.007;
   if(rotavion(xx-x,yy-y,zz-z,2)){  
    mvPushMatrix();
    mat4.translate(mvMatrix, [xx,yy,zz]);
    mat4.rotate(mvMatrix, degtorad(roadarrow0o1[i]), [0, 0, 1]);
	mat4.rotate(mvMatrix, degtorad(-roadarrow0o2[i]), [0, 1, 0]);
	//mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
    var sc=0.005;//0.0035
    mat4.scale(mvMatrix,[sc*1.4,sc,sc]);
    
    colorr=1;colorg=1;colorb=1;colora=1;	
    drawcarre();
    colorr=1;colorg=1;colorb=1;colora=1;	

	mvPopMatrix();
}}}}}
function drawwoman(){
for(var i=0;i<iwoman0;i++){
  var xx=woman0x[i]/2,yy=woman0y[i]/2;
  if(rotavion(xx-x,yy-y,woman0z[i]-z,2)){
    mvPushMatrix();
	if(iview==1 && tfoot==0){
	   mat4.translate(mvMatrix, [xx,yy,woman0z[i]+0.19]);
	   mat4.rotate(mvMatrix, degtorad(o1view), [0, 0, 1]);
	}else{
	   mat4.translate(mvMatrix, [xx,yy,woman0z[i]+0.19]);
	   mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
    }
	mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
	mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
    var sc=0.0030;//0.0035
    mat4.scale(mvMatrix,[sc,sc*1.5,sc]);
    
	var dxx=(xx-x)*woman0co1[i]+(yy-y)*woman0si1[i];
	var dxy=(xx-x)*woman0si1[i]-(yy-y)*woman0co1[i];
	if(Math.random()<dtime*0.0002){
	   var co10=woman0co1[i];
	   woman0co1[i]=-woman0si1[i];
	   woman0si1[i]=co10;
	   tmovertt=1;}
	gl.activeTexture(gl.TEXTURE0);
    if(dxx>0.7){
	   gl.bindTexture(gl.TEXTURE_2D,woman2Texture);
   	}else if(dxy>0){
	   gl.bindTexture(gl.TEXTURE_2D,woman3Texture);
	}else{
	   gl.bindTexture(gl.TEXTURE_2D,woman1Texture);
    }	
	gl.uniform1i(shaderProgram.samplerUniform, 0);

    colorr=1;colorg=1;colorb=1;colora=1;	
    drawcarre();
    colorr=1;colorg=1;colorb=1;colora=1;	

	mvPopMatrix();
  }
}}
function drawwoman2(){
for(var i=0;i<iwoman0;i++){
    mvPushMatrix();
	var xx=woman0x[i]/2,yy=woman0y[i]/2;
    mat4.translate(mvMatrix, [xx,yy,woman0z[i]+0.202]);
	mat4.rotate(mvMatrix, degtorad(-o1sun), [1, 0, 0]);
	mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
	//mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
    var sc=0.0045;//0.0035;
    mat4.scale(mvMatrix,[sc,sc*1.5,sc]);
    
	var dxx=(xx+sunx)*woman0co1[i]+(yy+suny)*woman0si1[i];
	var dxy=(xx+sunx)*woman0si1[i]-(yy+suny)*woman0co1[i];
	gl.activeTexture(gl.TEXTURE0);
    if(dxx>0.7){
	   gl.bindTexture(gl.TEXTURE_2D,woman2Texture);
   	}else if(dxy>0){
	   gl.bindTexture(gl.TEXTURE_2D,woman3Texture);
	}else{
	   gl.bindTexture(gl.TEXTURE_2D,woman1Texture);
    }	
	//gl.bindTexture(gl.TEXTURE_2D,woman2Texture);
	gl.uniform1i(shader22Program.samplerUniform, 0);

    colorr=1;colorg=1;colorb=1;colora=1;	
    drawcarreshadow22();
    colorr=1;colorg=1;colorb=1;colora=1;	

	mvPopMatrix();
}}
function drawcitypanel(){
  for(var i=0;i<ncitypanel;i++){
   if(citypanelr[i]>0.001){
      var nibuff=i;
        mvPushMatrix();
	mat4.translate(mvMatrix, [0,0,zsol0]);
    var sc=0.5;
    mat4.scale(mvMatrix,[sc,sc,1]);
    
	gl.activeTexture(gl.TEXTURE0);
    if(citypanelh[i]<2){gl.bindTexture(gl.TEXTURE_2D,ncitypanelTexture[i]);}
    else if(citypanelname[i]!="photo"){gl.bindTexture(gl.TEXTURE_2D,ncitypanelTexture[i]);}
	else if((i%9)<3){gl.bindTexture(gl.TEXTURE_2D,photoTexture);}
	else if((i%9)<5){gl.bindTexture(gl.TEXTURE_2D,marisolTexture);}
	else if((i%9)<7){gl.bindTexture(gl.TEXTURE_2D,womanTexture);}
	else{gl.bindTexture(gl.TEXTURE_2D,bikiniTexture);}
   	gl.uniform1i(lineProgram.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, citypanelVertexTextureCoordBuffer[nibuff]);
    gl.vertexAttribPointer(lineProgram.textureCoordAttribute, citypanelVertexTextureCoordBuffer[nibuff].itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, citypanelVertexPositionBuffer[nibuff]);
    gl.vertexAttribPointer(lineProgram.vertexPositionAttribute, citypanelVertexPositionBuffer[nibuff].itemSize, gl.FLOAT, false, 0, 0);
    
	rline=1;
	colorr=0.7;colorg=0.7;colorb=0.7;colora=1;
    setMatrixUniformsline();
    colorr=1;colorg=1;colorb=1;colora=1;	
    gl_drawArrays(gl.TRIANGLES, 0, citypanelVertexPositionBuffer[nibuff].numItems);
		
		mvPopMatrix();
	}}
}
var tourelle=0,to1=0;
var boeingx=0,boeingy=0,boeingz=0,boeingv=1,boeingo1=0;
function resetboeing(){
var r=200,do1=Math.random()*360;
var dist=distairportxx;
if(dist<r){r=dist;do1=diro1(airportxx-x,airportyy-y)+Math.random()*4;}
var co1=Math.cos(degtorad(do1)),si1=Math.sin(degtorad(do1));
boeingx=lngx+co1*r*klon/scale;
boeingy=latx+si1*r/scale;
boeingo1=do1+180+90*(Math.random()-0.5);
while(boeingo1>180){boeingo1-=360;}
while(boeingo1<-180){boeingo1+=360;}
}
var airportxx=0,airportyy=0,distairportxx=1,distboeing=999999;
function drawboeing(){
distboeing=999999;
airportxx=(airportx-lng0)*scale/klon;
airportyy=(airporty-lat0)*scale;
distairportxx=17+Math.max(Math.abs(airportxx-x),Math.abs(airportyy-y));
    var d720=Math.max(360,Math.min(720,720*distairportxx/200));
    var xx=(boeingx-lng0)*scale/klon;
    if(Math.abs(xx-x)>d720){resetboeing();return;}
	var yy=(boeingy-lat0)*scale;
    if(Math.abs(yy-y)>d720){resetboeing();return;}
    distboeing=Math.max(Math.abs(xx-x),Math.abs(yy-y));
	var co1=Math.cos(degtorad(boeingo1));
    var si1=Math.sin(degtorad(boeingo1));
	var o11=diro1(xx-x,yy-y);
    var cos11=Math.cos(degtorad(o11));
    var sin11=Math.sin(degtorad(o11));
	var do1=boeingo1-o11;
	while(do1>180){do1-=360;}
	while(do1<-180){do1+=360;}
    var sc=20,scx=sc;
    if(do1>0){
	     if(do1<49){boeingo1+=dtime*0.01;}
		 boeingx+=boeingv*dtime*0.0035*(co1-sin11)*klon/scale;
	     boeingy+=boeingv*dtime*0.0035*(si1+cos11)/scale;}
	else{if(do1>-49){boeingo1-=dtime*0.01;}
	     boeingx+=boeingv*dtime*0.0035*(co1+sin11)*klon/scale;
         boeingy+=boeingv*dtime*0.0035*(si1-cos11)/scale;scx=-scx;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy)+(Math.abs(xx-x)+Math.abs(yy-y))*0.17;
	if(distairportxx>400){zz=Math.max(zz,zsol+70);}
	boeingz+=(Math.max(zsol+3,Math.min(zsol+170,zz+3))-boeingz)*0.05;
	mat4.translate(mvMatrix, [xx,yy,boeingz]);//0.37
	sc=sc/(2*boussx);scx=scx/(2*boussx);
	var do11=do1-90;if(do1<0){do11=do1+90;}
	while(do11<-180){do11+=360;}
	while(do11>180){do11-=360;}
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o11+90-(do11)/1.5), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o11-to1+90-(do11)/1.5), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[scx,sc*0.5,1]);
    //mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  boeingTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
var boeing2x=0,boeing2y=0,boeing2z=0,boeing2v=1,boeing2o1=0,tairport=0;
var airportx=0,airporty=0,airportname="";
function resetboeing2(){
if(tairport==0){boeing2x=9999;return;}
var r=200,do1=diro1((boeingx-lngx)/klon,boeingy-latx)+180+Math.random()*120-60;
var dist=distairportxx;
if(dist<r){r=dist;do1=diro1(airportxx-x,airportyy-y);}
var co1=Math.cos(degtorad(do1)),si1=Math.sin(degtorad(do1));
boeing2x=lngx+co1*r*klon/scale;
boeing2y=latx+si1*r/scale;
boeing2o1=do1+180+90*(Math.random()-0.5);
while(boeing2o1>180){boeing2o1-=360;}
while(boeing2o1<-180){boeing2o1+=360;}
}
function drawboeing2(){
    if(distairportxx>200){return;}
    var d720=Math.max(390,Math.min(720,720*distairportxx/200));
    var xx=(boeing2x-lng0)*scale/klon;
    if(Math.abs(xx-x)>d720){resetboeing2();return;}
	var yy=(boeing2y-lat0)*scale;
    if(Math.abs(yy-y)>d720){resetboeing2();return;}
    distboeing=Math.min(distboeing,Math.max(Math.abs(xx-x),Math.abs(yy-y)));
	//setvol(myaudiojet,Math.max(0.002,0.6*20/(20+distboeing)));
    var co1=Math.cos(degtorad(boeing2o1));
    var si1=Math.sin(degtorad(boeing2o1));
	var o11=diro1(xx-x,yy-y);
    var cos11=Math.cos(degtorad(o11));
    var sin11=Math.sin(degtorad(o11));
	var do1=boeing2o1-o11;
	while(do1>180){do1-=360;}
	while(do1<-180){do1+=360;}
    var sc=20,scx=sc;
    if(do1>0){
	     if(do1<49){boeing2o1+=dtime*0.01;}
		 boeing2x+=boeing2v*dtime*0.00354*(co1-sin11)*klon/scale;
	     boeing2y+=boeing2v*dtime*0.00354*(si1+cos11)/scale;}
	else{if(do1>-49){boeing2o1-=dtime*0.01;}
	     boeing2x+=boeing2v*dtime*0.00354*(co1+sin11)*klon/scale;
         boeing2y+=boeing2v*dtime*0.00354*(si1-cos11)/scale;scx=-scx;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy)+(Math.abs(xx-x)+Math.abs(yy-y))*0.17;
	if(distairportxx>400){zz=Math.max(zz,zsol+70);}
	boeing2z+=(Math.max(zsol+3,Math.min(zsol+170,zz+3))-2-boeing2z)*0.05;
	mat4.translate(mvMatrix, [xx,yy,boeing2z]);//0.37
	sc=sc/(2*boussx);scx=scx/(2*boussx);
	var do11=do1-90;if(do1<0){do11=do1+90;}
	while(do11<-180){do11+=360;}
	while(do11>180){do11-=360;}
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o11+90-(do11)/1.5), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o11-to1+90-(do11)/1.5), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[scx,sc*0.5,1]);
    //mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  boeingTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=0.74;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function draweiffeltower(){
    var xx=(eiffeltowerx-lng0)*scale/klon;
    if(Math.abs(xx-x)>500){return;}
	var yy=(eiffeltowery-lat0)*scale;
    if(Math.abs(yy-y)>500){return;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy);
    var sc=63*0.6;//80*0.6;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.67]);//0.37
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(80), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    mat4.scale(mvMatrix,[sc,sc*1.53,1]);
    //mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  eiffeltowerTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawlibertystatue(){
    var xx=(libertystatuex-lng0)*scale/klon;
    if(Math.abs(xx-x)>500){return;}
	var yy=(libertystatuey-lat0)*scale;
    if(Math.abs(yy-y)>500){return;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy);
    var sc=32.5*0.6;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.58]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(80), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    //mat4.scale(mvMatrix,[sc,sc*1.3,1]);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  libertystatueTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawchristrio(){
    var xx=(christriox-lng0)*scale/klon;
    if(Math.abs(xx-x)>500){return;}
	var yy=(christrioy-lat0)*scale;
    if(Math.abs(yy-y)>500){return;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy);
    var sc=37*0.6;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.48]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(80), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    //mat4.scale(mvMatrix,[sc,sc*1.8,1]);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  christrioTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawdomerock(){
    var xx=(domerockx-lng0)*scale/klon;
    if(Math.abs(xx-x)>500){return;}
	var yy=(domerocky-lat0)*scale;
    if(Math.abs(yy-y)>500){return;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy);
    var sc=37.5*0.6;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.36]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(80), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    //mat4.scale(mvMatrix,[sc,sc,1]);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  domerockTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawgizah(){
    var xx=(gizahx-lng0)*scale/klon;
    if(Math.abs(xx-x)>500){return;}
	var yy=(gizahy-lat0)*scale;
    if(Math.abs(yy-y)>500){return;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy);
    var sc=69;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.345]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(80), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    //mat4.scale(mvMatrix,[sc,sc,1]);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  gizahTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawcapitole(){
    var xx=(capitolex-lng0)*scale/klon;
    if(Math.abs(xx-x)>500){return;}
	var yy=(capitoley-lat0)*scale;
    if(Math.abs(yy-y)>500){return;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy);
    var sc=91*0.6;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.49]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(80), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    //mat4.scale(mvMatrix,[sc,sc,1]);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  capitoleTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawtajmahal(){
    var xx=(tajmahalx-lng0)*scale/klon;
    if(Math.abs(xx-x)>500){return;}
	var yy=(tajmahaly-lat0)*scale;
    if(Math.abs(yy-y)>500){return;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy);
    var sc=65*0.6;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.36]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(80), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    //mat4.scale(mvMatrix,[sc,sc,1]);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  tajmahalTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function drawbuddah(){
    var xx=(buddahx-lng0)*scale/klon;
    if(Math.abs(xx-x)>500){return;}
	var yy=(buddahy-lat0)*scale;
    if(Math.abs(yy-y)>500){return;}
    mvPushMatrix();
	var zz=getterrainheight2(xx,yy);
    var sc=55*0.6;
	mat4.translate(mvMatrix, [xx,yy,zz+sc*0.32]);
	sc=sc/(2*boussx);
	if(tourelle==0){	
        mat4.rotate(mvMatrix, degtorad(-o1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(80), [1, 0, 0]);
	}else{
        mat4.rotate(mvMatrix, degtorad(-o1-to1+90), [0, 0, -1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
	}
    //mat4.scale(mvMatrix,[sc,sc*1.3,1]);
    mat4.scale(mvMatrix,[sc,sc,1]);
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  buddahTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 6);
	colorr=1;colorg=1;colorb=1;colora=1;
    drawcarre();    
	colorr=1;colorg=1;colorb=1;colora=1;

	mvPopMatrix();
}
function getterrainheight3(px,py,lng00,lat00){
 var lngpx=(px/scale)*klon+lng00;
 var latpy=(py/scale)+lat00;
 return getterrainheight(lngpx,latpy);
}
function getterrainheight2(px,py){
 var lngpx=(px/scale)*klon+lng0;
 var latpy=(py/scale)+lat0;
 return getterrainheight(lngpx,latpy);
}
var twater=0,testwater=0;
function getterrainheight(lngpx,latpy){
	//var scx=(dlngsol/klon)*scale;
	//var scy=dlatsol*scale;
//xsol=((lngsol0-lng0)/klon)*scale;
//ysol=(latsol0-lat0)*scale;
    twater=0;
	var n=nsol;
	var nx=nsol*(0.5+0.5*(lngpx-lngsol0)/dlngsol)-0.5;
	var ny=nsol*(0.5+0.5*(latpy-latsol0)/dlatsol)-0.5;
	//if(nx<=1 || nx>=nsol-1 || ny<=1 || ny>=nsol-1){return 0.01;}
	nx=Math.max(1.01,Math.min(nsol-1.01,nx));
	ny=Math.max(1.01,Math.min(nsol-1.01,ny));
	//while(nx<0){nx+=n};
	//while(ny<0){ny+=n;};
	var i=parseInt(nx),j=parseInt(ny);
	var dx=nx-i,dy=ny-j;
	/*while(i<0){i+=n;}
	while(i>=n){i-=n;}
	while(j<0){j+=n;}
	while(j>=n){j-=n;}*/
	var i1=i+1,j1=j+1;
	/*while(i1<0){i1+=n;}
	while(i1>=n){i1-=n;}
	while(j1<0){j1+=n;}
	while(j1>=n){j1-=n;}*/
	/*var ij=i*n+j;
	if(testwater==1){
	 if(i<(n-1) && j<(n-1)){
	  if(height2[ij]<0 || height2[ij+1]<0){twater=1;}
	  if(height2[ij+n]<0 || height2[ij+n+1]<0){twater=1;}
	 
	  if(i>1 && j>1){
	   if(height2[ij-1]<0 || height2[ij-1+n]<0){twater=1;}
	   if(height2[ij+1-n]<0){twater=1;}
	   if(height2[ij-n]<0 || height2[ij-n-1]<0){twater=1;}
	  }
	 }
	}*/
	//return height[parseInt(nx)*n+parseInt(ny)];
var ij=i*n+j;
if(height0[ij]<-0.1){
 if(height0[ij+n]<-0.1){
  if(height0[ij+1]<-0.1){
   if(height0[ij+n+1]<-0.1){
      twater=1;}}}}
if(dx<=(1.0-dy)){ 
    var z00=height2[ij];
    var z10=height2[ij+n];
    var z01=height2[ij+1];
    return ( dx*(z10-z00) +dy*(z01-z00) +z00);//+0.05;
}else{
    var z10=height2[ij+n];
    var z01=height2[ij+1];
    var z11=height2[ij+n+1];
    return ( (1-dx)*(z01-z11) +(1-dy)*(z10-z11) +z11 );//+0.05;
	}
}
function getterrainheight1(lngpx,latpy){
	//var scx=(dlngsol/klon)*scale;
	//var scy=dlatsol*scale;
//xsol=((lngsol0-lng0)/klon)*scale;
//ysol=(latsol0-lat0)*scale;
    var n=nsol;
	var nx=nsol*(0.5+0.5*(lngpx-lngsol0)/dlngsol)-0.5;
	var ny=nsol*(0.5+0.5*(latpy-latsol0)/dlatsol)-0.5;
	if(nx<=1 || nx>=nsol-1 || ny<=1 || ny>=nsol-1){return 0.01;}
	//while(nx<0){nx+=n};
	//while(ny<0){ny+=n;};
	var i=parseInt(nx),j=parseInt(ny);
	var dx=nx-i,dy=ny-j;
	/*while(i<0){i+=n;}
	while(i>=n){i-=n;}
	while(j<0){j+=n;}
	while(j>=n){j-=n;}*/
	var i1=i+1,j1=j+1;
	/*while(i1<0){i1+=n;}
	while(i1>=n){i1-=n;}
	while(j1<0){j1+=n;}
	while(j1>=n){j1-=n;}*/
	/*var ij=i*n+j;
	if(testwater==1){
	 if(i<(n-1) && j<(n-1)){
	  if(height2[ij]<0 || height2[ij+1]<0){twater=1;}
	  if(height2[ij+n]<0 || height2[ij+n+1]<0){twater=1;}
	 
	  if(i>1 && j>1){
	   if(height2[ij-1]<0 || height2[ij-1+n]<0){twater=1;}
	   if(height2[ij+1-n]<0){twater=1;}
	   if(height2[ij-n]<0 || height2[ij-n-1]<0){twater=1;}
	  }
	 }
	}*/
	//return height[parseInt(nx)*n+parseInt(ny)];
var ij=i*n+j;	
if(dx<=(1.0-dy)){ 
    var z00=height[ij];
    var z10=height[ij+n];
    var z01=height[ij+1];
    return ( dx*(z10-z00) +dy*(z01-z00) +z00);//+0.05;
}else{
    var z10=height[ij+n];
    var z01=height[ij+1];
    var z11=height[ij+n+1];
    return ( (1-dx)*(z01-z11) +(1-dy)*(z10-z11) +z11 );//+0.05;
	}
}
function getterrainheightfast(px,py){
 var lngpx=(px/scale)*klon+lng0;
 var latpy=(py/scale)+lat0;
	//var scx=(dlngsol/klon)*scale;
	//var scy=dlatsol*scale;
//xsol=((lngsol0-lng0)/klon)*scale;
//ysol=(latsol0-lat0)*scale;
	var nx=nsol*(0.5+0.5*(lngpx-lngsol0)/dlngsol)-0.5;
	var ny=nsol*(0.5+0.5*(latpy-latsol0)/dlatsol)-0.5;
	//if(nx<=1 || nx>=nsol-1 || ny<=1 || ny>=nsol-1){return 0.01;}
	var i=Math.max(1,Math.min(nsol-1,parseInt(nx)));
	var j=Math.max(1,Math.min(nsol-1,parseInt(ny)));
return height2[i*n+j];
}
var pxwater0=999,pywater0=0,kwater0=1;
function setwavez(px,py){
if(Math.abs(px-pxwater0)<1 && Math.abs(py-pywater0)<1){return kwater0;}
pxwater0=px;pywater0=py;
kwater0=setwavez0(px,py);
//kwater0=kwater0*kwater0;
setwavetx(px,py,20);
if(wavevx<0.001){setwavetx(px,py,35);}
if(wavevx<0.001){setwavetx(px,py,50);}
return kwater0;
}
function setwavez0(px,py){
var zwater=-0.04;
if(getterrainheightfast(px,py)>zwater){return 0.1;}
for(var j=1;j<=4;j++){
   var i=j*8;
   if(getterrainheightfast(px+i,py)>zwater){return j*0.2;}
   if(getterrainheightfast(px-i,py)>zwater){return j*0.2;}
   if(getterrainheightfast(px+i,py+i)>zwater){return j*0.2;}
   if(getterrainheightfast(px,py+i)>zwater){return j*0.2;}
   if(getterrainheightfast(px-i,py+i)>zwater){return j*0.2;}
   if(getterrainheightfast(px+i,py-i)>zwater){return j*0.2;}
   if(getterrainheightfast(px,py-i)>zwater){return j*0.2;}
   if(getterrainheightfast(px-i,py-i)>zwater){return j*0.2;}
}
return 1;
}
function setwavetx(px,py,dist){
var zwater=-0.04;
   var tx=0,ty=0,test=0;
   var i=dist;
   if(getterrainheightfast(px+i,py)>zwater){tx+=1;test=1;}
   if(getterrainheightfast(px-i,py)>zwater){tx-=1;test=1;}
   if(getterrainheightfast(px+i,py+i)>zwater){tx+=1;ty+=1;test=1;}
   if(getterrainheightfast(px,py+i)>zwater){ty+=1;test=1;}
   if(getterrainheightfast(px-i,py+i)>zwater){tx-=1;ty+=1;test=1;}
   if(getterrainheightfast(px+i,py-i)>zwater){tx+=1;ty-=1;test=1;}
   if(getterrainheightfast(px,py-i)>zwater){ty-=1;test=1;}
   if(getterrainheightfast(px-i,py-i)>zwater){tx-=1;ty-=1;test=1;}
   if(test==0){wavetx=0;wavety=0;wavevx=0;return;}
   var d=Math.sqrt(0.01+tx*tx+ty*ty);
   if(d<1){wavetx=0;wavety=0;wavevx=0.011;}
   else{wavetx=tx/d;wavety=ty/d;wavevx=(12/9)*d*d/(d*d+3);}
}
var tfindwater=0;
function findwater(){if(myisailship<0){return;}
var zwater=-0.0251,px=x,py=y;
//if(getterrainheight2(px,py)<zwater){return;}
for(var j=0;j<150;j++){
   var i=15*j;
   for(var ddo1=0;ddo1<360;ddo1+=15){
     var xx=px+Math.cos(degtorad(ddo1))*i;
	 var yy=py+Math.sin(degtorad(ddo1))*i;
	 var zz=getterrainheight2(xx,yy);
     if(zz<zwater){
       if(j>0){xx=xx+Math.cos(degtorad(ddo1))*15;
	           yy=yy+Math.sin(degtorad(ddo1))*15;
	           zz=getterrainheight2(xx,yy);}
       if(zz<zwater){
        sailshipo1=mysailshipo1;
        sailshipco1=Math.cos(degtorad(sailshipo1));
        sailshipsi1=Math.sin(degtorad(sailshipo1));
	    sailshipx=xx-mysailshipdxx*sailshipco1;
	    sailshipy=yy-mysailshipdxx*sailshipsi1;
        sailshipz=getterrainheight2(sailshipx,sailshipy);
		if(sailshipz<zwater){
			   x=xx;y=yy;
			   z=0.2;lastz=z;zsol=zz;
               lngx=lng0+x*klon/scale;
			   latx=lat0+y/scale;			   
			   return;}}}
   }}
}
function setterrainheight(lngpx,latpy,co1,si1,tan2,zz){
	//var scx=(dlngsol/klon)*scale;
	//var scy=dlatsol*scale;
//xsol=((lngsol0-lng0)/klon)*scale;
//ysol=(latsol0-lat0)*scale;
	var kx=co1*dlngsol*(1/klon)*scale/nsol;
	var ky=si1*dlatsol*scale/nsol;
	var nx=nsol*(0.5+0.5*(lngpx-lngsol0)/dlngsol)-0.5;
	var ny=nsol*(0.5+0.5*(latpy-latsol0)/dlatsol)-0.5;
	if(nx<=1 || nx>=nsol-1 || ny<=1 || ny>=nsol-1){return;}
	//while(nx<0){nx+=n};
	//while(ny<0){ny+=n;};
	var i=parseInt(nx),j=parseInt(ny);
	var dx=nx-i,dy=ny-j;
	/*while(i<0){i+=n;}
	while(i>=n){i-=n;}
	while(j<0){j+=n;}
	while(j>=n){j-=n;}*/
	var i1=i+1,j1=j+1;
	/*while(i1<0){i1+=n;}
	while(i1>=n){i1-=n;}
	while(j1<0){j1+=n;}
	while(j1>=n){j1-=n;}*/
	/*var ij=i*n+j;
	if(testwater==1){
	 if(i<(n-1) && j<(n-1)){
	  if(height2[ij]<0 || height2[ij+1]<0){twater=1;}
	  if(height2[ij+n]<0 || height2[ij+n+1]<0){twater=1;}
	 
	  if(i>1 && j>1){
	   if(height2[ij-1]<0 || height2[ij-1+n]<0){twater=1;}
	   if(height2[ij+1-n]<0){twater=1;}
	   if(height2[ij-n]<0 || height2[ij-n-1]<0){twater=1;}
	  }
	 }
	}*/
	//return height[parseInt(nx)*n+parseInt(ny)];
if(dx<=(1.0-dy)){ 
    var z00=height2[i*n+j];
    var z10=height2[i1*n+j];
    var z01=height2[i*n+j1];
    //var z=( dx*(z10-z00) +dy*(z01-z00) +z00);//+0.05;
	//if(z<0){z=0;}
	//z+=8;
	var kdx;
	kdx=(kx*dx+ky*dy);
	z00=Math.min(z00,zz+Math.max(0,-kdx*tan2));
	kdx=(kx*(dx-1)+ky*dy);
	z10=Math.min(z10,zz+Math.max(0,-kdx*tan2));
	kdx=(kx*dx+ky*(dy-1));
	z01=Math.min(z01,zz+Math.max(0,-kdx*tan2));
	height2[i*n+j]=z00;//-(kx*dx*co1+ky*dy*si1)*tan2;
	height2[i1*n+j]=z10;//-(kx*(dx-1)*co1+ky*dy*si1)*tan2;
	height2[i*n+j1]=z01;//-(kx*dx*co1+ky*(dy-1)*si1)*tan2;
	//height2[i1*n+j1]=Math.min(z,height2[i1*n+j1])
    //return z-8;
    //return ( dx*(z10-z00) +dy*(z01-z00) +z00);//+0.05;
}else{
    var z10=height2[i1*n+j];
    var z01=height2[i*n+j1];
    var z11=height2[i1*n+j1];
    //var z=( (1-dx)*(z01-z11) +(1-dy)*(z10-z11) +z11 );//+0.05;
    //if(z<0){z=0;}
	//z+=8;
    var kdx;
	kdx=(kx*(dx-1)+ky*dy);
	z10=Math.min(z10,zz+Math.max(0,-kdx*tan2));
	kdx=(kx*dx+ky*(dy-1));
	z01=Math.min(z01,zz+Math.max(0,-kdx*tan2));
	kdx=(kx*(dx-1)+ky*(dy-1));
	z11=Math.min(z11,zz+Math.max(0,-kdx*tan2));
	height2[i1*n+j]=z10;//-(kx*(dx-1)*co1+ky*dy*si1)*tan2;
	height2[i*n+j1]=z01;//-(kx*dx*co1+ky*(dy-1)*si1)*tan2;
	height2[i1*n+j1]=z11;//-(kx*(dx-1)*co1+ky*(dy-1)*si1)*tan2;
	//height2[i*n+j]=Math.min(z,height2[i*n+j])
    //return z-8;
    //return ( (1-dx)*(z01-z11) +(1-dy)*(z10-z11) +z11 );//+0.05;
	}
}
function flatterrainheight(lngpx,latpy){
	//var scx=(dlngsol/klon)*scale;
	//var scy=dlatsol*scale;
//xsol=((lngsol0-lng0)/klon)*scale;
//ysol=(latsol0-lat0)*scale;
	var n=nsol;
	var nx=nsol*(0.5+0.5*(lngpx-lngsol0)/dlngsol)-0.5;
	var ny=nsol*(0.5+0.5*(latpy-latsol0)/dlatsol)-0.5;
	if(nx<=1 || nx>=nsol-1 || ny<=1 || ny>=nsol-1){return;}
	var i0=parseInt(nx),j0=parseInt(ny);
	var zz=999999,di=2,kdi=1;
for(var i=Math.max(1,i0-di);i<Math.min(nsol-1,i0+di);i++){
 for(var j=Math.max(1,j0-di);j<Math.min(nsol-1,j0+di);j++){
    zz=Math.min(zz,height[i*nsol+j]);
 }
}
zz=Math.max(0.1,zz);//not water
di=10;
for(var i=Math.max(1,i0-di);i<Math.min(nsol-1,i0+di);i++){
 var ij0=i*nsol;
 for(var j=Math.max(1,j0-di);j<Math.min(nsol-1,j0+di);j++){
    kdi=1-Math.max(Math.abs(i-i0),Math.abs(j-j0))/di;
	var ij=ij0+j;
	var zzi=height[ij];
	if(zzi>0){height[ij]+=kdi*(zz-zzi);}
 }
}
}
var houlex,houley,kwater,houlez=[],altwater=2200;
for(var houlex=-612*32-200;houlex<=612*32+200;houlex++){
	houlez[houlex]=3.0*(-1.001+Math.cos(degtorad(houlex*360/32)));
}
var xsol=0,ysol=0,zsol0=-0.02,xsol0=0,ysol0=0;
var scalez=1,tloadsol=0,tsea0=0,tdrawsol=0,scxsol=1,scysol=1;
function drawsol(){
if(tdrawsol==0 && ttunnel==0){return;}
//xsol=parseInt(x/100)*100;
//ysol=parseInt(y/100)*100;
    var sc=1;//scalez;
	var scx=(dlngsol/klon)*scale;
	var scy=dlatsol*scale;
scxsol=scx;
scysol=scy;	
xsol=((lngsol0-lng0)/klon)*scale+scx/nsol;
ysol=(latsol0-lat0)*scale-scy/nsol;
//if(tupdatesoltexture==1){return;}
	
    if(loading==0 &&(Math.abs(xsol-x)>scx*0.5 || Math.abs(ysol-y)>scy*0.5)){//0.6//0.75
	   if(tupdatesoltexture==0 || tframe>tloadsol){
	      tloadsol=tframe+50000;
		  tdrawsol=tframe+9900;
		  tupdatesoltexture=2;loading=66;
		  updatesoltexture();return;}}
    //mat4.identity(mvMatrix);
	if(tframe>tdrawsol || tfly==1){dzsol0=zview;xsol0=lngsol0;ysol0=latsol0;}
	else if(ttunnelprev>=1 && tframe<tdrawsol-401){tdrawsol=tframe+300;z=zsol+0.7;}
	else if(tframe<tdrawsol-401){tdrawsol=tframe+300;z=Math.max(dzsol0+0.6,zsol+0.3);}
	mvPushMatrix();
	if(tframe>tdrawsol || tfly==1 || troad==0){
	     if(zsol>-0.04){mat4.translate(mvMatrix, [xsol,ysol,zsol0]);}
		 else{mat4.translate(mvMatrix, [xsol,ysol,zsol0-0.04]);}}
	else{z=zsol+0.7;
	     var xsol1=((xsol0-lng0)/klon)*scale+scx/nsol;
         var ysol1=(ysol0-lat0)*scale-scy/nsol;
	     if(ttunnelprev>=1){
		    mat4.translate(mvMatrix, [xsol1,ysol1,(zview-dzsol0-zsol0-0.15-tfoot*0.2)]);}
		 else{mat4.translate(mvMatrix, [xsol1,ysol1,(zview-dzsol0-zsol0-0.15-tfoot*0.2-5)]);
		      //mat4.translate(mvMatrix, [xsol1,ysol1,zsol0]);
		      mat4.scale(mvMatrix,[1,1,kdhzsol]);}
		 }
	mat4.scale(mvMatrix,[scx,scy,sc]);
	gl.activeTexture(gl.TEXTURE7);
    gl.bindTexture(gl.TEXTURE_2D,  solTexture);
    gl.uniform1i(solProgram.samplerUniform, 7);

	gl.activeTexture(gl.TEXTURE8);
    //if(tsnow==0 && ttrottoir==1){gl.bindTexture(gl.TEXTURE_2D,  trottoirTexture);}
    if(tsnow==0){gl.bindTexture(gl.TEXTURE_2D,  solTexture0);}
	else{gl.bindTexture(gl.TEXTURE_2D,  solTexture02);}
    gl.uniform1i(solProgram.samplerUniform2, 8);

	gl.activeTexture(gl.TEXTURE9);
    gl.bindTexture(gl.TEXTURE_2D,  seaTexture);
    gl.uniform1i(solProgram.samplerUniform3, 9);

	gl.bindBuffer(gl.ARRAY_BUFFER, solVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, solVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, solVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    if(tframe>tsea0){
	 tsea0=tframe+100;
	 //ksea=(1.0+Math.cos(tframe*0.001))*0.5;
     var tsea=tframe*0.00022;
	 ksea=Math.abs((tsea-parseInt(tsea))-0.5)*2;
	}
	//colorr=1.34;colorg=1.34;colorb=1.34;colora=1;
    colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniformssol();
    colorr=1;colorg=1;colorb=1;colora=1;
    gl_drawArrays(gl.TRIANGLES, 0, solVertexPositionBuffer.numItems);
	mvPopMatrix();
}
function drawsol2(){
//xsol=parseInt(x/100)*100;
//ysol=parseInt(y/100)*100;
    var sc=1;//scalez;
	var scx=(dlngsol/klon)*scale;
	var scy=dlatsol*scale;
xsol=((lngsol0-lng0)/klon)*scale+scx/nsol;
ysol=(latsol0-lat0)*scale-scy/nsol;
   
	
	mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [xsol,ysol,zsol0]);
	mat4.scale(mvMatrix,[scx,scy,sc]);
	mat4.set(mvMatrix,mvMatrix2sol);
	mvPopMatrix();
}
function drawsol3(){
//xsol=parseInt(x/100)*100;
//ysol=parseInt(y/100)*100;
    var sc=1;//scalez;
	var scx=(dlngsol/klon)*scale;
	var scy=dlatsol*scale;
xsol=((lngsol0-lng0)/klon)*scale+1.5*scx/nsol;
ysol=(latsol0-lat0)*scale+0.5*scy/nsol;
   
	
	mvPushMatrix();
    //mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [xsol,ysol,zsol0+z]);
	mat4.scale(mvMatrix,[scx/boussx,scy/boussy,sc]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  solTexture2);
    //gl.bindTexture(gl.TEXTURE_2D,  rttTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);

	//colorr=1.34;colorg=1.34;colorb=1.34;colora=1;
    colorr=0.3;colorg=0.7;colorb=0.52;colora=1;
	drawcarre();
    colorr=1;colorg=1;colorb=1;colora=1;
	mvPopMatrix();
}
function drawtexture(texture){   
    gl.disable(gl.DEPTH_TEST);
	mvPushMatrix();
    mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0,0,-20]);
	var sc=10;
	mat4.scale(mvMatrix,[(windx/windy)*sc/boussx,sc/boussy,1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  texture);
    //gl.bindTexture(gl.TEXTURE_2D,  rttTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);

    colorr=1;colorg=1;colorb=1;colora=0;
	drawcarre();
    colorr=1;colorg=1;colorb=1;colora=1;
	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}

	var index=0,indexroad=0,itextroad=0;
	var indexroadband=0,itextroadband=0;
	var indextower=0,itexttower=0;
	var indexchurch=0,itextchurch=0;
	var indexhouse=0,itexthouse=0;
	var indexofficial=0,itextofficial=0;
	var indexhospital=0,itexthospital=0;
	var indexroof=0,itextroof=0;
	var indexshop=0,itextshop=0;
	var indextree=0,indexline=0,indexcross=0,indexcitypanel=0;
	var indextree2=0,indexlinetext=0;
	function append(tab,values){
	  if(index>(tab.length-values.length)){return;}
	  for(var i=0;i<values.length;i++){
	     tab[index]=values[i];index+=1;
	  }
	}
    
	var roadVertexPositionBuffer=[];
	var roadVertexTextureCoordBuffer=[];
	var roadvertices,roadtextureCoords;
	var roadVertexNormalBuffer=[];
	var roadnormals;
	var roadbandVertexPositionBuffer=[];
	var roadbandVertexTextureCoordBuffer=[];
	var roadbandvertices,roadbandtextureCoords;
	var roadbandVertexNormalBuffer=[];
	var roadbandnormals;
	var towerVertexPositionBuffer=[];
	var towerVertexTextureCoordBuffer=[];
	var towervertices,towertextureCoords;
	var towerVertexNormalBuffer=[];
	var tower0VertexNormalBuffer=[];
	var towernormals;
	var churchVertexPositionBuffer=[];
	var churchVertexTextureCoordBuffer=[];
	var churchvertices,churchtextureCoords;
	var churchVertexNormalBuffer=[];
	var churchnormals;
	var solVertexPositionBuffer;
	var solVertexTextureCoordBuffer;
	var solvertices,soltextureCoords;
	var houseVertexPositionBuffer=[];
	var houseVertexTextureCoordBuffer=[];
	var housevertices,housetextureCoords;
	var houseVertexNormalBuffer=[];
	var housenormals;
	var officialVertexPositionBuffer=[];
	var officialVertexTextureCoordBuffer=[];
	var officialvertices,officialtextureCoords;
	var officialVertexNormalBuffer=[];
	var officialnormals;
	var hospitalVertexPositionBuffer=[];
	var hospitalVertexTextureCoordBuffer=[];
	var hospitalvertices,hospitaltextureCoords;
	var hospitalVertexNormalBuffer=[];
	var hospitalnormals;
	var roofVertexPositionBuffer=[];
	var roofVertexTextureCoordBuffer=[];
	var roofvertices,rooftextureCoords;
	var roofVertexNormalBuffer=[];
	var roofnormals;
	var shopVertexPositionBuffer=[];
	var shopVertexTextureCoordBuffer=[];
	var shopvertices,shoptextureCoords;
	var shopVertexNormalBuffer=[];
	var shopnormals;
	var boussVertexPositionBuffer;
    var boussVertexTextureCoordBuffer;
    var bouss2VertexTextureCoordBuffer;
	var boussvertices,bouss2textureCoords;
	var boussx=43,boussy=43,boussz=0;
	var cockpitVertexPositionBuffer;
	var cockpitVertexTextureCoordBuffer;
	var cockpitvertices,cockpittextureCoords;
	var treeVertexPositionBuffer=[];
    var treeVertexTextureCoordBuffer=[];
	var treevertices;
	var ntree=1800;
	var tree2VertexPositionBuffer=[];
    var tree2VertexTextureCoordBuffer=[];
	var tree2vertices;
	var ntree2=1800;
	var lineVertexPositionBuffer=[];
    var lineVertexTextureCoordBuffer=[];
	var linevertices,linetexturecoords;
	var nline=9000;
	var crossVertexPositionBuffer=[];
    var crossVertexTextureCoordBuffer=[];
	var crossvertices;
	var ncross=2100;
	var citypanelVertexPositionBuffer=[];
    var citypanelVertexTextureCoordBuffer=[];
	var citypanelvertices,citypaneltextureCoords;
	var ncitypanel=40,ncitypanelTexture=[];
	var ngrass=1500,nflower=50;
	var grassVertexPositionBuffer;
    var grassVertexTextureCoordBuffer;
	var grassvertices,grassh,grassvertices2,grassx,grassy,grassz;
	var flowerVertexPositionBuffer;
    var flowerVertexTextureCoordBuffer;
	var flowervertices,flowerh,flowerx,flowery,flowerz;

	var maxvertice=15000*6*2,ibuff=0,ibuff0=0,ibuff1=0;
	maxvertice=10000*6*2;
	var maxvertice2=5000*6*2;
	//var maxvertice4=parseInt(maxvertice/24)*6;
	var maxvertice4=2500*6*2;
	var maxvertice6=1500*6*2;
	//var nsol=80;nsol=96;//128;
	//var n=nsol,nsol2=16,n22=nsol+nsol2+nsol2;
	var nsol=80;nsol=96;//128;
	var n=nsol,nsol2=16,n22=nsol+nsol2+nsol2;
	var height,kheight,height1,height2,tinitgmap=0;
	var height00,height0;
	var maptree=[],mapgrass=[],nsea=40;
	for (var i=0; i < n; i++) {
      for(var j=0;j<n;j++){
		  var ij=j*n+i;
		  maptree[ij]=0;mapgrass[ij]=0;
	}}
function initgmaptree(){
        if(!solTexture.data){return;}
		var ndata=solTexture.datasize,r=0,g=0,b=0,h=0,ij=0;
		var rr=0,gg=0,bb=0,rrr=0,ggg=0,bbb=0;
		for (var i=0; i < n; i++) {
         for(var j=0;j<n;j++){
		  ij=j*n+i;
		  maptree[ij]=0;mapgrass[ij]=0;
		  if(height00[ij]>0){
		   var k=parseInt(4*(parseInt(Math.min(ndata-1,i*ndata/n))*ndata+parseInt(j*ndata/n)));
		   rrr=rr;ggg=gg;bbb=bb;
		   rr=r;gg=g;bb=b;
		   r=solTexture.data[k];
		   g=solTexture.data[k+1];
		   b=solTexture.data[k+2];
		   if(g>r*1.12 && g>b*1.02 && g<70 && g>10){
		     var dr=5,dg=5,db=5;
			 if(Math.abs(rr-r)>dr || Math.abs(gg-g)>dg || Math.abs(bb-b)>db){
		        maptree[ij]=1;}
			 else if(Math.abs(rrr-r)>dr || Math.abs(ggg-g)>dg || Math.abs(bbb-b)>db){
			    maptree[ij]=1;}	
		   }
		   if(g>r*1.2 && g>b*1.12 && g>20){mapgrass[ij]=1;}
		   //mapgrass[ij]=maptree[ij];
		   }
		}}
		//tinittree2=1;tinittree22=1;
}
function addgmaptreetest(){
	//var nx=nsol*(0.5+0.5*(lngpx-lngsol0)/dlngsol)-0.5;
	//var ny=nsol*(0.5+0.5*(latpy-latsol0)/dlatsol)-0.5;
	var nmaptree=0,tsequoia00=tsequoia,dxtree=5.7;
	var dx0=klon*dxtree/scale,dy0=dxtree/scale,xx=0,yy=0;
	var lngxx0=dx0*parseInt(lngx/dx0);
	var latxx0=dy0*parseInt(latx/dy0);
	var d91=dxmax*5,d20=parseInt(d91*0.5/dxtree);
	for(var ii=-d20;ii<d20;ii++){
	  var lngxx=lngxx0+dx0*ii;
      var i=parseInt(nsol*(0.5+0.5*(lngxx-lngsol0)/dlngsol)-0.5);
      for(var jj=-d20+(ii%2)*0.5;jj<d20;jj++){
		  var latxx=latxx0+dy0*jj;
	      var j=parseInt(nsol*(0.5+0.5*(latxx-latsol0)/dlatsol)-0.5);
		  if(i>=0 &&  i<n && j>=0 && j<n){
		   var ij=i*n+j;
		   if(maptree[ij]>=1){
	           yy=(latxx-latx0)*scale*2;
	           xx=((lngxx-lngx0)/klon)*scale*2;
			   var ztree=(latxx+lngxx)*1000000;
	           ztree=(ztree-100*parseInt(ztree/100))/2000;
	           ztree+=zsol0-0.01;//-0.06+zsol0;
    	       if(tinittree2==1 || Math.max(Math.abs(xx-x),Math.abs(yy-y))>50){
                  var typtree=parseInt((Math.abs(xx-yy)*10))%5;
                  if(typtree<=2){addtree22(xx,yy,ztree);}
                  else{addtree2(xx,yy,ztree);}
				  nmaptree+=1;
				  if(nmaptree>d20*d20*2.8 && tsequoia00==0){tsequoia=2;}
				  else if(nmaptree>d20*d20*0.4 && tsequoia==0){tsequoia=1;}
				  else if(nmaptree>d20*d20*0.15+25 && tsequoia==0){tsequoia=1;}
		  }}}
	}}
	if(tsequoia==0){settrottoir();if(jtrottoir<20){tsequoia=1;};}
}
function addgmaptreetest0(){
	//var nx=nsol*(0.5+0.5*(lngpx-lngsol0)/dlngsol)-0.5;
	//var ny=nsol*(0.5+0.5*(latpy-latsol0)/dlatsol)-0.5;
	var nmaptree=0,tsequoia00=tsequoia,dxtree=5.7;
	var dx0=klon*dxtree/scale,dy0=dxtree/scale,xx=0,yy=0;
	var lngxx0=dx0*parseInt(lngx/dx0);
	var latxx0=dy0*parseInt(latx/dy0);
	var d91=dxmax*5,d20=parseInt(d91*0.5/dxtree);
	for(var ii=-d20;ii<d20;ii++){
	  var lngxx=lngxx0+dx0*ii;
      var i=parseInt(nsol*(0.5+0.5*(lngxx-lngsol0)/dlngsol)-0.5);
      for(var jj=-d20+(ii%2)*0.5;jj<d20;jj++){
		  var latxx=latxx0+dy0*jj;
	      var j=parseInt(nsol*(0.5+0.5*(latxx-latsol0)/dlatsol)-0.5);
		  if(i>=0 &&  i<n && j>=0 && j<n){
		   var ij=i*n+j;
		   if(maptree[ij]>=1){
				  nmaptree+=1;
				  if(nmaptree>d20*d20*2.8 && tsequoia00==0){tsequoia=2;}
				  else if(nmaptree>d20*d20*0.4 && tsequoia==0){tsequoia=1;}
				  else if(nmaptree>d20*d20*0.15+25 && tsequoia==0){tsequoia=1;}
		  }}
	}}
}
function testmapgrass(xx,yy){
var lngxx=xx*klon/(scale)+lng0;
var latxx=yy/(scale)+lat0;
var i=parseInt(nsol*(0.5+0.5*(lngxx-lngsol0)/dlngsol)-0.5);
var j=parseInt(nsol*(0.5+0.5*(latxx-latsol0)/dlatsol)-0.5);
if(i>=0 &&  i<n && j>=0 && j<n){
		   var ij=i*n+j;
		   if(mapgrass[ij]>=1){return 1;}}
return 0;
}
var kdhzsol=1,dhzsol=1;
function initgmap(){
        if(!solTexture2.data){return;}
		var ndata=solTexture2.datasize,r=0,g=0,b=0,h=0,ij=0;
		var kh=1,hmax=12,h0=0;
		for (var i=0; i < n; i++) {h0=0;
        for(var j=0;j<n;j++){
		   var k=parseInt(4*(parseInt(Math.min(ndata-1,i*ndata/n))*ndata+parseInt(j*ndata/n)));
		   r=solTexture2.data[k];
		   g=solTexture2.data[k+1];
		   b=solTexture2.data[k+2];
		   ij=j*n+i;
		   height0[ij]=1;
		   kheight[ij]=kh;
		   //h=seaheight+Math.min(((r+g)/2-b),2.0);
		   //if(b<(r+g)*0.7 && h>0){seaheight=Math.min(seaheight,(9*seaheight+h)/10);}
		   //else{height[j*n+i]=-4;}
		   var rr=32;
		   if(b>r*1.4 && Math.abs(r-176)<rr && Math.abs(g-208)<rr && Math.abs(b-254)<rr){
		      height[ij]=-0.4;}
		   //if(b>r*1.4){height[ij]=-0.4;}//+(r*1.4-b);} //water
		   else{
		     //h=(test*800.0+800)*(g+g-b-r)/(30+r*r+g*g+b*b);
		     //if(h<0.003){h=h0;h0=h;}else{h0=h;}
			 //height[ij]=Math.max(0.003,h);
			 //if(h>hmax){hmax=h;}
			 height[ij]=0.03;//0.01;
			 //height[ij]=Math.max(0.01,Math.min(((r+g)/2-b)*0.1,2.0));
		   }
		   height00[ij]=height[ij];
		}}
		/*for (var j=0; j < n; j++) {h0=0.003;
        for(var i=0;i<n;i++){
		     ij=j*n+i;h=height[ij];
			 if(h<0.1 && h>0){height[ij]=h0;h0=h;}
			 else if(h>0){h0=h;}
			 //kheight[ij]=height[ij];
		}}*/

		var zsolmin2=9990,zsolmax2=0.1;
		var ij=0,h=0;
	if(testsrtm>=0.01){	
		updatesrtm();
        for(var ij2=0;ij2<n22*n22;ij2++){
		      if(zsolmin2>height1[ij2]){zsolmin2+=0.005*(height1[ij2]-zsolmin2);}
		      if(zsolmax2<height1[ij2]){zsolmax2+=0.005*(height1[ij2]-zsolmax2);}
	    }
		var dh=Math.max(1,(zsolmax2-zsolmin2));
		if(dh<33){dh=33/dh;}
		else if(dh>110){dh=110/dh;}
		else{dh=1;}
		dh=Math.max(0.3,Math.min(4.5,dh));kdhzsol=dhzsol/dh;dhzsol=dh;
		for(var ij2=0;ij2<n22*n22;ij2++){
		    if(height1[ij2]>0.001){height1[ij2]*=dh;}
		}
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   ij=i*n+j;
		   var ij22=(i+nsol2)*n22+j+nsol2;
		   h=height1[ij22];//height1[ij];
		   //if(height[ij]<-0.01 && h<1){zsolmin2=-0.1;}
		   if(height[ij]<-0.01){// && h<0){
		      ////zsolmin2+=0.1*(Math.min(zsolmin2,h)-zsolmin2);
		      //zsolmin2+=0.013*(h-0.2-zsolmin2);
		      if(i>1 && j>1){
		       height0[ij]-=1;
		       height0[ij-n]-=1;
		       height0[ij+n]-=1;
			   height0[ij+1]-=1;
		       height0[ij+1-n]-=1;
		       height0[ij+1+n]-=1;
		       height0[ij-1]-=1;
		       height0[ij-1-n]-=1;
		       height0[ij-1+n]-=1;
			   }
		   }
		   if(height[ij]>0 || h>1){
		      /*if(i>1 && j>1){
			    //h=(h*8+height1[ij-1]+height1[ij+1]+height1[ij-n]+height1[ij+n])/12;
			    h=(h*8+height1[ij22-1]+height1[ij22+1]+height1[ij22-n22]+height1[ij22+n22])/12;
			  }*/
		      if(h>0){height[ij]+=h*testsrtm;}}
		   }
		}	
        zsolmax2=Math.min(9990,zsolmax2);
        zsolmin2=Math.max(-0.5,zsolmin2);		

 		/*var dij=4;//12;
		for (var i=0; i < n; i+=2) {
        for(var j=0;j<n;j+=2){
		  if(height[j*n+i]<0){
		   if(height0[j*n+i]>0){ 
		    for(var s=Math.max(0,i-dij);s<Math.min(n,i+dij);s++){
		     var ks=Math.abs(s-i)+1;
			 for(var t=Math.max(0,j-dij);t<Math.min(n,j+dij);t++){
			   var kt=Math.max(ks,Math.abs(t-j));
			   kheight[t*n+s]=Math.min(kh*(kt/dij)^1.3,kheight[t*n+s]);
			   height0[t*n+s]=1;
			 }
			} 
		   }}
		}}*/
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   ij=i*n+j;
		   h=height[ij];
		   var zwater=-0.025;
		   var h0=height0[ij];
		   var h1=height1[(i+nsol2)*n22+j+nsol2];
		   //if(height0[i*n+j]<0){height[i*n+j]=Math.min(zsolmin2,height1[i*n+j]-0.2);}
		   if(h0<0 && h>zwater && h1<1.2){height0[ij]=0;
		      height[ij]=Math.max(0.01,testsrtm*h1);}
		   else if(h0<0 && h0>=-2 && h>-0.025){height0[ij]=0;
		      height[ij]=Math.max(0.01,testsrtm*h1);}
		   else if(h0<-2 && h>-0.04){
		      //height[i*n+j]=Math.max(-0.4,parseInt(testsrtm*height1[(i+nsol2)*n22+j+nsol2]/3)*3-1);
		      //height[i*n+j]=Math.max(zsolmin2,parseInt(testsrtm*height1[(i+nsol2)*n22+j+nsol2]/5)*5-0.1);
			  if(h1>1){height[ij]=Math.max(-0.045,testsrtm*h1);}
			  else{height[ij]=Math.max(-0.4,Math.min(0.1,testsrtm*h1));}
			  //else{height[ij]=Math.max(-0.045,Math.min(0.001,testsrtm*h1));}
			  }
        }}//}

        //var kdh=1;//(18*hmax-18*12+12*12*2)/(hmax*hmax+12*12);
		/*for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   ij=j*n+i;
		   //if(height[ij]>0){height[ij]*=kheight[ij]*kdh;}
		   if(height[ij]<-0.1){height[ij]=-0.4;
		                       var ij22=(i+nsol2)*n22+j+nsol2;
		                       height1[ij22]=Math.min(0.001,height1[ij22]);}
		}}*/
		flatterrainheight(eiffeltowerx,eiffeltowery);
		flatterrainheight(libertystatuex,libertystatuey);
		flatterrainheight(christriox,christrioy);
		flatterrainheight(domerockx,domerocky);
		flatterrainheight(gizahx,gizahy);
		flatterrainheight(capitolex,capitoley);
		flatterrainheight(tajmahalx,tajmahaly);
		flatterrainheight(buddahx,buddahy);
	}/*else{
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		    height1[(i+nsol2)*n22+j+nsol2]=0;
			}}
	}*/

       /*		
		var nitem=0;
		var px=1,py=1,pz=0,pzz=0,pz1=0,pzz1=0;
		index=0;
		var dx=2/nsol,dy=dx;
		for(var i=0;i<nsol-1;i++){
		 var ppx=-px+dx*i;
		 pz=height[i*n+0];
		 pz1=height[i*n+n+0];
		 for(var j=0;j<nsol;j++){
		 nitem+=1;
		   /*append(solvertices,[
             -px,-py,pz, px,-py,pz, -px,py,pz,
              px,-py,pz, px,py,pz,  -px,py,pz  			 
            ]);
           var ppy=-py+dx*j;
		   var ij=i*n+j;
		   pzz=pz;pzz1=pz1;
           pz=height[ij];pz1=height[ij+n];
		   append(solvertices,[
             ppx,ppy,pzz, ppx+dx,ppy,pzz1, ppx,ppy+dy,pz,
             ppx+dx,ppy,pzz1, ppx+dx,ppy+dy,pz1, ppx,ppy+dy,pz  			 
            ]);
		}}*/
		//tupdatebuffersol=1;
		//tdraw=1;
}
function updatebuffersolheight(){
		var nitem=0,n=nsol;
		var px=1,py=1,pz=0,pzz=0,pz1=0,pzz1=0;
		index=0;
		var dx=2/nsol,dy=dx;
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
		for(var i=0;i<nsol-1;i++){
		 var ppx=-px+dx*i;
		 pz=height2[i*n+0];
		 pz1=height2[i*n+n+0];
		 for(var j=0;j<nsol;j++){
		 nitem+=1;
           var ppy=-py+dx*j;
		   var ij=i*n+j;
		   pzz=pz;pzz1=pz1;
           pz=height2[ij];pz1=height2[ij+n];
		   append(solvertices,[
             ppx,ppy,pzz, ppx+dx,ppy,pzz1, ppx,ppy+dy,pz,
             ppx+dx,ppy,pzz1, ppx+dx,ppy+dy,pz1, ppx,ppy+dy,pz  			 
            ]);
		}}
		var dx0=dx,dy0=dy,dkn18=kn18/n;
		var dx1=dkn18+dx,dy1=dx1;
		dx=dx1;dy=dy1;
		px=1+nsol2*dx0;py=1+nsol2*dy0;
		for(var i=1;i<nsol2+1;i++){
		 var ppx=-px+dx0*i;
 //if(i<nsol2){lngx-=(lng1-lngsol0)*(nsol2-i)*kn18/n;}
 //if(i>n22-nsol2){lngx+=(lng1-lngsol0)*(i-n22+nsol2)*kn18/n;}
 if(i<nsol2){ppx-=(nsol2-i)*dkn18;dx=dx1;}else{dx=dx0;}
 		 pz=height1[i*n22+nsol2]*testsrtm;
		 pz1=height1[i*n22+n22+nsol2]*testsrtm;
		 for(var j=nsol2;j<n22-nsol2;j++){
		 nitem+=1;
           var ppy=-py+dx0*j;
 //if(j<nsol2){ppy-=(nsol2-j)*dkn18;}
 //if(j>n22-nsol2){ppy+=(j-n22+nsol2)*dkn18;}
		   var ij=i*n22+j;
		   pzz=pz;pzz1=pz1;
           pz=height1[ij]*testsrtm;pz1=height1[ij+n22]*testsrtm;
		   append(solvertices,[
             ppx,ppy,pzz, ppx+dx,ppy,pzz1, ppx,ppy+dy,pz,
             ppx+dx,ppy,pzz1, ppx+dx,ppy+dy,pz1, ppx,ppy+dy,pz  			 
            ]);
		}}
		for(var i=n22-nsol2-1;i<n22-1;i++){
		 var ppx=-px+dx0*i;
 //if(i<nsol2){ppx-=(nsol2-i)*dkn18;}
 if(i>=n22-nsol2){ppx+=(i-n22+nsol2)*dkn18;dx=dx1;}else{dx=dx0;}
		 pz=height1[i*n22+nsol2]*testsrtm;
		 pz1=height1[i*n22+n22+nsol2]*testsrtm;
		 for(var j=nsol2;j<n22-nsol2;j++){
		 nitem+=1;
           var ppy=-py+dx0*j;
 //if(j<nsol2){ppy-=(nsol2-j)*dkn18;}
 //if(j>n22-nsol2){ppy+=(j-n22+nsol2)*dkn18;}
		   var ij=i*n22+j;
		   pzz=pz;pzz1=pz1;
           pz=height1[ij]*testsrtm;pz1=height1[ij+n22]*testsrtm;
		   append(solvertices,[
             ppx,ppy,pzz, ppx+dx,ppy,pzz1, ppx,ppy+dy,pz,
             ppx+dx,ppy,pzz1, ppx+dx,ppy+dy,pz1, ppx,ppy+dy,pz  			 
            ]);
		}}
		for(var i=1;i<n22-2;i++){
		 var ppx=-px+dx0*i;
		 dx=dx0;
 if(i<nsol2){ppx-=(nsol2-i)*dkn18;dx=dx1;}
 if(i>=n22-nsol2){ppx+=(i-n22+nsol2)*dkn18;dx=dx1;}
		 pz=height1[i*n22+0]*testsrtm;
		 pz1=height1[i*n22+n22+0]*testsrtm;
		 for(var j=1;j<nsol2+1;j++){
		 nitem+=1;
           var ppy=-py+dx0*j;
 if(j<nsol2){ppy-=(nsol2-j)*dkn18;}
 //if(j>n22-nsol2){ppy+=(j-n22+nsol2)*dkn18;}
		   var ij=i*n22+j;
		   pzz=pz;pzz1=pz1;
           pz=height1[ij]*testsrtm;pz1=height1[ij+n22]*testsrtm;
		   append(solvertices,[
             ppx,ppy,pzz, ppx+dx,ppy,pzz1, ppx,ppy+dy,pz,
             ppx+dx,ppy,pzz1, ppx+dx,ppy+dy,pz1, ppx,ppy+dy,pz  			 
            ]);
		}}
		for(var i=1;i<n22-2;i++){
		 var ppx=-px+dx0*i;
		 dx=dx0;
 if(i<nsol2){ppx-=(nsol2-i)*dkn18;dx=dx1;}
 if(i>=n22-nsol2){ppx+=(i-n22+nsol2)*dkn18;dx=dx1;}
		 pz=height1[i*n22+n22-nsol2-2]*testsrtm;
		 pz1=height1[i*n22+n22+n22-nsol2-2]*testsrtm;
		 for(var j=n22-nsol2-1;j<n22-2;j++){
		 nitem+=1;
           var ppy=-py+dx0*j;
 //if(j<nsol2){ppy-=(nsol2-j)*dkn18;}
 if(j>=n22-nsol2){ppy+=(j-n22+nsol2)*dkn18;}
		   var ij=i*n22+j;
		   pzz=pz;pzz1=pz1;
           //pz=height1[ij]*testsrtm;pz1=height1[ij+n22]*testsrtm;
		   append(solvertices,[
             ppx,ppy,pzz, ppx+dx,ppy,pzz1, ppx,ppy+dy,pz,
             ppx+dx,ppy,pzz1, ppx+dx,ppy+dy,pz1, ppx,ppy+dy,pz  			 
            ]);
		}}
        gl.bufferData(gl.ARRAY_BUFFER, (solvertices), gl.STATIC_DRAW);
        solVertexPositionBuffer.itemSize = 3;
        solVertexPositionBuffer.numItems = 6*nitem;
        
		//solVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexTextureCoordBuffer);
        //soltextureCoords = new Float32Array(2*6*(nsol+1)*(nsol+1));
		index=0;
		var s1=1;
		nitem=0;
		for(var i=0;i<nsol-1;i++){
		 for(var j=0;j<nsol;j++){
		 nitem+=1;
		 var ds=s1/nsol;
		 var s0=ds*i;
         var t0=ds*j;
         if(height0[i*n+j]<0){t0-=10;}		 
	     append(soltextureCoords,[
             s0,t0, s0+ds,t0, s0,t0+ds,
             s0+ds,t0, s0+ds,t0+ds, s0,t0+ds			 
			 ]);
        }}
        s1*=2000;		
		for(var i=1;i<nsol2+1;i++){
		 for(var j=nsol2;j<n22-nsol2;j++){
		 nitem+=1;
		 var ds=s1/n22;
		 var s0=ds*i;
         var t0=ds*j;
         //if(height1[i*n22+j]<0){t0-=10;}		 
	     append(soltextureCoords,[
             s0,t0, s0+ds,t0, s0,t0+ds,
             s0+ds,t0, s0+ds,t0+ds, s0,t0+ds			 
			 ]);
        }} 			 
		for(var i=n22-nsol2-1;i<n22-1;i++){
		 for(var j=nsol2;j<n22-nsol2;j++){
		 nitem+=1;
		 var ds=s1/n22;
		 var s0=ds*i;
         var t0=ds*j;
         //if(height1[i*n22+j]<0){t0-=10;}		 
	     append(soltextureCoords,[
             s0,t0, s0+ds,t0, s0,t0+ds,
             s0+ds,t0, s0+ds,t0+ds, s0,t0+ds			 
			 ]);
        }} 			 
		for(var i=1;i<n22-2;i++){
		 for(var j=1;j<nsol2+2;j++){
		 nitem+=1;
		 var ds=s1/n22;
		 var s0=ds*i;
         var t0=ds*j;
         //if(height1[i*n22+j]<0){t0-=10;}		 
	     append(soltextureCoords,[
             s0,t0, s0+ds,t0, s0,t0+ds,
             s0+ds,t0, s0+ds,t0+ds, s0,t0+ds			 
			 ]);
        }} 			 
		for(var i=1;i<n22-2;i++){
		 for(var j=n22-nsol2;j<n22-2;j++){
		 nitem+=1;
		 var ds=s1/n22;
		 var s0=ds*i;
         var t0=ds*j;
         //if(height1[i*n22+j]<0){t0-=10;}		 
	     append(soltextureCoords,[
             s0,t0, s0+ds,t0, s0,t0+ds,
             s0+ds,t0, s0+ds,t0+ds, s0,t0+ds			 
			 ]);
        }} 			 
        gl.bufferData(gl.ARRAY_BUFFER, (soltextureCoords), gl.STATIC_DRAW);
        solVertexTextureCoordBuffer.itemSize = 2;
        solVertexTextureCoordBuffer.numItems = 6*nitem;

		//updatebuffersol();
		//if(tupdatesoltexture==1){
		//   tupdatebuffersol=1;//}
}
var tupdatebuffersol=0;
function updatebuffersol(){
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, (solvertices), gl.STATIC_DRAW);

        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexTextureCoordBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, (soltextureCoords), gl.STATIC_DRAW);
}	
	
	function initBuffers() {
        roadVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexPositionBuffer[ibuff]);
        if(ibuff==0){roadvertices = new Float32Array(3*maxvertice);
		}
		var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(roadvertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (roadvertices), gl.STATIC_DRAW);
        roadVertexPositionBuffer[ibuff].itemSize = 3;
        roadVertexPositionBuffer[ibuff].numItems = maxvertice;
	
        roadVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){roadtextureCoords = new Float32Array(2*maxvertice);
		}
		index=0;
		for (var i=0;i<maxvertice;i++) {
		   append(roadtextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (roadtextureCoords), gl.STATIC_DRAW);
        roadVertexTextureCoordBuffer[ibuff].itemSize = 2;
        roadVertexTextureCoordBuffer[ibuff].numItems = maxvertice;//24;

        roadVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexNormalBuffer[ibuff]);
        if(ibuff==0){roadnormals = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(roadnormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (roadnormals), gl.STATIC_DRAW);
        roadVertexNormalBuffer[ibuff].itemSize = 3;
        roadVertexNormalBuffer[ibuff].numItems = maxvertice;
         
		
        roadbandVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roadbandVertexPositionBuffer[ibuff]);
        if(ibuff==0){roadbandvertices = new Float32Array(3*maxvertice4);
		}
		var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice4;i++){
		   append(roadbandvertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (roadbandvertices), gl.STATIC_DRAW);
        roadbandVertexPositionBuffer[ibuff].itemSize = 3;
        roadbandVertexPositionBuffer[ibuff].numItems = maxvertice4;
	
        roadbandVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roadbandVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){roadbandtextureCoords = new Float32Array(2*maxvertice4);
		}
		index=0;
		for (var i=0;i<maxvertice4;i++) {
		   append(roadbandtextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (roadbandtextureCoords), gl.STATIC_DRAW);
        roadbandVertexTextureCoordBuffer[ibuff].itemSize = 2;
        roadbandVertexTextureCoordBuffer[ibuff].numItems = maxvertice4;//24;
        
		roadbandVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roadbandVertexNormalBuffer[ibuff]);
        if(ibuff==0){roadbandnormals = new Float32Array(3*maxvertice4);
		}
		px=0,py=0,pz=1;
		index=0;
		for(var i=0;i<maxvertice4;i++){
		   append(roadbandnormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (roadbandnormals), gl.STATIC_DRAW);
        roadbandVertexNormalBuffer[ibuff].itemSize = 3;
        roadbandVertexNormalBuffer[ibuff].numItems = maxvertice4;
         

        towerVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer[ibuff]);
        if(ibuff==0){towervertices = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(towervertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (towervertices), gl.STATIC_DRAW);
        towerVertexPositionBuffer[ibuff].itemSize = 3;
        towerVertexPositionBuffer[ibuff].numItems = maxvertice;
	
        towerVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){towertextureCoords = new Float32Array(2*maxvertice);
		}
		index=0;
		for (var i=0;i<maxvertice;i++) {
		   append(towertextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (towertextureCoords), gl.STATIC_DRAW);
        towerVertexTextureCoordBuffer[ibuff].itemSize = 2;
        towerVertexTextureCoordBuffer[ibuff].numItems = maxvertice;//24;

        towerVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexNormalBuffer[ibuff]);
        if(ibuff==0){towernormals = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(towernormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (towernormals), gl.STATIC_DRAW);
        towerVertexNormalBuffer[ibuff].itemSize = 3;
        towerVertexNormalBuffer[ibuff].numItems = maxvertice;

        tower0VertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, tower0VertexNormalBuffer[ibuff]);
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(towernormals,[
             0,0,1
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (towernormals), gl.STATIC_DRAW);
        tower0VertexNormalBuffer[ibuff].itemSize = 3;
        tower0VertexNormalBuffer[ibuff].numItems = maxvertice;

        churchVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexPositionBuffer[ibuff]);
        if(ibuff==0){churchvertices = new Float32Array(3*maxvertice6);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice6;i++){
		   append(churchvertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (churchvertices), gl.STATIC_DRAW);
        churchVertexPositionBuffer[ibuff].itemSize = 3;
        churchVertexPositionBuffer[ibuff].numItems = maxvertice6;
	
        churchVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){churchtextureCoords = new Float32Array(2*maxvertice6);
		}
		index=0;
		for (var i=0;i<maxvertice6;i++) {
		   append(churchtextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (churchtextureCoords), gl.STATIC_DRAW);
        churchVertexTextureCoordBuffer[ibuff].itemSize = 2;
        churchVertexTextureCoordBuffer[ibuff].numItems = maxvertice6;//24;

        churchVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexNormalBuffer[ibuff]);
        if(ibuff==0){churchnormals = new Float32Array(3*maxvertice6);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice6;i++){
		   append(churchnormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (churchnormals), gl.STATIC_DRAW);
        churchVertexNormalBuffer[ibuff].itemSize = 3;
        churchVertexNormalBuffer[ibuff].numItems = maxvertice6;

        houseVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexPositionBuffer[ibuff]);
        if(ibuff==0){housevertices = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(housevertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (housevertices), gl.STATIC_DRAW);
        houseVertexPositionBuffer[ibuff].itemSize = 3;
        houseVertexPositionBuffer[ibuff].numItems = maxvertice;
	
        houseVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){housetextureCoords = new Float32Array(2*maxvertice);
		}
		index=0;
		for (var i=0;i<maxvertice;i++) {
		   append(housetextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (housetextureCoords), gl.STATIC_DRAW);
        houseVertexTextureCoordBuffer[ibuff].itemSize = 2;
        houseVertexTextureCoordBuffer[ibuff].numItems = maxvertice;//24;

        houseVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexNormalBuffer[ibuff]);
        if(ibuff==0){housenormals = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(housenormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (housenormals), gl.STATIC_DRAW);
        houseVertexNormalBuffer[ibuff].itemSize = 3;
        houseVertexNormalBuffer[ibuff].numItems = maxvertice;

        officialVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexPositionBuffer[ibuff]);
        if(ibuff==0){officialvertices = new Float32Array(3*maxvertice6);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice6;i++){
		   append(officialvertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (officialvertices), gl.STATIC_DRAW);
        officialVertexPositionBuffer[ibuff].itemSize = 3;
        officialVertexPositionBuffer[ibuff].numItems = maxvertice6;
	
        officialVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){officialtextureCoords = new Float32Array(2*maxvertice6);
		}
		index=0;
		for (var i=0;i<maxvertice6;i++) {
		   append(officialtextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (officialtextureCoords), gl.STATIC_DRAW);
        officialVertexTextureCoordBuffer[ibuff].itemSize = 2;
        officialVertexTextureCoordBuffer[ibuff].numItems = maxvertice6;//24;

        officialVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexNormalBuffer[ibuff]);
        if(ibuff==0){officialnormals = new Float32Array(3*maxvertice6);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice6;i++){
		   append(officialnormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (officialnormals), gl.STATIC_DRAW);
        officialVertexNormalBuffer[ibuff].itemSize = 3;
        officialVertexNormalBuffer[ibuff].numItems = maxvertice6;

        hospitalVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexPositionBuffer[ibuff]);
        if(ibuff==0){hospitalvertices = new Float32Array(3*maxvertice6);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice6;i++){
		   append(hospitalvertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (hospitalvertices), gl.STATIC_DRAW);
        hospitalVertexPositionBuffer[ibuff].itemSize = 3;
        hospitalVertexPositionBuffer[ibuff].numItems = maxvertice6;
	
        hospitalVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){hospitaltextureCoords = new Float32Array(2*maxvertice6);
		}
		index=0;
		for (var i=0;i<maxvertice6;i++) {
		   append(hospitaltextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (hospitaltextureCoords), gl.STATIC_DRAW);
        hospitalVertexTextureCoordBuffer[ibuff].itemSize = 2;
        hospitalVertexTextureCoordBuffer[ibuff].numItems = maxvertice6;//24;

        hospitalVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexNormalBuffer[ibuff]);
        if(ibuff==0){hospitalnormals = new Float32Array(3*maxvertice6);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice6;i++){
		   append(hospitalnormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (hospitalnormals), gl.STATIC_DRAW);
        hospitalVertexNormalBuffer[ibuff].itemSize = 3;
        hospitalVertexNormalBuffer[ibuff].numItems = maxvertice6;

        shopVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexPositionBuffer[ibuff]);
        if(ibuff==0){shopvertices = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(shopvertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (shopvertices), gl.STATIC_DRAW);
        shopVertexPositionBuffer[ibuff].itemSize = 3;
        shopVertexPositionBuffer[ibuff].numItems = maxvertice;
	
        shopVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){shoptextureCoords = new Float32Array(2*maxvertice);
		}
		index=0;
		for (var i=0;i<maxvertice;i++) {
		   append(shoptextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (shoptextureCoords), gl.STATIC_DRAW);
        shopVertexTextureCoordBuffer[ibuff].itemSize = 2;
        shopVertexTextureCoordBuffer[ibuff].numItems = maxvertice;//24;

        shopVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexNormalBuffer[ibuff]);
        if(ibuff==0){shopnormals = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(shopnormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (shopnormals), gl.STATIC_DRAW);
        shopVertexNormalBuffer[ibuff].itemSize = 3;
        shopVertexNormalBuffer[ibuff].numItems = maxvertice;

        if(ibuff==0){
		solVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        solvertices = new Float32Array(3*6*(n22+1)*(n22+1));
		var n=nsol;
		height=new Array((n+1)*(n+1));
		kheight=new Array((n+1)*(n+1));
		height1=new Array((n22+1)*(n22+1));
		height2=new Array((n+1)*(n+1));
		height0=new Array((n+1)*(n+1));
		height00=new Array((n+1)*(n+1));
		for(var i=0;i<=nsol;i++){
		 for(var j=0;j<=nsol;j++){
		   var ij=i*n+j;
		   height[ij]=0;
		   kheight[ij]=0;
		   height1[ij]=0;
		   height2[ij]=0;
		   height0[ij]=0;
		   height00[ij]=0;
		}}
		for(var i=0;i<=n22;i++){
		 for(var j=0;j<=n22;j++){
		   height1[i*n22+j]=0;
		}}
		var nitem=0;
		px=1;py=1;pz=0;
		index=0;
		var dx=2*px/nsol,dy=dx;
		for(var i=0;i<n22;i++){
		 var ppx=-px+dx*i;
		 for(var j=0;j<n22;j++){
		 nitem+=1;
		   /*append(solvertices,[
             -px,-py,pz, px,-py,pz, -px,py,pz,
              px,-py,pz, px,py,pz,  -px,py,pz  			 
            ]);*/
           var ppy=-py+dx*j;
           pz=-0.004;
		   append(solvertices,[
             ppx,ppy,pz, ppx+dx,ppy,pz, ppx,ppy+dy,pz,
             ppx+dx,ppy,pz, ppx+dx,ppy+dy,pz, ppx,ppy+dx,pz  			 
            ]);
		}}
        gl.bufferData(gl.ARRAY_BUFFER, (solvertices), gl.STATIC_DRAW);
        solVertexPositionBuffer.itemSize = 3;
        solVertexPositionBuffer.numItems = 6*nitem;
	
        solVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexTextureCoordBuffer);
        soltextureCoords = new Float32Array(2*6*(n22+1)*(n22+1));
		index=0;
		var s1=1;
		nitem=0;
		for(var i=0;i<n22;i++){
		 for(var j=0;j<n22;j++){
		 nitem+=1;
	     /*append(soltextureCoords,[
             0,0, s1,0, 0,s1,
             s1,0, s1,s1, 0,s1			 
			 ]);*/
		 var ds=s1/nsol;
		 var s0=ds*i;
         var t0=ds*j;		   
	     append(soltextureCoords,[
             s0,t0, s0+ds,t0, s0,t0+ds,
             s0+ds,t0, s0+ds,t0+ds, s0,t0+ds			 
			 ]);
        }} 			 
        gl.bufferData(gl.ARRAY_BUFFER, (soltextureCoords), gl.STATIC_DRAW);
        solVertexTextureCoordBuffer.itemSize = 2;
        solVertexTextureCoordBuffer.numItems = 6*nitem;

        boussVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
        boussvertices = new Float32Array(3*6);
		var xc=0,yc=0,zc=0;
		index=0;
		for (var i=0; i < 1; i++) {
		   xc=boussx;
		   yc=boussy;
		   zc=boussz;
		   append(boussvertices,[
             -xc,-yc,zc,  -xc,yc,zc,  xc,-yc,zc,
             -xc,yc,zc,  xc,yc,zc,  xc,-yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (boussvertices), gl.STATIC_DRAW);
        boussVertexPositionBuffer.itemSize = 3;
        boussVertexPositionBuffer.numItems = 6;

        boussVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
        var bousstextureCoords = new Array(2*6);
		//var sc=5.5,sc2=11;
		index=0;
		for (var i=0; i < 1; i++) {
		   append(bousstextureCoords,[
             0,0, 0,1, 1,0,
			 0,1, 1,1, 1,0
			 //-sc,-sc2,  -sc,sc2,   sc,-sc2,
			 //-sc,sc2,   sc,sc2,    sc,-sc2
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(bousstextureCoords), gl.STATIC_DRAW);
        boussVertexTextureCoordBuffer.itemSize = 2;
        boussVertexTextureCoordBuffer.numItems = 6;

        bouss2VertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, bouss2VertexTextureCoordBuffer);
        bouss2textureCoords = new Float32Array(2*6);
		index=0;
		for (var i=0; i < 1; i++) {
		   append(bouss2textureCoords,[
             0,0, 0,1, 1,0,
			 0,1, 1,1, 1,0
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (bouss2textureCoords), gl.STATIC_DRAW);
        bouss2VertexTextureCoordBuffer.itemSize = 2;
        bouss2VertexTextureCoordBuffer.numItems = 6;

        cockpitVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, cockpitVertexPositionBuffer);
        cockpitvertices = new Float32Array(3*6*4);
	    xc=boussx;
	    yc=boussy;
	    zc=boussz;
		var dx=0.2*xc,dx0=0.35*xc,dy=0.6*yc,dy0=1.05*yc;
		index=0;
		for (var i=0; i < 1; i++) {
		   append(cockpitvertices,[
             -xc,-yc,zc,  -xc,yc,zc,  -xc+dx0,-yc,zc,
             -xc,yc,zc,  -xc+dx0,yc,zc,  -xc+dx0,-yc,zc,	
			 
             xc-dx,-yc,zc, xc-dx,yc,zc,  xc,-yc,zc,
             xc-dx,yc,zc,  xc,yc,zc,  xc,-yc,zc,
			 
             -xc+dx0,-yc,zc,  -xc+dx0,-yc+dy0,zc,  xc-dx,-yc,zc,
             -xc+dx0,-yc+dy0,zc,  xc-dx,-yc+dy0,zc,  xc-dx,-yc,zc,	
			 
             -xc+dx0,yc-dy,zc,  -xc+dx0,yc,zc,  xc-dx,yc-dy,zc,
             -xc+dx0,yc,zc,  xc-dx,yc,zc,  xc-dx,yc-dy,zc	
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (cockpitvertices), gl.STATIC_DRAW);
        cockpitVertexPositionBuffer.itemSize = 3;
        cockpitVertexPositionBuffer.numItems = 6*4;

        cockpitVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, cockpitVertexTextureCoordBuffer);
        cockpittextureCoords = new Float32Array(2*6*4);
		dx/=xc;dx0/=xc;dy/=yc;dy0/=yc;
		dx/=2;dx0/=2;dy/=2;dy0/=2;
		index=0;
		for (var i=0; i < 1; i++) {
		   append(cockpittextureCoords,[
             0,0, 0,1, dx0,0,
			 0,1, dx0,1, dx0,0,
			 
             1-dx,0, 1-dx,1, 1,0,
			 1-dx,1, 1,1, 1,0,
			 
             dx0,0, dx0,dy0, 1-dx,0,
			 dx0,dy0, 1-dx,dy0, 1-dx,0,
			 
             dx0,1-dy, dx0,1, 1-dx,1-dy,
			 dx0,1, 1-dx,1, 1-dx,1-dy
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER,  (cockpittextureCoords), gl.STATIC_DRAW);
        cockpitVertexTextureCoordBuffer.itemSize = 2;
        cockpitVertexTextureCoordBuffer.numItems = 6*4;
		
        }
		
        roofVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roofVertexPositionBuffer[ibuff]);
        if(ibuff==0){roofvertices = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(roofvertices,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (roofvertices), gl.STATIC_DRAW);
        roofVertexPositionBuffer[ibuff].itemSize = 3;
        roofVertexPositionBuffer[ibuff].numItems = maxvertice;
	
        roofVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roofVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){rooftextureCoords = new Float32Array(2*maxvertice);
		}
		index=0;
		for (var i=0;i<maxvertice;i++) {
		   append(rooftextureCoords,[
             0,0        
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (rooftextureCoords), gl.STATIC_DRAW);
        roofVertexTextureCoordBuffer[ibuff].itemSize = 2;
        roofVertexTextureCoordBuffer[ibuff].numItems = maxvertice;//24;

        roofVertexNormalBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, roofVertexNormalBuffer[ibuff]);
        if(ibuff==0){roofnormals = new Float32Array(3*maxvertice);
		}
		//var px=0,py=0,pz=0;
		index=0;
		for(var i=0;i<maxvertice;i++){
		   append(roofnormals,[
             px,py,pz
            ]);
		   
		}		
        gl.bufferData(gl.ARRAY_BUFFER, (roofnormals), gl.STATIC_DRAW);
        roofVertexNormalBuffer[ibuff].itemSize = 3;
        roofVertexNormalBuffer[ibuff].numItems = maxvertice;

        treeVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer[ibuff]);
        if(ibuff==0){treevertices = new Float32Array(3*3*ntree);
		}
		var xc=0,yc=0,zc=0;
		index=0;
		for (var i=0; i < ntree; i++) {
		   zc=1;
		   var h=1;
		   s=0;//Math.random()*2*90+x;
		   t=0;//Math.random()*2*90+y;
		   zc=0;//getterrainheight(s,t);
		   append(treevertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
        treeVertexPositionBuffer[ibuff].itemSize = 3;
        treeVertexPositionBuffer[ibuff].numItems = 3*ntree;

        treeVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexTextureCoordBuffer[ibuff]);
        var treetextureCoords = new Array(2*3*ntree);
		index=0;
		for (var i=0; i < ntree; i++) {
		   append(treetextureCoords,[
             0,0,  0.5,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(treetextureCoords), gl.STATIC_DRAW);
        treeVertexTextureCoordBuffer[ibuff].itemSize = 2;
        treeVertexTextureCoordBuffer[ibuff].numItems = 3*ntree;

        tree2VertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, tree2VertexPositionBuffer[ibuff]);
        if(ibuff==0){tree2vertices = new Float32Array(3*3*ntree2);
		}
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntree2; i++) {
		   zc=1;
		   var h=1;
		   s=0;//Math.random()*2*90+x;
		   t=0;//Math.random()*2*90+y;
		   zc=0;//getterrainheight(s,t);
		   append(tree2vertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (tree2vertices), gl.STATIC_DRAW);
        tree2VertexPositionBuffer[ibuff].itemSize = 3;
        tree2VertexPositionBuffer[ibuff].numItems = 3*ntree2;

        tree2VertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, tree2VertexTextureCoordBuffer[ibuff]);
        var tree2textureCoords = new Array(2*3*ntree2);
		index=0;
		for (var i=0; i < ntree2; i++) {
		   append(tree2textureCoords,[
             0,0,  0.5,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(tree2textureCoords), gl.STATIC_DRAW);
        tree2VertexTextureCoordBuffer[ibuff].itemSize = 2;
        tree2VertexTextureCoordBuffer[ibuff].numItems = 3*ntree2;

        lineVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, lineVertexPositionBuffer[ibuff]);
        if(ibuff==0){linevertices = new Float32Array(4*6*nline);
		}
		index=0;
		for (var i=0; i < nline; i++){
		   var h=1,r=0.1;
		   s=0;//Math.random()*2*90+x;
		   t=0;//Math.random()*2*90+y;
		   zc=0;//getterrainheight(s,t);
		   append(linevertices,[
             s,t,zc,r,  s,t,zc+h,r, s,t,zc+h,r,	 
             s,t,zc,r,  s,t,zc+h,r, s,t,zc,r	 
					 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (linevertices), gl.STATIC_DRAW);
        lineVertexPositionBuffer[ibuff].itemSize = 4;
        lineVertexPositionBuffer[ibuff].numItems = 6*nline;

        lineVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, lineVertexTextureCoordBuffer[ibuff]);
        if(ibuff==0){linetexturecoords = new Float32Array(2*6*nline);}
		index=0;
		for (var i=0; i < nline; i++) {
		   append(linetexturecoords,[
             0,0,  0,1,  1,1,
			 0,0,  1,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (linetexturecoords), gl.STATIC_DRAW);
        lineVertexTextureCoordBuffer[ibuff].itemSize = 2;
        lineVertexTextureCoordBuffer[ibuff].numItems = 6*nline;

        crossVertexPositionBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, crossVertexPositionBuffer[ibuff]);
        if(ibuff==0){crossvertices = new Float32Array(4*6*ncross);
		}
		index=0;
		for (var i=0; i < ncross; i++){
		   var h=1,r=0.1;
		   s=0;//Math.random()*2*90+x;
		   t=0;//Math.random()*2*90+y;
		   zc=0;//getterrainheight(s,t);
		   append(crossvertices,[
             s,t,zc,r,  s,t,zc+h,r, s,t,zc+h,r,	 
             s,t,zc,r,  s,t,zc+h,r, s,t,zc,r	 
					 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (crossvertices), gl.STATIC_DRAW);
        crossVertexPositionBuffer[ibuff].itemSize = 4;
        crossVertexPositionBuffer[ibuff].numItems = 6*ncross;

        crossVertexTextureCoordBuffer[ibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, crossVertexTextureCoordBuffer[ibuff]);
        var crosstextureCoords = new Array(2*6*ncross);
		index=0;
		var s1=0.25;
		for (var i=0; i < ncross/3; i++) {
		   append(crosstextureCoords,[
             0,0,  0,1,  s1,1,
			 0,0,  s1,1,  s1,0,

             0,10,  0,11,  s1,11,
			 0,10,  s1,11,  s1,10,

             0,20,  0,21,  s1,21,
			 0,20,  s1,21,  s1,20
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(crosstextureCoords), gl.STATIC_DRAW);
        crossVertexTextureCoordBuffer[ibuff].itemSize = 2;
        crossVertexTextureCoordBuffer[ibuff].numItems = 6*ncross;

		if(ibuff==0){
		for (var i=0; i < ncitypanel; i++){
		var nibuff=i;
        citypanelVertexPositionBuffer[nibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, citypanelVertexPositionBuffer[nibuff]);
        if(nibuff==0){citypanelvertices = new Float32Array(4*8*3);
		}
		index=0;
		   var h=1,r=0.1;
		   s=0;//Math.random()*2*90+x;
		   t=0;//Math.random()*2*90+y;
		   zc=0;//getterrainheight(s,t);
		   append(citypanelvertices,[
             s,t,zc,r,  s,t,zc+h,r, s,t,zc+h,r,	 
             s,t,zc,r,  s,t,zc+h,r, s,t,zc,r,
             s,t,zc,r,  s,t,zc+h,r,			 
            s,t,zc,r,  s,t,zc+h,r, s,t,zc+h,r,	 
             s,t,zc,r,  s,t,zc+h,r, s,t,zc,r,
             s,t,zc,r,  s,t,zc+h,r,			 
            s,t,zc,r,  s,t,zc+h,r, s,t,zc+h,r,	 
             s,t,zc,r,  s,t,zc+h,r, s,t,zc,r,
             s,t,zc,r,  s,t,zc+h,r			 
					 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (citypanelvertices), gl.STATIC_DRAW);
        citypanelVertexPositionBuffer[nibuff].itemSize = 4;
        citypanelVertexPositionBuffer[nibuff].numItems = 0;//8*ncitypanel;

        citypanelVertexTextureCoordBuffer[nibuff] = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, citypanelVertexTextureCoordBuffer[nibuff]);
        if(nibuff==0){citypaneltextureCoords = new Float32Array(2*8*3);}
		index=0;var x1=0.2,y10=20.0,y11=21.0,y20=20.1,y21=20.9;
		//for (var i=0; i < ncitypanel/3; i++) {
		   append(citypaneltextureCoords,[
             0,0,  0,1,  1,1,
			 0,0,  1,1,  1,0,

             0,y10,  0,y11,  x1,y10,
			 0,y11,  x1,y11,  x1,y10,

             0,y20,  0,y21,  1,y20,
			 0,y21,  1,y21,  1,y20,
			 
             x1,y10,  x1,y11,  0,y10,
			 x1,y11,  0,y11,   0,y10
			 ]);
		//}	
        gl.bufferData(gl.ARRAY_BUFFER, (citypaneltextureCoords), gl.STATIC_DRAW);
        citypanelVertexTextureCoordBuffer[nibuff].itemSize = 2;
        citypanelVertexTextureCoordBuffer[nibuff].numItems = 0;//8*ncitypanel;
        }
		}
		
		if(ibuff==0){
        grassVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexPositionBuffer);
        grassvertices = new Float32Array(3*3*ngrass);
        grassvertices2 = new Float32Array(3*3*ngrass);
		grassh=new Array(ngrass);
		grassx=new Array(ngrass);
		grassy=new Array(ngrass);
		grassz=new Array(ngrass);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ngrass; i++) {
		   zc=1;
		   var h=2*0.3;
		   s=Math.random()*2*24+x;
		   t=Math.random()*2*24+y;
		   zc=getterrainheight2(s,t)+0.15;
		   h=0.2*(1+Math.random()*0.5);
		   grassh[i]=h;
		   grassx[i]=s;grassy[i]=t;grassz[i]=zc;
		   append(grassvertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (grassvertices), gl.STATIC_DRAW);
        grassVertexPositionBuffer.itemSize = 3;
        grassVertexPositionBuffer.numItems = 3*ngrass;

        grassVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexTextureCoordBuffer);
        var grasstextureCoords = new Float32Array(2*3*ngrass);
		index=0;
		for (var i=0; i < ngrass; i++) {
		   append(grasstextureCoords,[
             0,0,  0.5,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (grasstextureCoords), gl.STATIC_DRAW);
        grassVertexTextureCoordBuffer.itemSize = 2;
        grassVertexTextureCoordBuffer.numItems = 3*ngrass;

        flowerVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexPositionBuffer);
        flowervertices = new Float32Array(3*6*nflower);
    	flowerh=new Array(nflower);
    	flowerx=new Array(nflower);
    	flowery=new Array(nflower);
    	flowerz=new Array(nflower);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < nflower; i++) {
		   zc=1;
		   var h=2*0.3;
		   s=Math.random()*2*24+(xmax-xmin)*0.5;
		   t=Math.random()*2*24+(ymax-ymin)*0.5;
		   zc=getterrainheight2(s,t)+0.15;
		   h=0.12*(1+Math.random()*0.3);flowerh[i]=h;
		   flowerx[i]=s;flowery[i]=t;flowerz[i]=zc;
		   append(flowervertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc,
             s,t,zc+h, s,t,zc+h, s,t,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (flowervertices), gl.STATIC_DRAW);
        flowerVertexPositionBuffer.itemSize = 3;
        flowerVertexPositionBuffer.numItems = 6*nflower;

        flowerVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexTextureCoordBuffer);
        var flowertextureCoords = new Float32Array(2*6*nflower);
		index=0;
		for (var i=0; i < nflower; i++) {
		   append(flowertextureCoords,[
             0,0,  0,1,  1,0,
			 0,1,  1,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (flowertextureCoords), gl.STATIC_DRAW);
        flowerVertexTextureCoordBuffer.itemSize = 2;
        flowerVertexTextureCoordBuffer.numItems = 6*nflower;
		}

		}
var nroad=maxvertice-1,iroad=0,iroad0=0;
var roadlng0=0,roadlat0=0,roadlng=0,roadlat=0;
var roadx=[],roady=[],roadz=[],roadtan2=[],roadcross=[],roadlayer=[];
var o1road=0,o2road=0,o3road=0,zroad=0,xroad=0,yroad=0,ixyroad=0,myroadname="";
var cos1road=1,sin1road=0;
var roadr=[],roadl=[],roadco1=[],roadsi1=[],roadoneway=[],roadname=[];
var road0x=[],road0y=[],road0z=[],road0tan2=[],road0cross=[],road0layer=[];
var road0r=[],road0l=[],road0co1=[],road0si1=[],road0oneway=[],road0name=[];
function testaddcitypanel(){
var px=((lngrev2-roadlng0)*scale/klon)*2;
var py=(latrev2-roadlat0)*scale*2;
var j=-1,d=4;
  for(var i=0;i<iroad0;i++){
    if(Math.abs(px-road0x[i])<d){
	 if(Math.abs(py-road0y[i])<d){
	   var co1=road0co1[i];
	   var si1=road0si1[i];
	   var dxx=cos1*co1+sin1*si1;
	   if(Math.abs(dxx)>0.78){j=i;
    	   //d=Math.min(Math.abs(px-road0x[i]),Math.abs(py-road0y[i]));
    	   d=Math.max(Math.abs(px-road0x[i]),Math.abs(py-road0y[i]));
	   }
  }}}
  if(j>=0){
       var i=j;
	   var co1=road0co1[i];
	   var si1=road0si1[i];
	   var r=road0r[i]*1.1+0.5;
	   var dxx=cos1*co1+sin1*si1;
	   if(dxx>0.78){var test=addcitypanel((road0x[i]+si1*r)/2,(road0y[i]-co1*r)/2,road0z[i],0.45,co1,si1,locationname2,1);
	                if(test==1){addcitypaneltest();}
					if(test>=1){latrev20=latrev2;lngrev20=lngrev2;}
	                }
	   if(dxx<-0.78){var test=addcitypanel((road0x[i]-si1*r)/2,(road0y[i]+co1*r)/2,road0z[i],0.45,-co1,-si1,locationname2,1);
	                 if(test==1){addcitypaneltest();}
					 if(test>=1){latrev20=latrev2;lngrev20=lngrev2;}
	                }
 }
}
function testaddphotopanel(){
  for(var i=0;i<iroad0;i++){
	var xx=road0x[i],yy=road0y[i];
    var xxx=xx*klon/scale+lng0;
	var yyy=yy/scale+lat0;
	var test=0;
    if(road0cross[i]>0 && airportx<998){
	   test=testaddairportpanel(xxx,yyy,i);}
	if((parseInt(Math.abs(xxx+yyy)*99999)%100)==1 && test==0){
     if(Math.max(Math.abs(xx-x),Math.abs(yy-y))>50){
	   var co1=road0co1[i];
	   var si1=road0si1[i];
	   var r=road0r[i]*1.01+1.3;
	   if(r>1.9){
	      var name="photo";
	      if((parseInt(Math.abs(xxx-yyy)*99998)%3)==1 && getmytown(xxx,yyy,co1,si1)==1){
		    //name="PARIS NEUILLY SUR SEINE 200";
			name=mytown1+mytown2;
			var k=1.7;
            addcitypanel((xx+si1*r)/2,(yy-co1*r)/2,road0z[i],1.2,co1*k,si1*k,name,2.7*k);}
          else{addcitypanel((xx+si1*r)/2,(yy-co1*r)/2,road0z[i],1,co1,si1,name,5);}
				 }
	}}}
}
var airportpanelxx=999999,airportpanelyy=0;
function testaddairportpanel(xxx,yyy,i){
var xx=road0x[i],yy=road0y[i];
var test=0;
var dist1=Math.max(Math.abs(xx-airportpanelxx),Math.abs(yy-airportpanelyy));
if(dist1>150){test=1;}
var dist=Math.max(Math.abs(xx-airportxx),Math.abs(yy-airportyy));
if(dist>30000){return 0;}
var kdist=1+parseInt(dist/50);
if(test==1 || kdist==1 || (parseInt(Math.abs(xxx-yyy)*99993)%kdist)==1){
var co1=road0co1[i],si1=road0si1[i];
var do1=diro1(airportxx-xx,airportyy-yy)-diro1(co1,si1);
while(do1>180){do1-=360;}
while(do1<-180){do1+=360;}
var name="";
if(Math.abs(do1-90)<45){name="airport left";}
if(Math.abs(do1)<45){name="airport forward";}
if(Math.abs(do1+90)<45){name="airport right";}
if(dist<30){name="AIRPORT";}
if(name!=""){
   if(test==1){airportpanelxx=xx;airportpanelyy=yy;}
   var r=road0r[i]*1.01+1.3;
   var k=1.7;mytown1=name;mytown2=airportname;
   addcitypanel((xx+si1*r)/2,(yy-co1*r)/2,road0z[i],1.2,co1*k,si1*k,name,2.7*k);
   //addcitypanel((xx+si1*r)/2,(yy-co1*r)/2,road0z[i],1,co1,si1,name,5);
   return 1;}
}
return 0;
}
function testroad(px0,py0,lat10,lng10,r){
var l,dx,dy,dxy,test=0;
var px=(px0+(roadlng0-lng10)*scale/klon)*2;
var py=(py0+(roadlat0-lat10)*scale)*2;
  for(var i=0;i<iroad0;i++){
    if(Math.abs(px-road0x[i])<road0l[i]+3){
	 if(Math.abs(py-road0y[i])<road0l[i]+3){
	   dx=px-road0x[i];
	   dy=py-road0y[i];
	   dxy=-dx*road0si1[i]+dy*road0co1[i];
	   if(Math.abs(dxy)<road0r[i]+r){
	     dxy=dx*road0co1[i]+dy*road0si1[i];
		 if(dxy>-2 && dxy<road0l[i]+2){
		  //if(Math.abs(zroad-pz0)<0.4){
		   zroad=Math.max(zroad,road0tan2[i]*dxy+road0z[i]);
		   test=1;
		  //}
		   dxy=cos1*road0co1[i]+sin1*road0si1[i];
		   o2road=diro1(1,dxy*road0tan2[i]);
	       dxy=-cos1*road0si1[i]+sin1*road0co1[i];
		   o3road=diro1(1,dxy*road0tan2[i]);
		   
		   //return 1;
		 }
	   }
	 }
	}
  }
return test;
}
var ztunnel=1.8;
function testroadcar(px0,py0,pz0,lat10,lng10,r){
var l,dx,dy,dxy,dxx=0,dxx0=0,test=0;
var px=(px0+(roadlng0-lng10)*scale/klon)*2;
var py=(py0+(roadlat0-lat10)*scale)*2;
  o2road=80;zroad=0.054-ztunnel;
  for(var i=0;i<iroad0;i++){
    if(Math.abs(px-road0x[i])<road0l[i]+3){
	 if(Math.abs(py-road0y[i])<road0l[i]+3){
	   dx=px-road0x[i];
	   dy=py-road0y[i];
	   dxy=-dx*road0si1[i]+dy*road0co1[i];
	   if(Math.abs(dxy)<road0r[i]+r){
	    dxy=dx*road0co1[i]+dy*road0si1[i];
		if(dxy>-0.28 && dxy<road0l[i]+0.28){
		  var zroad1=road0tan2[i]*dxy+road0z[i];
		  dxx=0.37-Math.abs(zroad1-0.22-pz0);//cos1*road0co1[i]+sin1*road0si1[i];
          //if(Math.abs(dxx)>Math.abs(dxx0)){
          if(road0layer[i]<=-1){dxx=Math.max(dxx,0.55-Math.abs(zroad1+0.12-pz0));
		                       dxx=Math.max(dxx,0.55-Math.abs(zroad1+0.42-pz0));		  
		                       dxx=Math.max(dxx,0.55-Math.abs(zroad1+0.84-pz0));		  
		                       if(pz0<-99){dxx=0.75;};
							   }		  
          if(dxx>dxx0-0.15){		  
		   test=1;
		   dxx0=Math.max(dxx,dxx0);
		   if(zroad<zroad1){zroad=zroad1;}//road0tan2[i]*dxy+road0z[i];
		   cos1road=road0co1[i];
		   sin1road=road0si1[i];
		   var dxxx=cos1*cos1road+sin1*sin1road;
		   if(dxxx<0 && road0oneway[i]==0){cos1road=-cos1road;sin1road=-sin1road;}
		   o2road=Math.min(o2road,diro1(1,dxxx*road0tan2[i]));
	       dxy=-cos1*road0si1[i]+sin1*road0co1[i];
		   o3road=diro1(1,dxy*road0tan2[i]);
		   xroad=road0x[i];
		   yroad=road0y[i];
		   myroadname=road0name[i];
		   ixyroad=i;
		  }//return 1;
		 }
	   }
	 }
	}
  }
return test;
}
function testroad2(px0,py0,lat10,lng10,r){
var l,dx,dy,dxy;
var px=(px0)*2;
var py=(py0)*2;
  for(var i=0;i<iroad;i++){
    if(Math.abs(px-roadx[i])<roadl[i]+3){
	 if(Math.abs(py-roady[i])<roadl[i]+3){
	   dx=px-roadx[i];
	   dy=py-roady[i];
	   dxy=-dx*roadsi1[i]+dy*roadco1[i];
	   if(Math.abs(dxy)<roadr[i]+r){
	     dxy=dx*roadco1[i]+dy*roadsi1[i];
		 if(dxy>-2 && dxy<roadl[i]+2){
		    return 1;
		 }
	   }
	 }
	}
  }
return 0;
}
function testroad23(px0,py0,pz0,lat10,lng10,r){
var l,dx,dy,dxy;
var px=(px0)*2;
var py=(py0)*2;
  for(var i=0;i<iroad;i++){
    if(Math.abs(px-roadx[i])<roadl[i]+3){
	 if(Math.abs(py-roady[i])<roadl[i]+3){
	   dx=px-roadx[i];
	   dy=py-roady[i];
	   dxy=-dx*roadsi1[i]+dy*roadco1[i];
	   if(Math.abs(dxy)<roadr[i]+r){
	     dxy=dx*roadco1[i]+dy*roadsi1[i];
		 if(dxy>-2 && dxy<roadl[i]+2){
		   var zroad=roadz[i]+dxy*roadtan2[i];
		   //if(Math.abs(zroad-pz0-0.2)<0.7){return 1;}
		   if(Math.abs(zroad-pz0)<0.5 && roadr[i]>1.7){return 1;}
		 }
	   }
	 }
	}
  }
return 0;
}
function testroadcross(px0,py0,lat10,lng10,rr){
var test=0;
var px=(px0)*2;
var py=(py0)*2;
  for(var i=0;i<iroad;i++){
    if(Math.abs(px-roadx[i])<4){
	 if(Math.abs(py-roady[i])<4){
	   test=2;
	   if(rr<roadr[i]-0.05){
		   return 1;
	   }
	 }
	}
  }
return test;
}
var iroadnear=0,xroadnear=0,yroadnear=0,zroadnear=0,o1roadnear=0,iroadnear0=0,dxyiroadnear=0;
function testroadnear(px0,py0,lat10,lng10,r,dr){
var l,dx,dy,dxx,dxy,dxyi,distxy=999999;
var px=(px0)*2;
var py=(py0)*2;
iroadnear=0;iroadnear0=-1;
var j=-1;
  for(var i=0;i<iroad;i++){
    if(Math.abs(px-roadx[i])<roadl[i]+r){//+7
	 if(Math.abs(py-roady[i])<roadl[i]+r && roadr[i]>=dr){//+7
	   dx=px-roadx[i];
	   dy=py-roady[i];
       dxx=dx*roadco1[i]+dy*roadsi1[i];
	   if(dxx>-0.2 && dxx<roadl[i]+0.2){
	     dxy=-dx*roadsi1[i]+dy*roadco1[i];
	     if(Math.abs(dxy)<distxy){
		    distxy=Math.abs(dxy);
			dxyi=dxy;
            iroadnear=i;j=i;
			if(distxy>roadr[i]){iroadnear0=i;dxyiroadnear=dxyi;}
		 }
	   }
	 }
	}
  }
if(j>=0){var i=j;
         if(distxy<roadr[i]){xroadnear=roadx[i]+dxx*roadco1[i];
		                     yroadnear=roady[i]+dxx*roadsi1[i];}
		 else{xroadnear=px;//roadx[i]+dxx*roadco1[i]-(r+roadr[i])*sign(dxyi)*roadsi1[i];
              yroadnear=py;//roady[i]+dxx*roadsi1[i]+(r+roadr[i])*sign(dxyi)*roadco1[i];
         }
		 zroadnear=roadz[i]+dxx*roadtan2[i];
         o1roadnear=diro1(roadco1[i],roadsi1[i]);			
  return 1;}
return 0;
}
var nroadarrow=25,iroadarrow=0,iroadarrow0=0;
var roadarrowx=[],roadarrowy=[],roadarrowz=[];
var roadarrowo1=[],roadarrowo2=[];
var roadarrow0x=[],roadarrow0y=[],roadarrow0z=[];
var roadarrow0o1=[],roadarrow0o2=[];
for(var i=0;i<nroadarrow;i++){
  roadarrowx[i]=99999;roadarrowy[i]=99999;roadarrowz[i]=99999;
  roadarrowo1[i]=0;roadarrowo2[i]=0;
}
function updateroadarrow(){
iroadarrow0=iroadarrow;
for(var i=1;i<=iroadarrow0;i++){
   roadarrow0x[i]=roadarrowx[i];
   roadarrow0y[i]=roadarrowy[i];
   roadarrow0z[i]=roadarrowz[i];
   roadarrow0o1[i]=roadarrowo1[i];
   roadarrow0o2[i]=roadarrowo2[i];
}}
function addroadarrow(px,py,pz,co1,si1,tan2){
 //var xx=(px/2-(roadlng0-lngx0)*scale/klon);
 //var yy=(py/2-(roadlat0-latx0)*scale);
 if(iroadarrow>=nroadarrow-1){return;}
 iroadarrow+=1;
 var i=iroadarrow;
 roadarrowx[i]=px/2;roadarrowy[i]=py/2;roadarrowz[i]=pz;
 roadarrowo1[i]=diro1(co1,si1);roadarrowo2[i]=diro1(1,tan2);
}
var npautoroad=[],npautoroad0=[],no1pilot=[];
var ndxyroad0=[],ndxyroad=[],ncar=12,ncar2=5;
var nlngx=[],nlatx=[],no1=[],ncos1=[],nsin1=[];
var ncos2=[],nsin2=[],ncos3=[],nsin3=[],nvrun=[];
var no2=[],no3=[],nx=[],ny=[],nz=[],nvcar=[];
var nvmx=[],nvmy=[],nvmz=[],nvmx2=[],nvmy2=[],nvmz2=[];
var nzsol=[],no3volant0=[],no3volant=[],no3wheel=[],ntlogan=[];
var ntbrakes=[],ncarvisible=[];
function initncar(){
for(var i=0;i<=ncar;i++){
   npautoroad[i]=-1;npautoroad0[i]=-1;no1pilot[i]=0;
   ndxyroad0[i]=0;ndxyroad[i]=0;
   nlngx[i]=lngx+i*4*klon/scale;nlatx[i]=latx;no1[i]=o1;ncos1[i]=cos1;nsin1[i]=sin1;
   ncos2[i]=cos2;nsin2[i]=sin2;ncos3[i]=cos3;nsin3[i]=sin3;
   no2[i]=0;no3[i]=0;nx[i]=x+i*4;ny[i]=y;nz[i]=z;
   nzsol[i]=0;no3volant0[i]=0;no3volant[i]=0;
   no3wheel[i]=0;nvcar[i]=0;nvrun[i]=vrun;
   nvmx[i]=vmx;nvmy[i]=vmy;nvmz[i]=vmz;
   nvmx2[i]=vmx2;nvmy2[i]=vmy2;nvmz2[i]=vmz2;ntlogan[i]=parseInt(Math.random()*1.9);
   ntbrakes[i]=0;ncarvisible[i]=0;
}}
function loadcar(i){
   pautoroad=npautoroad[i];pautoroad0=npautoroad0[i];o1pilot=no1pilot[i];
   dxyroad0=ndxyroad0[i];dxyroad=ndxyroad[i];
   lngx=nlngx[i];latx=nlatx[i];o1=no1[i];cos1=ncos1[i];sin1=nsin1[i];
   cos2=ncos2[i];sin2=nsin2[i];cos3=ncos3[i];sin3=nsin3[i];
   o2=no2[i];o3=no3[i];x=nx[i];y=ny[i];z=nz[i];
   zsol=nzsol[i];o3volant0=no3volant0[i];o3volant=no3volant[i];
   o3wheel=no3wheel[i];vcar=nvcar[i];vrun=nvrun[i];
   vmx=nvmx[i];vmy=nvmy[i];vmz=nvmz[i];
   vmz2=nvmx2[i];vmy2=nvmy2[i];vmz2=nvmz2[i];tlogan=ntlogan[i];
   tbrakes=ntbrakes[i];carvisible=ncarvisible[i];
}
function savecar(i){
   npautoroad[i]=pautoroad;npautoroad0[i]=pautoroad0;no1pilot[i]=o1pilot;
   ndxyroad0[i]=dxyroad0;ndxyroad[i]=dxyroad;
   nlngx[i]=lngx;nlatx[i]=latx;no1[i]=o1;ncos1[i]=cos1;nsin1[i]=sin1;
   ncos2[i]=cos2;nsin2[i]=sin2;ncos3[i]=cos3;nsin3[i]=sin3;
   no2[i]=o2;no3[i]=o3;nx[i]=x;ny[i]=y;nz[i]=z;
   nzsol[i]=zsol;no3volant0[i]=o3volant0;no3volant[i]=o3volant;
   no3wheel[i]=o3wheel;nvcar[i]=vcar;nvrun[i]=vrun;
   nvmx[i]=vmx;nvmy[i]=vmy;nvmz[i]=vmz;
   nvmx2[i]=vmx2;nvmy2[i]=vmy2;nvmz2[i]=vmz2;ntlogan[i]=tlogan;
   ntbrakes[i]=tbrakes;ncarvisible[i]=carvisible;
}
var autoroad=[],nautoroad=20,iautoroad=0;
var pautoroad=-1,pautoroad0=-1,o1pilot=0;
var dxyroad0=0,dxyroad=0;
function resetfindroad(){
  pautoroad=-1;pautoroad0=-1;
  for(var i=0;i<=ncar;i++){
     npautoroad[i]=-1;npautoroad0[i]=-1;
  }
}
var pautoroad00=0,tpautoroad00=0;
function findroad(auto){
var xx=((lngx-lng0)/klon)*scale+3*cos1;
var yy=(latx-lat0)*scale+3*sin1;
//troad=testroad(xx,yy,lat0,lng0,0.5);//}
var r=1;
var l,dx,dy,dxy;
var px=(xx+(roadlng0-lng0)*scale/klon)*2;
var py=(yy+(roadlat0-lat0)*scale)*2;
if(typecar==0){
   if(pautoroad<0 && tframe>tpautoroad00+1000){pautoroad=pautoroad00;}
   else if(pautoroad>=0){pautoroad00=pautoroad;tpautoroad00=tframe;}
}
var j=pautoroad;
r=1.5+vcar;
if(pautoroad>=0 && (auto==0 || pautoroad0<0)){
    var dx0=road0x[j]+road0l[j]*road0co1[j]-px;
    var dy0=road0y[j]+road0l[j]*road0si1[j]-py;
    dx=dx0;dy=dy0;
	 var dx1=road0x[j]-px;
     var dy1=road0y[j]-py;
	 if(Math.abs(dx1*sin1-dy1*cos1)<Math.abs(dx*sin1-dy*cos1)){
	   dx=dx1;dy=dy1;}
	 var dx2=road0x[j]+road0l[j]*road0co1[j]/2-px;
     var dy2=road0y[j]+road0l[j]*road0si1[j]/2-py;
	 if(Math.abs(dx2*sin1-dy2*cos1)<Math.abs(dx*sin1-dy*cos1)){
	   dx=dx2;dy=dy2;}
	if(Math.abs(dx)>30.25 || Math.abs(dy)>30.25){
       pautoroad=-1;}   
    if(Math.abs(dx)<r){
	 if(Math.abs(dy)<r){
	   pautoroad0=pautoroad;pautoroad=-1;
    }}
	if(dx*cos1+dy*sin1<-5.08*road0r[j] && pautoroad>0){
	   pautoroad0=pautoroad;pautoroad=-1;
	}
	}
if(pautoroad>=0 && auto==1 && pautoroad0>=0){
    var jj=pautoroad0;
    //var dxy=-(road0co1[j]*road0si1[jj]-road0si1[j]*road0co1[jj])*(road0co1[j]*cos1+road0si1[j]*sin1);
    var dxy=-(cos1*road0si1[jj]-sin1*road0co1[jj]);//*(road0co1[j]*cos1+road0si1[j]*sin1);
	var dx0=road0x[j]+road0l[j]*road0co1[j]-px;
    var dy0=road0y[j]+road0l[j]*road0si1[j]-py;
    dx=dx0;dy=dy0;
	 var dx1=road0x[j]-px;
     var dy1=road0y[j]-py;
	 if(dxy*(dx1*sin1-dy1*cos1)<dxy*(dx*sin1-dy*cos1)){
	   dx=dx1;dy=dy1;}
	 /*var dx2=road0x[j]+road0l[j]*road0co1[j]/2-px;
     var dy2=road0y[j]+road0l[j]*road0si1[j]/2-py;
	 if(dxy*(dx2*sin1-dy2*cos1)<dxy*(dx*sin1-dy*cos1)){
	   dx=dx2;dy=dy2;}*/
	if(Math.abs(dx)>30.25 || Math.abs(dy)>30.25){
       pautoroad=-1;}   
    if(Math.abs(dx)<r){
	 if(Math.abs(dy)<r){
	   pautoroad0=pautoroad;pautoroad=-1;
    }}
	if(dx*cos1+dy*sin1<-5.08*road0r[j] && pautoroad>0){
	   pautoroad0=pautoroad;pautoroad=-1;
	}
	}
//if(vcar<0.08){vrun+=(0.74-vrun)*Math.min(1,dtime*0.002);}
//else{vrun+=(0.48-vrun)*Math.min(1,dtime*0.002);}
if(vcar<0.08){vrun=0.74;}
else{vrun=0.48;}
if(vcar<0.04){vrun=1.80;vcar=Math.max(0.015,vcar);}

if(pautoroad>=0){
   j=pautoroad;
   //if(typecar==0 && vcar>road0r[j]*0.12){vrun+=(0.1-vrun)*Math.min(1,dtime*0.002);
   //			          vcar=Math.max(vcar-vcar*dtime*0.0003,0.03);}
   //var dxxroad=dx*road0co1[j]+dy*road0si1[j];
   var dxyroad1=dx*road0si1[j]-dy*road0co1[j];
   if(road0oneway[j]==1){if((sin1*road0co1[j]-cos1*road0si1[j])*dxyroad1>0.1){
     if(dxyroad1>0){o1pilot=o1-3;}else{o1pilot=o1+3;}
     if(vcar>0.025){vrun=0.2;}
	 vcar=Math.max(vcar-vcar*dtime*0.001,0.05);
	 return;
	  }}	
   dxyroad0=dxyroad;
   dxyroad=dxyroad1;//dx*road0si1[j]-dy*road0co1[j];
   var dxx=dx*cos1+dy*sin1;
   //var dyy=dx*sin1-dy*cos1;
   if(Math.abs(dxyroad)>Math.abs(dxyroad0) && dxx<0.5){
     o1pilot=diro1(dx,dy);
     if(vcar>0.025){vrun=0.2;}
	 vcar=Math.max(vcar-vcar*dtime*0.001,0.05);
	 }
   else if(Math.abs(dxyroad)<0.9*road0r[j]){
     var dxxxx=road0co1[j]*cos1+road0si1[j]*sin1;
     dx+=0.45*road0r[j]*(road0si1[j]+Math.abs(dxxxx)*road0co1[j])*sign(dxxxx);
     dy-=0.45*road0r[j]*(road0co1[j]-Math.abs(dxxxx)*road0si1[j])*sign(dxxxx);
     o1pilot=diro1(dx,dy);}
   else{
        var dxxx=cos1*road0co1[j]+sin1*road0si1[j];
		//var dyyy=cos1*road0si1[j]-sin1*road0co1[j];
		if(Math.abs(dxyroad)<1.3*road0r[j]){
		   if(vcar>0.025){vrun=0.2;}
		   vcar=Math.max(vcar-vcar*dtime*0.001,0.05);
        }
		if(Math.abs(dxxx)>0.12){
 		 if(dxx>0){o1pilot=o1-3*sign(dxxx*dxyroad);//dyyy);
		 }else{o1pilot=o1+3*sign(dxxx*dxyroad);//dyyy);
		}}
	}
   //if(road0oneway[j]==1){if((cos1*road0co1[j]+sin1*road0si1[j])<-0.83){o1pilot=o1-3;}}	
   return;}
//o1pilot=o1;
if(pautoroad00>=0 && tframe<tpautoroad00+1 && typecar==0){return;}
dxyroad=0;
var cos10=0,sin10=0;
if(pautoroad0>=0){
  var j=pautoroad0;
  cos10=road0co1[j];
  sin10=road0si1[j];
  var dxxxx=cos10*cos1+sin10*sin1;
  if(auto==0){px+=3*(cos10)*sign(dxxxx);
            py+=3*(sin10)*sign(dxxxx);}
  else{px+=(cos1+2*cos10)*sign(dxxxx);
     py+=(sin1+2*sin10)*sign(dxxxx);}
}
r=3;//5
px-=sin1*0.3;py+=cos1*0.3;
iautoroad=-1;
//if(tautopilot==2 && typecar==0){
if(typecar==0){
var dxyauto=0.5,idxyauto=-1,dxy0=0,kdxy0=0.5+4,kdxy=0;
  if(tautopilot==2 && typecar==0){dxyauto=0.7;kdxy0=0,kdxy=0.5;}
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i];
	if(Math.abs(dx)<r){
	if(road0oneway[i]==0){dxy=Math.abs(cos10*road0co1[i]+sin10*road0si1[i]);}
	else{dxy=(cos10*road0co1[i]+sin10*road0si1[i]);}
	if(dxy<0.607){dxy=0;}//0.607
	if(Math.abs(dx+dxy*sin1)<r){
	 dy=py-road0y[i];
	 if(Math.abs(dy)<r){
	 if(Math.abs(dy-dxy*cos1)<r){
       var dxxh=0.37-cos2*Math.abs(road0z[i]+0.5-(sin2/2)*road0l[i]-z);
       if(dx*cos1+dy*sin1<-kdxy && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=cos1*road0co1[i]+sin1*road0si1[i];
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}
		  if(dxy0>=0.7){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}}}
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i]-road0l[i]*road0co1[i];
	if(Math.abs(dx)<r){
	if(road0oneway[i]==0){dxy=Math.abs(cos10*road0co1[i]+sin10*road0si1[i]);}
	else{dxy=(cos10*road0co1[i]+sin10*road0si1[i]);}
	if(dxy<0.607){dxy=0;}//0.607
	if(Math.abs(dx+dxy*sin1)<r){
	 dy=py-road0y[i]-road0l[i]*road0si1[i];
	 if(Math.abs(dy)<r){
	 if(Math.abs(dy-dxy*cos1)<r){
       var dxxh=0.37-cos2*Math.abs(road0z[i]+0.5+(road0tan2[i]-sin2/2)*road0l[i]-z);
	   if(dx*cos1+dy*sin1<-kdxy && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=cos1*road0co1[i]+sin1*road0si1[i];
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}
		  if(dxy0>=0.7){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}}}
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i]-road0l[i]*road0co1[i]/2;
	if(Math.abs(dx)<r){
	if(road0oneway[i]==0){dxy=Math.abs(cos10*road0co1[i]+sin10*road0si1[i]);}
	else{dxy=(cos10*road0co1[i]+sin10*road0si1[i]);}
	if(dxy<0.607){dxy=0;}//0.607
	if(Math.abs(dx+dxy*sin1)<r){
	 dy=py-road0y[i]-road0l[i]*road0si1[i]/2;
	 if(Math.abs(dy)<r){
	 if(Math.abs(dy-dxy*cos1)<r){
       var dxxh=0.37-cos2*Math.abs(road0z[i]+0.5+(road0tan2[i]/2-sin2/2)*road0l[i]-z);
	   if(dx*cos1+dy*sin1<-kdxy && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=cos1*road0co1[i]+sin1*road0si1[i];
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}
		  if(dxy0>=0.7){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}}}
  if(idxyauto>=0 && (auto==1 || iautoroad<0)){pautoroad=idxyauto;return;}
  if(iautoroad>=0){
    var i=parseInt(Math.random()*(iautoroad+0.99));
	pautoroad=autoroad[i];return;
	}
}//}
r=5;
iautoroad=-1;
var dxyauto=0.05,idxyauto=-1,dxy0=0,kdxy0=0.5+4;
  if(tautopilot==2 && typecar==0){dxyauto=0.5;kdxy0=2;}
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i];
	if(Math.abs(dx)<r){
	if(road0oneway[i]==0){dxy=Math.abs(cos10*road0co1[i]+sin10*road0si1[i]);}
	else{dxy=(cos10*road0co1[i]+sin10*road0si1[i]);}
	if(dxy<0.607){dxy=0;}//0.607
	if(Math.abs(dx+dxy*sin1)<r){
	 dy=py-road0y[i];
	 if(Math.abs(dy)<r){
	 if(Math.abs(dy-dxy*cos1)<r){
       var dxxh=0.37-cos2*Math.abs(road0z[i]+0.5-(sin2/2)*road0l[i]-z);
       if(dx*cos1+dy*sin1<0 && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=cos1*road0co1[i]+sin1*road0si1[i];
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){if(tautopilot!=2 || typecar!=0){
	      //           dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}}
		  if(dxy0>=0){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}}}
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i]-road0l[i]*road0co1[i];
	if(Math.abs(dx)<r){
	if(road0oneway[i]==0){dxy=Math.abs(cos10*road0co1[i]+sin10*road0si1[i]);}
	else{dxy=(cos10*road0co1[i]+sin10*road0si1[i]);}
	if(dxy<0.607){dxy=0;}//0.607
	if(Math.abs(dx+dxy*sin1)<r){
	 dy=py-road0y[i]-road0l[i]*road0si1[i];
	 if(Math.abs(dy)<r){
	 if(Math.abs(dy-dxy*cos1)<r){
       var dxxh=0.37-cos2*Math.abs(road0z[i]+0.5+(road0tan2[i]-sin2/2)*road0l[i]-z);
	   if(dx*cos1+dy*sin1<0 && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=cos1*road0co1[i]+sin1*road0si1[i];
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){if(tautopilot!=2 || typecar!=0){
	      //           dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}}
		  if(dxy0>=0){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}}}
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i]-road0l[i]*road0co1[i]/2;
	if(Math.abs(dx)<r){
	if(road0oneway[i]==0){dxy=Math.abs(cos10*road0co1[i]+sin10*road0si1[i]);}
	else{dxy=(cos10*road0co1[i]+sin10*road0si1[i]);}
	if(dxy<0.607){dxy=0;}//0.607
	if(Math.abs(dx+dxy*sin1)<r){
	 dy=py-road0y[i]-road0l[i]*road0si1[i]/2;
	 if(Math.abs(dy)<r){
	 if(Math.abs(dy-dxy*cos1)<r){
       var dxxh=0.37-cos2*Math.abs(road0z[i]+0.5+(road0tan2[i]/2-sin2/2)*road0l[i]-z);
	   if(dx*cos1+dy*sin1<0 && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=(cos1*road0co1[i]+sin1*road0si1[i]);
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){if(tautopilot!=2 || typecar!=0){
	      //           dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}}
		  if(dxy0>=0){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}}}
  if(idxyauto>=0 && (auto==1 || iautoroad<0)){pautoroad=idxyauto;return;}
  if(iautoroad>=0){
    var i=parseInt(Math.random()*(iautoroad+0.99));
	pautoroad=autoroad[i];return;
	}
if(tautopilot==2 && typecar==0){o1pilot=o1;return;}
r=10;
dxyauto=-1;dxy0=0;
iautoroad=-1;
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i];
	if(Math.abs(dx)<r){
	 dy=py-road0y[i];
	 if(Math.abs(dy)<r){
       //var dxxh=0.37;//-Math.abs(road0z[i]+0.5-sin2/2-z);
	   if(dx*cos1+dy*sin1<0){// && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=cos1*road0co1[i]+sin1*road0si1[i];
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}
		  if(dxy0>=-10){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i]-road0l[i]*road0co1[i];
	if(Math.abs(dx)<r){
	 dy=py-road0y[i]-road0l[i]*road0si1[i];
	 if(Math.abs(dy)<r){
       //var dxxh=0.37;//-Math.abs(road0z[i]+0.5+(road0tan2[i]-sin2/2)*road0l[i]-z);
	   if(dx*cos1+dy*sin1<0){// && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=cos1*road0co1[i]+sin1*road0si1[i];
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}
		  if(dxy0>=-10){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}
  for(var i=0;i<iroad0;i++){
    dx=px-road0x[i]-road0l[i]*road0co1[i]/2;
	if(Math.abs(dx)<r){
	 dy=py-road0y[i]-road0l[i]*road0si1[i]/2;
	 if(Math.abs(dy)<r){
       //var dxxh=0.37;//-Math.abs(road0z[i]+0.5+(road0tan2[i]-sin2/2)*road0l[i]-z);
	   if(dx*cos1+dy*sin1<0){// && dxxh>0){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  dxy0=cos1*road0co1[i]+sin1*road0si1[i];
          if(road0oneway[i]==0){dxy0=Math.abs(dxy0);}
		  if(dxy0>0){dxy0+=Math.max(0,(road0r[i]-0.85)*kdxy0);}//1.05
		  if(dxy0>dxyauto){dxyauto=dxy0;idxyauto=i;}
		  //if(dxy0<0){dxy0+=sign(-dx*road0co1[i]-dy*road0si1[i])*0.5;}
		  if(dxy0>=-10){iautoroad+=1;autoroad[iautoroad]=i;}
	   }}}}}
  if(idxyauto>=0 && (auto==1 || iautoroad<0)){pautoroad=idxyauto;return;}
  if(iautoroad>=0){
    var i=parseInt(Math.random()*(iautoroad+0.99));
	pautoroad=autoroad[i];return;
	}
r=30;	
iautoroad=-1;
  for(var i=0;i<iroad0;i++){
    if(Math.abs(px-road0x[i])<r){
	 if(Math.abs(py-road0y[i])<r){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  iautoroad+=1;
	      autoroad[iautoroad]=i;
	   }}}}
  for(var i=0;i<iroad0;i++){
    if(Math.abs(px-road0x[i]-road0l[i]*road0co1[i])<r){
	 if(Math.abs(py-road0y[i]-road0l[i]*road0si1[i])<r){
	    if(iautoroad<nautoroad && i!=pautoroad0){
		  iautoroad+=1;
	      autoroad[iautoroad]=i;
	   }}}}
  if(iautoroad>=0){
    var i=parseInt(Math.random()*(iautoroad+0.99));
	pautoroad=autoroad[i];return;
	}
if(typecar>0){
   lngx=nlngx[0]+ncos1[0]*dxmax*klon/scale;
   latx=nlatx[0]+nsin1[0]*dxmax/scale;
   x=nx[0]+ncos1[0]*dxmax;
   y=ny[0]+nsin1[0]*dxmax;
}
pautoroad0=-1;
o1+=Math.random()*dtime*0.005;
o1pilot=o1;
if(Math.random()<dtime*0.00007){carvisible=0;}
}
function testresetcar(typecar){
if(typecar>0){
 var dmax=Math.min(40.0,dxmax*1.3);
 if(Math.abs(x-nx[0])>dmax+2 || Math.abs(y-ny[0])>dmax+2){
   lngx=nlngx[0]+ncos1[0]*dmax*klon/scale;
   latx=nlatx[0]+nsin1[0]*dmax/scale;
   x=nx[0]+ncos1[0]*dmax;
   y=ny[0]+nsin1[0]*dmax;
   tlogan=parseInt(Math.random()*1.9);
pautoroad0=-1;pautoroad=-1;
o1=no1[0]+180+(Math.random()-0.5)*90;
if(Math.random()<0.3){
   o1=no1[0]+(Math.random()-0.5)*40;
   if(vcar>nvcar[0]*1.3){
     lngx=nlngx[0]-ncos1[0]*dmax*klon/scale;
     latx=nlatx[0]-nsin1[0]*dmax/scale;
     x=nx[0]-ncos1[0]*dmax;
     y=ny[0]-nsin1[0]*dmax;
}}
while(o1>180){o1-=360;}
o1pilot=o1;
carvisible=0;
}}
}
var roadbandlng0=0,roadbandlat0=0,roadbandlng=0,roadbandlat=0;
var roadbandx=[],roadbandy=[],roadbandz=[],roadbandtan2=[];
var o1roadband=0,o2roadband=0,zroadband=0;
var roadbandr=[],roadbandl=[],roadbandco1=[],roadbandsi1=[];
var roadband0x=[],roadband0y=[],roadband0z=[],roadband0tan2=[];
var roadband0r=[],roadband0l=[],roadband0co1=[],roadband0si1=[];
var latx0=latx,lngx0=lngx,tdraw=0,tdraw2=0;
var inode2=0,nodeid2=[],inode3=0,nodeid3=[],towerid=[],iway2=[];
var inode31=0,nodeid31=[],avgdh31=0;
function setinode2(){
var dh=4;dh=Math.max(4,avgdh31*0.8);
avgdh31=Math.max(5,avgdh31*0.7);
inode2=0;inode3=0;inode31=0;towerid=[];iway2=[];
var ntest=0;
for(var i=0;i<ways.length;i++){
   var way=(ways[i]),test=0,h00=0;
   //if(way.id){towerid[way.id]=1;}
   //var waytype="none";
   if(way.nodes){
   if(way.tags){
     if(way.tags.highway){
      test=1;//waytype=way.tags.highway;
	  }
     if(way.tags.aeroway){
      test=2;//waytype=way.tags.aeroway;
	  }
   }
   if(test>=1){
   var jmax=way.nodes.length-1;
   if(test==2){jmax=Math.min(jmax,3);}
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(!latnodes[inode]){
	   if(test==2){ntest+=1;}
	   if(inode2<150){inode2+=1;nodeid2[inode2]=inode;}
	   else if(inode3<150){inode3+=1;nodeid3[inode3]=inode;}
	   else if(inode31<150){inode31+=1;nodeid31[inode31]=inode;}
	   else{break;}
   }}}}}
for(var i=0;i<ways.length;i++){
   var way=(ways[i]),test=0,h00=0;
   //if(way.id){towerid[way.id]=1;}
   //var waytype="none";
   if(way.nodes){
   if(way.tags){
     if(way.tags.building){
      //waytype="building";
      if(way.tags.height){h00=way.tags.height/6;
	        }
      else if(way.tags["building:height"]){
		    h00=way.tags["building:height"]/6;
			}
      else if(way.tags["building:levels"]){
		    h00=way.tags["building:levels"]*1.2;
			}
      else if(way.tags.levels){
		    h00=way.tags.levels*1.2;
			}
	  if(h00>dh){test=2;avgdh31+=(h00-avgdh31)*0.3;}
	  }
   }
   if(test>=1){
   var jmax=way.nodes.length-1;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(!latnodes[inode]){
	   if(test==2){ntest+=1;}
	   if(inode2<150){inode2+=1;nodeid2[inode2]=inode;}
	   else if(inode3<150){inode3+=1;nodeid3[inode3]=inode;}
	   else if(inode31<150){inode31+=1;nodeid31[inode31]=inode;}
	   else{break;}
   }}}}}
/*var iway=0;
for(var i=0;i<ways2.length;i++){
  var way=(ways2[i]),test=0,h00=0;
  //var waytype="none";
  if(way.id){
   if(way.nodes){
   if(!towerid[way.id]){
   towerid[way.id]=1;
   if(way.tags){
     if(way.tags.building){
      //waytype="building";
      if(way.tags.height){h00=way.tags.height/6;
	        }
      else if(way.tags["building:height"]){
		    h00=way.tags["building:height"]/6;
			}
      else if(way.tags["building:levels"]){
		    h00=way.tags["building:levels"]*1.2;
			}
      else if(way.tags.levels){
		    h00=way.tags.levels*1.2;
			}
	  if(h00>4){test=1;}
	  }
   }
   if(test==1){
   iway2[iway]=i;iway+=1;
   var jmax=way.nodes.length-1;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(!latnodes[inode]){
	   if(inode2<150){inode2+=1;nodeid2[inode2]=inode;}
	   else if(inode3<150){inode3+=1;nodeid3[inode3]=inode;}
	   else{break;}
   }}}}}}}
   */  
   //auxvar3=inode2+inode3+inode31;
   if(inode2==9990){tdraw=2;loading=1.75;}
   else if(loading==1){setTimeout("getnodes2();",t100);}
}		
function drawglroad(iway){
lat=latx0;lng=lngx0;
if(iway==0){
for(var i=0;i<nsol;i++){
 for(var j=0;j<nsol;j++){
    height2[i*nsol+j]=height[i*nsol+j];}}
iroad=0;
roadlng=lngx0;roadlat=latx0;
indexroad=0;//inode2=0;
//if(Math.max(Math.abs(latx-lat0),Math.abs(lngx-lng0))>0.001){
//   latx0=latx;lngx0=lngx;}
}
for(var i=iway;i<ways.length;i++){
   var way=(ways[i]),test=0;
   var xx=0,xxx=0,yy=0,yyy=0,r=1,dr=1,rt=1;
   var dx=1,dy=1,dxx=0,dyy=0,dx0=0,dy0=0,zz=0,zzz=0;
   var di=1,xx0=0,yy0=0,zz0=0,xxx0=0,yyy0=0,zzz0=0;
   var dr0=1;
   var waytype="none";
   if(way.nodes){
   if(way.tags){
     if(way.tags.highway){
      test=1;waytype=way.tags.highway;
	  }
    if(way.tags.aeroway){
      test=1;waytype=way.tags.aeroway;}
   }
   if(test==1){
   if(waytype=="aerodrome"){
     r=5;
   }else if(waytype=="runway"){
     r=8;
   }else if(waytype=="taxiway"){
     r=6;
   }else if(waytype=="motorway"){
     r=2.8;
	 //context.lineWidth = 4;
     //context.strokeStyle = '#ff0000';
   }else if(waytype=="trunk"){
     r=2.6;
	 //context.lineWidth = 3;
     //context.strokeStyle = '#cf0000';
   }else if(waytype=="primary"){
     r=2.4;
	 //context.lineWidth = 2;
     //context.strokeStyle = '#4f9f00';
   }else if(waytype=="secondary"){
     r=1.8;
	 //context.lineWidth = 1;
     //context.strokeStyle = '#00ff00';
   }else if(waytype=="tertiary"){
     r=1.2;
	 //context.lineWidth = 1;
     //context.strokeStyle = '#008f00';
   }else if(waytype=="service"){
     r=0.7
	 //context.lineWidth = 1;
     //context.strokeStyle = '#8f8f00';
   }else if(waytype=="pedestrian"){
	 r=0.5;rt=0.3
	 //context.lineWidth = 1;
     //context.strokeStyle = '#ffff00';
   }else if(waytype=="path"){
     r=0.35;rt=0.25
	 //context.lineWidth = 1;
     //context.strokeStyle = '#ff00ff';
   }else{//test=0;
     r=0.8;
	 //context.lineWidth = 1;
     //context.strokeStyle = '#000000';
   }
   r*=1.1;
   //if(test==1 && indexroad<(maxvertice*3/(1)-1)){
   //context.beginPath();
   var jmax=way.nodes.length-1;
   var jstart=0,dh=0.5,tth=0.1,th=0.11;
   var latxx=0,lonxx=0,latxxx=0,lonxxx=0;
   var dlonxx=r*klon/(scale*2);
   var dlatxx=r/(scale*2);
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(!latnodes[inode]){
	   //if(r>2 && inode2<150){inode2+=1;nodeid2[inode2]=inode;}
	 }else{
	   xxx=xx;yyy=yy;zzz=zz;
	   latxxx=latxx;lonxxx=lonxx;
	   latxx=latnodes[inode];
	   lonxx=lonnodes[inode];
	   yy=(latxx-latx0)*scale*2;
	   xx=((lonxx-lngx0)/klon)*scale*2;
	   zz=getterrainheight(lonxx,latxx);
	   //zz=getterrainheight(lonxx+dlonxx,latxx+dlatxx);
	   //zz=Math.max(zz,getterrainheight(lonxx-dlonxx,latxx-dlatxx));
	   if(zz<0){zz=0;}
	   //if (zz>0.001){zz=0;}else{zz=0.0012;}
	   dx0=dx;dy0=dy;
	   if(jstart==0){jstart=j+1;//context.moveTo(xx,yy);
	   }else{//context.lineTo(xx,yy);
	        dxx=xx-xxx;dyy=yy-yyy;
			dr=Math.max(0.00001,Math.sqrt(dxx*dxx+dyy*dyy));
			di=1;if(dr>7){di=parseInt(dr/4);}
			dx=-r*dyy/dr;dy=r*dxx/dr;
			if(j==jstart){dx0=dx;dy0=dy;
			         drtree5=5+(parseInt((latxx+lonxx)*100000)%3)*10;
			         xxx-=dy*0.4;yyy+=dx*0.4;}
			if(j==jmax){xx+=dy*0.4;yy-=dx*0.4;}
			dr0=dr;
			var co1=dxx/dr,si1=dyy/dr;
			var tan2=(zz-zzz)/dr;
			dr=dr0/di;
			var dxxii=(xx-xxx)/di;
			var dyyii=(yy-yyy)/di;
			var ddxii=(dx-dx0)/di;
			var ddyii=(dy-dy0)/di;
			var dlonii=(lonxx-lonxxx)/di;
			var dlatii=(latxx-latxxx)/di;
			xx=xxx;yy=yyy;
			dx=dx0;dy=dy0;
			latxx=latxxx;lonxx=lonxxx;
		   for(var ii=1;ii<=di;ii++){
			xx+=dxxii;
			yy+=dyyii;
			dx+=ddxii;
			dy+=ddyii;
			lonxx+=dlonii;
			latxx+=dlatii;
			zz=getterrainheight1(lonxx,latxx);//,co1,si1,tan2);
			//if(r<1.7){setterrainheight(lonxx,latxx,co1,si1,tan2,zz);}
			var zz1=Math.max(0.1,zz-0.1);//0.5);
			setterrainheight(lonxx+dlonxx,latxx+dlatxx,co1,si1,tan2,zz1);
			setterrainheight(lonxx-dlonxx,latxx-dlatxx,co1,si1,tan2,zz1);
			tan2=(zz-zzz)/dr;
			xxx=xx;yyy=yy;zzz=zz;
		   }//ii
           //xx=xx0;yy=yy0;zz=zz0;		   
		   }
	 }  
   }
   //context.stroke();
   }}}
   //ibuff=ibuff1;
   //updatebuffers();
}
function dectohex(d) {return d.toString(16);}
function hextodec(h) {var h4="00000000"+h;h4=h4.substr(h4.length-8,8);
                      var i=parseInt(h4.substr(0,2),16);
					  i=i*256+parseInt(h4.substr(2,2),16);
					  i=i*256+parseInt(h4.substr(4,2),16);
					  i=i*256+parseInt(h4.substr(6,2),16);
					  return i;}

var taddbar=0,layer=0,distairport1=0,distairport2=0,icolor=0;
var layernode2=[],ilayer2=0,ilayernode2=[];
function drawgl(iway){
lat=latx0;lng=lngx0;
if(tfoot==1){t300=20;}else{t300=Math.min(30,parseInt(tfps));}
if(iway==0){
context.clearRect (0,0,canvas.width-256,canvas.height);
printlocationname();
msgload("drawgl");
iroad=0;itree=0;iline=0;icross=0;iwoman=0,iwall=0,iwalltree=0,ibar=0;
iroadarrow=0;itree2=0;tsequoia=0;
roadlng=lngx0;roadlat=latx0;
indexroad=0;
itextroad=0;
indexroadband=0;
itextroadband=0;
indextower=0;
itexttower=0;
indexchurch=0;
itextchurch=0;
indexhouse=0;
itexthouse=0;
indexofficial=0;
itextofficial=0;
indexhospital=0;
itexthospital=0;
indexroof=0;
itextroof=0;
indexshop=0;
itextshop=0;
indextree=0;indextree2=0;
indexline=0;indexlinetext=0;
indexcross=0;
tairport=0;airportx=999;airportname="";distairport1=999999;distairport2=999999;
ntrottoir=0;
//resettree2();
//resettree22();
//if(Math.max(Math.abs(latx-lat0),Math.abs(lngx-lng0))>0.001){
//   latx0=latx;lngx0=lngx;}
layernode2=[];ilayer2=0;ilayernode2=[];
for(var i=0;i<ways.length;i++){
  var way=ways[i];
  if(way.tags){
    if(way.tags.layer){
	  var layer=Math.min(1,way.tags.layer+0);
	  if(way.nodes){
	   if(layer>0.1){
	    ilayer2+=1;ilayernode2[ilayer2]=way.nodes[0];
	    layernode2[ilayernode2[ilayer2]]=1;
	    ilayer2+=1;ilayernode2[ilayer2]=way.nodes[way.nodes.length-1];
		layernode2[ilayernode2[ilayer2]]=1;}}}
    else if(way.tags.bridge){
	  if(way.nodes){
	    ilayer2+=1;ilayernode2[ilayer2]=way.nodes[0];
	    layernode2[ilayernode2[ilayer2]]=1;
	    ilayer2+=1;ilayernode2[ilayer2]=way.nodes[way.nodes.length-1];
		layernode2[ilayernode2[ilayer2]]=1;}}
	}
}
for(var i=1;i<=ilayer2;i++){
   var inode=ilayernode2[i];
   if(latnodes[inode]){
     for(var j=i+1;j<=ilayer2;j++){
	    if(i!=j){
		  var inode2=ilayernode2[j];
		  if(latnodes[inode2]){
		    if(Math.abs(latnodes[inode]-latnodes[inode2])<0.000035){
			  if(Math.abs(lonnodes[inode]-lonnodes[inode2])<0.000035*klon){
			     layernode2[inode]+=1;
				 layernode2[inode2]+=1;}}
		   }}}}
}
addgmaptreetest0();
}
for(var i=iway;i<ways.length;i++){
   if(i>iway+Math.max(200,ways.length/4)){
     setTimeout("drawgl("+i+");",t300);
	 return;
   }
   var way=(ways[i]),test=1;
   var xx=0,xxx=0,yy=0,yyy=0,r=1,dr=1;
   var dx=0,dy=0,dxx=0,dyy=0,dx0=0,dy0=0,zz=0,zzz=0;
   var s=0,t=0,tt=0,rt=1;
   var di=1,xx0=0,yy0=0,zz0=0,xxx0=0,yyy0=0,zzz0=0;
   var dr0=1,oneway=0,bridge=0,colour="",structure="";icolor=0;
   var tparking=0,parkingx=0,parkingy=0,parkingz=0,parkingco1=1,parkingsi1=0;
   var building="",amenity="";
   waytype="none";wayname="";taddbar=0;layer=0;
   if(way.tags){
    if(way.tags.highway){
      waytype=way.tags.highway;
	  if(way.tags.oneway){var tag=way.tags.oneway;
	                      if(tag=="yes" || tag=="true" || tag=="1"){oneway=1;}}}
	if(way.tags.layer){layer=Math.min(1,way.tags.layer+0);}
	if(layer<=-1){layer=-2;}
	if(way.tags.bridge){bridge=1;layer=Math.max(0,layer);}
	if(way.tags["bridge:structure"]){structure=way.tags["bridge:structure"];}
	if(way.tags["building:colour"]){colour=way.tags["building:colour"];}
	if(way.tags.colour){colour=way.tags.colour;}
	if(colour!=""){
	                    if(colour=="white"){icolor=1;} 
	                    else if(colour=="orange"){icolor=2;} 
	                    else if(colour=="gray"){icolor=3;} 
	                    else if(colour=="green"){icolor=4;} 
	                    else if(colour=="blue"){icolor=5;}
	                    else if(colour=="red"){icolor=6;}
						else if(colour.indexOf("#")>=0){
						     if(colour.length>4){
						        var color="000000"+colour.substr(colour.indexOf("#")+1,6);
						        color=color.substr(color.length-6,6);
					            var r=Math.max(2,hextodec(color.substr(0,1)));
								var g=Math.max(2,hextodec(color.substr(2,1)));
								var b=Math.max(2,hextodec(color.substr(4,1)));
								icolor=parseInt(20000+(r*256+g*16+b)*256);
							 }else{
						        var color="000"+colour.substr(colour.indexOf("#")+1,3);
						        color=color.substr(color.length-3,3);
					            var r=Math.max(2,hextodec(color.substr(0,1)));
								var g=Math.max(2,hextodec(color.substr(1,1)));
								var b=Math.max(2,hextodec(color.substr(2,1)));
								icolor=parseInt(20000+(r*256+g*16+b)*256);
							 }	
					   }}
    if(icolor==0 && bridge==1){icolor=parseInt(1+(Math.abs(latx0+lngx0)*11.2)%6);}						
		  /*}else if(ty<109.9){gl_FragColor = vec4(1.0,1.0,1.0,1.0);//white
		  }else if(ty<119.9){gl_FragColor = vec4(1.0,0.3,0.0,1.0);//orange
		  }else if(ty<129.9){gl_FragColor = vec4(0.55,0.55,0.55,1.0);//gray
		  }else if(ty<139.9){gl_FragColor = vec4(0.0,0.7,0.0,1.0);//green
		  }else if(ty<149.9){gl_FragColor = vec4(0.1,0.1,0.8,1.0);//blue
		  }else if(ty<1999.9){gl_FragColor = vec4(1.0,0.0,0.0,1.0);//red
		  */
    if(way.tags.building){
      waytype="building";building=way.tags.building;}
    if(way.tags.amenity){
	  if(way.tags.amenity=="parking"){waytype="parking";}
	  else if(waytype="none"){waytype="building";}
	  amenity=way.tags.amenity;
	  }
    if(way.tags.aeroway){
      waytype=way.tags.aeroway;}
    if(way.tags.landuse){
      waytype=way.tags.landuse;}
    if(way.tags.natural){
      waytype=way.tags.natural;}
	if(way.tags.name){
	  if(waytype=="building"){wayname=way.tags.name.toLowerCase();}
	  else{wayname=way.tags.name;}
	   //if(wayname.indexOf("tour eiffel")==0){auxvar+=1;auxtext=wayname;}
	   //if(wayname.indexOf("pyramid of khufu")>=0){auxvar+=1;auxtext=wayname;}
	   //if(wayname.indexOf("united states capitol")==0){auxvar+=1;auxtext=wayname;}
	}
    }  
   //if(waytype=="none" || waytype=="path"){
   //  test=0;}
if(way.nodes){
   test=1;
   if(building=="hospital" || amenity=="hospital" || amenity=="clinic"){addhospital(way);}
   if(waytype=="building"){
     if(indexhouse<(maxvertice*3-1) || indextower<(maxvertice*3-1)){
		if(way.nodes.length>0){
		 if(latnodes[way.nodes[0]]){addtower(way);}}
		}
     test=0;
	 //context.lineWidth = 1;
     //context.strokeStyle = '#008fff';
   }else if(waytype=="aerodrome"){
     r=5;tairport=1;
   }else if(waytype=="runway"){
     r=8;tairport=1;
   }else if(waytype=="taxiway"){
     r=6;tairport=1;
   }else if(waytype=="parking"){
     r=0.87;tparking=1;
   }else if(waytype=="motorway"){
     r=2.8;taddbar=1;
	 //context.lineWidth = 4;
     //context.strokeStyle = '#ff0000';
   }else if(waytype=="trunk"){
     r=2.6;if(oneway==1){taddbar=1;}
	 //context.lineWidth = 3;
     //context.strokeStyle = '#cf0000';
   }else if(waytype=="primary"){
     r=2.4;
	 //context.lineWidth = 2;
     //context.strokeStyle = '#4f9f00';
   }else if(waytype=="secondary"){
     r=1.8;
	 //context.lineWidth = 1;
     //context.strokeStyle = '#00ff00';
   }else if(waytype=="tertiary"){
     r=1.2;
	 //context.lineWidth = 1;
     //context.strokeStyle = '#008f00';
   }else if(waytype=="service"){
     r=0.7
	 //context.lineWidth = 1;
     //context.strokeStyle = '#8f8f00';
   }else if(waytype=="pedestrian"){
	 r=0.5;rt=0.3
	 //context.lineWidth = 1;
     //context.strokeStyle = '#ffff00';
   }else if(waytype=="path"){
     r=0.35;rt=0.25
	 //context.lineWidth = 1;
     //context.strokeStyle = '#ff00ff';
   }else if(waytype=="forest"){
     addforest(way);test=0;
   }else if(waytype=="wood"){
     addforest(way);test=0;
   }else{//test=0;
     r=0.8;
	 //context.lineWidth = 1;
     //context.strokeStyle = '#000000';
   }
   r*=1.1;
   if(test==1 && indexroad<(maxvertice*3-1)){
   //context.beginPath();
   var jmax=way.nodes.length-1;
   var jmid=parseInt(jmax/2-0.1);
   var xmid=0,ymid=0,zmid=0,ztree=0;
   var jstart=0,dh=0.5,tth=0.1,th=0.11;
   var jmid=parseInt(jmax/2)+1;
   var drtree=999,drtree5=5;
   var latxx=0,lonxx=0,latxxx=0,lonxxx=0;
   var dzlayer=Math.max(0,layer*0.82);//0.015);
   if(layer<=-2){dzlayer=-ztunnel;}
   var smallbridge=0;
   var xxx0=0,yyy0=0,zzz0=0,r0=0,co10=0,si10=0;
   if((layer>0 || bridge>0) &&(jmax<5)){smallbridge=1;dzlayer=Math.max(dzlayer,0.82);}
   var airportx1=0,airporty1=0,nairport1=0;
   var dhr2=0;
   for(var j=0;j<=jmax;j++){
     if(j>0 && smallbridge==1 && j<jmax){j=jmax;}
	 var inode=way.nodes[j];
	 if(latnodes[inode]){
	   xxx=xx;yyy=yy;zzz=zz;
	   latxxx=latxx;lonxxx=lonxx;
	   latxx=latnodes[inode];
	   lonxx=lonnodes[inode];
	   yy=(latxx-latx0)*scale*2;
	   xx=((lonxx-lngx0)/klon)*scale*2;
       if(way.tags.aeroway && r>3){
		    airporty1+=latxx;airportx1+=lonxx;nairport1+=1;}
	   var dhr=Math.min(4,r)*0.003+0.005;
	   zz=getterrainheight(lonxx,latxx)+dhr;
	   //zz=getterrainheight(lonxx+dlonxx,latxx+dlatxx);
	   //zz=Math.max(zz,getterrainheight(lonxx-dlonxx,latxx-dlatxx));
	   if(zz<0){zz=0;}
	   //if (zz>0.001){zz=0;}else{zz=0.0012;}
	   dx0=dx;dy0=dy;
	   if(jstart==0){jstart=j+1;//context.moveTo(xx,yy);
			if(layernode2[inode]){if(layernode2[inode]>1.9){dhr2=0.82;}
			else if(layernode[inode]){dhr2=Math.max(0,Math.min(0.82,layernode[inode]*0.82));}}
			if(layer<=-2){dhr2=-ztunnel;}
	        zz+=dhr2;
	   }else{//context.lineTo(xx,yy);
	        dxx=xx-xxx;dyy=yy-yyy;
			dr=Math.max(0.00001,Math.sqrt(dxx*dxx+dyy*dyy));
			di=1;if(dr>6){di=parseInt(dr/4);}
			//di=1;if(dr>12){di=parseInt(dr/8);}
			dx=-r*dyy/dr;dy=r*dxx/dr;
			var dlon2=0,dlat2=0;
			if(bridge>=1){dlon2=0.5*dx*klon/(scale*2);dlat2=0.5*dy/(scale*2);
			   zz=(getterrainheight(lonxx+dlon2,latxx+dlat2)+dhr);}
			 if(tparking==1 && j==jstart){parkingx=xxx;parkingy=yyy,parkingz=zzz;
					                      parkingco1=dxx/dr;parkingsi1=dyy/dr;}
			if(j==jstart){dx0=dx;dy0=dy;
			         drtree5=5+(parseInt((latxx+lonxx)*100000)%3)*10;
			         xxx-=dy*0.4;yyy+=dx*0.4;
					 }
			else if(j==jmax){xx+=dy*0.4;yy-=dx*0.4;
			        if(smallbridge==1){dx0=dx;dy0=dy;}
			}
			if(j==jmax){dhr2=0;}
			if(layernode2[inode]){if(layernode2[inode]>1.9){dhr2=0.82;}
			else if(layernode[inode]){dhr2=Math.max(0,Math.min(0.82,layernode[inode]*0.82));}}
			else if(j>1 && j<jmax-1 || layer<=-2){zz+=dzlayer;}
			if(layer<=-2){dhr2=-ztunnel;}
			dr0=dr;
			var co1=dxx/dr,si1=dyy/dr;
			var tan2=(zz-zzz)/(dr);
			if(j==jstart){xxx0=xx;yyy0=yy;zzz0=zz;r0=r;co10=co1;si10=si1;}
			else if((co1*co10+si1*si10)<(0.9-0.0005*Math.max(Math.abs(xx-xxx0),Math.abs(yy-yyy0)))){
     		  if((co1*si10-si1*co10)<0){//turn left
			    addcross(xxx0+(r0+0.15)*si10+0.5*co10,yyy0-(r0+0.15)*co10+0.5*si10,zzz0+zsol0,r0+600,co10,si10);}
			  else{//turn right
			    addcross(xxx0+(r0+0.15)*si10-0.5*co10,yyy0-(r0+0.15)*co10-0.5*si10,zzz0+zsol0,r0+650,co10,si10);}
			  xxx0=xx;yyy0=yy;zzz0=zz;r0=r;co10=co1;si10=si1;	
			 }
            /*if(nodesignal[inode]){		      
              addcross(xxx+(r+0.25)*(si1),yyy-(r+0.25)*(co1),zzz+zsol0,r,co1,si1);
			  //else if(j==jstart){addcross(xx-(r+0.15)*(si1),yy+(r+0.15)*(co1),zz+zsol0,r,-co1,-si1);}
			  auxvar=icross;}*/	
		   /*if(tparking==1 && j>jstart){
			var xx2=(xx+xxx)/2,yy2=(yy+yyy)/2;
			var drk=0.00001+Math.sqrt((xx2-parkingx)*(xx2-parkingx)+(yy2-parkingy)*(yy2-parkingy));
			var dk=parseInt(Math.max(4,8*drk));
			var zz1=Math.max(0.1,parkingz-0.2);//0.5);
			var dlonxx=(parkingco1*klon/scale)*drk;
			var dlatxx=(parkingsi1/scale)*drk;
			var tan2=0;
			for(var k=0;k<=dk;k++){
			  setterrainheight((lonxx+lonxxx)/2-k*dlonxx/dk,(latxx+latxxx)/2-k*dlatxx/dk,-parkingco1,-parkingsi1,tan2,zz1);}
			var dhrr=0.012;
			dk=parseInt(dk/4);
			index=indexroad;
			for(var k=3;k<dk;k++){
		    append(roadvertices,[
              parkingx+(k-1)*(xxx-parkingx)/dk,parkingy+(k-1)*(yyy-parkingy)/dk,parkingz+dhrr,
              parkingx+k*(xxx-parkingx)/dk,parkingy+k*(yyy-parkingy)/dk,parkingz+dhrr,
              parkingx+k*(xx-parkingx)/dk,parkingy+k*(yy-parkingy)/dk,parkingz+dhrr,
			  
              parkingx+(k-1)*(xxx-parkingx)/dk,parkingy+(k-1)*(yyy-parkingy)/dk,parkingz+dhrr,
              parkingx+k*(xx-parkingx)/dk,parkingy+k*(yy-parkingy)/dk,parkingz+dhrr,
              parkingx+(k-1)*(xx-parkingx)/dk,parkingy+(k-1)*(yy-parkingy)/dk,parkingz+dhrr
            ]);}
			indexroad=index;
			var parkingss=(xxx-parkingx)*parkingco1+(yyy-parkingy)*parkingsi1;
			var parkingtt=(xxx-parkingx)*parkingsi1-(yyy-parkingy)*parkingco1;
			var parkings=(xx-parkingx)*parkingco1+(yy-parkingy)*parkingsi1;
			var parkingt=(xx-parkingx)*parkingsi1-(yy-parkingy)*parkingco1;
			index=itextroad;
			for(var k=3;k<dk;k++){
			append(roadtextureCoords,[
			  (k-1)*parkingss*0.3/dk,(k-1)*parkingtt*0.3/dk,
			  k*parkingss*0.3/dk,k*parkingtt*0.3/dk,
			  k*parkings*0.3/dk,k*parkingt*0.3/dk,
			  
			  (k-1)*parkingss*0.3/dk,(k-1)*parkingtt*0.3/dk,
			  k*parkings*0.3/dk,k*parkingt*0.3/dk,
			  (k-1)*parkings*0.3/dk,(k-1)*parkingt*0.3/dk
            ]);}
			itextroad=index;
			dk=parseInt(dr-2);
			for(var k=2;k<dk;k++){
			if(iroad<nroad-1){
			  roadx[iroad]=parkingx-parkingsi1*2;roady[iroad]=parkingy+parkingco1*2;
			  roadr[iroad]=0.5*dr/dk;
			  xx2=xxx+(k+0.5)*(xx-xxx)/dk;
			  yy2=yyy+(k+0.5)*(yy-yyy)/dk;
			  drk=0.00001+Math.sqrt((xx2-parkingx)*(xx2-parkingx)+(yy2-parkingy)*(yy2-parkingy));
			  roadl[iroad]=drk;
			  roadco1[iroad]=(xx2-parkingx)/drk;
			  roadsi1[iroad]=(yy2-parkingy)/drk;
			  roadtan2[iroad]=0;
			  roadz[iroad]=Math.max(zz,parkingz+0.05);
			  roadoneway[iroad]=0;
			  roadcross[iroad]=0;
			  //iroadcross=iroad;
			  iroad+=1;
			}}
		   }*/
            if(smallbridge==1 && di<3){di=3;}
			dr=dr0/di;
			var dh=0.005,dxdh=dx*1.2,dydh=dy*1.2;
			var dx0dh=dx0*1.2,dy0dh=dy0*1.2;
			var dxxii=(xx-xxx)/di;
			var dyyii=(yy-yyy)/di;
			var ddxdhii=(dxdh-dx0dh)/di;
			var ddydhii=(dydh-dy0dh)/di;
			var ddxii=(dx-dx0)/di;
			var ddyii=(dy-dy0)/di;
			var dlonii=(lonxx-lonxxx)/di;
			var dlatii=(latxx-latxxx)/di;
			xx=xxx;yy=yyy;
			dxdh=dx0dh;dydh=dy0dh;
			dx=dx0;dy=dy0;
			var zz1=zzz;zz2=zz;
			if(bridge==1 || layer>0){
			   if(zz1<0.02){zz1=Math.max(0.1,getterrainheightsrtm(lonxxx,latxxx));}
			   if(zz2<0.02){zz2=Math.max(0.1,getterrainheightsrtm(lonxx,latxx));}
			}
			latxx=latxxx;lonxx=lonxxx;
		   for(var ii=1;ii<=di;ii++){
			if(ii<(di-100) &&(Math.abs(xx-x)>700 || Math.abs(yy-y)>700)){
			 ii+=99;
			 xx+=dxxii*100;
			 yy+=dyyii*100;
			 dxdh+=ddxdhii*100;
			 dydh+=ddydhii*100;
			 dx+=ddxii*100;
			 dy+=ddyii*100;
			 lonxx+=dlonii*100;
			 latxx+=dlatii*100;
			}else if(ii<(di-10) &&(Math.abs(xx-x)>340 || Math.abs(yy-y)>340)){
			 ii+=9;
			 xx+=dxxii*10;
			 yy+=dyyii*10;
			 dxdh+=ddxdhii*10;
			 dydh+=ddydhii*10;
			 dx+=ddxii*10;
			 dy+=ddyii*10;
			 lonxx+=dlonii*10;
			 latxx+=dlatii*10;
			}else{
			 xx+=dxxii;
			 yy+=dyyii;
			 dxdh+=ddxdhii;
			 dydh+=ddydhii;
			 dx+=ddxii;
			 dy+=ddyii;
			 lonxx+=dlonii;
			 latxx+=dlatii;
			}
			//zz=setterrainheight(lonxx,latxx,co1,si1,tan2);
			if(smallbridge==1){zz=(getterrainheight(lonxx+dlon2,latxx+dlat2)+dhr);
			           if(ii<di){zz+=dzlayer;}else{zz+=dhr2;}}
			else if(bridge>=1){zz=(getterrainheight(lonxx+dlon2,latxx+dlat2)+dhr);
			           if(ii<di){zz+=dzlayer;}else{zz+=dhr2;}
			              zz=Math.max(zz,zz1+(zz2-zz1)*ii/(di));
			              //zz=Math.max(zz,zz1+(zz2-zz1)/(di-ii+1));
			              //zz1=zz;
						  }
			else if(layer>=1){zz=(getterrainheight(lonxx,latxx)+dhr);
			           if(ii<di){zz+=dzlayer;}else{zz+=dhr2;}
			              zz=Math.max(zz,zz1+(zz2-zz1)*ii/(di));}
			else if(layer<=-2){zz=(getterrainheight(lonxx,latxx)+dhr);
					   if(ii<di){zz+=dzlayer;}else if(j<jmax){zz+=dhr2;}
			              }
			else{zz=getterrainheight(lonxx,latxx)+dhr;}
			//zz=getterrainheight(lonxx+dlonxx,latxx+dlatxx);
			//zz=Math.max(zz,getterrainheight(lonxx-dlonxx,latxx-dlatxx));
			if(zz<-ztunnel){zz=-ztunnel;}
			if(ii==1 && j==jstart){zzz-=dhr2;}
			tan2=(zz-zzz)/dr;
		    var testband=0;
	    	if(r>0.68 && bridge==0 && layer==0){
			 if(ii==1){
    		  if(j==(jstart)){		    
        	    if(dr0>10 || jmax>4){testband=2;}}}
			 if(ii==di){
    		  if(j==(jmax)){		    
        	    if(dr0>10 || jmax>4){testband=1;}}}
			}
		if((xx-x)*(xx-x)+(yy-y)*(yy-y)<Math.max(200*200,5*dxmax*5*dxmax)){
			if(iroad<nroad){
			  roadx[iroad]=xxx;roady[iroad]=yyy;
			  roadr[iroad]=r;
			  roadl[iroad]=dr;
			  roadco1[iroad]=co1;//dxx/dr;
			  roadsi1[iroad]=si1;//dyy/dr;
			  roadtan2[iroad]=tan2;
			  roadz[iroad]=zzz;
			  roadoneway[iroad]=oneway;
			  roadname[iroad]=wayname;
			  roadcross[iroad]=0;
			  roadlayer[iroad]=layer;
			  if(layer<=-2){if((ii==1 && j==jstart)||(ii==di && j==jmax)){roadlayer[iroad]=-1;}}
			  iroadcross=iroad;
			  iroad+=1;
			}
			var zzsave=zz,zzzsave=zzz;
			//zz+=dzlayer;zzz+=dzlayer;
			index=indexroad;
			if(testband==0){
		    append(roadvertices,[
              xxx-dx0,yyy-dy0,zzz,
			  xx+dx,yy+dy,zz,
			  xxx+dx0,yyy+dy0,zzz,
			  xxx-dx0,yyy-dy0,zzz,
			  xx-dx,yy-dy,zz,
			  xx+dx,yy+dy,zz
            ]);
			}
			if(r>1){
		    append(roadvertices,[			  
			  xxx-dx0,yyy-dy0,zzz,
			  xx-dx,yy-dy,zz,
			  xx-dxdh,yy-dydh,zz-dh,
			  xxx-dx0,yyy-dy0,zzz,
			  xx-dxdh,yy-dydh,zz-dh,
			  xxx-dx0dh,yyy-dy0dh,zzz-dh,
			  
			  xxx+dx0,yyy+dy0,zzz,
			  xx+dx,yy+dy,zz,
			  xx+dxdh,yy+dydh,zz-dh,
			  xxx+dx0,yyy+dy0,zzz,
			  xx+dxdh,yy+dydh,zz-dh,
			  xxx+dx0dh,yyy+dy0dh,zzz-dh
			  
            ]);}
		    /*append(roadvertices,[
              xxx-dx0,yyy-dy0,zzz,
			  xx-dx,yy-dy,zz-dh,
			  xx-dx,yy-dy,zz,
			  xxx-dx0,yyy-dy0,zzz,
			  xxx-dx0,yyy-dy0,zzz-dh,
			  xx-dx,yy-dy,zz-dh,
			  
              xxx+dx0,yyy+dy0,zzz,
			  xx+dx,yy+dy,zz-dh,
			  xx+dx,yy+dy,zz,
			  xxx+dx0,yyy+dy0,zzz,
			  xxx+dx0,yyy+dy0,zzz-dh,
			  xx+dx,yy+dy,zz-dh 
            ]);*/
			indexroad=index;
			zz=zzsave;zzz=zzzsave;
			s=1;tt=t;t+=dr*0.3;
			index=itextroad;
		    var s1=rt-0.1,s0=0.1;
			if(testband==0){
			append(roadtextureCoords,[
			  s0,tt,
			  s1,t,
			  s1,tt,
			  s0,tt,
			  s0,t,
			  s1,t
            ]);
			}
			if(r>1){
		    append(roadtextureCoords,[  
			  0.1,tt,
			  0.1,t,
			  0,t,
			  0.1,tt,
			  0,t,
			  0,tt,
			  
			  0.1,tt,
			  0.1,t,
			  0,t,
			  0.1,tt,
			  0,t,
			  0,tt
			  
            ]);
			}
		    /*append(roadtextureCoords,[
			  0,tth,
			  0.1,th,
			  0.1,tth,
			  0,tth,
			  0,th,
			  0.1,th,
			  
			  0,tth,
			  0.1,th,
			  0.1,tth,
			  0,tth,
			  0,th,
			  0.1,th
            ]);*/
			itextroad=index;
			drtree+=dr;
			//if(j==jstart || (j==jmid && jmid!=jstart)){
	        if(drtree>drtree5 && (layer==0 || bridge>0)){
			  drtree=0;
			  ztree=(latnodes[inode]+lonnodes[inode])*1000000;
	          ztree=(ztree-100*parseInt(ztree/100))/2000;
	          ztree+=zsol0-0.01;//-0.06+zsol0;
              addtree(xxx-(r+0.5)*(si1-co1),yyy+(r+0.5)*(co1+si1),ztree);
              //if(bridge>0){if(r>0.8){addline(xxx+(r+0.19)*(si1-co1),yyy-(r+0.19)*(co1+si1),zzz+zsol0,0.017,co1,si1);}
			  if(r>0.8){addline(xxx+(r+0.3)*(si1-co1),yyy-(r+0.3)*(co1+si1),zzz+zsol0,0.017,co1,si1);}
			}
			if(tparking==1 && (ii%5)==1){
			    ttestroadcross=1;
			    addcross(xxx+(r+0.15)*(si1),yyy-(r+0.15)*(co1),zzz+zsol0,r+500,co1,si1);//parking
			    addcross(xxx-(r+0.15)*(si1),yyy+(r+0.15)*(co1),zzz+zsol0,r+500,-co1,-si1);//parking
				ttestroadcross=1;}
			else if(r>2.7 && (ii%20)==10 && (parseInt(Math.abs(xxx+yyy))%4)==0){
			    addcross(xxx+(r+0.5)*(si1),yyy-(r+0.5)*(co1),zzz+zsol0,r+400,co1,si1);}//highway
			else if(testband==0 && (ii%20)==10){
			//if(testband==0 && (ii%16)==7){
			    if(oneway==1){addcross(xxx+(r+0.15)*(si1),yyy-(r+0.15)*(co1),zzz+zsol0,r+100,co1,si1);
							  addcross(xxx-(r+0.15)*(si1),yyy+(r+0.15)*(co1),zzz+zsol0,r+100,co1,si1);
							  if(r>0.9){addroadarrow(xxx+r*(0.48*si1+co1),yyy-r*(0.48*co1-si1),zzz+r*tan2,co1,si1,tan2);
    				              addroadarrow(xxx-r*(0.48*si1-co1),yyy+r*(0.48*co1+si1),zzz+r*tan2,co1,si1,tan2);}
							 }
			    else if(r>0.9){addroadarrow(xxx+r*(0.48*si1+co1),yyy-r*(0.48*co1-si1),zzz+r*tan2,co1,si1,tan2);
				             addroadarrow(xxx-r*(0.48*si1-co1),yyy+r*(0.48*co1+si1),zzz+r*tan2,-co1,-si1,-tan2);
			    }};
			if(testband>=1){
            if(j>jstart){addcross(xxx+(r+0.15)*(si1),yyy-(r+0.15)*(co1),zzz+zsol0,r,co1,si1);
			    if(oneway==1){addcross(xxx-(r+0.15)*(si1),yyy+(r+0.15)*(co1),zzz+zsol0,r+200,-co1,-si1);}
			}else{if(oneway==0){addcross(xx-(r+0.15)*(si1),yy+(r+0.15)*(co1),zz+zsol0,r,-co1,-si1);}
			    if(oneway==1){addcross(xx+(r+0.15)*(si1),yy-(r+0.15)*(co1),zz+zsol0,r+100,co1,si1);
			                  addcross(xx-(r+0.15)*(si1),yy+(r+0.15)*(co1),zz+zsol0,r+100,co1,si1);}

			if(layer==0){addwoman(xx-(r+0.4)*(si1-co1),yy+(r+0.4)*(co1+si1),zz+zsol0,r,-si1,co1);}}
			index=indexroadband;
		    append(roadbandvertices,[
              xxx-dx0,yyy-dy0,zzz,
			  xx+dx,yy+dy,zz,
			  xxx+dx0,yyy+dy0,zzz,
			  xxx-dx0,yyy-dy0,zzz,
			  xx-dx,yy-dy,zz,
			  xx+dx,yy+dy,zz
            ]);
			indexroadband=index;
			index=itextroadband;
            var ttb=0;tb=1;
			if(testband==2){ttb=1;tb=0;}
			append(roadbandtextureCoords,[
			  s0,ttb,
			  s1,tb,
			  s1,ttb,
			  s0,ttb,
			  s0,tb,
			  s1,tb
            ]);
			itextroadband=index;
			}
			if(bridge==1 && (di*dr)>70 && (structure=="suspension" || r>2.4)){
			     var kr=1,kr1=1;if(r>1){kr=1.3;kr1=1.193;}
				 var xxx0=xxx+(r*kr1)*si1,yyy0=yyy-(r*kr1)*co1;
			     var xxx1=xxx-(r*kr1)*si1,yyy1=yyy+(r*kr1)*co1;
			     var khi=1,ki=parseInt(di*dr/70);///(di);
				 if(ki>2.9){khi=2;ki=parseInt(ki/2)/di;}
				 else{ki=parseInt(ki)/di;}
				 for(var p=0.8;p<2;p++){
				    var hi;
					if(co1>0){hi=Math.abs(Math.sin(3.1416*(ii+p/2)*ki));}
					else{hi=Math.abs(Math.sin(3.1416*(di-ii+2-p/2)*ki));}
					hi=khi*r*11*hi*hi+3;
					var zzzi=zzz+tan2*dr*p/2;
				    addbar(xxx0+co1*dr*p/2,yyy0+si1*dr*p/2,zzzi,0.275,co1,si1,tan2,hi,icolor,1);
				    //if(oneway==0){
				    addbar(xxx1+co1*dr*p/2,yyy1+si1*dr*p/2,zzzi,0.275,co1,si1,tan2,hi,icolor,-1);
					}//}
				 }
			else if(bridge==1 && layer<=0){
			        addbar(xxx-dx0*1.1,yyy-dy0*1.1,zzz,dr,co1,si1,tan2,1,2,1);
					//if(oneway==0){
			         addbar(xxx+dx0*1.1,yyy+dy0*1.1,zzz,dr,co1,si1,tan2,1,2,-1);
					//}
					}
			else if(layer>0){
			        addbar(xxx-dx0*1.1,yyy-dy0*1.1,zzz,dr*0.9,co1,si1,tan2,0.85,1,1);
					//if(oneway==0){
			         addbar(xxx+dx0*1.1,yyy+dy0*1.1,zzz,dr*0.9,co1,si1,tan2,0.85,1,-1);
					//}
					}
			else if(layer<=-2){
			     var kr=1,kr1=1;if(r>1){kr=1.3;kr1=1.193;}
				 var xxx0=xxx+(r*kr1)*si1,yyy0=yyy-(r*kr1)*co1;
			     var xxx1=xxx-(r*kr1)*si1,yyy1=yyy+(r*kr1)*co1;
				 var hi=12,icolor2=5;if((j==jstart && ii<=1)||(j==jmax && ii>=di)){hi=18;}
				 for(var p=0.8;p<3;p++){
					var zzzi=zzz+tan2*dr*p/3;
				    addbar(xxx0+co1*dr*p/3,yyy0+si1*dr*p/3,zzzi,1,co1,si1,tan2,hi,icolor2,1);
				    //if(oneway==0){
				    addbar(xxx1+co1*dr*p/3,yyy1+si1*dr*p/3,zzzi,1,co1,si1,tan2,hi,icolor2,-1);
					}
					}
			else if(taddbar>0){addbar(xxx+(r*1.3)*si1,yyy-(r*1.3)*co1,zzz,dr,co1,si1,tan2,1,0,1);}
		}//dxmax
			xxx=xx;yyy=yy;zzz=zz;
			dx0dh=dxdh;dy0dh=dydh;
			dx0=dx;dy0=dy;
		   }//ii
           //xx=xx0;yy=yy0;zz=zz0;
		   }
	 }  
   }
   if(nairport1>0.1){airportx1/=nairport1;airporty1/=nairport1;
      var dist=scale*Math.max(Math.abs(airportx1-lngx)/klon,Math.abs(airporty1-latx));
	  if(dist<distairport1){
	     distairport1=dist;
	     airportx=airportx1;airporty=airporty1;
	  //}
	  //if(dist<distairport2){
	     if(way.tags.name){distairport2=dist;airportname=way.tags.name;}
		 else{airportname="";}
	  }
	  }
}//(way.nodes)
   //context.stroke();
   }}
   //addtower2();
   //ibuff=ibuff1;
   //updatebuffers();
   
   context.font = "12pt Arial";
   context.fillStyle = '#ff0000';
   //var latt=parseInt(lat*1000)/1000;
   //var lngg=parseInt(lng*1000)/1000;
   //context.fillText("lat="+latt+" lon="+lngg,20,20);
   nways=i;
   context.fillText("nways="+i+" nnodes="+nnode,20,20);
   //context.fillText("M => map",20,60);
   //alert("drawways="+i);
   //loading=0;
   addstationtest();
   addhospitaltest();
   addrailstationtest();
   addgmaptreetest();
   addtreetest();
   addlinetest();
   addbartest();
   addcrosstest();
   settowernormals();
   setchurchnormals();
   sethousenormals();
   setofficialnormals();
   sethospitalnormals();
   setshopnormals();
   //setroadnormals();
   //updatebuffersolheight();
   //loading=0;dtloading=tframe;
   tupdatebuffer=1;
}
function addtower2(){
for(var i=0;i<iway2.length;i++){
   var way=ways2[iway2[i]];
   waytype="none";wayname="";taddbar=0;layer=0;
   if(way.tags){
	if(way.tags.layer){layer=way.tags.layer+0;}
    if(way.tags.building){
      waytype="building";}
    if(way.tags.amenity){
	  if(waytype="none"){waytype="building";}}
	if(way.tags.landuse){
      waytype=way.tags.landuse;}
    if(way.tags.natural){
      waytype=way.tags.natural;}
	if(way.tags.name && waytype=="building"){
	   wayname=way.tags.name.toLowerCase();
	   //if(wayname.indexOf("tour eiffel")==0){auxvar+=1;auxtext=wayname;}
	   //if(wayname.indexOf("pyramid of khufu")>=0){auxvar+=1;auxtext=wayname;}
	   //if(wayname.indexOf("united states capitol")==0){auxvar+=1;auxtext=wayname;}
	}
    }  
    if(way.nodes){
     if(indexhouse<(maxvertice*3-1) && indextower<(maxvertice*3-1)){
		addtower(way);}else{break;}}
}}
function settowernormals(){
var x,y,z,r;
var Ax,Ay,Az,Bx,By,Bz,Cx,Cy,Cz;
index=0;
for(var i=0;i<indextower;i++){
 Ax=towervertices[i];i++;
 Ay=towervertices[i];i++;
 Az=towervertices[i];i++;
 Bx=towervertices[i];i++;
 By=towervertices[i];i++;
 Bz=towervertices[i];i++;
 Cx=towervertices[i];i++;
 Cy=towervertices[i];i++;
 Cz=towervertices[i];
 x = (By - Ay) * (Cz - Az) - (Bz - Az) * (Cy - Ay);
 y = (Bz - Az) * (Cx - Ax) - (Bx - Ax) * (Cz - Az);
 z = (Bx - Ax) * (Cy - Ay) - (By - Ay) * (Cx - Ax);
 r=Math.sqrt(x*x+y*y+z*z);
 if(r<0.000001){r=0.000001;}
 r=1/r;
 x*=r;y*=r;z*=r;
 append(towernormals,[
	    x,y,z, x,y,z, x,y,z
            ]);
 } 
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexNormalBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (towernormals), gl.STATIC_DRAW);
   towerVertexNormalBuffer[ibuff1].itemSize = 3;
   towerVertexNormalBuffer[ibuff1].numItems = index/3;
   //ibuff=ibuff0;
}
function setchurchnormals(){
var x,y,z,r;
var Ax,Ay,Az,Bx,By,Bz,Cx,Cy,Cz;
index=0;
for(var i=0;i<indexchurch;i++){
 Ax=churchvertices[i];i++;
 Ay=churchvertices[i];i++;
 Az=churchvertices[i];i++;
 Bx=churchvertices[i];i++;
 By=churchvertices[i];i++;
 Bz=churchvertices[i];i++;
 Cx=churchvertices[i];i++;
 Cy=churchvertices[i];i++;
 Cz=churchvertices[i];
 x = (By - Ay) * (Cz - Az) - (Bz - Az) * (Cy - Ay);
 y = (Bz - Az) * (Cx - Ax) - (Bx - Ax) * (Cz - Az);
 z = (Bx - Ax) * (Cy - Ay) - (By - Ay) * (Cx - Ax);
 r=Math.sqrt(x*x+y*y+z*z);
 if(r<0.000001){r=0.000001;}
 r=1/r;
 x*=r;y*=r;z*=r;
 append(churchnormals,[
	    x,y,z, x,y,z, x,y,z
            ]);
 } 
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexNormalBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (churchnormals), gl.STATIC_DRAW);
   churchVertexNormalBuffer[ibuff1].itemSize = 3;
   churchVertexNormalBuffer[ibuff1].numItems = index/3;
   //ibuff=ibuff0;
}
function sethousenormals(){
var x,y,z,r;
var Ax,Ay,Az,Bx,By,Bz,Cx,Cy,Cz;
index=0;
for(var i=0;i<indexhouse;i++){
 Ax=housevertices[i];i++;
 Ay=housevertices[i];i++;
 Az=housevertices[i];i++;
 Bx=housevertices[i];i++;
 By=housevertices[i];i++;
 Bz=housevertices[i];i++;
 Cx=housevertices[i];i++;
 Cy=housevertices[i];i++;
 Cz=housevertices[i];
 x = (By - Ay) * (Cz - Az) - (Bz - Az) * (Cy - Ay);
 y = (Bz - Az) * (Cx - Ax) - (Bx - Ax) * (Cz - Az);
 z = (Bx - Ax) * (Cy - Ay) - (By - Ay) * (Cx - Ax);
 r=Math.sqrt(x*x+y*y+z*z);
 if(r<0.000001){r=0.000001;}
 r=1/r;
 x*=r;y*=r;z*=r;
 append(housenormals,[
	    x,y,z, x,y,z, x,y,z
            ]);
 } 
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexNormalBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (housenormals), gl.STATIC_DRAW);
   houseVertexNormalBuffer[ibuff1].itemSize = 3;
   houseVertexNormalBuffer[ibuff1].numItems = index/3;
   //ibuff=ibuff0;
}
function setofficialnormals(){
var x,y,z,r;
var Ax,Ay,Az,Bx,By,Bz,Cx,Cy,Cz;
index=0;
for(var i=0;i<indexofficial;i++){
 Ax=officialvertices[i];i++;
 Ay=officialvertices[i];i++;
 Az=officialvertices[i];i++;
 Bx=officialvertices[i];i++;
 By=officialvertices[i];i++;
 Bz=officialvertices[i];i++;
 Cx=officialvertices[i];i++;
 Cy=officialvertices[i];i++;
 Cz=officialvertices[i];
 x = (By - Ay) * (Cz - Az) - (Bz - Az) * (Cy - Ay);
 y = (Bz - Az) * (Cx - Ax) - (Bx - Ax) * (Cz - Az);
 z = (Bx - Ax) * (Cy - Ay) - (By - Ay) * (Cx - Ax);
 r=Math.sqrt(x*x+y*y+z*z);
 if(r<0.000001){r=0.000001;}
 r=1/r;
 x*=r;y*=r;z*=r;
 append(officialnormals,[
	    x,y,z, x,y,z, x,y,z
            ]);
 } 
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexNormalBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (officialnormals), gl.STATIC_DRAW);
   officialVertexNormalBuffer[ibuff1].itemSize = 3;
   officialVertexNormalBuffer[ibuff1].numItems = index/3;
   //ibuff=ibuff0;
}
function sethospitalnormals(){
var x,y,z,r;
var Ax,Ay,Az,Bx,By,Bz,Cx,Cy,Cz;
index=0;
for(var i=0;i<indexhospital;i++){
 Ax=hospitalvertices[i];i++;
 Ay=hospitalvertices[i];i++;
 Az=hospitalvertices[i];i++;
 Bx=hospitalvertices[i];i++;
 By=hospitalvertices[i];i++;
 Bz=hospitalvertices[i];i++;
 Cx=hospitalvertices[i];i++;
 Cy=hospitalvertices[i];i++;
 Cz=hospitalvertices[i];
 x = (By - Ay) * (Cz - Az) - (Bz - Az) * (Cy - Ay);
 y = (Bz - Az) * (Cx - Ax) - (Bx - Ax) * (Cz - Az);
 z = (Bx - Ax) * (Cy - Ay) - (By - Ay) * (Cx - Ax);
 r=Math.sqrt(x*x+y*y+z*z);
 if(r<0.000001){r=0.000001;}
 r=1/r;
 x*=r;y*=r;z*=r;
 append(hospitalnormals,[
	    x,y,z, x,y,z, x,y,z
            ]);
 } 
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexNormalBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (hospitalnormals), gl.STATIC_DRAW);
   hospitalVertexNormalBuffer[ibuff1].itemSize = 3;
   hospitalVertexNormalBuffer[ibuff1].numItems = index/3;
   //ibuff=ibuff0;
}
function setshopnormals(){
var x,y,z,r;
var Ax,Ay,Az,Bx,By,Bz,Cx,Cy,Cz;
index=0;
for(var i=0;i<indexshop;i++){
 Ax=shopvertices[i];i++;
 Ay=shopvertices[i];i++;
 Az=shopvertices[i];i++;
 Bx=shopvertices[i];i++;
 By=shopvertices[i];i++;
 Bz=shopvertices[i];i++;
 Cx=shopvertices[i];i++;
 Cy=shopvertices[i];i++;
 Cz=shopvertices[i];
 x = (By - Ay) * (Cz - Az) - (Bz - Az) * (Cy - Ay);
 y = (Bz - Az) * (Cx - Ax) - (Bx - Ax) * (Cz - Az);
 z = (Bx - Ax) * (Cy - Ay) - (By - Ay) * (Cx - Ax);
 r=Math.sqrt(x*x+y*y+z*z);
 if(r<0.000001){r=0.000001;}
 r=1/r;
 x*=r;y*=r;z*=r;
 append(shopnormals,[
	    x,y,z, x,y,z, x,y,z
            ]);
 } 
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexNormalBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (shopnormals), gl.STATIC_DRAW);
   shopVertexNormalBuffer[ibuff1].itemSize = 3;
   shopVertexNormalBuffer[ibuff1].numItems = index/3;
   //ibuff=ibuff0;
}
function setroadnormals(){
var x,y,z,r;
var Ax,Ay,Az,Bx,By,Bz,Cx,Cy,Cz;
index=0;
for(var i=0;i<indexroad;i++){
 Ax=roadvertices[i];i++;
 Ay=roadvertices[i];i++;
 Az=roadvertices[i];i++;
 Bx=roadvertices[i];i++;
 By=roadvertices[i];i++;
 Bz=roadvertices[i];i++;
 Cx=roadvertices[i];i++;
 Cy=roadvertices[i];i++;
 Cz=roadvertices[i];
 x = (By - Ay) * (Cz - Az) - (Bz - Az) * (Cy - Ay);
 y = (Bz - Az) * (Cx - Ax) - (Bx - Ax) * (Cz - Az);
 z = (Bx - Ax) * (Cy - Ay) - (By - Ay) * (Cx - Ax);
 r=Math.sqrt(x*x+y*y+z*z);
 if(r<0.000001){r=0.000001;}
 r=1/r;
 x*=r;y*=r;z*=r;
 append(roadnormals,[
	    x,y,z, x,y,z, x,y,z
            ]);
 } 
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexNormalBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (roadnormals), gl.STATIC_DRAW);
   roadVertexNormalBuffer[ibuff1].itemSize = 3;
   roadVertexNormalBuffer[ibuff1].numItems = index/3;
   //ibuff=ibuff0;
}
function updateiroad(){
   for(var i=0;i<iroad;i++){
      road0x[i]=roadx[i];
      road0y[i]=roady[i];
      road0r[i]=roadr[i];
      road0l[i]=roadl[i];
      road0co1[i]=roadco1[i];
      road0si1[i]=roadsi1[i];
      road0tan2[i]=roadtan2[i];
      road0z[i]=roadz[i];
      road0oneway[i]=roadoneway[i];
      road0name[i]=roadname[i];
	  road0cross[i]=roadcross[i];
	  road0layer[i]=roadlayer[i];
   }
   iroad0=iroad;
   roadlng0=lngx0;
   roadlat0=latx0;
   var dx=(lng0-lngx0)*scale/klon;
   var dy=(lat0-latx0)*scale;
   for(var i=0;i<iwall;i++){
      wallx0[i]=wallx[i]*0.5+dx;
      wally0[i]=wally[i]*0.5+dy;
      wallco10[i]=wallco1[i];
      wallsi10[i]=wallsi1[i];
      walll0[i]=walll[i]*0.5;
	  wallh0[i]=wallh[i];
   }
   iwall0=iwall;
   for(var i=0;i<iwalltree;i++){
      walltreex0[i]=walltreex[i]*0.5+dx;
      walltreey0[i]=walltreey[i]*0.5+dy;
	  walltreeh0[i]=walltreeh[i];
   }
   iwalltree0=iwalltree;
   //for(var i=0;i<ncitypanel;i++){
   //   citypanelx[i]+=dx;
   //   citypanely[i]+=dy;
   //}
   for(var i=0;i<nstation;i++){
     
      stationlat0[i]=stationlat[i];
      stationlon0[i]=stationlon[i];
      stationx0[i]=stationx[i];
      stationy0[i]=stationy[i];
      if(stationz[i]>-999){stationz0[i]=getterrainheight(stationlon0[i],stationlat0[i]);}
	  else{stationz0[i]=-999999;}
      stationo10[i]=stationo1[i];
   }
   nstation0=nstation;
   
   for(var i=1;i<=nstop;i++){stopx0[i]=stopx[i];stopy0[i]=stopy[i];stopz0[i]=stopz[i];
                             stopco10[i]=stopco1[i];stopsi10[i]=stopsi1[i];
   }
   nstop0=nstop;
}
function updatebuffer1(){   
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (roadvertices), gl.STATIC_DRAW);
   roadVertexPositionBuffer[ibuff1].itemSize = 3;
   roadVertexPositionBuffer[ibuff1].numItems = indexroad/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, roadVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (roadtextureCoords), gl.STATIC_DRAW);
   roadVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   roadVertexTextureCoordBuffer[ibuff1].numItems = itextroad/2;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, roadbandVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (roadbandvertices), gl.STATIC_DRAW);
   roadbandVertexPositionBuffer[ibuff1].itemSize = 3;
   roadbandVertexPositionBuffer[ibuff1].numItems = indexroadband/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, roadbandVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (roadbandtextureCoords), gl.STATIC_DRAW);
   roadbandVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   roadbandVertexTextureCoordBuffer[ibuff1].numItems = itextroadband/2;
   //ibuff=ibuff0;
tupdatebuffer=2;
}
function updatebuffer2(){
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (towervertices), gl.STATIC_DRAW);//DYNAMIC_DRAW
   towerVertexPositionBuffer[ibuff1].itemSize = 3;
   towerVertexPositionBuffer[ibuff1].numItems = indextower/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (towertextureCoords), gl.STATIC_DRAW);
   towerVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   towerVertexTextureCoordBuffer[ibuff1].numItems = itexttower/2;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (churchvertices), gl.STATIC_DRAW);//DYNAMIC_DRAW
   churchVertexPositionBuffer[ibuff1].itemSize = 3;
   churchVertexPositionBuffer[ibuff1].numItems = indexchurch/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, churchVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (churchtextureCoords), gl.STATIC_DRAW);
   churchVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   churchVertexTextureCoordBuffer[ibuff1].numItems = itextchurch/2;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (housevertices), gl.STATIC_DRAW);//DYNAMIC_DRAW
   houseVertexPositionBuffer[ibuff1].itemSize = 3;
   houseVertexPositionBuffer[ibuff1].numItems = indexhouse/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, houseVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (housetextureCoords), gl.STATIC_DRAW);
   houseVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   houseVertexTextureCoordBuffer[ibuff1].numItems = itexthouse/2;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (officialvertices), gl.STATIC_DRAW);//DYNAMIC_DRAW
   officialVertexPositionBuffer[ibuff1].itemSize = 3;
   officialVertexPositionBuffer[ibuff1].numItems = indexofficial/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, officialVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (officialtextureCoords), gl.STATIC_DRAW);
   officialVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   officialVertexTextureCoordBuffer[ibuff1].numItems = itextofficial/2;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (hospitalvertices), gl.STATIC_DRAW);//DYNAMIC_DRAW
   hospitalVertexPositionBuffer[ibuff1].itemSize = 3;
   hospitalVertexPositionBuffer[ibuff1].numItems = indexhospital/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, hospitalVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (hospitaltextureCoords), gl.STATIC_DRAW);
   hospitalVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   hospitalVertexTextureCoordBuffer[ibuff1].numItems = itexthospital/2;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (shopvertices), gl.STATIC_DRAW);//DYNAMIC_DRAW
   shopVertexPositionBuffer[ibuff1].itemSize = 3;
   shopVertexPositionBuffer[ibuff1].numItems = indexshop/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, shopVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (shoptextureCoords), gl.STATIC_DRAW);
   shopVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   shopVertexTextureCoordBuffer[ibuff1].numItems = itextshop/2;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
   treeVertexPositionBuffer[ibuff1].itemSize = 3;
   treeVertexPositionBuffer[ibuff1].numItems = indextree/3;
	
   //gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexTextureCoordBuffer[ibuff1]);
   //gl.bufferData(gl.ARRAY_BUFFER, (treetextureCoords), gl.STATIC_DRAW);
   treeVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   treeVertexTextureCoordBuffer[ibuff1].numItems = indextree/3;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, tree2VertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (tree2vertices), gl.STATIC_DRAW);
   tree2VertexPositionBuffer[ibuff1].itemSize = 3;
   tree2VertexPositionBuffer[ibuff1].numItems = indextree2/3;
	
   //gl.bindBuffer(gl.ARRAY_BUFFER, tree2VertexTextureCoordBuffer[ibuff1]);
   //gl.bufferData(gl.ARRAY_BUFFER, (tree2textureCoords), gl.STATIC_DRAW);
   tree2VertexTextureCoordBuffer[ibuff1].itemSize = 2;
   tree2VertexTextureCoordBuffer[ibuff1].numItems = indextree2/3;
   
   gl.bindBuffer(gl.ARRAY_BUFFER, lineVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (linevertices), gl.STATIC_DRAW);
   lineVertexPositionBuffer[ibuff1].itemSize = 4;
   lineVertexPositionBuffer[ibuff1].numItems = indexline/4;

   gl.bindBuffer(gl.ARRAY_BUFFER, lineVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (linetexturecoords), gl.STATIC_DRAW);
   lineVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   lineVertexTextureCoordBuffer[ibuff1].numItems = indexline/4;
   //lineVertexTextureCoordBuffer[ibuff1].numItems = indexlinetext/2;//indexline/4;

   gl.bindBuffer(gl.ARRAY_BUFFER, crossVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (crossvertices), gl.STATIC_DRAW);
   crossVertexPositionBuffer[ibuff1].itemSize = 4;
   crossVertexPositionBuffer[ibuff1].numItems = indexcross/4;

   //gl.bindBuffer(gl.ARRAY_BUFFER, crossVertexTextureCoordBuffer[ibuff1]);
   //gl.bufferData(gl.ARRAY_BUFFER, (crosstextureCoords), gl.STATIC_DRAW);
   crossVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   crossVertexTextureCoordBuffer[ibuff1].numItems = indexcross/4;

   //ibuff=ibuff0;
tupdatebuffer=3;
}
function updatebuffer3(){
   //var ibuff=ibuff1;
   gl.bindBuffer(gl.ARRAY_BUFFER, roofVertexPositionBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (roofvertices), gl.STATIC_DRAW);
   roofVertexPositionBuffer[ibuff1].itemSize = 3;
   roofVertexPositionBuffer[ibuff1].numItems = indexroof/3;
	
   gl.bindBuffer(gl.ARRAY_BUFFER, roofVertexTextureCoordBuffer[ibuff1]);
   gl.bufferData(gl.ARRAY_BUFFER, (rooftextureCoords), gl.STATIC_DRAW);
   roofVertexTextureCoordBuffer[ibuff1].itemSize = 2;
   roofVertexTextureCoordBuffer[ibuff1].numItems = itextroof/2;
   
   ////lat0=lat;lng0=lng;
   //x0=((lng-lng0)/klon)*scale;
   //y0=(lat-lat0)*scale;
   
   //ibuff=ibuff0;
setTimeout("tupdatebuffer=4;",t300);
}
var treex=[],treey=[],treez=[],itree=0;
function addtree(xx,yy,zz){
var typtree=parseInt((Math.abs(xx-yy)*10))%5;
if(typtree==1){addtree22(xx,yy,zz);}
else{
   if(itree<ntree){
     treex[itree]=xx;
	 treey[itree]=yy;
	 treez[itree]=zz;
	 itree+=1;}
}}
var tree2x=[],tree2y=[],tree2z=[],itree2=0,ntree22=2500;
var tree2lngx=[],tree2latx=[],tree2z=[],tinittree2=1;
for(i=0;i<ntree22;i++){tree2x[i]=999999;};   
function addtree2(xx,yy,zz){
var dxx=xx+((lngx0-lngx)/klon)*scale*2;
var dyy=yy+(latx0-latx)*scale*2;
if(Math.abs(dxx)>50 || Math.abs(dyy)>50 || tinittree2==1){
 for(i=0;i<ntree22;i++){
   if(tree2x[i]>99999){   
     tree2lngx[i]=lngx0;
     tree2latx[i]=latx0;
	 tree2x[i]=xx;
	 tree2y[i]=yy;
	 tree2z[i]=zz;
	 break;}
 }
}}
var tree22x=[],tree22y=[],tree22z=[],itree22=0,ntree222=2500;
var tree22lngx=[],tree22latx=[],tree22z=[],tinittree22=1;
for(i=0;i<ntree222;i++){tree22x[i]=999999;};   
function addtree22(xx,yy,zz){
var dxx=xx+((lngx0-lngx)/klon)*scale*2;
var dyy=yy+(latx0-latx)*scale*2; 
if(Math.abs(dxx)>50 || Math.abs(dyy)>50 || tinittree22==1){
 for(i=0;i<ntree222;i++){
   if(tree22x[i]>99999){   
     tree22lngx[i]=lngx0;
     tree22latx[i]=latx0;
	 tree22x[i]=xx;
	 tree22y[i]=yy;
	 tree22z[i]=zz;
	 return;}
 }
}}
var iwalltree=0,walltreex=[],walltreey=[],walltreeh=[];
var iwalltree0=0,walltreex0=[],walltreey0=[],walltreeh0=[];
function addtreetest(){
for(var i=0;i<itree;i++){
var xx=treex[i],yy=treey[i];
if(testroad2(xx/2,yy/2,latx0,lngx0,0.1)==0){
   //if(indextree<3*3*(ntree-1)){
   zz=treez[i]+parseInt(getterrainheight3(xx/2,yy/2,lngx0,latx0)*100)/100;
   index=indextree;
    append(treevertices,[
              xx,yy,zz,
			  xx,yy,zz+1,
			  xx,yy,zz
            ]);
    indextree=index;
	walltreex[iwalltree]=xx;walltreey[iwalltree]=yy;
	walltreeh[iwalltree]=1;iwalltree+=1;
	}//}
}
addtree2test();
addtree22test();
}
function addtree2test(){
itree22=itree;
for(var i=0;i<ntree22;i++){
if(itree22>=ntree){return;}
if(tree2x[i]<99999){
var xx2=tree2x[i],yy2=tree2y[i];
var latx2=tree2latx[i],lngx2=tree2lngx[i];
var dxx=xx2+((lngx2-lngx)/klon)*scale*2;
var dyy=yy2+(latx2-latx)*scale*2;
var d91=dxmax*5;
if(Math.abs(dxx)>d91 || Math.abs(dyy)>d91){//65
   tree2x[i]=999999;
   }
else{//} if(Math.abs(dxx)<50 && Math.abs(dyy)<50){
   tinittree2=0;
var xx=xx2+((lngx2-lngx0)/klon)*scale*2;
var yy=yy2+(latx2-latx0)*scale*2;
if(testroad2(xx/2,yy/2,latx0,lngx0,0.1)==0){
   //if(indextree<3*3*(ntree-1)){
   var zz=tree2z[i]+parseInt(getterrainheight3(xx/2,yy/2,lngx0,latx0)*100)/100;
   itree22+=1;
   var htree=1;
   index=indextree;
    append(treevertices,[
              xx,yy,zz,
			  xx,yy,zz+htree,
			  xx,yy,zz
            ]);
    indextree=index;
	walltreex[iwalltree]=xx;walltreey[iwalltree]=yy;
	walltreeh[iwalltree]=htree;iwalltree+=1;
	}
}
}}}
var ineartree=0;itree222=0;
function addtree22test(){
itree222=itree2;
for(var i=0;i<ntree222;i++){
if(itree222>=ntree2){return;}
if(tree22x[i]<99999){
var xx2=tree22x[i],yy2=tree22y[i];
var latx2=tree22latx[i],lngx2=tree22lngx[i];
var dxx=xx2+((lngx2-lngx)/klon)*scale*2;
var dyy=yy2+(latx2-latx)*scale*2;
var d91=dxmax*5;
if(Math.abs(dxx)>d91 || Math.abs(dyy)>d91){//65
   tree22x[i]=999999;
   }
else{//} if(Math.abs(dxx)<50 && Math.abs(dyy)<50){
   tinittree22=0;
var xx=xx2+((lngx2-lngx0)/klon)*scale*2;
var yy=yy2+(latx2-latx0)*scale*2;
if(testroad2(xx/2,yy/2,latx0,lngx0,0.1+tsequoia*0.55)==0){
   //if(indextree2<3*3*(ntree2-1)){
   var zz=tree22z[i]+parseInt(getterrainheight3(xx/2,yy/2,lngx0,latx0)*100)/100;
   itree222+=1;
   var htree=1;
   if(tsequoia==1){htree=9;}
   if(tsequoia==2){htree=13;}
   index=indextree2;
    append(tree2vertices,[
              xx,yy,zz,
			  xx,yy,zz+htree,
			  xx,yy,zz
            ]);
    indextree2=index;
	walltreex[iwalltree]=xx;walltreey[iwalltree]=yy;
	walltreeh[iwalltree]=htree;iwalltree+=1;
	}
}
}}}
function setineartree(){
ineartree=0;
for(var i=0;i<iwalltree0;i+=2){
  if(Math.abs(walltreex0[i]-x)<20){
   if(Math.abs(walltreey0[i]-y)<20){
     ineartree+=1;if(walltreeh0[i]>4){ineartree+=1;}
}}}
}
function resettree22(){
var dxx0=((lngx0-lngx)/klon)*scale*2;
var dyy0=(latx0-latx)*scale*2;
for(var i=0;i<ntree222;i++){
if(tree22x[i]<99999){
var xx2=tree22x[i],yy2=tree22y[i];
var latx2=tree22latx[i],lngx2=tree22lngx[i];
var xx=xx2+((lngx2-lngx0)/klon)*scale*2;
var yy=yy2+(latx2-latx0)*scale*2;
var dxx=xx+dxx0;//((lngx0-lngx)/klon)*scale*2;
var dyy=yy+dyy0;//(latx0-latx)*scale*2;
if(Math.abs(dxx)>51 || Math.abs(dyy)>51){//65
   tree22x[i]=999999;
   }
//else if(Math.abs(dxx)<50 && Math.abs(dyy)<50){
//   tinittree22=0;}
}}}
function resettree2(){
var dxx0=((lngx0-lngx)/klon)*scale*2;
var dyy0=(latx0-latx)*scale*2;
for(var i=0;i<ntree22;i++){
if(tree2x[i]<99999){
var xx2=tree2x[i],yy2=tree2y[i];
var latx2=tree2latx[i],lngx2=tree2lngx[i];
var xx=xx2+((lngx2-lngx0)/klon)*scale*2;
var yy=yy2+(latx2-latx0)*scale*2;
var dxx=xx+dxx0;//((lngx0-lngx)/klon)*scale*2;
var dyy=yy+dyy0;//(latx0-latx)*scale*2;
if(Math.abs(dxx)>51 || Math.abs(dyy)>51){//65
   tree2x[i]=999999;
   }
//else if(Math.abs(dxx)<50 && Math.abs(dyy)<50){
//   tinittree2=0;}
}}}
var linex=[],liney=[],linez=[],liner=[],iline=0;
var lineco1=[],linesi1=[];
function addline(xx,yy,zz,r,co1,si1){
   if(Math.abs(xx-x)>300){return;}
   if(Math.abs(yy-y)>300){return;}
   if(iline<(nline-ibar)/3-1){
     linex[iline]=xx;
	 liney[iline]=yy;
	 linez[iline]=zz;
	 liner[iline]=r;
	 lineco1[iline]=co1;
	 linesi1[iline]=si1;
	 iline+=1}
}
function addlinetest(){
var h=0.6,h2=0.7,h21=0.765,xx,yy,zz,r,co1,si1;
var co11,si11,r2,r21;
for(var i=0;i<iline;i++){
xx=linex[i];yy=liney[i];
if(testroad2(xx/2,yy/2,latx0,lngx0,0.01)==0){
   //if(indexline<3*3*(nline-1)){
   zz=linez[i];//+parseInt(getterrainheight3(xx/2,yy/2,lngx0,latx0)*100)/100;
   r=liner[i];
   r2=r*1.2;
   r21=r*1.8;
   co1=lineco1[i]*0.25;
   si1=linesi1[i]*0.25;
   co11=1.654*co1;
   si11=1.654*si1;
   var zz0=zz;//-0.5;
   index=indexline;
    append(linevertices,[
              xx,yy,zz0,r,
              xx,yy,zz+h,r,
			  xx,yy,zz+h,r,
              
			  xx,yy,zz0,r,
              xx,yy,zz+h,r,
			  xx,yy,zz0,r,
              
			  xx,yy,zz+h,r2,
              xx-si1,yy+co1,zz+h2,r2,
			  xx-si1,yy+co1,zz+h2,r2,
              
			  xx,yy,zz+h,r2,
              xx-si1,yy+co1,zz+h2,r2,
			  xx,yy,zz+h,r2,
			  
			  xx-si1,yy+co1,zz+h2,r21,
              xx-si11,yy+co11,zz+h21,r21,
			  xx-si11,yy+co11,zz+h21,r21,
              
			  xx-si1,yy+co1,zz+h2,r21,
              xx-si11,yy+co11,zz+h21,r21,
			  xx-si1,yy+co1,zz+h2,r21
            ]);
    indexline=index;
	index=indexlinetext;
		for (var ii=0; ii < 3; ii++) {
		   append(linetexturecoords,[
             0,0,  0,1,  1,1,
			 0,0,  1,1,  1,0
			 ]);
		}
    indexlinetext=index;		
	}//}
}}
var barx=[],bary=[],barz=[],barr=[],ibar=0;
var barco1=[],barsi1=[],bartan2=[],barh=[],barcolor=[],barside=[];
function addbar(xx,yy,zz,r,co1,si1,tan2,h,icolor,side){
if(Math.abs(xx-x)>300 || Math.abs(yy-y)>300){return;}
   if(ibar<nline-1-iline*3){
     barx[ibar]=xx;
	 bary[ibar]=yy;
	 barz[ibar]=zz;
	 barr[ibar]=r;
	 barco1[ibar]=co1;
	 barsi1[ibar]=si1;
	 bartan2[ibar]=tan2;
	 barh[ibar]=h;
	 barcolor[ibar]=icolor;
	 barside[ibar]=side;
	 ibar+=1}
}
function addbartest(){
var h=0.085,xx,yy,zz,r,rr,xxx,yyy,zzz;
for(var i=0;i<ibar;i++){
xx=barx[i];yy=bary[i];
h=(0.075+0.025)*barh[i];
   zz=barz[i]-0.025*Math.min(2,barh[i]);//0.05//+parseInt(getterrainheight3(xx/2,yy/2,lngx0,latx0)*100)/100;
   rr=barr[i]*0.85;
   xxx=xx+barco1[i]*rr;
   yyy=yy+barsi1[i]*rr;
   zzz=zz+rr*bartan2[i];
 var test=0;
 if(barcolor[i]==0){//not bridge
   test=testroad2((xx+xxx+barsi1[i]*rr*kscalex)/4,(yy+yyy-barco1[i]*rr*kscalex)/4,latx0,lngx0,rr/2.2);
 }else{var r4=barside[i],zzzi=barz[i]+rr*bartan2[i];
       test=testroad23((xx+xxx+barsi1[i]*(r4)*kscalex)/4,(yy+yyy-barco1[i]*(r4)*kscalex)/4,zzzi,latx0,lngx0,0.45);
       //test=testroad23((xx+xxx+barsi1[i]*(rr+r4)*kscalex)/4,(yy+yyy-barco1[i]*(rr+r4)*kscalex)/4,zzzi,latx0,lngx0,rr/2.2);
 }
 if(test==0){
   r=0;
   if(barcolor[i]>0){r+=1000;}
   index=indexline;
    append(linevertices,[
              xx,yy,zz,r,
              xx,yy,zz+h,r,
			  xxx,yyy,zzz,r,
              
			  xx,yy,zz+h,r,
              xxx,yyy,zzz+h,r,
			  xxx,yyy,zzz,r
            ]);
    indexline=index;
	index=indexlinetext;
	var ty=0,t1=0.03;
	if(barcolor[i]>0){if(barcolor[i]<19000){ty=parseInt(100+10*barcolor[i]-5);}
	                  else{ty=parseInt(barcolor[i]);}}
		   append(linetexturecoords,[
             0,ty,  0,ty+t1,  1,ty+t1,
			 0,ty,  1,ty+t1,  1,ty
			 ]);
    indexlinetext=index;		
}}
}
var crossx=[],crossy=[],crossz=[],crossr=[],icross=0,iroadcross=0,ttestroadcross=1;
var crossco1=[],crosssi1=[],crossiroad=[],crossttestroad=[];
function addcross(xx,yy,zz,r,co1,si1){
   if(icross<ncross/3-1){
     crossx[icross]=xx;
	 crossy[icross]=yy;
	 crossz[icross]=zz;
	 crossr[icross]=r;
	 crossco1[icross]=co1;
	 crosssi1[icross]=si1;
	 crossiroad[icross]=iroadcross;
	 crossttestroad[icross]=ttestroadcross;
	 icross+=1}
}
var nstop=0,stopx=[],stopy=[],stopz=[],stopco1=[],stopsi1=[];
var nstop0=0,stopx0=[],stopy0=[],stopz0=[],stopco10=[],stopsi10=[];
function addcrosstest(){
var h=0.3,h2=0.45,h21=0.765,xx,yy,zz,rr,co1,si1,r;
var co11,si11;
nstop=0;
for(var i=0;i<icross;i++){
xx=crossx[i];yy=crossy[i];
if(crossttestroad[i]==0 || testroad2(xx/2,yy/2,latx0,lngx0,0.1)==0){
   //if(indexcross<3*3*(ncross-1)){
   zz=crossz[i];//+parseInt(getterrainheight3(xx/2,yy/2,lngx0,latx0)*100)/100;
   rr=crossr[i];
   r=0.017;
   co1=crossco1[i]*r*9.45;
   si1=crosssi1[i]*r*9.45;
   co11=0.014*co1;
   si11=0.014*si1;
   h2=0.45;
   var face=1;
   var test=0;if(crossttestroad[i]==1){test=testroadcross(xx/2,yy/2,latx0,lngx0,rr);}
   roadcross[crossiroad[i]]=test;
   if(test==1){nstop+=1;stopx[nstop]=xx/2;stopy[nstop]=yy/2;stopz[nstop]=zz;
               stopco1[nstop]=crossco1[i];stopsi1[nstop]=crosssi1[i];
      r+=10;co1*=0.87;si1*=0.87;}//stop
   else if(rr>750){r+=750;co1*=1.4;si1*=1.4;h2=0.55;face=2;}//hospital
   else if(rr>700){r+=700;co1*=0.82;si1*=0.82;face=2;}//hospital
   else if(rr>650){r+=650;co1*=0.82;si1*=0.82;}//turn right
   else if(rr>600){r+=600;co1*=0.82;si1*=0.82;}//turn left
   else if(rr>500){r+=500;co1*=0.82;si1*=0.82;}//parking
   else if(rr>400){r+=400;co1*=1.05;si1*=1.05;h2=0.48;}//highway
   else if(rr>300){r+=300;co1*=0.82;si1*=0.82;face=2;}//station
   else if(rr>200){r+=200;co1*=0.82;si1*=0.82;}//oneway2
   else if(rr>100){r+=100;co1*=0.82;si1*=0.82;}//oneway
   var zz0=zz-0.5;
   index=indexcross;
    append(crossvertices,[
              xx,yy,zz0,r,
              xx,yy,zz+h,r,
			  xx,yy,zz+h,r,
              
			  xx,yy,zz0,r,
              xx,yy,zz+h,r,
			  xx,yy,zz0,r,
              
			  xx-si1,yy+co1,zz+h,r,
              xx-si1,yy+co1,zz+h2,r,
			  xx+si1,yy-co1,zz+h2,r,
              
			  xx-si1,yy+co1,zz+h,r,
              xx+si1,yy-co1,zz+h2,r,
			  xx+si1,yy-co1,zz+h,r
            ]);
    if(face==1){          
     append(crossvertices,[
			  xx-si1+si11+co11,yy+co1-co11+si11,zz+h+0.007,r,
              xx-si1+si11+co11,yy+co1-co11+si11,zz+h2-0.007,r,
			  xx+si1-si11+co11,yy-co1+co11+si11,zz+h2-0.007,r,
			  
			  xx-si1+si11+co11,yy+co1-co11+si11,zz+h+0.007,r,
			  xx+si1-si11+co11,yy-co1+co11+si11,zz+h2-0.007,r,
			  xx+si1-si11+co11,yy-co1+co11+si11,zz+h+0.007,r
			  
            ]);
	}else{
     append(crossvertices,[
	          0,0,-99,0,
			  0,0,-99,0,
			  0,0,-99,0,
			  
	          0,0,-99,0,
			  0,0,-99,0,
			  0,0,-99,0			  
            ]);
	}
    indexcross=index;
	}//}
}}
var womanx=[],womany=[],womanz=[],womanr=[],iwoman=0;
var womanco1=[],womansi1=[],nwoman=50;
var woman0x=[],woman0y=[],woman0z=[],woman0r=[],iwoman0=0;
var woman0co1=[],woman0si1=[];
function addwoman(xx,yy,zz,r,co1,si1){
   if(iwoman<nwoman-1){
     womanx[iwoman]=xx;
	 womany[iwoman]=yy;
	 womanz[iwoman]=zz;
	 womanr[iwoman]=r;
	 womanco1[iwoman]=co1;
	 womansi1[iwoman]=si1;
	 iwoman+=1}
}
function addwomantest(){
var xx,yy;
iwoman0=0;
for(var i=0;i<iwoman;i++){
xx=womanx[i];yy=womany[i];
if(testroad2(xx/2,yy/2,latx0,lngx0,0.1)==0){
   woman0x[iwoman0]=womanx[i];
   woman0y[iwoman0]=womany[i];
   woman0z[iwoman0]=womanz[i];
   woman0r[iwoman0]=womanr[i];
   woman0co1[iwoman0]=womanco1[i];
   woman0si1[iwoman0]=womansi1[i];
   iwoman0+=1;
}}
}
function addstationtest(){
  for(var i=0;i<nstation;i++){
     stationz[i]=-999999;
	 var px=(stationlon[i]-lngx0)*scale/klon;
	 var py=(stationlat[i]-latx0)*scale;
	 if(testroadnear(px,py,latx0,lngx0,7,0)==1){
	    stationx[i]=xroadnear/2;
		stationy[i]=yroadnear/2;
		//stationlon[i]=xroadnear*klon/scale+lngx0;
		//stationlat[i]=yroadnear/scale+latx0;
		stationz[i]=zroadnear;
		stationo1[i]=o1roadnear;
		var j=iroadnear0;
		if(j>=0){
		   iroadcross=iroadnear0;
		   var xxx=roadx[j],yyy=roady[j],zzz=roadz[j],r=roadr[j],co1=roadco1[j],si1=roadsi1[j];
		   var l=roadl[j];
		   if(dxyiroadnear<0){addcross(xxx+(r+0.5)*(si1),yyy+(r+0.5)*(-co1),zzz+zsol0,r+300,co1,si1);}//station
		   else{addcross(xxx+l*co1+(r+0.5)*(-si1),yyy+l*si1+(r+0.5)*(co1),zzz+zsol0,r+300,-co1,-si1);}
		   }
	 }
  }
}
var nhospital=0,hospitallon=[],hospitallat=[];
function addhospital(way){
if(nhospital>50){return;}
if(way.nodes){
   var jj=way.nodes.length;
   if(jj>4){
     var j=0;
     var inode=way.nodes[j];
     if(latnodes[inode]){hospitallat[nhospital]=latnodes[inode];
	                     hospitallon[nhospital]=lonnodes[inode];
						 nhospital+=1;}
     j=parseInt(jj/4);
     inode=way.nodes[j];
     if(latnodes[inode]){hospitallat[nhospital]=latnodes[inode];
	                     hospitallon[nhospital]=lonnodes[inode];
						 nhospital+=1;}
     j=parseInt(2*jj/4);
     inode=way.nodes[j];
     if(latnodes[inode]){hospitallat[nhospital]=latnodes[inode];
	                     hospitallon[nhospital]=lonnodes[inode];
						 nhospital+=1;}
     j=parseInt(3*jj/4);
     inode=way.nodes[j];
     if(latnodes[inode]){hospitallat[nhospital]=latnodes[inode];
	                     hospitallon[nhospital]=lonnodes[inode];
						 nhospital+=1;}
   }  
   }
}
function addhospitaltest(){//auxvar3=nhospital;
  for(var i=0;i<nhospital;i++){
	 var px=(hospitallon[i]-lngx0)*scale/klon;
	 var py=(hospitallat[i]-latx0)*scale;
	 var test=testroadnear(px,py,latx0,lngx0,65,1.3);
	 if(test==0){test=testroadnear(px,py,latx0,lngx0,65,1);}
	 if(test==1){
		var j=iroadnear0;
		if(j>=0){//auxvar3+=1000;
		   iroadcross=iroadnear0;
		   var xxx=roadx[j],yyy=roady[j],zzz=roadz[j],r=roadr[j],co1=roadco1[j],si1=roadsi1[j];
		   var l=roadl[j];
           ttestroadcross=0;
		   if(dxyiroadnear<0){addcross(xxx+(r+0.3)*(si1),yyy+(r+0.3)*(-co1),zzz+zsol0,r+700,co1,si1);}//hospital
		   else{addcross(xxx+l*co1+(r+0.3)*(-si1),yyy+l*si1+(r+0.3)*(co1),zzz+zsol0,r+700,-co1,-si1);}
           ttestroadcross=1;
		   }
	 }
  }
}
var nrailstation=0,railstationlon=[],railstationlat=[];
function addrailstationtest(){
  for(var i=0;i<nrailstation;i++){
	 var px=(railstationlon[i]-lngx0)*scale/klon;
	 var py=(railstationlat[i]-latx0)*scale;
	 var test=testroadnear(px,py,latx0,lngx0,65,1.3);
	 if(test==0){test=testroadnear(px,py,latx0,lngx0,65,1);}
	 if(test==1){
		var j=iroadnear0;
		if(j>=0){
		   iroadcross=iroadnear0;
		   var xxx=roadx[j],yyy=roady[j],zzz=roadz[j],r=roadr[j],co1=roadco1[j],si1=roadsi1[j];
		   var l=roadl[j];
           ttestroadcross=0;
		   if(dxyiroadnear<0){addcross(xxx+(r+0.4)*(si1),yyy+(r+0.4)*(-co1),zzz+zsol0,r+750,co1,si1);}//railstation
		   else{addcross(xxx+l*co1+(r+0.4)*(-si1),yyy+l*si1+(r+0.4)*(co1),zzz+zsol0,r+750,-co1,-si1);}
           ttestroadcross=1;
		   }
	 }
  }
}
var citypanelx=[],citypanely=[],citypanelz=[],citypanelr=[],icitypanel=0;
var citypanelco1=[],citypanelsi1=[],citypanelname=[],citypanelh=[];
for(var i=0;i<ncitypanel;i++){
    citypanelr[i]=0;
	citypanelx[i]=0;
	citypanely[i]=0;
	citypanelz[i]=0;
	citypanelco1[i]=1;
	citypanelsi1[i]=0;
	citypanelh[i]=1;
	}
var citypanelsave="";
function savecitypanel(){
citypanelsave=latx*100+"/"+lngx*100+"/"+o1+"/"+o2+"/$";
for(var i=0;i<ncitypanel;i++){
   citypanelsave+=citypanelr[i]+"/";
   citypanelsave+=citypanelx[i]+"/";
   citypanelsave+=citypanely[i]+"/";
   citypanelsave+=citypanelz[i]+"/";
   citypanelsave+=citypanelco1[i]+"/";
   citypanelsave+=citypanelsi1[i]+"/";
   citypanelsave+=citypanelh[i]+"/";
   citypanelsave+=citypanelname[i]+"/";
   citypanelsave+="$";
 }
if(localStorage){localStorage.setItem("webglcarsimheight_shadow_citypanelsave",citypanelsave);}
}
function clearcitypanelsave(){
citypanelsave="";
if(localStorage){localStorage.setItem("webglcarsimheight_shadow_citypanelsave",citypanelsave);}
}
function loadcitypanel(){
if(localStorage){
   citypanelsave=localStorage.getItem("webglcarsimheight_shadow_citypanelsave");
   if(citypanelsave==null){return;};}
else{return;}   
var words=citypanelsave.split("$");
var tword=words[0].split("/");
//alert(tword[1]+"/"+lngx*100+"/");
if(Math.abs(evaln(tword[0])-latx*100)>0.0015){return;}
if(Math.abs(evaln(tword[1])-lngx*100)>0.0015){return;}
//alert(tword[3]+"/"+o2+"/");
if(Math.abs(evaln(tword[2])-o1)>0.15){return;}
//if(Math.abs(evaln(tword[3])-o2)>0.0015){return;}
//alert("ok");
var nwords=Math.min(ncitypanel+1,words.length);
for(var i=1;i<nwords;i++){
    var word=words[i].split("/");
   if(word[7]=="photo"){
    var j=-1;
    j+=1;citypanelr[i]=evaln(word[j]);
    j+=1;citypanelx[i]=evaln(word[j]);
    j+=1;citypanely[i]=evaln(word[j]);
    j+=1;citypanelz[i]=evaln(word[j]);
    j+=1;citypanelco1[i]=evaln(word[j]);
    j+=1;citypanelsi1[i]=evaln(word[j]);
    j+=1;citypanelh[i]=evaln(word[j]);
    j+=1;citypanelname[i]=word[j];
    //if(i==1){alert(citypanelname[i]);}
    //if(i<=1){alert(citypanelh[i]);}
	var name=citypanelname[i];
	var h=citypanelh[i];
    if(name=="photo" && citypanelr[i]>0.001){	
	     icitypanel=i;
		 if(h<2){setcitypaneltexture(icitypanel,name);}
	 	 else if(name.toLowerCase().indexOf("airport")==0){
	             citypanelh[icitypanel]=2.2;
	             citypanelr[icitypanel]=0.8;
		         setcitypaneltexture3(icitypanel,mytown1,mytown2);}
		 else if(name!="photo"){
	             //citypanelh[icitypanel]=2.7;
	             //citypanelr[icitypanel]=Math.max(1.2,name.length*1.15/21.4);
		         setcitypaneltexture2(icitypanel,mytown1,mytown2);}
		 else{//ncitypanelTexture[icitypanel]=photoTexture;
		      citypanelr[icitypanel]=1.2;}
	}}
 }
}
function testsavecitypanel(){
 return;
 savecitypanel();
 loadcitypanel();
}
function seticitypanel(xx,yy,zz,name){
var j=-1,jj=-1,dist=0;
   for(var i=0;i<ncitypanel;i++){
     if(citypanelr[i]>0.001){
        var xxx=((citypanelx[i]-lng0)/klon)*scale;
        var yyy=(citypanely[i]-lat0)*scale;
	    var dx=Math.max(Math.abs(xxx-xx),Math.abs(yyy-yy));
		if(dx<4.5){if(citypanelname[i]==name){return 0;}}
		if(dx<0.5){citypanelr[i]=0;if(j<0){j=i;}}
	    dx=Math.max(Math.abs(xxx-x),Math.abs(yyy-y));
	    if(dx>300){citypanelr[i]=0;if(j<0){j=i;}}
		if(dx>dist){dist=dx;jj=i;}
	 }else if(j<0){j=i;}}
   if(j>=0){icitypanel=j;return 1;}
   if(jj>=0){icitypanel=jj;return 1;}
   icitypanel+=1;
   if(icitypanel>=ncitypanel){icitypanel=0;}
   return 1;
}
function addcitypanel(xx,yy,zz,r,co1,si1,name0,h){
if(testroad2(xx,yy,lat0,lng0,0.01)==0 || h<2){
   if(name0==""){return 0;}
   var name="",name1=name0,i=0;
   for(var j=0;j<8;j++){i=name1.indexOf(" ");
                        if(i<0){break;name+=name1}
						else{name+=name1.substr(0,i+1);name1=name1.substr(i+1,99);}
						//if(i<0 || name.length>=24){break;}
						}
   if(h<2){name=(name+name1).substr(0,24);}//22
   //else if(name0!="photo"){name=name.substr(0,17)+"  "+name1;}
   else{name=name0;}   
   var test=seticitypanel(xx,yy,zz,name);
   if(test==0){return 2;}
   if(test==1){
     //x=((lngx-lng0)/klon)*scale;
     //y=(latx-lat0)*scale;
     citypanelx[icitypanel]=xx*klon/scale+lng0;
	 citypanely[icitypanel]=yy/scale+lat0;
	 citypanelz[icitypanel]=zz;
	 if(h<2){citypanelr[icitypanel]=Math.max(r,name.length/21.4);}//20.8);
	 else{citypanelr[icitypanel]=r;}
	 citypanelco1[icitypanel]=co1;
	 citypanelsi1[icitypanel]=si1;
	 citypanelh[icitypanel]=h;
	 if( citypanelname[icitypanel]!=name){
     	 citypanelname[icitypanel]=name;
		 if(h<2){setcitypaneltexture(icitypanel,name);}
	 	 else if(name.toLowerCase().indexOf("airport")==0){
	             citypanelh[icitypanel]=2.2;
	             citypanelr[icitypanel]=0.8;
		         setcitypaneltexture3(icitypanel,mytown1,mytown2);}
		 else if(name!="photo"){
	             //citypanelh[icitypanel]=2.7;
	             //citypanelr[icitypanel]=Math.max(1.2,name.length*1.15/21.4);
		         setcitypaneltexture2(icitypanel,mytown1,mytown2);}
		 else{//ncitypanelTexture[icitypanel]=photoTexture;
		      citypanelr[icitypanel]=1.2;}
	 }
	 return 1;
	 }
}
return 0;
}
function setcitypaneltexture(i,name){
if(citypanelTexture.image.width>1){
 	canvas2.setAttribute('width', 512);
    canvas2.setAttribute('height', 64);
	canvastext.drawImage(citypanelTexture.image, 0,0,512,64);
    canvastext.font = "18pt Arial";
    canvastext.fillStyle = '#000000';
    canvastext.fillText(name,120,40);
	handleLoadedTexture00(ncitypanelTexture[i]);
 	canvas2.setAttribute('width', 10);
    canvas2.setAttribute('height', 10);
	}
}
function setcitypaneltexture2(i,mytown1,mytown2){
if(citypanelTexture.image.width>1){
 	canvas2.setAttribute('width', 256);
    canvas2.setAttribute('height', 64);
	//canvastext.drawImage(citypanelTexture.image, 0,0,512,128);
	canvastext.lineWidth=10;
	canvastext.strokeStyle='#ffffff';
    canvastext.beginPath();
    canvastext.moveTo(0,2);
    canvastext.lineTo(256,2);
    canvastext.lineTo(256,62);
    canvastext.lineTo(0,62);
    canvastext.lineTo(0,2);
    canvastext.stroke();
    canvastext.moveTo(150,25);
    canvastext.fillStyle = '#0000b5';
	canvastext.fill();	  
    canvastext.beginPath();
    canvastext.moveTo(0,2);
    canvastext.lineTo(256,2);
    canvastext.lineTo(256,62);
    canvastext.lineTo(0,62);
    canvastext.lineTo(0,2);
    canvastext.stroke();
	var li=23;
    if(mytown1!=""){ 
	 canvastext.font = "Bold 11pt Arial";
     canvastext.fillStyle = '#ffffff';
     canvastext.fillText(mytown1,60,li);
	 li+=17;
	} 
    if(mytown2!=""){ 
	 canvastext.font = "Bold 11pt Arial";
     canvastext.fillStyle = '#ffffff';
     canvastext.fillText(mytown2,60,li);
	 li+=17;
	} 
	handleLoadedTexture00(ncitypanelTexture[i]);
 	canvas2.setAttribute('width', 10);
    canvas2.setAttribute('height', 10);
	}
}
function setcitypaneltexture3(i,mytown1,mytown2){
if(citypanelTexture.image.width>1){
 	canvas2.setAttribute('width', 256);
    canvas2.setAttribute('height', 64);
	//mytown1="airport left";
	//mytown2="Orly 123456789abcdef";
	if(mytown1=="airport left"){canvastext.drawImage(arrowgreenleft, 0,0,196,64);}
	if(mytown1=="airport forward"){canvastext.drawImage(arrowgreenforward, 0,0,196,64);}
	if(mytown1=="airport right"){canvastext.drawImage(arrowgreenright, 0,0,196,64);}
	if(mytown1!="AIRPORT"){mytown1="airport";
	                       mytown2=mytown2.substr(0,parseInt(122/11));
	}else{
	mytown2=mytown2.substr(0,parseInt(180/11));
	canvastext.lineWidth=10;
	canvastext.strokeStyle='#ffffff';
    canvastext.beginPath();
    canvastext.moveTo(0,2);
    canvastext.lineTo(256,2);
    canvastext.lineTo(256,62);
    canvastext.lineTo(0,62);
    canvastext.lineTo(0,2);
    canvastext.stroke();
    canvastext.moveTo(150,25);
    canvastext.fillStyle = '#00b500';
	canvastext.fill();	  
    canvastext.beginPath();
    canvastext.moveTo(0,2);
    canvastext.lineTo(256,2);
    canvastext.lineTo(256,62);
    canvastext.lineTo(0,62);
    canvastext.lineTo(0,2);
    canvastext.stroke();}
	var li=23;
    if(mytown1!=""){ 
	 canvastext.font = "Bold 11pt Arial";
     canvastext.fillStyle = '#ffffff';
     canvastext.fillText(mytown1,60,li);
	 li+=17;
	} 
    if(mytown2!=""){ 
	 canvastext.font = "Bold 11pt Arial";
     canvastext.fillStyle = '#ffffff';
     canvastext.fillText(mytown2,60,li);
	 li+=17;
	} 
	handleLoadedTexture00(ncitypanelTexture[i]);
 	canvas2.setAttribute('width', 10);
    canvas2.setAttribute('height', 10);
	}
}
var indexcitypaneltext=0;
function updatecitypanelx(){
  for(var i=0;i<ncitypanel;i++){
     if(citypanelr[i]>0.001){
       var xx=((citypanelx[i]-lng0)/klon)*scale;
       var yy=(citypanely[i]-lat0)*scale;
       if(Math.max(Math.abs(xx-x),Math.abs(yy-y))>300){
	      citypanelr[i]=0;citypanelx[i]=9999;}}
	   }
}
var tgirlimage=0,tgirlimage2=0,tgirlimage3=0,kw5=0.48;
function subgirlimage(){
if(tgirlimage2==1){subgirlimage2();return;}
var w=256,h=200;
var ix=canvas.width-w,jx=canvas.height-h,di=w,dj=h;
var h2=canvas.height*kw5,w2=h2*256/200;
var ix2=canvas.width-w2,jx2=canvas.height-h2,di2=w2,dj2=h2;
if(keys[vk_shift]){tgirlimage3=(tgirlimage3+1)%2;
   if(tgirlimage3==0){context.clearRect(ix2,jx2,ix2+di2,jx2+dj2);}
   else{ix=ix2;jx=jx2;di=di2;dj=dj2;}
   if(tgirlimage>0){tgirlimage-=1;}
}
if(tgirlimage3==1){ix=ix2;jx=jx2;di=di2;dj=dj2;}
if(tgirlimage==0){tgirlimage=1;
       context.drawImage(girlimage,0,0,girlimage.width,girlimage.height, ix,jx,di,dj);}
else if(tgirlimage==1){tgirlimage=2;var i=w/2,j=h/2;
       context.drawImage(girlimage,i,j,girlimage.width-i,girlimage.height-j, ix,jx,di,dj);}
else{tgirlimage=0;context.clearRect(ix,jx,ix+di,jx+dj);}
}
function subgirlimage2(){
var w=256,h=200;
var ix=canvas.width-w,jx=canvas.height-h,di=w,dj=h;
var h2=canvas.height*kw5,w2=h2*256/200;
var ix2=canvas.width-w2,jx2=canvas.height-h2,di2=w2,dj2=h2;
if(keys[vk_shift]){tgirlimage3=(tgirlimage3+1)%2;
   if(tgirlimage3==0){context.clearRect(ix2,jx2,ix2+di2,jx2+dj2);}
   else{ix=ix2;jx=jx2;di=di2;dj=dj2;}
   if(tgirlimage>0){tgirlimage-=1;}
}
if(tgirlimage3==1){ix=ix2;jx=jx2;di=di2;dj=dj2;}
if(tgirlimage==0){tgirlimage=1;
       context.drawImage(girlimage2,0,0,girlimage2.width,girlimage2.height,  ix,jx,di,dj);}
else if(tgirlimage==1){tgirlimage=2;var i=w/2,j=h/2;
       context.drawImage(girlimage2,i,j,girlimage2.width-i,girlimage2.height-j,  ix,jx,di,dj);}
else{tgirlimage=0;context.clearRect(ix,jx,ix+di,jx+dj);}
}
function subtgirlimage(){
tgirlimage2=(tgirlimage2+1)%2;
tgirlimage-=1;subgirlimage();
}
function subgirlimage3(){
var w=256,h=200;
var ix=canvas.width-w,jx=canvas.height-h,di=w,dj=h;
var h2=canvas.height*kw5,w2=h2*256/200;
var ix2=canvas.width-w2,jx2=canvas.height-h2,di2=w2,dj2=h2;
if(keys[vk_shift]){tgirlimage3=(tgirlimage3+1)%2;
   if(tgirlimage3==0){context.clearRect(ix2,jx2,ix2+di2,jx2+dj2);}
   else{ix=ix2;jx=jx2;di=di2;dj=dj2;}
   if(tgirlimage>0){tgirlimage-=1;}
}
if(tgirlimage3==1){ix=ix2;jx=jx2;di=di2;dj=dj2;}
if(tgirlimage==2){tgirlimage=1;var i=w/4,j=h/4;
       context.drawImage(girlimage3,i,j,girlimage3.width-i-i,girlimage3.height-j-j, ix,jx,di,dj);}
else{tgirlimage=2;var i=w/2.5,j=h/2.5;
       context.drawImage(girlimage3,i,j,girlimage3.width-i-i,girlimage3.height-j-j, ix,jx,di,dj);}
}
function subtest(){subwind();return;
if(tupdatesoltexture==0){
 tupdatesoltexture=2;loading=66;
 updatesoltexture();
 }
 return;
       testsavecitypanel();return;
	   tloadsol=0;tdrawsol=tframe-1;//return;
	   if(tupdatesoltexture==0 || tframe>tloadsol){
	      tloadsol=tframe+50000;
		  tdrawsol=tframe+9900;
		  tupdatesoltexture=2;loading=66;
		  updatesoltexture();return;}
		  return;
var srtmfich='http://caper.ws/terrain-srtm30-plus/tms7/14/24.png';
var srtmimg=new Image();
//srtmimg.crossOrigin = "anonymous";
srtmimg.onload=function(){alert(srtmimg.width+"/"+srtmimg.height);}//337x95/337x337/337x325
srtmimg.src=srtmfich;alert(srtmfich);
return;
snowlat=9999;setsnow();return;
resetboeing2();return;
getnodes4();
//addcitypanel(x-5,y,getterrainheight2(x-5,y),0.45,cos1,sin1,locationname,5);addcitypaneltest();
//soundpneu();playsound(myaudiopneu);}
//train=1;
alert("ok"+countrycode);
return;
}
function addcitypaneltest(){
var h=0.15,h2=h+0.12,h21=0.765,xx,yy,zz,rr,co1,si1,r,h1;
var co11,si11;
updatecitypanelx();
indexcitypanel=0;
indexcitypaneltext=0;
for(var i=0;i<ncitypanel;i++){
if(citypanelr[i]>0.001){
   xx=2*((citypanelx[i]-lng0)/klon)*scale;
   yy=2*(citypanely[i]-lat0)*scale;
   //zz=citypanelz[i];//+parseInt(getterrainheight3(xx/2,yy/2,lngx0,latx0)*100)/100;
   zz=getterrainheight(citypanelx[i],citypanely[i]);
   rr=citypanelr[i]*0.5;
   r=rr+20;
   co1=citypanelco1[i]*rr;
   si1=citypanelsi1[i]*rr;
   co11=0.04*citypanelco1[i];
   si11=0.04*citypanelsi1[i];
   h1=citypanelh[i];
   h2=h+0.12*h1;
   var zz0=zz-0.5,rrr=0.05;
   index=0;
    append(citypanelvertices,[
              xx,yy,zz0,rrr,
              xx,yy,zz+h,rrr,
			  xx,yy,zz+h,rrr,
              
			  xx,yy,zz0,rrr,
              xx,yy,zz+h,rrr,
			  xx,yy,zz0,rrr,
              
			  xx-si1-si11,yy+co1+co11,zz+h,r,
              xx-si1-si11,yy+co1+co11,zz+h2,r,
			  xx-si1,yy+co1,zz+h,r,
              
			  xx-si1-si11,yy+co1+co11,zz+h2,r,
              xx-si1,yy+co1,zz+h2,r,
			  xx-si1,yy+co1,zz+h,r,
              
			  xx-si1,yy+co1,zz+h,r,
              xx-si1,yy+co1,zz+h2,r,
			  xx+si1,yy-co1,zz+h,r,
			  
			  xx-si1,yy+co1,zz+h2,r,
			  xx+si1,yy-co1,zz+h2,r,
			  xx+si1,yy-co1,zz+h,r,
			  
			  xx+si1,yy-co1,zz+h,r,
              xx+si1,yy-co1,zz+h2,r,
			  xx+si1+si11,yy-co1-co11,zz+h,r,
              
			  xx+si1,yy-co1,zz+h2,r,
              xx+si1+si11,yy-co1-co11,zz+h2,r,
			  xx+si1+si11,yy-co1-co11,zz+h,r
              
            ]);
    indexcitypanel=index;
	index=0;var tr=rr*1.8;
		var x0=0.011,x1=0.03,x01=0.215,x11=x01+0.7*tr,y10=20.1,y11=20.9,y20=20.1,y21=20.9;
		   append(citypaneltextureCoords,[
             0,0,  0,1,  1,1,
			 0,0,  1,1,  1,0,

             x0,y10,  x0,y11,  x1,y10,
			 x0,y11,  x1,y11,  x1,y10,

             x01,y20,  x01,y21,  x11,y20,
			 x01,y21,  x11,y21,  x11,y20,
			 
             x1,y10,  x1,y11,  x0,y10,
			 x1,y11,  x0,y11,   x0,y10
			 ]);
     indexcitypaneltext=index;		
	 
   nibuff=i;
   gl.bindBuffer(gl.ARRAY_BUFFER, citypanelVertexPositionBuffer[nibuff]);
   gl.bufferData(gl.ARRAY_BUFFER, (citypanelvertices), gl.STATIC_DRAW);
   citypanelVertexPositionBuffer[nibuff].itemSize = 4;
   citypanelVertexPositionBuffer[nibuff].numItems = indexcitypanel/4;

   gl.bindBuffer(gl.ARRAY_BUFFER, citypanelVertexTextureCoordBuffer[nibuff]);
   gl.bufferData(gl.ARRAY_BUFFER, (citypaneltextureCoords), gl.STATIC_DRAW);
   citypanelVertexTextureCoordBuffer[nibuff].itemSize = 2;
   citypanelVertexTextureCoordBuffer[nibuff].numItems = indexcitypaneltext/2;
   }}

}
var scaleh=1.8;
function addtower(way){
   var xx=0,xxx=0,yy=0,yyy=0,r=1,dr=1;
   var dxx=0,dyy=0,zz=0,zzz=0;
   var s=0,t=0,tt=0;
   var h=scaleh,amenity="",building="",hmin=0,h00=0,tmarket=0,trailstation=0,tofficial=0;
   var thospital=0;
   if(way.tags){
    if(way.tags.height){h00=way.tags.height/6;
	        }
    else if(way.tags["building:height"]){
		    h00=way.tags["building:height"]/6;
			}
    else if(way.tags["building:levels"]){
		    h00=way.tags["building:levels"]*1.0;// /4;
			}
    else if(way.tags.levels){
		    h00=way.tags.levels*1.0;// /4;
			}
	if(h00>0){h=h00;}
    if(way.tags.min_height){hmin=way.tags.min_height/6;}
    else if(way.tags["building:min_height"]){
		    hmin=way.tags["building:min_height"]/6;
			}
    else if(way.tags["building:min_level"]){
		    hmin=way.tags["building:min_level"]*1.0;// /4;
			}
    if(way.tags.amenity){
	   amenity=way.tags.amenity;//amenity="fuel";//way.tags.amenity;
	   }
	if(way.tags.building){building=way.tags.building;
	   if(building=="hospital"){amenity="hospital";}
	   }   
	if(way.tags.shop){tmarket=1;}
   }
   var jmax=way.nodes.length;//-1;
   var larg=1,ilarg=way.nodes[parseInt(jmax*0.51)];
   var i0=way.nodes[0];
   var xmid=0,ymid=0,zmid=0,ztree=-9999,larg2=1,latmid=-90,lonmid=0,latmid2=-90,lonmid2=0;
   var latmid0=-90,lonmid0=0,latmid20=-90,lonmid20=0;
   if(latnodes[ilarg] && latnodes[i0]){
   	   latmid=latnodes[i0];lonmid=lonnodes[i0];
   	   latmid2=latnodes[ilarg];lonmid2=lonnodes[ilarg];
	   latmid0=latmid;lonmid0=lonmid;
	   latmid20=latmid2;lonmid20=lonmid2;
	   yyy=(latnodes[i0]-latx0)*scale*2;
	   xxx=((lonnodes[i0]-lngx0)/klon)*scale*2;
   	   yy=(latnodes[ilarg]-latx0)*scale*2;
	   xx=((lonnodes[ilarg]-lngx0)/klon)*scale*2;
       larg=Math.max(Math.abs(xx-xxx),Math.abs(yy-yyy));
	   xmid=(xx+xxx)/2;
	   ymid=(yy+yyy)/2;
	   //if(((xmid-x)*(xmid-x)+(ymid-y)*(ymid-y))>4*Math.max(200*200,5*dxmax*5*dxmax)){return;}
	   zmid=Math.min(getterrainheight(lonnodes[i0],latnodes[i0]),
	        getterrainheight(lonnodes[ilarg],latnodes[ilarg]));
	   ztree=(latnodes[i0]+lonnodes[i0])*1000000;
	   ztree=(ztree-100*parseInt(ztree/100))/2000;
	   ztree+=zsol0-0.01;//-0.06+zsol0;
	   //zmid-=0.5;
   }
   ilarg=way.nodes[parseInt(jmax*0.76)];
   i0=way.nodes[parseInt(jmax*0.26)];
   if(latnodes[ilarg] && latnodes[i0]){
   	   latmid=latnodes[i0];lonmid=lonnodes[i0];
   	   latmid2=latnodes[ilarg];lonmid2=lonnodes[ilarg];
	   yyy=(latnodes[i0]-latx0)*scale*2;
	   xxx=((lonnodes[i0]-lngx0)/klon)*scale*2;
   	   yy=(latnodes[ilarg]-latx0)*scale*2;
	   xx=((lonnodes[ilarg]-lngx0)/klon)*scale*2;
       larg2=Math.max(Math.abs(xx-xxx),Math.abs(yy-yyy));
   	  if(xmid==0 && ymid==0){
	   xmid=(xx+xxx)/2;
	   ymid=(yy+yyy)/2;
	   zmid=99999;
	   //if(((xmid-x)*(xmid-x)+(ymid-y)*(ymid-y))>4*Math.max(200*200,5*dxmax*5*dxmax)){return;}
      }
	   zmid=Math.min(zmid,getterrainheight(lonnodes[i0],latnodes[i0]));
	   zmid=Math.min(zmid,getterrainheight(lonnodes[ilarg],latnodes[ilarg]));
      if(latmid0>-89 && latmid20>-89){	  
	   var latmin=Math.min(latmid,Math.min(latmid2,Math.min(latmid0,latmid20)));
	   var lonmin=Math.min(lonmid,Math.min(lonmid2,Math.min(lonmid0,lonmid20)));
	   var latmax=Math.max(latmid,Math.max(latmid2,Math.max(latmid0,latmid20)));
	   var lonmax=Math.max(lonmid,Math.max(lonmid2,Math.max(lonmid0,lonmid20)));
	   for(var i=0;i<nmarket;i++){
	       if(marketlat[i]>latmin && marketlat[i]<latmax){
	        if(marketlon[i]>lonmin && marketlon[i]<lonmax){
			   tmarket=1;break;
	   }}}
	   for(var i=0;i<nrailstation;i++){
	       if(railstationlat[i]>latmin && railstationlat[i]<latmax){
	        if(railstationlon[i]>lonmin && railstationlon[i]<lonmax){
			   trailstation=1;break;
	   }}}
	   }
	   //ztree=(latnodes[i0]+lonnodes[i0])*1000000;
	   //ztree=(ztree-100*parseInt(ztree/100))/2000;
	   //ztree+=zsol0-0.01;//-0.06+zsol0;
	   //if(zmid<0.01 && (Math.abs(xmid-x)>50 || Math.abs(ymid-y)>50)){
	   //   zmid=getterrainheightsrtm(lonmid,latmid);}
	   zmid-=0.5;
   }else{zmid-=0.5;}
   jmax-=1;
   larg=Math.max(larg2,larg);
zz=zmid;zzz=zmid;
if(wayname=="tour eiffel"){h=4;return;}
if(wayname.indexOf("pyramid of khufu")>=0){h=1;return}//gizah
if(wayname.indexOf("united states capitol")==0){h=1;}
if(isNaN(h)){h=5;}
//tmarket=1;
if(amenity=="place_of_worship"){h=Math.max(3.1,h);tmarket=0;}
else if(amenity!=""){h=Math.max(1.1,h);tmarket=0;tofficial=1;
                     if(amenity=="hospital"){thospital=1;};}
var h0=h;
h+=0.5;
//if(layer>0.9){hmin=1.2;}
if(tmarket==1){var r=3,g=15,b=3;icolor=parseInt(20000+(r*256+g*16+b)*256);}
if(trailstation==1){var r=3+3,g=3+5,b=15;icolor=parseInt(20000+(r*256+g*16+b)*256);
                    tofficial=1;amenity="hospital";thospital=1;}
var dty=0;if(icolor>19999){dty=icolor;}
if(latmid>-89){trottoirlat[ntrottoir]=(latmid+latmid2)/2;
               trottoirlon[ntrottoir]=(lonmid+lonmid2)/2;
			   trottoirr[ntrottoir]=(Math.abs(latmid-latmid2)+Math.abs(lonmid-lonmid2)/klon)/2;
			   ntrottoir+=1;}
var droofmax=120;
if(h0>3 || hmin>0.1 || tofficial==1 || trailstation==1){//tower
   if(indextower>=(maxvertice*3-1)){return;}
   //if(h0>8){tairport=1;}
   if(hmin>0.1){zmid+=0.5;h-=0.5;}
   h-=hmin;if(h<0.1){h=0.1;}
   zmid+=hmin;
   zz=zmid;zzz=zz;
   var hshop=0,stt=0,st=0;
   if(larg<10 && larg>5){tmarket=1;}
   if(indexshop>=(maxvertice*3-1)){tmarket=0;}
   if(tmarket==1){hshop=1;if(h<hshop){hshop=h;h=0;};if(hshop<0.011){hshop=0;};}
   var jstart=0;
   var xxmin=xmid+999999,xxmax=xmid-999999;
   var yymin=ymid+999999,yymax=ymid-999999;
   var kdr=0;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){
	   xxx=xx;yyy=yy;zzz=zz;
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   zz=zmid;
	   if(xx<xxmin){xxmin=xx;}
	   if(xx>xxmax){xxmax=xx;}
	   if(yy<yymin){yymin=yy;}
	   if(yy>yymax){yymax=yy;}
	   if(jstart==0){jstart=1;//context.moveTo(xx,yy);
	   }else{//context.lineTo(xx,yy);
	        dxx=xx-xxx;dyy=yy-yyy;
			if(kdr==0){kdr=1;if(dxx*(yy-ymid)+dyy*(xmid-xx)>0){kdr=-kdr;}}
			dr=kdr*Math.max(0.00001,Math.sqrt(dxx*dxx+dyy*dyy));
		if(amenity!="place_of_worship"){
		   if(h>0.01 && amenity==""){
			index=indextower;
		    append(towervertices,[
              xxx,yyy,zzz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+h,
			  xx,yy,zz+hshop
            ]);
			indextower=index;
		   }
		   if(h>0.01 && amenity=="hospital"){
			index=indexhospital;
		    append(hospitalvertices,[
              xxx,yyy,zzz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+h,
			  xx,yy,zz+hshop
            ]);
			indexhospital=index;
		   }
		   else if(h>0.01 && amenity!=""){
			index=indexofficial;
		    append(officialvertices,[
              xxx,yyy,zzz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+h,
			  xx,yy,zz+hshop
            ]);
			indexofficial=index;
		   }
		   if(hshop>0.01){
			index=indexshop;
		    append(shopvertices,[
              xxx,yyy,zzz,
			  xxx,yyy,zzz+hshop,
			  xx,yy,zz,
			  xxx,yyy,zzz+hshop,
			  xx,yy,zz+hshop,
			  xx,yy,zz
            ]);
			indexshop=index;
		   }
		}else{
			index=indexchurch;
		    append(churchvertices,[
              xxx,yyy,zzz,
			  xxx,yyy,zzz+h,
			  xx,yy,zz,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+h,
			  xx,yy,zz
            ]);
			indexchurch=index;
		}
			wallx[iwall]=xxx;wally[iwall]=yyy;wallh[iwall]=zzz+h;
			wallco1[iwall]=dxx/dr;wallsi1[iwall]=dyy/dr;walll[iwall]=dr;
			iwall+=1;
			var s0=(parseInt(h0*10.5)%10)*400;
			if(thospital==1){s0=0;s=s0+1+parseInt(h*0.5);tt=t;t+=0.315*dr;}
			else if(tofficial==1){s0=0;s=s0+1+parseInt(h);tt=t;t+=0.5*dr;}
			else if(h0<=3){s=s0+1+parseInt(h*2);tt=t;t+=2*dr;}
			else{s=s0+1+parseInt(h*2);tt=t;t+=dr;}
			var sshop=0;if(hshop>0.01){sshop=1;stt=st;st+=dr*0.115;}
			//s=s0+(s-s0)/2;t=tt+(t-tt)/1.5;//immeuble.jpg
			if(amenity=="place_of_worship"){
			   s0=0;//(parseInt(h0*20)%2)*400;//white,gray
			   s=s0+1+parseInt(h);
			   tt=t;t+=dr*0.75;
			   //s=s0+1+10000;s0+=10000;
			   }
			else if(dty>19999){s+=-s0+dty;s0+=-s0+dty;}
			else if(amenity=="hospital"){s0+=1201;s+=1201;}
			else if(amenity!=""){s0+=10000;s+=10000;}
        if(amenity!="place_of_worship"){
		   if(h>0.01 && amenity==""){
			index=itexttower;
		    append(towertextureCoords,[
			  tt,s0+sshop,
			  tt,s,
			  t,s0+sshop,
			  tt,s,
			  t,s,
			  t,s0+sshop
            ]);
			itexttower=index;
		   }
		   if(h>0.01 && amenity=="hospital"){
			index=itexthospital;
		    append(hospitaltextureCoords,[
			  tt,s0+sshop,
			  tt,s,
			  t,s0+sshop,
			  tt,s,
			  t,s,
			  t,s0+sshop
            ]);
			itexthospital=index;
		   }
		   else if(h>0.01 && amenity!=""){
			index=itextofficial;
		    append(officialtextureCoords,[
			  tt,s0+sshop,
			  tt,s,
			  t,s0+sshop,
			  tt,s,
			  t,s,
			  t,s0+sshop
            ]);
			itextofficial=index;
		   }
		   if(hshop>0.01){
		    var ss0=-0.8;
			index=itextshop;
		    append(shoptextureCoords,[
			  stt,ss0,
			  stt,sshop,
			  st,ss0,
			  stt,sshop,
			  st,sshop,
			  st,ss0
            ]);
			itextshop=index;
		   }
		}else{
			index=itextchurch;
		    append(churchtextureCoords,[
			  tt,s0,
			  tt,s,
			  t,s0,
			  tt,s,
			  t,s,
			  t,s0
            ]);
			itextchurch=index;
		}
		   }
	 }  
   }
   //xx=xmid;yy=ymid;
   var xmid0=xmid,ymid0=ymid;
   xmid=(xxmin+xxmax)/2;
   ymid=(yymin+yymax)/2;
  if(ztree>-999){
   dxx=xx-xmid;
   dyy=yy-ymid;
   var r=Math.sqrt(dxx*dxx+dyy*dyy)+0.001;
   addtree(xx+dxx/r,yy+dyy/r,ztree);
   if(zmid<-0.1){
     xx=xmid0;yy=ymid0;
	 dxx=xx-xmid;
     dyy=yy-ymid;
     r=Math.sqrt(dxx*dxx+dyy*dyy)+0.001;
     addtree(xx+dxx/r,yy+dyy/r,ztree);
   }
  }
  if(larg<droofmax){  
   var hh=0;
   //hh=Math.max(hh,Math.min(xxmax-xxmin,yymax-yymin)/12);
   hh=h+hh;
   tt=0;t=0;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){
	   xxx=xx;yyy=yy;zzz=zz;
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   zz=zmid;
	   if(jstart==0){jstart=1;//context.moveTo(xx,yy);
	   }else{//context.lineTo(xx,yy);
	        dxx=xx-xxx;dyy=yy-yyy;
			dr=Math.max(0.00001,Math.abs(dxx)+Math.abs(dyy));
			index=indexroof;
		    append(roofvertices,[
              xmid,ymid,zmid+hh,
			  xx,yy,zz+h,
			  xxx,yyy,zzz+h
            ]);
			indexroof=index;
            tt=t;t+=dr;
			index=itextroof;
		    append(rooftextureCoords,[
			  0.5,1,
			  t-parseInt(t),0,
			  tt-parseInt(tt),0
            ]);
			itextroof=index;
		}}
	}}
}else if(larg>12*h0){//commercial 
   if(indextower>=(maxvertice*3-1)){return;}
   if(h00==0){h=Math.max(0.5,Math.min(3,larg/12));}
   var hshop=0,stt=0,st=0;
   if(larg<10 && larg>5){tmarket=1;}
   if(larg<10 && larg>2.5 && tsequoia>0){tmarket=1;}
   if(indexshop>=(maxvertice*3-1)){tmarket=0;}
   if(tmarket==1){hshop=1.2;if(h<hshop){hshop=h;h=0;};if(hshop<0.011){hshop=0;};}
   var jstart=0;
   var xxmin=xmid+999999,xxmax=xmid-999999;
   var yymin=ymid+999999,yymax=ymid-999999;
   var kdr=0;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){
	   xxx=xx;yyy=yy;zzz=zz;
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   zz=zmid;
	   if(jstart==0){jstart=1;//context.moveTo(xx,yy);
	   }else{//context.lineTo(xx,yy);
	        dxx=xx-xxx;dyy=yy-yyy;
			if(kdr==0){kdr=1;if(dxx*(yy-ymid)+dyy*(xmid-xx)>0){kdr=-kdr;}}
			dr=kdr*Math.max(0.00001,Math.sqrt(dxx*dxx+dyy*dyy));
		   if(h>0.01){
			index=indextower;
		    append(towervertices,[
              xxx,yyy,zzz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+h,
			  xx,yy,zz+hshop
            ]);
			indextower=index;
		   }
		   if(hshop>0.01){
			index=indexshop;
		    append(shopvertices,[
              xxx,yyy,zzz,
			  xxx,yyy,zzz+hshop,
			  xx,yy,zz,
			  xxx,yyy,zzz+hshop,
			  xx,yy,zz+hshop,
			  xx,yy,zz
            ]);
			indexshop=index;
		   }
			wallx[iwall]=xxx;wally[iwall]=yyy;wallh[iwall]=zzz+h;
			wallco1[iwall]=dxx/dr;wallsi1[iwall]=dyy/dr;walll[iwall]=dr;
			iwall+=1;
			var s0=(parseInt(h0*10.5)%10)*400;
			if(h0<=3){s=s0+1+parseInt(h*2);tt=t;t+=2*dr/3.5;}
			else{s=s0+1+parseInt(h*2);tt=t;t+=dr/3.5;}
			var sshop=0;if(hshop>0.01){sshop=1;stt=st;st+=dr*0.113;}
			//s=s0+(s-s0)/2;t=tt+(t-tt)/1.5;//immeuble.jpg
			if(amenity=="place_of_worship"){
			   s=s0+1+10000;s0+=10000;}
			else if(dty>19999){s+=-s0+dty;s0+=-s0+dty;}
			else if(amenity!=""){s0+=10000;s+=10000;}
		   if(h>0.01){
			index=itexttower;
		    append(towertextureCoords,[
			  tt,s0+sshop,
			  tt,s,
			  t,s0+sshop,
			  tt,s,
			  t,s,
			  t,s0+sshop
            ]);
			itexttower=index;
		   }
		   if(hshop>0.01){
		    var ss0=-0.7;
			index=itextshop;
		    append(shoptextureCoords,[
			  stt,ss0,
			  stt,sshop,
			  st,ss0,
			  stt,sshop,
			  st,sshop,
			  st,ss0
            ]);
			itextshop=index;
		   }
		   }
	 }  
   }
   xmid=(xxmin+xxmax)/2;
   ymid=(yymin+yymax)/2;
   //xx=xmid;yy=ymid;
   xmid=(xxmin+xxmax)/2;
   ymid=(yymin+yymax)/2;
  if(ztree>-999){ 
   dxx=xx-xmid;
   dyy=yy-ymid;
   var r=Math.sqrt(dxx*dxx+dyy*dyy)+0.001;
   addtree(xx+dxx/r,yy+dyy/r,ztree);
  }
  if(larg<droofmax){  
   var hh=0;
   //hh=Math.max(hh,Math.min(xxmax-xxmin,yymax-yymin)/12);
   hh=h+hh;
   tt=0;t=0;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){
	   xxx=xx;yyy=yy;zzz=zz;
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   zz=zmid;
	   if(jstart==0){jstart=1;//context.moveTo(xx,yy);
	   }else{//context.lineTo(xx,yy);
	        dxx=xx-xxx;dyy=yy-yyy;
			dr=Math.max(0.00001,Math.abs(dxx)+Math.abs(dyy));
			index=indexroof;
		    append(roofvertices,[
              xmid,ymid,zmid+hh,
			  xx,yy,zz+h,
			  xxx,yyy,zzz+h
            ]);
			indexroof=index;
            tt=t;t+=dr;
			index=itextroof;
		    append(rooftextureCoords,[
			  0.5,1,
			  t-parseInt(t),0,
			  tt-parseInt(tt),0
            ]);
			itextroof=index;
		}}
	}}
}else if(ttower==0){//house
   if(indexhouse>(maxvertice*3-31)){return;}
   if(larg>1.5 && h00==0){
     h=Math.max(h0,Math.min(3,h0*12*h0/larg));
     h=Math.max(h0,Math.min(2.5*larg,h));
   }
   if(larg>5 && larg<10 && tsequoia==0){tmarket=1;}
   var hshop=0,stt=0,st=0;//tmarket=1;
   if(indexshop>=(maxvertice*3-1)){tmarket=0;}
   if(tmarket==1){hshop=1;if(h<hshop){hshop=h;h=0;};if(hshop<0.011){hshop=0;};}
   var jstart=0;
   var xxmin=xmid+999999,xxmax=xmid-999999;
   var yymin=ymid+999999,yymax=ymid-999999;
   var kdr=0;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){
	   xxx=xx;yyy=yy;zzz=zz;
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   zz=zmid;
	   if(xx<xxmin){xxmin=xx;}
	   if(xx>xxmax){xxmax=xx;}
	   if(yy<yymin){yymin=yy;}
	   if(yy>yymax){yymax=yy;}
	   if(jstart==0){jstart=1;//context.moveTo(xx,yy);
	   }else{//context.lineTo(xx,yy);
	        dxx=xx-xxx;dyy=yy-yyy;
			if(kdr==0){kdr=1;if(dxx*(yy-ymid)+dyy*(xmid-xx)>0){kdr=-kdr;}}
			dr=kdr*Math.max(0.00001,Math.sqrt(dxx*dxx+dyy*dyy));
		   if(h>0.01){
			index=indexhouse;
		    append(housevertices,[
              xxx,yyy,zzz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+hshop,
			  xxx,yyy,zzz+h,
			  xx,yy,zz+h,
			  xx,yy,zz+hshop
            ]);
			indexhouse=index;
		   }
		   if(hshop>0.01){
			index=indexshop;
		    append(shopvertices,[
              xxx,yyy,zzz,
			  xxx,yyy,zzz+hshop,
			  xx,yy,zz,
			  xxx,yyy,zzz+hshop,
			  xx,yy,zz+hshop,
			  xx,yy,zz
            ]);
			indexshop=index;
		   }
			wallx[iwall]=xxx;wally[iwall]=yyy;wallh[iwall]=zzz+h;
			wallco1[iwall]=dxx/dr;wallsi1[iwall]=dyy/dr;walll[iwall]=dr;
			iwall+=1;
			/*var s0=(parseInt(h0*10.5)%10)*400;
			if(h0<=3){s=s0+1+parseInt(h*2);tt=t;t+=2*dr;}
			else{s=s0+1+parseInt(h*2);tt=t;t+=dr;}*/
			var s0=(parseInt(h*10.5)%10)*400;
			//if(h0<=3){s=s0+1+parseInt(h*2);tt=t;t+=2*dr;}
			if(h0<=3){s=s0+1+parseInt(h*2);tt=t;t+=1.3*dr;}
			else{s=s0+1+parseInt(h*2);tt=t;t+=dr;}
			var sshop=0;if(hshop>0.01){sshop=1;stt=st;st+=dr*0.113;}
			/*var s0=(parseInt(h0*10.5)%10)*200;
			//if(h0<=3){s=s0+1+parseInt(h*2);tt=t;t+=2*dr;}
			if(h0<=3){s=s0+1+parseInt(h);tt=t;t+=0.331*dr;}
			else{s=s0+1+parseInt(h);tt=t;t+=dr*0.27;}*/
			if(amenity=="place_of_worship"){
			   s=s0+1+10000;s0+=10000;}
			else if(dty>19999){s+=-s0+dty;s0+=-s0+dty;}
			else if(amenity!=""){s0+=10000;s+=10000;}
		   if(h>0.01){
			index=itexthouse;
		    append(housetextureCoords,[
			  tt,s0+sshop,
			  tt,s,
			  t,s0+sshop,
			  tt,s,
			  t,s,
			  t,s0+sshop
            ]);
			itexthouse=index;
		   }
		   if(hshop>0.01){
		    var ss0=-0.8;
			index=itextshop;
		    append(shoptextureCoords,[
			  stt,ss0,
			  stt,sshop,
			  st,ss0,
			  stt,sshop,
			  st,sshop,
			  st,ss0
            ]);
			itextshop=index;
		   }
		   }
	 }  
   }
   xmid=(xxmin+xxmax)/2;
   ymid=(yymin+yymax)/2;
  if(ztree>-999){ 
   dxx=xx-xmid;
   dyy=yy-ymid;
   var r=Math.sqrt(dxx*dxx+dyy*dyy)+0.001;
   addtree(xx+dxx/r,yy+dyy/r,ztree);
  } 
  if(larg<droofmax){  
   var hh=h0*0.2;
   hh=Math.max(hh,Math.min(xxmax-xxmin,yymax-yymin)/12);
   hh=h+hh;
   tt=0;t=0;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){
	   xxx=xx;yyy=yy;zzz=zz;
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   zz=zmid;
	   if(jstart==0){jstart=1;//context.moveTo(xx,yy);
	   }else{//context.lineTo(xx,yy);
	        dxx=xx-xxx;dyy=yy-yyy;
			dr=Math.max(0.00001,Math.abs(dxx)+Math.abs(dyy));
			index=indexroof;
		    append(roofvertices,[
              xmid,ymid,zmid+hh,
			  xx,yy,zz+h,
			  xxx,yyy,zzz+h
            ]);
			indexroof=index;
            tt=t;t+=dr;
			index=itextroof;
		    append(rooftextureCoords,[
			  0.5,1,
			  t-parseInt(t),0,
			  tt-parseInt(tt),0
            ]);
			itextroof=index;
		}}
	}}
}
}
function addforest(way){
   var jmax=way.nodes.length-1;
   var jstart=0;
   var xxmin=999999,xxmax=-999999;
   var yymin=999999,yymax=-999999;
   var xx=0,yy=0,xxx=0,yyy=0;
   var dx=1,dy=1,dxx=0,dyy=0,dx0=0,dy0=0,zz=0,zzz=0;
   var di=1,xx0=0,yy0=0,zz0=0,xxx0=0,yyy0=0,zzz0=0;
   var dr0=1,latxx=0,lngxx=0,latxxx=0,lngxxx=0;
   var o1ii=0,o10ii=0,inode0=0;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   if(xx<xxmin){xxmin=xx;}
	   if(xx>xxmax){xxmax=xx;}
	   if(yy<yymin){yymin=yy;}
	   if(yy>yymax){yymax=yy;}
	   }}
   var xmid=(xxmin+xxmax)/2;
   var ymid=(yymin+yymax)/2; 
   var ddmin=9999;
   for(var j=0;j<=jmax;j++){
     var inode=way.nodes[j];
	 if(latnodes[inode]){
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   ddmin=Math.min(Math.abs(xx-xmid)+Math.abs(yy-ymid),ddmin);
   }}
   if(ddmin>9990){return;}
   ddmin=ddmin+Math.min(xxmax-xxmin,yymax-yymin)/3;   
   if(ddmin>200){tsequoia=2;}
   if(ddmin>100 && tsequoia==0){tsequoia=1;}
   for(var j=0;j<=jmax+1;j++){
     var inode;
	 if(j==(jmax+1)){inode=inode0;}
	 else{inode=way.nodes[j];}
	 if(latnodes[inode]){
	   if(inode0==0){inode0=inode;}
	   //xxx0=xxx;yyy0=yyy;xx0=xx;yy0=yy;
	   xxx=xx;yyy=yy;
	   yy=(latnodes[inode]-latx0)*scale*2;
	   xx=((lonnodes[inode]-lngx0)/klon)*scale*2;
	   if(jstart==0){jstart=1;//context.moveTo(xx,yy);
	   }else{//context.lineTo(xx,yy);
	      dxx=xx-xxx;dyy=yy-yyy;
		  dr=Math.max(0.00001,Math.sqrt(dxx*dxx+dyy*dyy));
		  if(dr>1){
			//di=1;if(dr>27){di=parseInt(dr/20);}
			di=1;if(dr>14){di=parseInt(dr/10);}
			dr0=dr;
			dr=dr0/di;
			var dxxii=(xx-xxx)/di;
			var dyyii=(yy-yyy)/di;
			xx=xxx;yy=yyy;
		   for(var ii=1;ii<=di;ii++){
			xx+=dxxii;
			yy+=dyyii;
			o1ii=diro1(xx-xmid,yy-ymid);
			var dkx=xx-xmid,dky=yy-ymid;
			var kk=0.1+Math.sqrt(dkx*dkx+dky*dky);
			var dk=kk/4;
			var do1ii=Math.abs(o1ii-o10ii);
			if(do1ii>180){do1ii=360-do1ii;}
			if(do1ii>Math.min(10,220/dk)){//8
			 if(dk>2){//2
			  o10ii=o1ii;
			  //for(k=1+dk/8;k<dk;k+=1+(dk-k)/8){
			  //for(var k=0.25+(((o1ii*40)%18)/18)*dk/14;k<dk;k+=0.2+(dk-k)/14){
			  for(var k=0.25+(((o1ii*40)%18)/18)*dk/14;k<dk;k+=2*(0.2+(dk-k)/14)){
			   var dkk=((k*111)%10-5)*(k+1)/50;
			   var xtree=xmid+dkx*k/dk-dkk*dky/dk;
			   var ytree=ymid+dky*k/dk+dkk*dkx/dk;
			   var ztree=parseInt(((xtree+ytree)%3)/2+1)/2000;//getterrainheight3(xtree,ytree,latx0,lngx0);
			   var typtree=parseInt((Math.abs(xtree+ytree)*10))%2;
			   if(typtree==0){addtree2(xtree,ytree,ztree);}
			   else{addtree22(xtree,ytree,ztree);}
			}}
			}
			//xx0=xx;yy0=yy;xxx0=xxx;yyy0=yyy;
		    //xxx=xx;yyy=yy;
		   }//ii		   
		   }}
		   //xxx=xxx0;yyy=yyy0;xx=xx0;yy=yy0;
		}}   
}
var MERCATOR_RANGE = 256;
function degreesToRadians(deg) {
  return deg * (Math.PI / 180);
}
function radiansToDegrees(rad) {
  return rad / (Math.PI / 180);
}
var pixeloriginx=MERCATOR_RANGE / 2;
var pixeloriginy=MERCATOR_RANGE / 2;
var pixelsPerLonDegree = MERCATOR_RANGE / 360;
var pixelsPerLonRadian = MERCATOR_RANGE / (2 * Math.PI);

var pointx=0,pointy=0,worldx=0,worldy=0,zoom=14;
function MercatorLatLngtoPoint(lat,lng) {
  pointx = pixeloriginx + lng * pixelsPerLonDegree;
  // NOTE(appleton): Truncating to 0.9999 effectively limits latitude to
  // 89.189.  This is about a third of a tile past the edge of the world tile.
  var siny=Math.min(Math.max(Math.sin(degreesToRadians(lat)),-0.9999),0.9999);
  pointy = pixeloriginy+0.5*Math.log((1+siny)/(1-siny))*pixelsPerLonRadian;  
};

function MercatorPointtoLatLng(pointx,pointy) {
  lng=(pointx-pixeloriginx)/pixelsPerLonDegree;
  var latRadians = (pointy-pixeloriginy)/pixelsPerLonRadian;
  lat=radiansToDegrees(2*Math.atan(Math.exp(latRadians))-Math.PI/2);
};
function getlatlng(zoom,worldx,worldy){
pointx = worldx / Math.pow(2,zoom);
pointy = worldy / Math.pow(2,zoom);
MercatorPointtoLatLng(pointx,pointy);
}
function getworldxy(zoom,lat,lng){
MercatorLatLngtoPoint(lat,lng);
worldx=pointx*Math.pow(2,zoom);
worldy=pointy*Math.pow(2,zoom);
}	 
var fullscreen=1,windx2=windx/2,windy2=windy/2;
function sizescreen(){
	    if(fullscreen==0){fullscreen=1;
		                  canvas.width  = parseInt(window.innerWidth*0.98);
                          canvas.height = parseInt(window.innerHeight*0.94);
	    }else if(fullscreen==1){fullscreen=2;
		                  canvas.width  = parseInt(window.innerWidth*0.8);
                          canvas.height = parseInt(window.innerHeight*0.8);
						 }else{fullscreen=0;
						  canvas.width=600;canvas.height=400;};
	if(cssscale<1){cssscale=1;}
	if(cssscale>4){cssscale=4;}
	if(cssscaley<1){cssscaley=1;}
	if(cssscaley>4){cssscaley=4;}
	canvas.width  = Math.min(canvas.width,window.innerWidth-20);
    canvas.height = Math.min(canvas.height,window.innerHeight-36);
	canvasgl.width  = Math.min(canvas.width,window.innerWidth-20);
    canvasgl.height = Math.min(canvas.height,window.innerHeight-36);
	var width0=canvasgl.width,height0=canvasgl.height;
	canvasgl.width=parseInt(canvas.width*(1/cssscale));
	canvasgl.height=parseInt(canvas.height*(1/cssscaley));
	var cssscale1=width0/canvasgl.width;
	var cssscaley1=height0/canvasgl.height;
	gl.viewportWidth = canvasgl.width;
    gl.viewportHeight = canvasgl.height;
			windx = canvasgl.width;
            windy = canvasgl.height;
            gl.viewport(0, 0, windx,windy);
            windx2=parseInt(windx/2);
			windy2=parseInt(windy/2);
            document.getElementById("canvasgl").setAttribute("style",
	         "border: none;top:0px;left:0px;-ms-transform: scale("+cssscale1+","+cssscaley1+"); /* IE 9 */-webkit-transform: scale("+cssscale+","+cssscaley+"); /* Chrome, Safari, Opera */transform: scale("+cssscale+","+cssscaley+");-ms-transform-origin: 0 0;-webkit-transform-origin: 0 0;transform-origin: 0 0;");
	         //"border: red 1px solid;top:0px;left:0px;-ms-transform: scale("+cssscale+",1); /* IE 9 */-webkit-transform: scale("+cssscale+",1); /* Chrome, Safari, Opera */transform: scale("+cssscale+",1);-ms-transform-origin: 0 0;-webkit-transform-origin: 0 0;transform-origin: 0 0;";
            //document.getElementById("canvas").setAttribute("style",
	        // "border: none;top:0px;left:0px;");
    //canvas.height = parseInt(canvasgl.height/3);
	//canvas.width  = 200;
	tmap=0;
    if(tfocus==1){document.getElementById("msg").focus();}
    if(tradio==1){
	 if(fullscreen==0){
	  document.getElementById('radiodiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-68-15)+'px;left:'+parseInt(windx*cssscale)+'px;width:120px;height:80px;z-index:500;' );
	 }else{
	  document.getElementById('radiodiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-68-15)+'px;left:'+parseInt(windx*cssscale-120)+'px;width:120px;height:80px;z-index:500;' );
	 }
     document.getElementById('radio').setAttribute('style','top:0px;left:0px;width:119px;height:50px;' );
     tradioexpand=0;radioreduce();	
	} 
	testzoom();
}
function testzoom(){
    if(fullscreen==0){
	 document.getElementById('zoomdiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-36)+'px;left:'+parseInt(windx*cssscale*0.657+118)+'px;width:40px;height:20px;z-index:500;' );
	}else{
	 document.getElementById('zoomdiv').setAttribute('style','position:absolute;top:'+parseInt(windy*cssscaley-36)+'px;left:'+parseInt(windx*cssscale*0.657+118)+'px;width:120px;height:980px;z-index:500;' );
	}
    if((tfoot==0 && tminimap==1) || (tfoot==1 && tminimap2==1)){
       document.getElementById('zoomdiv').style.visibility = 'visible';}
    else{document.getElementById('zoomdiv').style.visibility='hidden';}	  
}
var zoomminimap=1;
function subzoom(){
    if(zoomminimap==1){zoomminimap=2;}
	else if(zoomminimap==2){zoomminimap=4;}
	else{zoomminimap=1;}
document.getElementById('msg').focus();
}
function sizescreen2(){
	if(cssscale2<1){cssscale2=1;}
	if(cssscale2>4){cssscale2=4;}
	if(cssscaley2<1){cssscaley2=1;}
	if(cssscaley2>4){cssscaley2=4;}
	var canvasglwidth  = Math.min(canvas.width,window.innerWidth-20);
    var canvasglheight = Math.min(canvas.height,window.innerHeight-36);
	var width0=canvasglwidth,height0=canvasglheight;
	canvasgl.width=parseInt(canvas.width*(1/cssscale2));
	canvasgl.height=parseInt(canvas.height*(1/cssscaley2));
	var cssscale1=width0/canvasgl.width;
	var cssscaley1=height0/canvasgl.height;
	gl.viewportWidth = canvasgl.width;
    gl.viewportHeight = canvasgl.height;
			windx = canvasgl.width;
            windy = canvasgl.height;
            gl.viewport(0, 0, windx,windy);
            windx2=parseInt(windx/2);
			windy2=parseInt(windy/2);
            document.getElementById("canvasgl").setAttribute("style",
	         "border: none;top:0px;left:0px;-ms-transform: scale("+cssscale1+","+cssscaley1+"); /* IE 9 */-webkit-transform: scale("+cssscale2+","+cssscaley2+"); /* Chrome, Safari, Opera */transform: scale("+cssscale2+","+cssscaley2+");-ms-transform-origin: 0 0;-webkit-transform-origin: 0 0;transform-origin: 0 0;");
}
var cssscale0=cssscale,cssscaley0=cssscaley;
var cssscale2=cssscale,cssscaley2=cssscaley;
function subscale(scale){
cssscale2=cssscale;cssscaley2=cssscaley;
cssscale2*=scale;cssscaley2*=scale;
sizescreen2();
//cssscale=cssscale0;cssscaley=cssscaley0;
} 
function subcssscale(){ 
var crlf=String.fromCharCode(10),msg="";
var cssx0=cssscale,cssy0=cssscaley;  
  if(cssscale<=1){cssscale=1.4;
  }else if(cssscale<=1.4+0.01){cssscale=2.0;
  }else if(cssscaley<=1){cssscaley=1.2;
  }else if(cssscaley<=1.2+0.01){cssscaley=1.4;
  }else if(cssscaley<=1.4+0.01){cssscaley=1.7;
  }else if(cssscaley<=1.7+0.01){cssscaley=2.0;
  }else{cssscale=1;cssscaley=1;}
  msg="cssscalex="+cssscale;
  if(cssscale==1){msg+=" normal";}
  if(Math.abs(cssscale-1.4)<0.01){msg+=" lowerres,faster";}
  if(Math.abs(cssscale-2.0)<0.01){msg+=" more lowerres,faster";}
  msg+=crlf+"cssscaley="+cssscaley;
  if(cssscaley==1){msg+=" normal";}
  if(Math.abs(cssscaley-1.2)<0.01){msg+=" lowerres,faster";}
  if(Math.abs(cssscaley-1.4)<0.01){msg+=" more lowerres,faster";}
  if(Math.abs(cssscaley-1.7)<0.01){msg+=" more lowerres,faster";}
  if(Math.abs(cssscaley-2.0)<0.01){msg+=" more lowerres,faster";}
  
  if(confirm("set cssscale to "+crlf+crlf+msg+crlf+"?")){
    fullscreen-=1;sizescreen();
  }else{cssscale=cssx0;cssscaley=cssy0;}	
}
function subscalex(){
var k0=parseInt(100*kscalex)/100;
var k=prompt("scalex : enter a number 0.25 - 2.0 last="+k0)
if(k){k=Math.max(0.25,Math.min(2.0,k));}
if(k>=0.25 && k<=2.0){kscalex=k;scale=kscalex*scale0;
                      if(loading==0 || loading==1.4){drawgl(0);}else{trygetways=1;}
   } 
}
function subscaleh(){
var k0=parseInt(100*scaleh)/100;
var k=prompt("default scaleh : enter a number 0.5 - 2.0 last="+k0)
if(k){k=Math.max(0.5,Math.min(2.0,k));}
if(k>=0.5 && k<=2.0){scaleh=k;
                      if(loading==0 || loading==1.4){drawgl(0);}else{trygetways=1;}
   } 
}
var wind2=0;
function subwind(){
var k0=parseInt(100*wind)/100;
var k=prompt("wind : enter a number 0.0 - 200.0 last="+k0+" km/h")
if(k){k=Math.max(0,Math.min(200.0,evaln(k)));wind2=k;wind=k;msgload("");}
if(wind2<=0.01){trygetways=1;trygetweather=1;}
}
var geolocation="";
function geolocate(){
geolocation = "paris france";
geolocation=window.prompt("flyto : enter address or location");
//alert("geolocation="+geolocation);
if (geolocation.length>0){
  var geocoder = new google.maps.Geocoder();
  geocoder.geocode( { 'address': geolocation}, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      var latlng=results[0].geometry.location;
	  lat=latlng.lat();
	  lng=latlng.lng();
	  flytolat=lat;flytolng=lng;flytoname=geolocation;
	  combolat=lat;combolng=lng;locationname=flytoname;cityname="";
	  icombo=1;
	  document.getElementById('combo')[icombo].text=flytoname;
	  document.getElementById('combo').selectedIndex=icombo;
      latx0=lat;lngx0=lng;lngsol0=999;
      latx=lat;lngx=lng;tmap=0;z=-1;
	  tloadingreverse=timer()+1100;locx=99999;
      x00=999999;trygetways=1;tinit=0;//getways();
    } else {
      alert('Geolocation not found ! ' + status);
    }
  });
}
document.getElementById('msg').focus();
}
try{
var audioctx = new (window.AudioContext || window.webkitAudioContext)();
var twebaudio=1;
var songlength;
function loadsound(source,url){
source.request = new XMLHttpRequest();
source.request.open('GET', url, true);
source.request.responseType = 'arraybuffer';
source.request.onload = function() {
var audioData = source.request.response;
audioctx.decodeAudioData(audioData, function(buffer) {
//myBuffer = buffer;
songlength = buffer.duration;
source.buffer = buffer;
source.playbackRate.value = 1.0;
//source.connect(audioctx.destination);
source.loopStart=0.5;
source.loopEnd=songlength-0.5;
source.gainNode = audioctx.createGain();
source.connect(source.gainNode);
source.gainNode.connect(audioctx.destination);
source.gainNode.gain.value = 1.0;
if(source.onload){source.onload();}
},
function(e){alert("Error with decoding audio data" + e.err);});
}
source.request.send();
}
function loadsound64(source,data){
var audioData = Base64Binary.decodeArrayBuffer(data.split(",")[1]);
audioctx.decodeAudioData(audioData, function(buffer) {
//myBuffer = buffer;
songlength = buffer.duration;
source.buffer = buffer;
source.playbackRate.value = 1.0;
//source.connect(audioctx.destination);
source.loopStart=0.5;
source.loopEnd=songlength-0.5;
source.gainNode = audioctx.createGain();
source.connect(source.gainNode);
source.gainNode.connect(audioctx.destination);
source.gainNode.gain.value = 1.0;
if(source.onload){source.onload();}
audioData=null;
},
function(e){alert("Error with decoding audio data" + e.err);});
}
function setvol(source,vol){
  if(source.gainNode){source.gainNode.gain.value = vol;}
}
function setspeed(source,speed){
  if(source.playbackRate){source.playbackRate.value=speed;}
}
function playloop(source){source.loop=true;source.start(0);}
function playsound(source){if(!source.gainNode){return;}
  var sourcex = audioctx.createBufferSource(); // creates a sound source
  sourcex.buffer = source.buffer;  // tell the source which sound to play
  sourcex.loop=false;
  if(source.playbackRate){
     if(sourcex.playbackRate){sourcex.playbackRate.value=source.playbackRate.value;}
  }	 
  sourcex.connect(source.gainNode);       // connect the source to the audioctx's destination (the speakers)
  sourcex.start(0);                           // play the source now                                           // note: on older systems, may have to use deprecated noteOn(time);
}
function soundpause(source){
  source.disconnect();}
function soundunpause(source){
  source.connect(source.gainNode);}
var myaudiocar = audioctx.createBufferSource();
myaudiocar.volume=0;
loadsound64(myaudiocar,carmp3);
myaudiocar.onload=function(){
 setTimeout("playloop(myaudiocar);",340);
 setTimeout("setvol(myaudiocar,0.03);",340);
 setTimeout("setspeed(myaudiocar,0.9);",340);
 }
function soundcaron(){
//soundunpause(myaudiocar);
}
function soundcaroff(){
//soundpause(myaudiocar);
setvol(myaudiocar,0.01);
setvol(myaudiocar2,0.01);
}
var myaudiocar2 = audioctx.createBufferSource();
myaudiocar2.volume=0;
loadsound64(myaudiocar2,carmp3);
myaudiocar2.onload=function(){
 setTimeout("playloop(myaudiocar2);",340);
 setTimeout("setvol(myaudiocar2,0.03);",340);
 setTimeout("setspeed(myaudiocar2,0.9);",340);
 }
var myaudiowater = audioctx.createBufferSource();
myaudiowater.volume=0;
loadsound64(myaudiowater,watermp3);
myaudiowater.onload=function(){
 //setTimeout("playsound(myaudiowater);",900);
 setTimeout("setvol(myaudiowater,0.4);",800);
 setTimeout("setspeed(myaudiowater,1.0);",800);
 }
var planedo2=0,planedo3=0;
var tsoundwater=0;
function soundwater(){
 if(tframe>tsoundwater+700){
   tsoundwater=tframe;
   if(myisailship>=0){tsoundwater+=200+Math.random()*100-220+440/(1+psailshipv[myisailship]);}
   setvol(myaudiowater,0.4);
   playsound(myaudiowater);
   vcar=vcar*0.5+0.0001;
 }else{planedo2+=Math.min(350,(350-Math.abs(tframe-tsoundwater-350)))/500;
 }} 
var myaudioocean = audioctx.createBufferSource();
myaudioocean.volume=0;
loadsound64(myaudioocean,oceanmp3);
myaudioocean.onload=function(){
 //setTimeout("playsound(myaudioocean);",900);
 setTimeout("setvol(myaudioocean,0.4);",800);
 setTimeout("setspeed(myaudioocean,1.0);",800);
 }
var tsoundocean=0;
function soundocean(){
 if(tframe>tsoundocean+13500){
   tsoundocean=tframe;
   setvol(myaudioocean,0.4);
   playsound(myaudioocean);
 }} 
var myaudiopneu = audioctx.createBufferSource();
//audiosrc=folder+"pneu."+wav;
myaudiopneu.volume=0;
loadsound64(myaudiopneu,pneump3);
myaudiopneu.onload=function(){
 setTimeout("playsound(myaudiopneu);",500);
 setTimeout("setvol(myaudiopneu,0.11);",500);
 setTimeout("setspeed(myaudiopneu,1.0);",500);
 }
var tsoundpneu=0;
function soundpneu(){
 if(zsol<-0.04){return;}//water
 //if(tframe>tsoundpneu+700+(1.5-troad)*1000){
 if(tframe>tsoundpneu+700.350+(1.5-troad)*1000){
   tsoundpneu=tframe;
   //setvol(myaudiopneu,0.4*(1+0.5*(vcar-0.2)));
   if(troad==1){setspeed(myaudiopneu,1.0);}
   else{setspeed(myaudiopneu,0.95);}
   playsound(myaudiopneu);
 } 
}
var myaudiorain = audioctx.createBufferSource();
//audiosrc=folder+"rain."+wav;
myaudiorain.volume=0;
loadsound64(myaudiorain,rainmp3);
myaudiorain.onload=function(){
 //setTimeout("playloop(myaudiorain);",800);
 setTimeout("setvol(myaudiorain,0.3);",700);
 setTimeout("setspeed(myaudiorain,1.0);",700);
 }
var tsoundrain=0;
function soundrain(){
   if(tframe>tsoundrain+4500){tsoundrain=tframe;
      setvol(myaudiorain,0.3);
	  playsound(myaudiorain);}
   }
function stopsoundrain(){
   if(tframe<tsoundrain+4500){tsoundrain=0;setvol(myaudiorain,0.002);}
}
var myaudiocricket = audioctx.createBufferSource();
//audiosrc=folder+"cricket."+wav;
myaudiocricket.volume=0;
loadsound64(myaudiocricket,cricketmp3);
myaudiocricket.onload=function(){
 //setTimeout("playloop(myaudiocricket);",800);
 setTimeout("setvol(myaudiocricket,0.3);",700);
 setTimeout("setspeed(myaudiocricket,1.0);",700);
 }
var tsoundcricket=0;
function soundcricket(){
   if(tframe>tsoundcricket+6500){tsoundcricket=tframe;
      setvol(myaudiocricket,0.4*(ineartree/(ineartree+100)));
	  playsound(myaudiocricket);}
   }
function stopsoundcricket(){
   if(tframe<tsoundcricket+4500){tsoundcricket=0;setvol(myaudiocricket,0.002);}
}
var myaudionature = audioctx.createBufferSource();
//audiosrc=folder+"nature."+wav;
myaudionature.volume=0;
loadsound64(myaudionature,naturemp3);
myaudionature.onload=function(){
 //setTimeout("playloop(myaudionature);",800);
 setTimeout("setvol(myaudionature,0.3);",700);
 setTimeout("setspeed(myaudionature,1.0);",700);
 }
var tsoundnature=0;
function soundnature(){
   if(tframe>tsoundnature+14500){tsoundnature=tframe;
      setvol(myaudionature,0.4*(ineartree/(ineartree+100)));
	  playsound(myaudionature);}
   }
function stopsoundnature(){
   if(tframe<tsoundnature+12500){tsoundnature=0;setvol(myaudionature,0.002);}
}
var myaudiocrash = audioctx.createBufferSource();
//audiosrc=folder+"crash."+wav;
myaudiocrash.volume=0;
loadsound64(myaudiocrash,crashmp3);
myaudiocrash.onload=function(){
 setTimeout("playsound(myaudiocrash);",500);
 setTimeout("setvol(myaudiocrash,0.3);",500);
 setTimeout("setspeed(myaudiocrash,1.0);",500);
 }
var tsoundcrash=0;
function soundcrash(){
 if(tframe>tsoundcrash+2000){
   tsoundcrash=tframe;
   //setvol(myaudiocrash,0.4*(1+0.5*(vcar-0.2)));
   playsound(myaudiocrash);
   o1+=(Math.random()-0.5);
 }
} 
var myaudiojet = audioctx.createBufferSource();
myaudiojet.volume=0;
loadsound64(myaudiojet,jet4mp3);
myaudiojet.onload=function(){
 setTimeout("playloop(myaudiojet);",320);
 setTimeout("setvol(myaudiojet,0.003);",320);
 setTimeout("setspeed(myaudiojet,1.14);",320);
 }
var myaudioanchor = audioctx.createBufferSource();
//audiosrc=folder+"anchor."+wav;
myaudioanchor.volume=0;
loadsound64(myaudioanchor,anchormp3);
myaudioanchor.onload=function(){
 //setTimeout("playsound(myaudioanchor);",500);
 setTimeout("setvol(myaudioanchor,0.042);",500);
 setTimeout("setspeed(myaudioanchor,1.0);",500);
 }
var tsoundanchor=0,ianchorship=-1;
function soundanchor(){
 if(tframe>tsoundanchor+3500){
   tsoundanchor=tframe;
   playsound(myaudioanchor);
 }
} 
var myaudiovoyage = audioctx.createBufferSource();
//audiosrc=folder+"voyage."+wav;
myaudiovoyage.volume=0;
loadsound64(myaudiovoyage,voyagemp3);
myaudiovoyage.onload=function(){
 //setTimeout("playsound(myaudiovoyage);",500);
 setTimeout("setvol(myaudiovoyage,0.65);",500);
 setTimeout("setspeed(myaudiovoyage,1.0);",500);
 }
var myaudiovoyage2 = audioctx.createBufferSource();
//audiosrc=folder+"voyage."+wav;
myaudiovoyage2.volume=0;
loadsound64(myaudiovoyage2,deerhuntermp3);
myaudiovoyage2.onload=function(){
 //setTimeout("playsound(myaudiovoyage2);",500);
 setTimeout("setvol(myaudiovoyage2,0.65);",500);
 setTimeout("setspeed(myaudiovoyage2,1.0);",500);
 }
var tsoundvoyage=0,isoundvoyage=0;
function soundvoyage(){
if(isoundvoyage==1 && tframe>tsoundvoyage+295000-200){isoundvoyage=0;}//4'53
if(isoundvoyage==2 && tframe>tsoundvoyage2+223000-200){isoundvoyage=0;}//3'41
if(isoundvoyage==0){
   //tsoundvoyage=0;tsoundvoyage2=0;
   if(Math.random()<0.5){isoundvoyage=1;}else{isoundvoyage=2;}}
if(isoundvoyage==1){soundvoyage1();}else{soundvoyage2();}
}
function soundvoyage1(){
 if(tframe>tsoundvoyage+295000){//4'53
   tsoundvoyage=tframe;
   setvol(myaudiovoyage,0.65);
   playsound(myaudiovoyage);
 }else{setvol(myaudiovoyage,0.65);}
}
var tsoundvoyage2=0,vol2=0.70; 
function soundvoyage2(){
 if(tframe>tsoundvoyage2+223000){//3'41
   tsoundvoyage2=tframe;
   setvol(myaudiovoyage2,vol2);
   playsound(myaudiovoyage2);
 }else{setvol(myaudiovoyage2,vol2);}
} 
function stopsoundvoyage(){
if(isoundvoyage==1){
   if(tframe<tsoundvoyage+295000){setvol(myaudiovoyage,0.002);}
}else{
   if(tframe<tsoundvoyage2+223000){setvol(myaudiovoyage,0.002);}
}   
}
function restartsoundvoyage(){
if(isoundvoyage==1){
   if(tframe<tsoundvoyage+295000){setvol(myaudiovoyage,0.65);}
}else{
   if(tframe<tsoundvoyage+223000){setvol(myaudiovoyage,vol2);}
}
}
//var myaudiomusic = audioctx.createBufferSource();
//audiosrc=folder+"music."+wav;
/*myaudiomusic.volume=0;
if(document.location.href.indexOf(folderdrive)>=0){
 loadsound(myaudiomusic,folderdrive+"silence_before_storm.mp3");
}else{
 loadsound(myaudiomusic,"silence_before_storm.mp3");
}
myaudiomusic.onload=function(){
 setTimeout("playloop(myaudiomusic);soundpause(myaudiomusic);",1800);
 setTimeout("setvol(myaudiomusic,0.4);",1700);
 setTimeout("setspeed(myaudiomusic,1.0);",1700);
 }
function soundmusic(){
      //setvol(myaudiomusic,0.4);
	  soundunpause(myaudiomusic);
   }
function stopsoundmusic(){
   //setvol(myaudiomusic,0.002);
   soundpause(myaudiomusic);
}
*/
}catch(e){
var twebaudio=0,planedo2=0;
/*function soundwater(){};
function soundpneu(){};
function soundrain(){};
function stopsoundrain(){};
function soundcrash(){};
function soundmusic(){};
function stopsoundmusic(){};
function soundcaron(){};
function soundcaroff(){};
*/
}
var searchtxt="",parms=[],iparm=0;
function addparm(parm){
   searchtxt+=(parseInt(parm*1000)/1000)+"&";
}
var tsea=0,tinitcombo=0,latinit=0,lnginit=0,hash0="";
var latanchor=0,lnganchor=0,latinitanchor=0,lnginitanchor=0;
function initparms(){
  hash0=document.location.search;//parent.location.hash;
  if(hash0.indexOf("reset",0)>=0 || hash0.indexOf("nocook",0)>=0){hash0="";
  }else if(hash0==""){readcookie();}
  //var hash0=document.location.search;//parent.location.hash;
  getparms(hash0);
  latinit/=100;
  lnginit/=100;
  latx=latinit;lngx=lnginit;
  latinitanchor/=100;
  lnginitanchor/=100;
  latanchor=latinitanchor;lnganchor=lnginitanchor;
  if(kscalex>=0.25 && kscalex<=2.0){scale=scale0*kscalex;}
  if(noshadow>=2){noshadow=2;}
  ncar2=Math.max(1,Math.min(ncar,ncar2));
  if(flytoname){
    document.getElementById('combo')[1].text=flytoname;}
  if(icombo>0){document.getElementById('combo').selectedIndex=icombo;
               tinitcombo=1;
			   //setTimeout("subcombo();",8000);
			   }
  }
function evaln(n){if(isNaN(eval(n))){return 0;}else{return eval(n);};}
function getparms(hash){
  if(hash!=""){parms=[];parms=hash.split("&");
    tsea=evaln(parms[0].substr(1,parms[0].length-1));
    var i=1,n=parms.length-1;
    icombo=evaln(parms[i]);i+=1;if(i>=n){return;}
    fullscreen=evaln(parms[i]);i+=1;if(i>=n){return;}
    cssscale=evaln(parms[i]);i+=1;if(i>=n){return;}
    cssscaley=evaln(parms[i]);i+=1;if(i>=n){return;}
    tfoot=evaln(parms[i]);i+=1;if(i>=n){return;}
    latinit=evaln(parms[i]);i+=1;if(i>=n){return;}
    lnginit=evaln(parms[i]);i+=1;if(i>=n){return;}
    o1=evaln(parms[i]);i+=1;if(i>=n){return;}
    o2=evaln(parms[i]);i+=1;if(i>=n){return;}
    flytolat=evaln(parms[i])/100;i+=1;if(i>=n){return;}
    flytolng=evaln(parms[i])/100;i+=1;if(i>=n){return;}
	flytoname=parms[i];i+=1;if(i>=n){return;}
    cockpith=evaln(parms[i]);i+=1;if(i>=n){return;}
    testsrtm=evaln(parms[i]);i+=1;if(i>=n){return;}
    tminimap=evaln(parms[i]);i+=1;if(i>=n){return;}
    tcloud=evaln(parms[i]);i+=1;if(i>=n){return;}
    tcollideon=evaln(parms[i]);i+=1;if(i>=n){return;}
    iview=evaln(parms[i]);i+=1;if(i>=n){return;}
    noshadow=evaln(parms[i]);i+=1;if(i>=n){return;}
    tgirl=evaln(parms[i]);i+=1;if(i>=n){return;}
    mouse2dx=evaln(parms[i]);i+=1;if(i>=n){return;}
    mouse2dy=evaln(parms[i]);i+=1;if(i>=n){return;}
    kscalex=evaln(parms[i]);i+=1;if(i>=n){return;}
    tfog=evaln(parms[i]);i+=1;if(i>=n){return;}
    ncar2=evaln(parms[i]);i+=1;if(i>=n){return;}
    myisailship=evaln(parms[i]);i+=1;if(i>=n){return;}
    mysailshipo1=evaln(parms[i]);i+=1;if(i>=n){return;}
    mysailshipdxx=evaln(parms[i]);i+=1;if(i>=n){return;}
    ianchorship=evaln(parms[i]);i+=1;if(i>=n){return;}
    latinitanchor=evaln(parms[i]);i+=1;if(i>=n){return;}
    lnginitanchor=evaln(parms[i]);i+=1;if(i>=n){return;}
    tfly=evaln(parms[i]);i+=1;if(i>=n){return;}
    scaleh=evaln(parms[i]);i+=1;if(i>=n){return;}
	}
}
function setlink(){
  tclose=1;
  alert("copy the adress bar to link to this place later");
  savecookie();
  setsearchtxt();
  document.location.search=searchtxt;  
}
function setsearchtxt(){
latinit=latx*100;lnginit=lngx*100;
latinitanchor=latanchor*100;lnginitanchor=lnganchor*100;
if(Math.abs(combolat-latx)>0.1 || Math.abs(combolng-lngx)>0.1){
  var text=formatname(locationname);
  if(text!=""){//alert(text);
     flytolat=latx;flytolng=lngx;flytoname=text;
     document.getElementById('combo')[1].text=flytoname;
	 icombo=1;document.getElementById('combo').selectedIndex=icombo;
    }}
  searchtxt="";
  addparm(tsea);
  addparm(icombo);
  addparm(fullscreen);
  addparm(cssscale);
  addparm(cssscaley);
  addparm(tfoot);
  addparm(latinit);
  addparm(lnginit);
  addparm(o1);
  addparm(o2);
  addparm(flytolat*100);
  addparm(flytolng*100);
  searchtxt+=formatname(flytoname)+"&";
  addparm(cockpith);
  addparm(testsrtm);
  addparm(tminimap);
  addparm(tcloud);
  addparm(tcollideon);
  addparm(iview);
  addparm(noshadow);
  addparm(tgirl);
  addparm(mouse2dx);
  addparm(mouse2dy);
  addparm(kscalex);
  addparm(tfog);
  addparm(ncar2);
  addparm(myisailship);
  addparm(mysailshipo1);
  addparm(mysailshipdxx);
  addparm(ianchorship);
  addparm(latinitanchor);
  addparm(lnginitanchor);
  addparm(tfly);
  addparm(scaleh);
}
function readcookie(){
var mycookie=document.cookie+";";
//alert("mycookie="+mycookie);
var pref="jsonosmwebglchung2=";
if(document.location.href.indexOf("woman",0)>0){pref="jsonosmwebglchung2woman=";}
else if(document.location.href.indexOf("2/",0)>0){pref="jsonosmwebglchung22=";}
else if(document.location.href.indexOf("3/",0)>0){pref="jsonosmwebglchung23=";}
var i=mycookie.indexOf(pref,0);
if(i<0){return;}
i+=pref.length;
var j=mycookie.indexOf(";",i);
if(j<i){return;}
var mycookie=mycookie.substring(i,j);
//alert(mycookie);
hash0="?"+mycookie;getparms(hash0);
}
function savecookie(){
var mycookie="";
var cookie0=document.cookie;
setsearchtxt();
savecitypanel();
mycookie+=searchtxt;
//alert(mycookie);  
var pref="jsonosmwebglchung2=";
if(document.location.href.indexOf("woman",0)>0){pref="jsonosmwebglchung2woman=";}
else if(document.location.href.indexOf("2/",0)>0){pref="jsonosmwebglchung22=";}
else if(document.location.href.indexOf("3/",0)>0){pref="jsonosmwebglchung23=";}
mycookie =pref+mycookie+"; expires=Fri, 3 Aug 2100 20:47:11 UTC; path=/";
if(mycookie.length>(3900-cookie0.length)){alert("could not save, cookie too long");return;}
document.cookie=mycookie;
}
function deletecookie(){
var pref="jsonosmwebglchung2=";
if(document.location.href.indexOf("woman",0)>0){pref="jsonosmwebglchung2woman=";}
else if(document.location.href.indexOf("2/",0)>0){pref="jsonosmwebglchung22=";}
else if(document.location.href.indexOf("3/",0)>0){pref="jsonosmwebglchung23=";}
document.cookie =pref+";expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/";
}
function subcookie(){
  if(confirm("save game cookie ?")){savecookie();alert("cookie saved");
  }else if(confirm("delete gamesave cookie ?")){
           deletecookie();alert("cookie deleted");}
}
function subloadsave(){
tgamesave=1;
gamereturndata=null;
gameprefix="webglcarsimheight_shadow";
var name=formatname(locationname);
if(name==""){name="unknown"}
setsearchtxt();
initgamesave(name,searchtxt);
loopgamesave();
}
var srtmfolder="",srtmfolder0=folderdrive+"srtm/";
var srtmfile="",srtmfiles=[],isrtm=0,srtmvar="",srtmvars=[];
var srtmdata=[],srtmlat=[],srtmlng=[];
var lat5=0,lng5=0,lat50=0,lng40=0;
var d5=360.0/128,d55=180.0/128,d25=d5/2.0,d255=d55/2.0;
for(var i=0;i<4;i++){srtmfiles[i]="";
    srtmvars[i]="";srtmdata[i]=new Int16Array(601*601);
	srtmlat[i]=99999;srtmlng[i]=9999;}
function getsrtmfile22(lat1,lng1){
if(lat1<-87 || lat1>87 || lng1<-177 || lng1>177){return "";}
lat5=-90+d55*parseInt((lat1+90.0)/d55);
lng5=-180+d5*parseInt((lng1+180.0)/d5);
srtmfile=parseInt((lng1+180.0)/d5);
srtmfile+="/"+parseInt((lat1+90.0)/d55);
srtmvar=''; 
srtmfile=srtmfile+".png";
}
function getsrtmfile(lat1,lng1){
if(lat1<-87 || lat1>87 || lng1<-177 || lng1>177){return "";}
lat5=-90+5*parseInt((lat1+90.0)/5);
lng5=-180+5*parseInt((lng1+180.0)/5);
if(lng5<=0){srtmfile="lngW"+(0-lng5);}
else{srtmfile="lngE"+(lng5);}
if(lat5>=0){srtmfile+="latN"+lat5;}
else{srtmfile+="latS"+(0-lat5);}
lat50=-60+50*parseInt((lat1+110.0)/50);
lng40=-180+40*parseInt((lng1+180.0)/40);
if(lng40<=0){srtmfolder="w"+(0-lng40);}
else{srtmfolder="e"+(lng40);}
if(lat50>=0){srtmfolder+="n"+lat50;}
else{srtmfolder+="s"+(0-lat50);}
srtmvar=srtmfile; 
srtmfile=srtmfolder+"/"+srtmfile+".js";
}
/*getworldxy(zoom,lat,lng);alert(lat+"/"+lng+"/"+worldx+"/"+worldy);
auxvar=worldy;
getworldxy(zoom,lat+1,lng);alert(lat+"/"+lng+"/"+(worldy-auxvar)+"/"+worldy);
getlatlng(zoom,worldx,worldy);alert(lat+"/"+lng+"/"+worldx+"/"+worldy);
*/
//testloadsrtmfile(lat,lng);
//testloadsrtmfile(lat,lng);
var itestloadsrtm=0,ttestloadsrtm=0;
function testloadsrtm(){
if(tframe<ttestloadsrtm){return;}
ttestloadsrtm=tframe+8000;
itestloadsrtm+=1;if(itestloadsrtm>=4){itestloadsrtm=0;}
var dx=0.2;
if(itestloadsrtm==0){testloadsrtmfile(lat-dx,lng-dx);}
if(itestloadsrtm==1){testloadsrtmfile(lat-dx,lng+dx);}
if(itestloadsrtm==2){testloadsrtmfile(lat+dx,lng+dx);}
if(itestloadsrtm==3){testloadsrtmfile(lat+dx,lng-dx);}
}
function testloadsrtmfile(lat1,lng1){
  getsrtmfile(lat1,lng1);
  if(srtmfile==""){return;}
  for(var i=0;i<4;i++){if(srtmfiles[i]==srtmfile){return;}}
  var distsrtm=0;
  for(var i=0;i<4;i++){
    var dist=(Math.abs(lat1-srtmlat[i])+Math.abs(lng1-srtmlng[i]));
    if(dist>distsrtm){isrtm=i;distsrtm=dist;}
  }
  //auxvar=isrtm;
  srtmfiles[isrtm]=srtmfile;
  srtmvars[isrtm]=srtmvar;
  //srtmlat[isrtm]=lat5+d255;
  //srtmlng[isrtm]=lng5+d25+1000;
  srtmlat[isrtm]=lat5+2.5;
  srtmlng[isrtm]=lng5+2.5+1000;
  var worldx0=worldx,worldy0=worldy;
  /*getworldxy(zoom,lat5,lng5);
  srtmxmin[isrtm]=-worldx;
  srtmymin[isrtm]=-worldy;
  getworldxy(zoom,lat5+5,lng5+5);
  srtmxmax[isrtm]=-worldx;//alert(worldx-srtmxmin[isrtm]);
  srtmymax[isrtm]=-worldy;//alert(worldy-srtmymin[isrtm]);
  worldx=worldx0;worldy=worldy0;
  */
  //getworldxy(zoom,lat5+0.1,lng5-0.1);
  loadsrtmfile(isrtm);
context.font = "12pt Arial";
context.fillStyle = '#ff0000';
context.fillText("updatesrtm...",20,120);
}
var head = document.getElementsByTagName('head')[0];
var tjsload=0,jsfilelist=[],njsfile=0,jslist=[],tloading=[];
function deletejsfile(i){
var msg="",err="",jsfile="";
jsfile=jsfilelist[i];
     if(jsfile.indexOf("objtxt.js")>=0 ||
        jsfile.indexOf("oog.js")>=0 ||
        jsfile.indexOf("wav.js")>=0 ||
	    jsfile.indexOf("mp3.js")>=0 ||
		jsfile.indexOf("jpg.js")>=0 ||
		jsfile.indexOf("256.js")>=0 ||
		jsfile.indexOf("/srtm/")>=0 ||
		jsfile.indexOf("png.js")>=0){
      if(jsfile.substr(jsfile.length-3,3)==".js"){
	    jsfile=jsfile.substr(0,jsfile.length-3);
		//try{eval(jsfile+"=null;");}catch(e){err+="/"+jsfile;}
		try{head.removeChild(jslist[i]);}catch(e){err+="/js:"+jsfile;}
		msg+="/"+jsfile;
		};}
}
var srtmimg=new Image(),iisrtm0=0;
srtmimg.crossOrigin = "anonymous";
srtmimg.onload=function(){alert(srtmimg.width+"/"+srtmimg.height);//337x95/337x337/337x325
              setTimeout("jscallback2(isrtm);",100);
			  };
function loadsrtmfile22(iisrtm){
loading=55;
//srtmfolder0='http://caper.ws/terrain-srtm30-plus/tms7/';//14/24.png;
srtmfolder0='http://jaanga.github.io/terrain-srtm30-plus-data-tms-7plus/7plus/';
var srtmfich=srtmfolder0+srtmfiles[iisrtm];
//alert("load "+srtmfolder0+srtmfiles[iisrtm]);
srtmimg.src=srtmfich;alert(srtmfich);
}
function loadsrtmfile(iisrtm){
loading=55;
//alert("load "+srtmfolder0+srtmfiles[isrtm]);
var jsfilepath=srtmfiles[iisrtm];
jslist[njsfile]=document.createElement("script");
var js=jslist[njsfile];
js.type = "text/javascript";
js.src = srtmfolder0+jsfilepath;
js.async=true;
//js.onreadystatechange = jscallback;
tjsload+=1;jsfilelist[njsfile]="/srtm/"+jsfilepath;
var i=njsfile;
tloading[i]=1;
js.onload = function(){setTimeout("jscallback2("+iisrtm+");",100);
              setTimeout("deletejsfile("+i+");",4000);
			  tloading[i]=0;
			  };
njsfile+=1;
head.appendChild(js);
}
var val62=new Int16Array(256);
var abcd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
for(var i=0;i<256;i++){val62[i]=0;}
for(var i=0;i<62;i++){val62[abcd.charCodeAt(i)]=i;};
function jscallback2(ii){
 //alert("callback "+srtmfiles[ii]+"/"+ii);
 var srtmtext=eval(srtmvars[ii]);
 //alert(srtmtext.length);
 var j=0,k=0,l=0,kl=0,n=0,p=0,x=0,ix=0,ixmax=601*600,jx=0;
 var jmax=srtmtext.length;
 while(j<jmax && ix<ixmax){
	//if(x>auxvar){auxvar=x;}
	if(jx>=600){jx=0;x=0;}
    k=val62[srtmtext.charCodeAt(j)];j++;
	l=val62[srtmtext.charCodeAt(j)];j++;
    kl=(k-30)*60+l;
	if(kl==0){
      k=val62[srtmtext.charCodeAt(j)];j++;
	  l=val62[srtmtext.charCodeAt(j)];j++;
	  kl=(k-30)*60+l;
	  for(var n=0;n<kl;n++){
    	  srtmdata[ii][ix]=x;ix++;jx++}
    }else{x+=kl;srtmdata[ii][ix]=x;
		  ix++;jx++}	
 }
 //alert("ix="+ix+"/"+(600*600)+"/isrtm="+isrtm+"/aux="+auxvar);
 srtmtext=null;
 eval(srtmvars[ii]+"=null;");
 //alert(srtmdata[i][0]); 
/*srtmxmin[ii]=-srtmxmin[ii];
srtmymin[ii]=-srtmymin[ii];
srtmxmax[ii]=-srtmxmax[ii];
srtmymax[ii]=-srtmymax[ii];
*/
srtmlng[ii]-=1000;
//updatesrtm();
if(tinitgmap>=0){tinitgmap=2;loading=50;}
ttestloadsrtm=0;
}
function jscallback22(ii){
 alert("callback "+srtmfiles[ii]+"/"+ii);
 canvas3.setAttribute('width', 600);
 canvas3.setAttribute('height', 600);
 canvassrtm.drawImage(srtmimg,0,0,srtmimg.width,srtmimg.height, 0,0,600,600);
 var rgb=canvassrtm.getImageData(0,0,600,600).data;
 //var srtmtext=eval(srtmvars[ii]);
 //alert("srtmtextlen="+rgb.length);
 var j=0,k=0,l=0,kl=0,n=0,p=0,x=0,ix=0,ixmax=601*600,jx=0;
 var jmax=rgb.length;
 while(j<jmax && ix<ixmax){
	//x=srtmtext[j];
	x = rgb[ j ] + 256 * rgb[ j + 1 ] + 65536 * rgb[ j +2 ] ;
    if(x>=32767){x-=16777216;}
	if(x<-11000){x=0;}
	x=-x;
    x*=0.0081;
	//elevation = elevation < 32767 ? elevation : elevation - 16777216;
	//elevation  = elevation < -11000 ? 0 : elevation ;
    srtmdata[ii][ix]=x;ix++;j+=4;
 }
 alert("ix="+ix+"/"+(600*600)+"/isrtm="+ii);
 srtmtext=[];
 //srtmimg.src=null;
 //alert(srtmdata[i][0]); 
/*srtmxmin[ii]=-srtmxmin[ii];
srtmymin[ii]=-srtmymin[ii];
srtmxmax[ii]=-srtmxmax[ii];
srtmymax[ii]=-srtmymax[ii];
*/
srtmlng[ii]-=1000;
//updatesrtm();
if(tinitgmap>=0){tinitgmap=2;loading=50;}
ttestloadsrtm=0;
}
var kn18=18;
function getheight1(i,j){return height1[(i+nsol2)*(n22)+j+nsol2];
}
var dtupdatesrtm=0;
function updatesrtm(){
dtupdatesrtm=tframe;
//scaletexture=512/(xmax-xmin);
var lngx=0,laty=0;//auxvar=0;
var lng0=lng,lat0=lat,worldx0=worldx,worldy0=worldy;
getworldxy(zoom,latsol0,lngsol0);
getlatlng(zoom,worldx+256,worldy+256)
var lng1=lng,lat1=lat;
lng=lng0;lat=lat0;worldx=worldx0;worldy=worldy0;
for(var i=0;i<n22;i++){
 lngx=lngsol0+(i/n22-0.5)*(lng1-lngsol0)*2*n22/n;
 if(i<nsol2){lngx-=(lng1-lngsol0)*(nsol2-i)*kn18/n;}
 if(i>n22-nsol2){lngx+=(lng1-lngsol0)*(i-n22+nsol2)*kn18/n;}
 //lngx=lng5+(i/n)*10;
 var h0=-3,dj=0;
 for(var j=0;j<n22;j++){
    laty=latsol0+(j/n22-0.5)*(lat1-latsol0)*2*n22/n;
    //dj+=1;	
    if(j<nsol2){laty-=(lat1-latsol0)*(nsol2-j)*kn18/n;dj=9;}
    if(j>n22-nsol2){laty+=(lat1-latsol0)*(j-n22+nsol2)*kn18/n;dj=9;}
	//var h=0.12*(getsrtmheight(lngx,laty)-14-4);
	var h=0.06*(getsrtmheight(lngx,laty)-14.004);//-14-0.004
	if(h<0){h=-0.015;};
	//if(h0>-2 && (h-h0)>0.3 && dj<3){h=h0;}else{h0=h;dj=0;}//avoid pics
	height1[i*n22+j]=h;//h;
	//auxvar=Math.min(auxvar,height1[i*n+j]);
   }
 }
}
function getterrainheightsrtm(lngx,laty){
	var h=0.06*(getsrtmheight(lngx,laty)-14.004);//-14-0.004
	if(h<0){h=-0.015;};
return h;
}
function getsrtmheight22(lngx,laty){
	//var wx=worldx+(px-xmaxmin2)*scaletexture*10;
	//var wy=worldy+(py-ymaxmin2)*scaletexture*10;
	var jj=-1;
	for(var ii=0;ii<4;ii++){
	  if(Math.abs(lngx-srtmlng[ii])<d25){
	   if(Math.abs(laty-srtmlat[ii])<d255){
	     jj=ii;break;}}
	}
	if(jj<0){return -0.5;}
	//auxvar=Math.max(auxvar,jj);
	//auxvar+=1;
	var nny=0.0001+599.99*(lngx-srtmlng[jj]+d25)/d5;
	var nnx=0.0001+599.99*(laty-srtmlat[jj]+d255)/d55;
	//nnx=599.5-nnx;
	nny-=0.5;
    var ndata=600;
	if(nnx>=ndata){nnx=ndata-1;}
	if(nny>=ndata){nny=ndata-1;}
	if(nnx<0.0001){nnx=0.0001;}
	if(nny<0.0001){nny=0.0001;}
	var i=parseInt(nnx),j=parseInt(nny);
	var dx=nnx-i,dy=nny-j;
	var i1=i+1,j1=j+1;
	if(i1>=ndata){i1=ndata-1;}
	if(j1>=ndata){j1=ndata-1;}
	//var h=srtmdata[jj][i*ndata+j];
	//auxvar=i+10000*j;//Math.max(h,auxvar);
	//return h;
    var z00=srtmdata[jj][i*ndata+j];
    var z10=srtmdata[jj][i1*ndata+j];
    var z01=srtmdata[jj][i*ndata+j1];
    var z11=srtmdata[jj][i1*ndata+j1];
return (1-dx)*(1-dy)*(z00)+(1-dx)*dy*(z01)+dx*(1-dy)*z10+dx*dy*z11;
}
function getsrtmheight(lngx,laty){
	//var wx=worldx+(px-xmaxmin2)*scaletexture*10;
	//var wy=worldy+(py-ymaxmin2)*scaletexture*10;
	var jj=-1;
	for(var ii=0;ii<4;ii++){
	  if(Math.abs(lngx-srtmlng[ii])<2.5){
	   if(Math.abs(laty-srtmlat[ii])<2.5){
	     jj=ii;break;}}
	}
	if(jj<0){return -0.5;}
	//auxvar=Math.max(auxvar,jj);
	//auxvar+=1;
	var nny=0.0001+599.99*(lngx-srtmlng[jj]+2.5)/5;
	var nnx=0.0001+599.99*(laty-srtmlat[jj]+2.5)/5;
	nnx=599.5-nnx;
	nny-=0.5;
	//if(nnx>=ndata){nnx=ndata-1;}
	//if(nny>=ndata){nny=ndata-1;}
	if(nnx<0.0001){nnx=0.0001;}
	if(nny<0.0001){nny=0.0001;}
	var i=parseInt(nnx),j=parseInt(nny);
	var dx=nnx-i,dy=nny-j;
	var i1=i+1,j1=j+1,ndata=600;
	if(i1>=ndata){i1=ndata-1;}
	if(j1>=ndata){j1=ndata-1;}
	//var h=srtmdata[jj][i*ndata+j];
	//auxvar=i+10000*j;//Math.max(h,auxvar);
	//return h;
    var z00=srtmdata[jj][i*ndata+j];
    var z10=srtmdata[jj][i1*ndata+j];
    var z01=srtmdata[jj][i*ndata+j1];
    var z11=srtmdata[jj][i1*ndata+j1];
return (1-dx)*(1-dy)*(z00)+(1-dx)*dy*(z01)+dx*(1-dy)*z10+dx*dy*z11;
}
function getsrtmheight0(lngx,laty){
	//var wx=worldx+(px-xmaxmin2)*scaletexture*10;
	//var wy=worldy+(py-ymaxmin2)*scaletexture*10;
	var jj=-1;
	for(var ii=0;ii<4;ii++){
	  if(Math.abs(lngx-srtmlng[ii])<2.5){
	   if(Math.abs(laty-srtmlat[ii])<2.5){
	     jj=ii;break;}}
	}
	if(jj<0){return -0.5;}
	//auxvar=Math.max(auxvar,jj);
	//auxvar+=1;
	var nny=0.0001+599.99*(lngx-srtmlng[jj]+2.5)/5;
	var nnx=0.0001+599.99*(laty-srtmlat[jj]+2.5)/5;
	nnx=600-nnx;
	//if(nnx>=ndata){nnx=ndata-1;}
	//if(nny>=ndata){nny=ndata-1;}
	//if(nnx<0){nnx=0;}
	//if(nny<0){nny=0;}
	var i=parseInt(nnx),j=parseInt(nny);
	var dx=nnx-i,dy=nny-j;
	var i1=i+1,j1=j+1,ndata=600;
	if(i1>=ndata){i1=ndata-1;}
	if(j1>=ndata){j1=ndata-1;}
	//var h=srtmdata[jj][i*ndata+j];
	//auxvar=i+10000*j;//Math.max(h,auxvar);
	//return h;
if(dx<=(1.0-dy)){ 
    var z00=srtmdata[jj][i*ndata+j];
    var z10=srtmdata[jj][i1*ndata+j];
    var z01=srtmdata[jj][i*ndata+j1];
    return ( dx*(z10-z00) +dy*(z01-z00) +z00);
}else{
    var z10=srtmdata[jj][i1*ndata+j];
    var z01=srtmdata[jj][i*ndata+j1];
    var z11=srtmdata[jj][i1*ndata+j1];
    return ( (1-dx)*(z01-z11) +(1-dy)*(z10-z11) +z11 );
	}
}
var map,marker,maplatlng;
function initgooglemap(){
    map=new google.maps.Map(document.getElementById('mapdiv'), {
    center: new google.maps.LatLng(latx,lngx),
    disableDefaultUI:true,
	mapTypeId: google.maps.MapTypeId.HYBRID,
	zoom: 14 });
    marker = new google.maps.Marker({
    map: map,
    position: new google.maps.LatLng(latx,lngx)
  });
  google.maps.event.addListener(map, 'click', function(event) {
    maplatlng = event.latLng;
    latx=maplatlng.lat();
	lngx=maplatlng.lng();
	tmap=0;tmousedown=0;tinit=0;trygetways=1;x00=999999;
  });
}
function updatemarker(){
  marker.setMap(null);
  marker=null;
  marker = new google.maps.Marker({
    map: map,
    position: new google.maps.LatLng(latx,lngx)
  });  
}
function hidemap(){
var mapdiv=document.getElementById('mapdiv');
mapdiv.setAttribute('style',"position:absolute;top:4022px;left:0px;width:0%;height:0%;");
google.maps.event.trigger(map, 'resize');
}
function showmap(){
var mapdiv=document.getElementById('mapdiv');
mapdiv.setAttribute('style',"position:absolute;top:4022px;left:0px;width:100%;height:95%;");
google.maps.event.trigger(map, 'resize');
}
var carVertexPositionBuffer = null;
var carVertexTextureCoordBuffer = null;
var carwheelVertexPositionBuffer = null;
var carwheelVertexTextureCoordBuffer = null;
var rocVertexPositionBuffer = null;
var rocVertexTextureCoordBuffer = null;
var stationVertexPositionBuffer = null;
var stationVertexTextureCoordBuffer = null;
var loganVertexPositionBuffer = null;
var loganVertexTextureCoordBuffer = null;
var c150VertexPositionBuffer = null;
var c150VertexTextureCoordBuffer = null;
var sailshipVertexPositionBuffer = null;
var sailshipVertexTextureCoordBuffer = null;


function loadmodels() {
    handleLoadedWorld(carobjtxt);
    carVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, carVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    carVertexPositionBuffer.itemSize = 3;
    carVertexPositionBuffer.numItems = vertexCount;

    carVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, carVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    carVertexTextureCoordBuffer.itemSize = 2;
    carVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
	handleLoadedWorld(carwheelobjtxt);
    carwheelVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, carwheelVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    carwheelVertexPositionBuffer.itemSize = 3;
    carwheelVertexPositionBuffer.numItems = vertexCount;

    carwheelVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, carwheelVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    carwheelVertexTextureCoordBuffer.itemSize = 2;
    carwheelVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    handleLoadedWorld(rocobjtxt);
    rocVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    rocVertexPositionBuffer.itemSize = 3;
    rocVertexPositionBuffer.numItems = vertexCount;

    rocVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    rocVertexTextureCoordBuffer.itemSize = 2;
    rocVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
    handleLoadedWorld(station2objtxt);
    stationVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, stationVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    stationVertexPositionBuffer.itemSize = 3;
    stationVertexPositionBuffer.numItems = vertexCount;

    stationVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, stationVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    stationVertexTextureCoordBuffer.itemSize = 2;
    stationVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
    handleLoadedWorld(loganobjtxt);
    loganVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, loganVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    loganVertexPositionBuffer.itemSize = 3;
    loganVertexPositionBuffer.numItems = vertexCount;

    loganVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, loganVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    loganVertexTextureCoordBuffer.itemSize = 2;
    loganVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
    handleLoadedWorld(c150objtxt);
    c150VertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, c150VertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    c150VertexPositionBuffer.itemSize = 3;
    c150VertexPositionBuffer.numItems = vertexCount;

    c150VertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, c150VertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    c150VertexTextureCoordBuffer.itemSize = 2;
    c150VertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
    handleLoadedWorld(sailshipobjtxt);
    sailshipVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    sailshipVertexPositionBuffer.itemSize = 3;
    sailshipVertexPositionBuffer.numItems = vertexCount;

    sailshipVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    sailshipVertexTextureCoordBuffer.itemSize = 2;
    sailshipVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
}
var vertexCount = 0;
var vertexPositions = [];
var vertexTextureCoords = [];
function handleLoadedWorld(data){//,vertexposbuff,vertextextbuff) { 
    var lines = data.split("\n");
    vertexCount = 0;
    vertexPositions = [];
    vertexTextureCoords = [];
    for (var i in lines) {
      var vals = lines[i].replace(/^\s+/, "").split(/\s+/);
      if (vals.length == 5 && vals[0] != "//") {
        // It is a line describing a vertex; get X, Y and Z first
        vertexPositions.push(parseFloat(vals[0]));
        vertexPositions.push(parseFloat(vals[1]));
        vertexPositions.push(parseFloat(vals[2]));

        // And then the texture coords
        vertexTextureCoords.push(parseFloat(vals[3]));
        vertexTextureCoords.push(parseFloat(vals[4]));

        vertexCount += 1;
      }
    }
	data=null;//alert(data);
}
function replaceall(text0,str1,str2){
    var text=text0;
	for(var p=0;p<100;p++){
	   if(text.indexOf(str1)<0){break;}
	   text=text.replace(str1,str2);
	   }
	return text;   
}
var paudiosrc=null,paudio=null,ptimeraudio=0,mytextspeak="";
function speak(msg){//mytextspeak=msg;
var voicename="UK English Female";
//var msg1=replaceall(msg," ","+");
responsiveVoice.speak(msg,voicename);
}
/*function testspeak(){return;
  if(mytextspeak!=""){try{myspeak(mytextspeak);}catch(e){auxtext="err "+e;};
  mytextspeak="";}}
function myspeak(textspeak){
	//var urlradio2=folderdrive+"speak_chung.html";
	var urlradio2="speak_chung.html";
	document.getElementById('radio2').src=urlradio2+"?"+textspeak;	
return;
if(paudio==null){paudio= new Audio();}
//paudiosrc ='http://translate.google.com/translate_tts?&tl=en&q='+encodeURIComponent(textspeak);
paudiosrc='http://translate.google.com/translate_tts?tl=en&q='+encodeURIComponent(textspeak)+'&ie=UTF-8&total=1&idx=0&client=t';
//paudiosrc =http+'//translate.google.com/translate_tts?&tl=en&q='+encodeURIComponent(textspeak);
paudio.type="audio/x-wav" 
paudio.src=paudiosrc;
ptimeraudio=-1;
paudio.addEventListener('canplay',function(){
      if(ptimeraudio<0){ptimeraudio=1;paudio.play();};});
paudio.load();
}*/
var tradiomsg=0;
function radiomsg(msg){
if(timer()<tradiomsg){return;}
tradiomsg=timer()+2000;
try{speak(msg);}catch(e){};
}
var tstreetview=0;
function substreetview(){
if(tstreetview==0){
tstreetview=1;
//var urlstreetview="https:"+"//30239318f214b2cdc3b069138f22a3fbc2a194c6.googledrive.com/host/0B6GM9ay7ImZLV1ZBV0w0U1pPRGs/mystreetview.html?"+latx+"&"+lngx+"&"+o1;
var urlstreetview="mystreetview.html?"+latx+"&"+lngx+"&"+o1;
savestreetviewstorage();
document.getElementById('streetview').src=urlstreetview;	
//setTimeout("document.getElementById('quitstreetview').focus();",3000);
//setTimeout("document.getElementById('quitstreetview').focus();",5000);
}else{tstreetview=0;
document.getElementById('streetview').src="";
document.getElementById('streetview').blur();
loadstreetviewstorage();
}
}
var streetviewmsg="off";
function loadstreetviewstorage(){
if(localStorage){var aux=localStorage.getItem("mystreetview_lat");
	             if(aux){latx=eval(aux);}
				 var aux1=localStorage.getItem("mystreetview_log");
	             if(aux1){lngx=eval(aux1);}
				 var aux2=localStorage.getItem("mystreetview_o1");
	             if(aux2){o1=eval(aux2);}
				}
}
function loadstreetviewmsg(){
if(localStorage){var aux3=localStorage.getItem("mystreetview_msg");
	             if(aux3){streetviewmsg=aux3;}
				}
}
function savestreetviewstorage(){
    streetviewmsg="start";
    if(localStorage){
	   localStorage.setItem("mystreetview_lat",latx);
	   localStorage.setItem("mystreetview_log",lngx);
	   localStorage.setItem("mystreetview_o1",o1);
	   localStorage.setItem("mystreetview_msg",streetviewmsg);
	   }
}
function substreetview2(){
if(tstreetview==0){
tstreetview=1;
var urlstreetview="https:"+"//30239318f214b2cdc3b069138f22a3fbc2a194c6.googledrive.com/host/0B6GM9ay7ImZLV1ZBV0w0U1pPRGs/mystreetview.html?"+latx+"&"+lngx+"&"+o1;
document.getElementById('streetview').src=showosmmapurl();	
setTimeout("document.getElementById('quitstreetview').focus();",300);
setTimeout("document.getElementById('quitstreetview').focus();",500);
}else{tstreetview=0;
document.getElementById('streetview').src="";
document.getElementById('streetview').blur();
}
}
function quitstreetview(){
tstreetview=0;
document.getElementById('streetview').src="";
document.getElementById('streetview').blur();
if(keys[vk_space] && tmap>0){
   tmap=0;
   hidemap();
   context.clearRect(0,0,canvas.width,canvas.height);
   resetkeys();}
else if(tmap==5){tmap=4;showmap();map.setCenter(new google.maps.LatLng(latx,lngx));updatemarker();}
loadstreetviewstorage();
}
var ntri=0,ndraw=0;
function gl_drawArrays(glTRIANGLES, x0, numItems){
if(numItems>=3 && tinit>1){
  ndraw+=1;ntri+=numItems/3;gl.drawArrays(glTRIANGLES, x0, numItems);}
}
function gl_drawElements(glTRIANGLES, numItems, glUNSIGNED_SHORT, x0){
if(numItems>=3 && tinit>1){
ndraw+=1;ntri+=numItems/3;gl.drawElements(glTRIANGLES, numItems, glUNSIGNED_SHORT, x0);}
}
function showosmmapurl(){
var dlat=0.001,dlon=0.001*klon;
var lat1=latx-dlat,lat2=latx+dlat,lng1=lngx-dlon,lng2=lngx+dlon;
//var osmmapsrc="https://www.openstreetmap.org/?minlon="+lng1+"&minlat="+lat1+"&maxlon="+lng2+"&maxlat="+lat2+"&mlat="+latx+"&mlon="+lngx;
//var osmmapsrc=http://www.openstreetmap.org/export/embed.html?bbox=33.49883794784546%2C44.61190236910504%2C33.52287054061889%2C44.62091409166478&amp;layer=mapnik&amp;marker=44.61640840520352%2C33.51085424423218"4.6164&amp;mlon=33.5109#map=16/44.6164/33.5109
var osmmapsrc="https://www.openstreetmap.org/export/embed.html?bbox="+lng1+"%2C"+lat1+"%2C"+lng2+"%2C"+lat2+"&amp;layer=mapnik&amp;";
//document.location.href=osmmapsrc;
return osmmapsrc;
}

var thour=0;
var hour=new Date().getHours()+new Date().getMinutes()/60.0+ thour;
while(hour>24){hour-=24;}
while(hour<0){hour+=24;};
try{initparms();}catch(e){alert("error initparms()");}
//getways();
getweather();timeinit=timer();
initgooglemap();setTimeout("hidemap();",2000);
setTimeout("getways();initwebgl();",3000);
setTimeout('radiomsg("hello,how are you");',4000);
</script>
<script type="text/javascript" src="stats.js">
</script>
</body>
</html>


